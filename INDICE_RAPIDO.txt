================================================================================
ÃNDICE RÃPIDO - SEBRAE NACIONAL - ESTRUTURA DO PROJETO
================================================================================

## CAMINHO DOS ARQUIVOS

Banco de Dados:
  /Users/felipematossardinhapinto/Library/CloudStorage/GoogleDrive-felipe@felipematos.net/
  My Drive/10K/Projetos/2025/Sebrae Nacional/Code/falhas_mercado_v1.db

CÃ³digo Python:
  app/
  â”œâ”€â”€ database.py           (356 linhas) - ConexÃµes e CRUD do SQLite
  â”œâ”€â”€ models.py             (92 linhas)  - Modelos Pydantic
  â”œâ”€â”€ schemas.py            (122 linhas) - Schemas API
  â”œâ”€â”€ config.py             - ConfiguraÃ§Ãµes
  â”œâ”€â”€ main.py               - Entrada FastAPI
  â”‚
  â”œâ”€â”€ agente/
  â”‚   â”œâ”€â”€ pesquisador.py    (601 linhas) - Agente orquestrador
  â”‚   â”œâ”€â”€ avaliador.py      (544 linhas) - CÃ¡lculo de scores
  â”‚   â””â”€â”€ deduplicador.py   - RemoÃ§Ã£o de duplicatas
  â”‚
  â”œâ”€â”€ api/
  â”‚   â”œâ”€â”€ resultados.py     (189 linhas) - GET/POST/PUT/DELETE resultados
  â”‚   â”œâ”€â”€ pesquisas.py      (150+ linhas)- POST/GET pesquisas
  â”‚   â”œâ”€â”€ falhas.py         - GET falhas de mercado
  â”‚   â””â”€â”€ health_check.py
  â”‚
  â””â”€â”€ integracao/
      â”œâ”€â”€ perplexity_api.py
      â”œâ”€â”€ jina_api.py
      â”œâ”€â”€ tavily_api.py
      â”œâ”€â”€ serper_api.py
      â”œâ”€â”€ exa_api.py
      â””â”€â”€ deep_research_mcp.py

================================================================================
## QUERIES SQL ÃšTEIS

### Ver Schema Completo
sqlite3 falhas_mercado_v1.db ".schema"

### Ver EstatÃ­sticas
SELECT 
  COUNT(*) as total,
  ROUND(MIN(confidence_score), 3) as min_score,
  ROUND(MAX(confidence_score), 3) as max_score,
  ROUND(AVG(confidence_score), 3) as avg_score
FROM resultados_pesquisa;

### Ver DistribuiÃ§Ã£o por Ferramenta
SELECT ferramenta_origem, COUNT(*) as total, ROUND(AVG(confidence_score), 3) as avg_score 
FROM resultados_pesquisa 
GROUP BY ferramenta_origem;

### Ver DistribuiÃ§Ã£o por Idioma
SELECT idioma, COUNT(*) as total, ROUND(AVG(confidence_score), 3) as avg_score 
FROM resultados_pesquisa 
GROUP BY idioma 
ORDER BY total DESC;

### Ver Top 5 Falhas
SELECT falha_id, COUNT(*) as total_resultados, ROUND(AVG(confidence_score), 3) as avg_score 
FROM resultados_pesquisa 
GROUP BY falha_id 
ORDER BY total_resultados DESC LIMIT 5;

### Ver Fila Pendente
SELECT COUNT(*) as total_pendente FROM fila_pesquisas WHERE status = 'pendente';

### Ver um Resultado EspecÃ­fico
SELECT * FROM resultados_pesquisa WHERE id = 2088;

### Buscar Resultados por Falha e Idioma
SELECT * FROM resultados_pesquisa 
WHERE falha_id = 1 AND idioma = 'pt' 
ORDER BY confidence_score DESC 
LIMIT 10;

================================================================================
## ENDPOINTS API

Base URL: http://localhost:8000

RESULTADOS:
  GET    /resultados
         ?skip=0&limit=50&falha_id=1&min_score=0.0&max_score=1.0&idioma=pt
  
  GET    /resultados/{resultado_id}
  POST   /resultados (criar resultado manual)
  PUT    /resultados/{resultado_id} (atualizar score)
  DELETE /resultados/{resultado_id}

PESQUISAS:
  POST   /pesquisas/iniciar
  POST   /pesquisas/custom
  GET    /pesquisas/progresso

FALHAS:
  GET    /falhas
  GET    /falhas/{falha_id}

ESTATÃSTICAS:
  GET    /estatisticas
  GET    /estatisticas/falha/{falha_id}

================================================================================
## ESTRUTURA DE TABELAS

FALHAS_MERCADO (50 registros - Original)
â”œâ”€â”€ id (PK)
â”œâ”€â”€ titulo
â”œâ”€â”€ pilar ("1. Talento", "2. Densidade", ..., "7. Capital")
â”œâ”€â”€ descricao
â””â”€â”€ dica_busca

RESULTADOS_PESQUISA (1,503 registros)
â”œâ”€â”€ id (PK)
â”œâ”€â”€ falha_id (FK)
â”œâ”€â”€ titulo
â”œâ”€â”€ descricao
â”œâ”€â”€ fonte_url
â”œâ”€â”€ fonte_tipo ("web", etc)
â”œâ”€â”€ pais_origem (NULL)
â”œâ”€â”€ idioma ("pt", "en", "es", "ar", "it", "fr", "de", "ko")
â”œâ”€â”€ confidence_score (0.11 - 0.477)
â”œâ”€â”€ num_ocorrencias (default 1)
â”œâ”€â”€ ferramenta_origem ("perplexity", "jina", "tavily", "serper")
â”œâ”€â”€ hash_conteudo (UNIQUE - SHA256)
â”œâ”€â”€ criado_em
â””â”€â”€ atualizado_em

FILA_PESQUISAS (10,800 registros)
â”œâ”€â”€ id (PK)
â”œâ”€â”€ falha_id (FK)
â”œâ”€â”€ query
â”œâ”€â”€ idioma
â”œâ”€â”€ ferramenta
â”œâ”€â”€ prioridade (default 0)
â”œâ”€â”€ tentativas (default 0)
â”œâ”€â”€ max_tentativas (default 3)
â”œâ”€â”€ status ("pendente", "processando", "concluido", "erro")
â””â”€â”€ criado_em

HISTORICO_PESQUISAS (0 registros - NÃ£o estÃ¡ sendo usado)
â”œâ”€â”€ id (PK)
â”œâ”€â”€ falha_id (FK)
â”œâ”€â”€ query
â”œâ”€â”€ idioma
â”œâ”€â”€ ferramenta
â”œâ”€â”€ status
â”œâ”€â”€ resultados_encontrados
â”œâ”€â”€ erro_mensagem
â”œâ”€â”€ tempo_execucao
â””â”€â”€ executado_em

================================================================================
## FÃ“RMULA DE CONFIDENCE SCORE

score = (relevancia Ã— 0.40) + (ocorrencias Ã— 0.30) + 
        (fonte Ã— 0.20) + (titulo_match Ã— 0.10)

Componentes:

1. RELEVÃ‚NCIA (40%)
   score_base = (matches / total_palavras) Ã— 0.7
   bonus_phrase = +0.2 (se query completa aparece)
   max = 1.0

2. OCORRÃŠNCIAS (30%)
   = min(1.0, num_ocorrencias / 10.0)

3. FONTE (20%)
   - perplexity: 0.95
   - jina: 0.90
   - deep_research: 0.85
   - google: 0.80
   - wikipedia: 0.75
   - blog: 0.50
   - social_media: 0.30
   - unknown: 0.40 (default)

4. TÃTULO MATCH (10%)
   = proporÃ§Ã£o_palavras_chave_no_tÃ­tulo

================================================================================
## PROBLEMAS IDENTIFICADOS

1. SCORES MUITO BAIXOS
   - MÃ©dia: 0.193 (apenas 19.3%)
   - MÃ¡ximo: 0.477 (bem abaixo de 0.5)
   - % acima de 0.5: 0%
   - Causa provÃ¡vel: RelevÃ¢ncia baixa e descriÃ§Ãµes vazias

2. CAMPOS INCOMPLETOS
   - pais_origem: NULL em todos os 1,503 registros
   - descricao: Muitos NULL
   - fonte_tipo: Todos "web"

3. HISTÃ“RICO VAZIO
   - historico_pesquisas: 0 registros
   - NÃ£o estÃ¡ sendo populado pelos workers

================================================================================
## FLUXO DE PROCESSAMENTO RESUMIDO

1. GERAR QUERIES
   50 falhas Ã— 8 idiomas = ~400 queries

2. POPULAR FILA
   400 queries Ã— 4 ferramentas = 1,600 entradas
   (Observado: 10,800 com retry logic)

3. PROCESSAR FILA
   â”œâ”€ Chamar API externa
   â”œâ”€ Coletar resultados
   â”œâ”€ Gerar hash para dedup
   â”œâ”€ Calcular confidence_score
   â””â”€ Inserir em resultados_pesquisa

4. DEDUPLICAÃ‡ÃƒO
   15,000 brutos â†’ 1,503 Ãºnicos (90% dedup rate)

5. ATUALIZAR STATUS
   fila_pesquisas: pendente â†’ concluido

================================================================================
## FERRAMENTAS SUPORTADAS

âœ… Habilitadas:
   - Perplexity AI (646 resultados, avg score 0.170)
   - Jina (nÃ£o visto em dados)
   - Tavily (420 resultados, avg score 0.220)
   - Serper (425 resultados, avg score 0.202)

âŒ Desabilitadas:
   - Exa
   - Deep Research

ğŸ“Œ RotaÃ§Ã£o: Cada query usa ferramentas em ordem rotacionada para diversidade

================================================================================
## IDIOMAS SUPORTADOS

pt (PortuguÃªs)      222 results - avg score 0.213
en (InglÃªs)         208 results - avg score 0.178
es (Espanhol)       170 results - avg score 0.195
ar (Ãrabe)          179 results - avg score 0.195
it (Italiano)       170 results - avg score 0.191
fr (FrancÃªs)        154 results - avg score 0.180
de (AlemÃ£o)         148 results - avg score 0.183
ko (Coreano)        147 results - avg score 0.193

================================================================================
## ÃNDICES DO BANCO

Criados:
  â”œâ”€â”€ idx_resultados_falha
  â”‚   ON resultados_pesquisa(falha_id)
  â”‚
  â”œâ”€â”€ idx_resultados_score
  â”‚   ON resultados_pesquisa(confidence_score DESC)
  â”‚
  â”œâ”€â”€ idx_historico_falha
  â”‚   ON historico_pesquisas(falha_id)
  â”‚
  â””â”€â”€ idx_fila_status
      ON fila_pesquisas(status, prioridade DESC)

ImplÃ­citos (Primary Keys):
  â”œâ”€â”€ pk_falhas_mercado(id)
  â”œâ”€â”€ pk_resultados_pesquisa(id)
  â”œâ”€â”€ pk_historico_pesquisas(id)
  â””â”€â”€ pk_fila_pesquisas(id)

================================================================================
## CONFIGURAÃ‡ÃƒO IMPORTANTE

app/config.py:
  IDIOMAS = ["pt", "en", "es", "fr", "de", "it", "ar", "ko"]
  
  FERRAMENTAS = ["perplexity", "jina", "tavily", "serper"]
  
  SEARCH_CHANNELS_ENABLED = {
    "perplexity": True,
    "jina": True,
    "tavily": True,
    "serper": True,
    "exa": False,
    "deep_research": False
  }
  
  USAR_BUSCA_ADAPTATIVA = True
  MIN_BUSCAS_POR_FALHA = 2
  MAX_BUSCAS_POR_FALHA = 4
  QUALIDADE_MINIMA_PARA_PARAR = 0.75
  
  RAG_ENABLED = False (desabilitado por padrÃ£o)
  RAG_SIMILARITY_THRESHOLD = 0.8

================================================================================
## COMANDOS ÃšTEIS

Inicializar Banco:
  python app/database.py

Popular Fila (CLI):
  python -m app.agente.pesquisador popular_fila

Limpar Fila (CLI):
  python -m app.agente.pesquisador limpar_fila

Iniciar Server:
  uvicorn app.main:app --reload

Ver Docs Swagger:
  http://localhost:8000/docs

================================================================================
## PRÃ“XIMOS PASSOS

1. Investigar por que confidence scores sÃ£o tÃ£o baixos
2. Analisar queries geradas (sÃ£o genÃ©ricas demais?)
3. Verificar parseamento de dados das APIs
4. Enriquecer dados com descriÃ§Ãµes completas
5. Ativar histÃ³rico de pesquisas
6. Implementar dashboard de visualizaÃ§Ã£o
7. Considerar ML para otimizar cÃ¡lculo de relevÃ¢ncia

================================================================================
