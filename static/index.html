<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Sebrae Nacional - Pesquisa de Políticas Públicas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script defer src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        [x-cloak] { display: none !important; }
        .phase-badge { @apply inline-block px-3 py-1 rounded-full text-sm font-medium; }
        .phase-active { @apply bg-blue-100 text-blue-800; }
        .phase-inactive { @apply bg-gray-100 text-gray-600; }
        .phase-badge-nav { @apply inline-flex items-center px-4 py-2 rounded-lg font-medium cursor-pointer transition; }
        .phase-nav-active { @apply bg-blue-600 text-white; }
        .phase-nav-inactive { @apply bg-gray-200 text-gray-700 hover:bg-gray-300; }
        .matrix-cell { @apply p-4 rounded-lg border-2 transition; }
        .quick-wins { @apply border-green-500 bg-green-50; }
        .strategic { @apply border-orange-500 bg-orange-50; }
        .fill-in { @apply border-blue-500 bg-blue-50; }
        .low-priority { @apply border-red-500 bg-red-50; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900" x-cloak>
    <div id="app" class="min-h-screen" x-data="app()" x-init="inicializar()">
        <!-- Header Principal -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h1 class="text-3xl font-bold" style="color: #1e3a8a;">Sebrae Nacional</h1>
                        <p class="text-sm mt-1" style="color: #374151;">Pesquisa de Políticas Públicas para Inovação</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium" style="color: #374151;">Fase Atual</p>
                        <p class="text-lg font-bold text-blue-700" x-text="fases[fase_atual].nome"></p>
                    </div>
                </div>

                <!-- Navegação de Fases -->
                <div class="flex gap-2">
                    <template x-for="(fase, idx) in fases" :key="idx">
                        <button @click="mudar_fase(idx)"
                                :class="idx === fase_atual ? 'phase-nav-active' : 'phase-nav-inactive'"
                                class="phase-badge-nav text-sm">
                            <span x-text="`${idx + 1}. ${fase.nome}`"></span>
                            <template x-if="idx < fase_atual">
                                <span class="ml-2">✓</span>
                            </template>
                        </button>
                    </template>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
            <!-- Fase 0: Home -->
            <section x-show="fase_atual === 0" class="space-y-8">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-8 border border-blue-200">
                    <h2 class="text-3xl font-bold mb-4">Bem-vindo ao Sistema de Pesquisa</h2>
                    <p class="text-lg text-gray-700 mb-6">
                        Este sistema ajuda a identificar, pesquisar e priorizar falhas de mercado no ecossistema de inovação brasileiro.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <template x-for="(fase, idx) in fases" :key="idx">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <div class="text-2xl font-bold text-blue-600 mb-2" x-text="`${idx + 1}`"></div>
                                <h3 class="font-bold mb-2" x-text="fase.nome"></h3>
                                <p class="text-sm text-gray-600" x-text="fase.descricao"></p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Estatísticas Gerais -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Total de Falhas</p>
                        <p class="text-3xl font-bold text-blue-700 mt-2" x-text="stats.total_falhas">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Priorizadas</p>
                        <p class="text-3xl font-bold text-green-700 mt-2" x-text="stats.total_priorizadas">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Pesquisas Realizadas</p>
                        <p class="text-3xl font-bold text-purple-700 mt-2" x-text="stats.total_resultados">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Status</p>
                        <p class="text-lg font-bold mt-2" :class="ativo ? 'text-green-700' : 'text-gray-600'" x-text="ativo ? '✓ Ativo' : '○ Inativo'"></p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-8">
                    <h3 class="text-xl font-bold mb-4">Comece Agora</h3>
                    <p class="text-gray-700 mb-6">Escolha uma fase para começar:</p>
                    <div class="space-y-2">
                        <button @click="mudar_fase(1)" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ▶ Fase 1: Pesquisa de Políticas Públicas
                        </button>
                        <button @click="mudar_fase(2)" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ▶ Fase 2: Priorização de Falhas
                        </button>
                    </div>
                </div>
            </section>

            <!-- Fase 1: Pesquisa -->
            <section x-show="fase_atual === 1" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">Fase 1: Pesquisa de Políticas Públicas</h2>
                        <p class="text-gray-600 mt-1">Identifique e pesquise políticas públicas relevantes para cada falha de mercado</p>
                    </div>
                </div>

                <!-- Status de Pesquisa -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Status de Processamento</h3>
                        <span class="text-sm font-medium" :class="ativo ? 'text-green-700' : 'text-red-700'" x-text="ativo ? '● Ativo' : '○ Parado'"></span>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-sm font-medium">Progresso Geral</span>
                                <span class="text-sm font-medium" x-text="`${percentual_processamento.toFixed(1)}%`"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-blue-600 h-3 rounded-full transition-all" :style="`width: ${percentual_processamento}%`"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-4">
                            <div>
                                <p class="text-xs text-gray-600">Pendentes</p>
                                <p class="text-2xl font-bold text-yellow-700" x-text="stats.total_pendentes">0</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Processando</p>
                                <p class="text-2xl font-bold text-blue-700" x-text="stats.total_processando">0</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Concluídas</p>
                                <p class="text-2xl font-bold text-green-700" x-text="stats.total_concluidas">0</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Resultados</p>
                                <p class="text-2xl font-bold text-purple-700" x-text="stats.total_resultados">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controles -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex gap-3 flex-wrap">
                        <button @click="iniciar_pesquisas()" :disabled="pesquisa_iniciando" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50">
                            <span x-show="!pesquisa_iniciando">▶ Iniciar Pesquisa</span>
                            <span x-show="pesquisa_iniciando">⟳ Iniciando...</span>
                        </button>
                        <button @click="pausar_pesquisas()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium">
                            ⏸ Pausar
                        </button>
                        <button @click="reiniciar_pesquisas()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium">
                            ⟲ Reiniciar Tudo
                        </button>
                    </div>
                </div>

                <!-- Tabela de Falhas -->
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-medium">ID</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Falha</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Pilar</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Progresso</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Resultados</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-falhas">
                            <tr class="border-b hover:bg-gray-50">
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">Carregando falhas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Fase 2: Priorização -->
            <section x-show="fase_atual === 2" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">Fase 2: Priorização de Falhas</h2>
                        <p class="text-gray-600 mt-1">Analise o impacto e esforço de implementação para cada falha</p>
                    </div>
                </div>

                <!-- Controles de Análise -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-bold mb-4">Análise de IA</h3>
                    <div class="flex gap-3 flex-wrap">
                        <button @click="analisar_todas_falhas()" :disabled="analisando" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50">
                            <span x-show="!analisando">🤖 Analisar Todas as Falhas</span>
                            <span x-show="analisando">⟳ Analisando...</span>
                        </button>
                        <button @click="carregar_matriz()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium">
                            📊 Ver Matriz 2x2
                        </button>
                    </div>
                </div>

                <!-- Abas de Conteúdo -->
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8">
                        <button @click="aba_priorizacao = 'tabela'" :class="aba_priorizacao === 'tabela' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'" class="py-4 px-1 font-medium text-sm border-b-2 border-transparent">
                            Tabela de Priorização
                        </button>
                        <button @click="aba_priorizacao = 'matriz'" :class="aba_priorizacao === 'matriz' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'" class="py-4 px-1 font-medium text-sm border-b-2 border-transparent">
                            Matriz 2x2
                        </button>
                    </nav>
                </div>

                <!-- Aba: Tabela -->
                <div x-show="aba_priorizacao === 'tabela'" class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-medium">ID</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Falha</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Impacto</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Esforço</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Quadrante</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-priorizacao">
                            <tr class="border-b hover:bg-gray-50">
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Carregando priorizações...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Aba: Matriz -->
                <div x-show="aba_priorizacao === 'matriz'" class="space-y-6">
                    <!-- Gráfico da Matriz -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <canvas id="canvas-matriz" height="80"></canvas>
                    </div>

                    <!-- Quadrantes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Quick Wins -->
                        <div class="matrix-cell quick-wins">
                            <h3 class="text-lg font-bold mb-2">🎯 Quick Wins</h3>
                            <p class="text-sm mb-4">Alto impacto, Baixo esforço</p>
                            <ul class="space-y-2" id="quadrante-quick-wins">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>

                        <!-- Strategic -->
                        <div class="matrix-cell strategic">
                            <h3 class="text-lg font-bold mb-2">⭐ Strategic</h3>
                            <p class="text-sm mb-4">Alto impacto, Alto esforço</p>
                            <ul class="space-y-2" id="quadrante-strategic">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>

                        <!-- Fill-in -->
                        <div class="matrix-cell fill-in">
                            <h3 class="text-lg font-bold mb-2">✓ Fill-in</h3>
                            <p class="text-sm mb-4">Baixo impacto, Baixo esforço</p>
                            <ul class="space-y-2" id="quadrante-fill-in">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>

                        <!-- Low Priority -->
                        <div class="matrix-cell low-priority">
                            <h3 class="text-lg font-bold mb-2">⏱ Low Priority</h3>
                            <p class="text-sm mb-4">Baixo impacto, Alto esforço</p>
                            <ul class="space-y-2" id="quadrante-low-priority">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        function app() {
            return {
                fase_atual: 0,
                fases: [
                    { nome: 'Home', descricao: 'Visão geral do projeto' },
                    { nome: 'Pesquisa', descricao: 'Busca por políticas públicas' },
                    { nome: 'Priorização', descricao: 'Análise de impacto e esforço' }
                ],
                stats: { total_falhas: 0, total_priorizadas: 0, total_resultados: 0, total_pendentes: 0, total_processando: 0, total_concluidas: 0 },
                ativo: false,
                pesquisa_iniciando: false,
                analisando: false,
                percentual_processamento: 0,
                aba_priorizacao: 'tabela',
                chartMatriz: null,

                mudar_fase(idx) {
                    this.fase_atual = idx;
                    if (idx === 1) this.carregar_dados_pesquisa();
                    if (idx === 2) this.carregar_dados_priorizacao();
                },

                async inicializar() {
                    await this.carregar_stats();
                    this.carregar_dados_pesquisa();
                    setInterval(() => this.carregar_stats(), 5000);
                },

                async carregar_stats() {
                    try {
                        const res = await fetch('/api/falhas');
                        const data = await res.json();
                        this.stats.total_falhas = data.total || 0;

                        const res2 = await fetch('/api/resultados');
                        const data2 = await res2.json();
                        this.stats.total_resultados = data2.total || 0;

                        const res3 = await fetch('/api/priorizacoes/');
                        if (res3.ok) {
                            const data3 = await res3.json();
                            this.stats.total_priorizadas = data3.total || 0;
                        }
                    } catch (e) {
                        console.error('Erro ao carregar stats', e);
                    }
                },

                async carregar_dados_pesquisa() {
                    try {
                        const res = await fetch('/api/falhas');
                        const data = await res.json();
                        const tbody = document.getElementById('tabela-falhas');
                        if (data.dados && Array.isArray(data.dados)) {
                            tbody.innerHTML = data.dados.map(falha => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-6 py-4 text-sm">${falha.id}</td>
                                    <td class="px-6 py-4 text-sm font-medium">${falha.titulo}</td>
                                    <td class="px-6 py-4 text-sm"><span class="bg-blue-100 text-blue-800 px-3 py-1 rounded">${falha.pilar}</span></td>
                                    <td class="px-6 py-4 text-sm">
                                        <div class="w-32 bg-gray-200 rounded h-2"><div class="bg-blue-600 h-2 rounded" style="width: ${(falha.total_resultados || 0) * 5}%"></div></div>
                                    </td>
                                    <td class="px-6 py-4 text-sm font-medium">${falha.total_resultados || 0}</td>
                                </tr>
                            `).join('');
                        }
                    } catch (e) {
                        console.error('Erro ao carregar falhas', e);
                    }
                },

                async carregar_dados_priorizacao() {
                    await this.carregar_priorizacoes();
                    await this.carregar_matriz();
                },

                async carregar_priorizacoes() {
                    try {
                        const res = await fetch('/api/priorizacoes/');
                        if (!res.ok) return;
                        const data = await res.json();
                        const tbody = document.getElementById('tabela-priorizacao');
                        if (data.dados && Array.isArray(data.dados)) {
                            tbody.innerHTML = data.dados.map(p => {
                                const quadrante = this.obter_quadrante(p.impacto, p.esforco);
                                return `
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="px-6 py-4 text-sm">${p.falha_id}</td>
                                        <td class="px-6 py-4 text-sm font-medium">${p.titulo}</td>
                                        <td class="px-6 py-4 text-sm"><span class="bg-green-100 text-green-800 px-3 py-1 rounded font-bold">${p.impacto}/10</span></td>
                                        <td class="px-6 py-4 text-sm"><span class="bg-orange-100 text-orange-800 px-3 py-1 rounded font-bold">${p.esforco}/10</span></td>
                                        <td class="px-6 py-4 text-sm"><span class="bg-purple-100 text-purple-800 px-3 py-1 rounded text-xs">${quadrante}</span></td>
                                        <td class="px-6 py-4 text-sm">
                                            <button onclick="alert('Edição de priorização - em desenvolvimento')" class="text-blue-600 hover:underline">Editar</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('');
                        }
                    } catch (e) {
                        console.error('Erro ao carregar priorizações', e);
                    }
                },

                async carregar_matriz() {
                    try {
                        const res = await fetch('/api/priorizacoes/matriz/quadrantes');
                        if (!res.ok) return;
                        const data = await res.json();

                        // Renderizar quadrantes
                        this.renderizar_quadrante('quick_wins', data.quick_wins.dados);
                        this.renderizar_quadrante('strategic', data.strategic.dados);
                        this.renderizar_quadrante('fill_in', data.fill_in.dados);
                        this.renderizar_quadrante('low_priority', data.low_priority.dados);

                        // Renderizar gráfico
                        this.renderizar_grafico(data);
                    } catch (e) {
                        console.error('Erro ao carregar matriz', e);
                    }
                },

                renderizar_quadrante(quadrante, falhas) {
                    const el = document.getElementById(`quadrante-${quadrante}`);
                    if (!el) return;
                    if (!falhas || falhas.length === 0) {
                        el.innerHTML = '<li class="text-sm text-gray-600">Nenhuma falha neste quadrante</li>';
                    } else {
                        el.innerHTML = falhas.map(f => `<li class="text-sm">• ${f.titulo}</li>`).join('');
                    }
                },

                async renderizar_grafico(data) {
                    const canvas = document.getElementById('canvas-matriz');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');

                    try {
                        const res = await fetch('/api/priorizacoes/matriz/dados');
                        if (!res.ok) return;
                        const matrizData = await res.json();

                        const labels = matrizData.dados.map(d => d.titulo.substring(0, 10));
                        const impactos = matrizData.dados.map(d => d.impacto);
                        const esforcos = matrizData.dados.map(d => d.esforco);

                        if (this.chartMatriz) this.chartMatriz.destroy();

                        this.chartMatriz = new Chart(ctx, {
                            type: 'scatter',
                            data: {
                                datasets: [{
                                    label: 'Falhas',
                                    data: impactos.map((imp, idx) => ({ x: esforcos[idx], y: imp })),
                                    borderColor: '#3B82F6',
                                    backgroundColor: '#93C5FD',
                                    borderWidth: 2,
                                    pointRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { display: true },
                                    title: { display: true, text: 'Matriz de Priorização (Impacto vs Esforço)' }
                                },
                                scales: {
                                    x: { title: { display: true, text: 'Esforço (0-10)' }, min: 0, max: 10 },
                                    y: { title: { display: true, text: 'Impacto (0-10)' }, min: 0, max: 10 }
                                }
                            }
                        });
                    } catch (e) {
                        console.error('Erro ao renderizar gráfico', e);
                    }
                },

                obter_quadrante(impacto, esforco) {
                    if (impacto >= 6 && esforco <= 4) return '🎯 Quick Wins';
                    if (impacto >= 6 && esforco > 4) return '⭐ Strategic';
                    if (impacto < 6 && esforco <= 4) return '✓ Fill-in';
                    return '⏱ Low Priority';
                },

                async iniciar_pesquisas() {
                    this.pesquisa_iniciando = true;
                    try {
                        const res = await fetch('/api/pesquisas/iniciar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ falhas_ids: 'all' })
                        });
                        if (res.ok) {
                            this.ativo = true;
                            setTimeout(() => this.carregar_stats(), 1000);
                        }
                    } catch (e) {
                        alert('Erro ao iniciar pesquisas: ' + e.message);
                    } finally {
                        this.pesquisa_iniciando = false;
                    }
                },

                async pausar_pesquisas() {
                    try {
                        await fetch('/api/pesquisas/pausar', { method: 'POST' });
                        this.ativo = false;
                    } catch (e) {
                        alert('Erro: ' + e.message);
                    }
                },

                async reiniciar_pesquisas() {
                    if (confirm('Tem certeza que deseja reiniciar todas as pesquisas?')) {
                        try {
                            await fetch('/api/pesquisas/reiniciar', { method: 'POST' });
                            this.carregar_stats();
                        } catch (e) {
                            alert('Erro: ' + e.message);
                        }
                    }
                },

                async analisar_todas_falhas() {
                    this.analisando = true;
                    try {
                        await fetch('/api/priorizacoes/inicializar/padrao');
                        const res = await fetch('/api/priorizacoes/analisar-todas', { method: 'POST' });
                        if (res.ok) {
                            alert('Análise concluída!');
                            this.carregar_priorizacoes();
                        }
                    } catch (e) {
                        alert('Erro: ' + e.message);
                    } finally {
                        this.analisando = false;
                    }
                }
            };
        }
    </script>
</body>
</html>
