<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Sebrae Nacional - Pol√≠ticas P√∫blicas de Inova√ß√£o</title>
    <!-- Force body display IMMEDIATELY before any CSS loads -->
    <script>
        // This runs BEFORE any stylesheets load
        // Set a style rule that forces body to display
        const style = document.createElement('style');
        style.innerHTML = 'body { display: block !important; visibility: visible !important; opacity: 1 !important; }';
        document.head.appendChild(style);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script defer src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        body { display: block !important; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        [x-cloak] { display: none !important; }
        .phase-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
        .phase-active { background-color: #dbeafe; color: #1e40af; }
        .phase-inactive { background-color: #f3f4f6; color: #4b5563; }
        .phase-badge-nav { display: inline-flex; align-items: center; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: all 0.3s; }
        .phase-nav-active { background-color: #2563eb; color: white; }
        .phase-nav-inactive { background-color: #e5e7eb; color: #374151; }
        .phase-nav-inactive:hover { background-color: #d1d5db; }
        .matrix-cell { padding: 1rem; border-radius: 0.5rem; border: 2px solid; transition: all 0.3s; }
        .quick-wins { border-color: #22c55e; background-color: #f0fdf4; }
        .strategic { border-color: #f97316; background-color: #fff7ed; }
        .fill-in { border-color: #3b82f6; background-color: #eff6ff; }
        .low-priority { border-color: #ef4444; background-color: #fef2f2; }
        .container { max-width: 80rem; margin: 0 auto; padding: 0 1rem; }
        header { background-color: white; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        main { margin: 2rem auto; }
    </style>
    <script>
        // Fallback: Remove x-cloak after 5 seconds if Alpine.js hasn't loaded
        setTimeout(() => {
            const app = document.getElementById('app');
            if (app && app.hasAttribute('x-cloak')) {
                app.removeAttribute('x-cloak');
                console.warn('Alpine.js loading fallback applied');
            }
        }, 5000);
    </script>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="app" class="min-h-screen" x-data="app()" x-init="inicializar()" style="display: block;">
        <!-- Container de Notifica√ß√µes -->
        <div id="notificacoes-container" class="fixed top-4 right-4 z-[9999] space-y-2" style="max-width: 400px;"></div>

        <!-- Container de Confirma√ß√£o Modal -->
        <div id="confirmacao-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center" @click.self="fechar_confirmacao()" x-show="confirmacao_aberta" x-cloak>
            <div class="bg-white rounded-lg p-6 max-w-sm" @click.stop>
                <h3 class="text-lg font-bold mb-2" x-text="confirmacao_titulo"></h3>
                <p class="text-gray-600 mb-6" x-text="confirmacao_mensagem"></p>
                <div class="flex gap-3 justify-end">
                    <button @click="fechar_confirmacao()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-medium">
                        Cancelar
                    </button>
                    <button @click="executar_confirmacao()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-medium">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Arquivos Duplicados -->
        <div id="duplicados-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center" @click.self="fechar_duplicados_modal()" x-show="duplicados_modal_aberto" x-cloak>
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4" @click.stop>
                <h3 class="text-xl font-bold mb-3 text-orange-600">‚ö†Ô∏è Arquivos Duplicados Detectados</h3>
                <p class="text-gray-600 mb-4">Os seguintes arquivos j√° existem na base de conhecimento. Como deseja proceder?</p>

                <!-- Lista de arquivos duplicados -->
                <div class="bg-gray-50 rounded p-4 mb-4 max-h-60 overflow-y-auto">
                    <template x-for="dup in arquivos_duplicados" :key="dup.nome">
                        <div class="flex items-center justify-between py-2 px-3 bg-white rounded mb-2">
                            <div class="flex items-center space-x-3 flex-1 min-w-0">
                                <span class="text-orange-500 text-xl">üìÑ</span>
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-sm truncate" x-text="dup.nome"></p>
                                    <p class="text-xs text-gray-500">
                                        Existente: <span x-text="(dup.tamanho_existente / 1024).toFixed(2)"></span> KB
                                        / Novo: <span x-text="(dup.tamanho_novo / 1024).toFixed(2)"></span> KB
                                    </p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Op√ß√µes de a√ß√£o -->
                <div class="mb-6">
                    <p class="text-sm font-semibold mb-3 text-gray-700">Escolha uma a√ß√£o:</p>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 border-2 rounded cursor-pointer hover:bg-blue-50" :class="opcao_duplicados === 'overwrite' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'">
                            <input type="radio" name="duplicate-action" value="overwrite" x-model="opcao_duplicados" class="mr-3">
                            <div>
                                <p class="font-medium text-sm">Sobrescrever arquivos existentes</p>
                                <p class="text-xs text-gray-500">Substitui os arquivos antigos pelos novos</p>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border-2 rounded cursor-pointer hover:bg-green-50" :class="opcao_duplicados === 'copy' ? 'border-green-500 bg-green-50' : 'border-gray-200'">
                            <input type="radio" name="duplicate-action" value="copy" x-model="opcao_duplicados" class="mr-3">
                            <div>
                                <p class="font-medium text-sm">Criar uma c√≥pia</p>
                                <p class="text-xs text-gray-500">Mant√©m o arquivo antigo e cria "arquivo (1).pdf"</p>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border-2 rounded cursor-pointer hover:bg-gray-50" :class="opcao_duplicados === 'skip' ? 'border-gray-500 bg-gray-50' : 'border-gray-200'">
                            <input type="radio" name="duplicate-action" value="skip" x-model="opcao_duplicados" class="mr-3">
                            <div>
                                <p class="font-medium text-sm">Ignorar duplicados</p>
                                <p class="text-xs text-gray-500">Mant√©m os arquivos existentes e n√£o envia os duplicados</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Bot√µes de a√ß√£o -->
                <div class="flex gap-3 justify-end">
                    <button @click="fechar_duplicados_modal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-medium">
                        Cancelar Upload
                    </button>
                    <button @click="proceder_com_upload()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium">
                        Continuar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Confirma√ß√£o de Rean√°lise -->
        <div id="reanalisar-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center" @click.self="modal_reanalisar_aberto = false" x-show="modal_reanalisar_aberto" x-cloak>
            <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4" @click.stop>
                <h3 class="text-xl font-bold mb-3 text-blue-600">üîÑ Reanalisar Resultados</h3>
                <p class="text-gray-700 mb-4">
                    Esta a√ß√£o ir√° reavaliar todas as fontes existentes com os novos crit√©rios de avalia√ß√£o.
                </p>

                <!-- Estimativas -->
                <div x-show="estimativa_reanalisar" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 space-y-2">
                    <p class="font-semibold text-gray-900">üìä Estimativas:</p>
                    <div class="space-y-1 text-sm">
                        <p><strong>Fontes:</strong> <span x-text="estimativa_reanalisar?.num_fontes || 0"></span> fontes ser√£o reanalisadas</p>
                        <p><strong>Modelo:</strong> <span x-text="estimativa_reanalisar?.modelo || 'N/A'"></span></p>
                        <p><strong>Tempo estimado:</strong>
                            <span x-text="estimativa_reanalisar ? Math.ceil(estimativa_reanalisar.tempo_estimado_segundos / 60) : 0"></span> minutos
                        </p>
                        <p x-show="estimativa_reanalisar && estimativa_reanalisar.custo_estimado > 0">
                            <strong>Custo estimado:</strong>
                            R$ <span x-text="estimativa_reanalisar?.custo_estimado.toFixed(2) || '0.00'"></span>
                        </p>
                        <p x-show="estimativa_reanalisar && estimativa_reanalisar.custo_estimado === 0" class="text-green-600 font-medium">
                            ‚úÖ Gratuito (sem custo)
                        </p>
                    </div>
                </div>

                <!-- Aviso -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-6">
                    <p class="text-sm text-yellow-800">
                        <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta opera√ß√£o pode levar algum tempo dependendo do n√∫mero de fontes.
                        O processo rodar√° em segundo plano e voc√™ pode continuar trabalhando.
                    </p>
                </div>

                <!-- Bot√µes -->
                <div class="flex gap-3 justify-end">
                    <button @click="modal_reanalisar_aberto = false" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-medium">
                        Cancelar
                    </button>
                    <button @click="executar_reanalisar()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium">
                        Confirmar Rean√°lise
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Confirma√ß√£o de Refazer Tradu√ß√µes -->
        <div id="refazer-traducoes-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center" @click.self="fechar_modal_traducao()" x-show="modal_confirmar_traducao_aberto" x-cloak>
            <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4" @click.stop>
                <h3 class="text-xl font-bold mb-3 text-purple-600">üîÑ Refazer Todas as Tradu√ß√µes</h3>
                <p class="text-gray-700 mb-4">
                    Esta a√ß√£o ir√° <strong>retraduzir TODOS</strong> os resultados internacionais e <strong>corrigir idiomas</strong> detectados incorretamente.
                </p>

                <!-- Loading de estimativa -->
                <div x-show="estimativa_traducao_carregando" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-purple-600 mb-3"></div>
                    <p class="text-gray-600 text-sm">Calculando estimativas...</p>
                </div>

                <!-- Estimativas -->
                <div x-show="!estimativa_traducao_carregando && estimativa_traducao" class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4 space-y-2">
                    <p class="font-semibold text-gray-900">üìä Estimativas:</p>
                    <div class="space-y-1 text-sm">
                        <p><strong>Resultados:</strong> <span x-text="estimativa_traducao?.total || 0"></span> resultados ser√£o retraduzidos</p>
                        <p><strong>Modo:</strong> <span x-text="estimativa_traducao?.modo_nome || 'N/A'"></span></p>
                        <p><strong>Tempo estimado:</strong>
                            <span x-text="estimativa_traducao ? Math.ceil(estimativa_traducao.tempo_estimado_segundos / 60) : 0"></span> minutos
                        </p>
                        <p x-show="estimativa_traducao && estimativa_traducao.custo_estimado > 0">
                            <strong>Custo estimado:</strong>
                            R$ <span x-text="estimativa_traducao?.custo_estimado.toFixed(2) || '0.00'"></span>
                        </p>
                        <p x-show="estimativa_traducao && estimativa_traducao.custo_estimado === 0" class="text-green-600 font-medium">
                            ‚úÖ Gratuito (sem custo)
                        </p>
                    </div>
                </div>

                <!-- Aviso -->
                <div x-show="!estimativa_traducao_carregando" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-6">
                    <p class="text-sm text-yellow-800">
                        <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta opera√ß√£o pode levar alguns minutos. O processo rodar√° em segundo plano e voc√™ poder√° acompanhar o progresso.
                    </p>
                </div>

                <!-- Bot√µes -->
                <div x-show="!estimativa_traducao_carregando" class="flex gap-3 justify-end">
                    <button @click="fechar_modal_traducao()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-medium">
                        Cancelar
                    </button>
                    <button @click="refazer_todas_traducoes()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded font-medium">
                        Confirmar e Refazer
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de An√°lise Individual -->
        <div id="analise-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center" @click.self="fechar_modal_analise()" x-show="modal_analise_aberto" x-cloak>
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" @click.stop>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-blue-600">üîç Analisar Falha</h3>
                        <p class="text-sm text-gray-600 mt-1" x-show="falha_analise">
                            <span class="font-medium">Falha #<span x-text="falha_analise?.id"></span>:</span>
                            <span x-text="falha_analise?.titulo"></span>
                        </p>
                    </div>
                    <button @click="fechar_modal_analise()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Configura√ß√µes Avan√ßadas -->
                <div class="space-y-4 mb-6">
                    <p class="text-sm text-gray-700 font-medium mb-3">‚öôÔ∏è Configura√ß√µes de An√°lise</p>

                    <!-- Fontes de Dados -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">üìö Fontes de Dados</p>

                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" x-model="config_analise.usar_rag" class="form-checkbox h-5 w-5 text-blue-600">
                            <div>
                                <p class="text-sm font-medium">Base de Conhecimento (RAG)</p>
                                <p class="text-xs text-gray-500">Usa documentos indexados para contexto adicional</p>
                            </div>
                        </label>

                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" x-model="config_analise.usar_resultados_pesquisa" class="form-checkbox h-5 w-5 text-blue-600">
                            <div>
                                <p class="text-sm font-medium">Resultados de Pesquisa</p>
                                <p class="text-xs text-gray-500">Usa resultados de pesquisa web relacionados √† falha</p>
                            </div>
                        </label>
                    </div>

                    <!-- Par√¢metros do Modelo -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">ü§ñ Par√¢metros do Modelo</p>

                        <!-- Seletor de Modelo -->
                        <div>
                            <label class="text-sm font-medium text-gray-700 block mb-2">Modelo de IA</label>
                            <select x-model="config_analise.modelo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="google/gemini-2.5-pro">Gemini 2.5 Pro (Recomendado)</option>
                                <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash Experimental (Gratuito)</option>
                                <option value="xai/grok-4-fast">Grok 4 Fast (R√°pido)</option>
                                <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Escolha o modelo de IA para an√°lise. Gemini 2.5 Pro oferece melhor qualidade.</p>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-gray-700 flex items-center justify-between">
                                Temperatura
                                <span class="text-blue-600 font-mono" x-text="config_analise.temperatura.toFixed(1)"></span>
                            </label>
                            <input type="range" x-model.number="config_analise.temperatura" min="0" max="1" step="0.1" class="w-full">
                            <p class="text-xs text-gray-500 mt-1">Controla a criatividade da resposta (0.0 = determin√≠stico, 1.0 = criativo)</p>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-gray-700 flex items-center justify-between">
                                Tokens M√°ximos
                                <span class="text-blue-600 font-mono" x-text="config_analise.max_tokens"></span>
                            </label>
                            <input type="range" x-model.number="config_analise.max_tokens" min="1000" max="8000" step="500" class="w-full">
                            <p class="text-xs text-gray-500 mt-1">Tamanho m√°ximo da resposta (1000-8000 tokens)</p>
                        </div>
                    </div>

                    <!-- Informa√ß√µes da An√°lise -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p class="text-sm text-blue-800">
                            <span class="font-medium">Sistema:</span> An√°lise com IA + RAG<br>
                            <span class="font-medium">Contexto:</span> Base de conhecimento + Resultados de pesquisa<br>
                            <span class="font-medium">Crit√©rios:</span> Sistema de calibragem objetivo (8 dimens√µes)
                        </p>
                    </div>
                </div>

                <!-- Indicador de Progresso -->
                <div x-show="analisando_individual" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-blue-800" x-text="progresso_analise.mensagem || 'Processando...'"></p>
                            <p class="text-xs text-blue-600 mt-1" x-text="`Etapa: ${progresso_analise.etapa || 'Iniciando'}`"></p>
                        </div>
                        <span class="text-lg font-bold text-blue-600" x-text="`${progresso_analise.progresso || 0}%`"></span>
                    </div>
                    <!-- Barra de progresso -->
                    <div class="w-full bg-blue-100 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" :style="`width: ${progresso_analise.progresso || 0}%`"></div>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="flex gap-3 justify-end">
                    <button @click="fechar_modal_analise()" :disabled="analisando_individual" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                        Cancelar
                    </button>
                    <button @click="executar_analise_individual()" :disabled="analisando_individual" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                        <span x-show="!analisando_individual">üöÄ Iniciar An√°lise</span>
                        <span x-show="analisando_individual">‚ü≥ Analisando...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Configura√ß√µes para An√°lise em Lote -->
        <div id="config-lote-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center" @click.self="fechar_config_lote()" x-show="modal_config_lote_aberto" x-cloak>
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" @click.stop>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-700">‚öôÔ∏è Configura√ß√µes de An√°lise em Lote</h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Estas configura√ß√µes ser√£o aplicadas ao analisar todas as falhas
                        </p>
                    </div>
                    <button @click="fechar_config_lote()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Configura√ß√µes -->
                <div class="space-y-4 mb-6">
                    <!-- Fontes de Dados -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">üìö Fontes de Dados</p>

                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" x-model="config_analise_lote.usar_rag" class="form-checkbox h-5 w-5 text-blue-600">
                            <div>
                                <p class="text-sm font-medium">Base de Conhecimento (RAG)</p>
                                <p class="text-xs text-gray-500">Usa documentos indexados para contexto adicional</p>
                            </div>
                        </label>

                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" x-model="config_analise_lote.usar_resultados_pesquisa" class="form-checkbox h-5 w-5 text-blue-600">
                            <div>
                                <p class="text-sm font-medium">Resultados de Pesquisa</p>
                                <p class="text-xs text-gray-500">Usa resultados de pesquisa web relacionados √† falha</p>
                            </div>
                        </label>
                    </div>

                    <!-- Par√¢metros do Modelo -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">ü§ñ Par√¢metros do Modelo</p>

                        <!-- Seletor de Modelo -->
                        <div>
                            <label class="text-sm font-medium text-gray-700 block mb-2">Modelo de IA</label>
                            <select x-model="config_analise_lote.modelo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="google/gemini-2.5-pro">Gemini 2.5 Pro (Recomendado)</option>
                                <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash Experimental (Gratuito)</option>
                                <option value="xai/grok-4-fast">Grok 4 Fast (R√°pido)</option>
                                <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Escolha o modelo de IA para an√°lise. Gemini 2.5 Pro oferece melhor qualidade.</p>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-gray-700 flex items-center justify-between">
                                Temperatura
                                <span class="text-blue-600 font-mono" x-text="config_analise_lote.temperatura.toFixed(1)"></span>
                            </label>
                            <input type="range" x-model.number="config_analise_lote.temperatura" min="0" max="1" step="0.1" class="w-full">
                            <p class="text-xs text-gray-500 mt-1">Controla a criatividade da resposta (0.0 = determin√≠stico, 1.0 = criativo)</p>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-gray-700 flex items-center justify-between">
                                Tokens M√°ximos
                                <span class="text-blue-600 font-mono" x-text="config_analise_lote.max_tokens"></span>
                            </label>
                            <input type="range" x-model.number="config_analise_lote.max_tokens" min="1000" max="8000" step="500" class="w-full">
                            <p class="text-xs text-gray-500 mt-1">Tamanho m√°ximo da resposta (1000-8000 tokens)</p>
                        </div>
                    </div>

                    <!-- Resumo da Configura√ß√£o -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm font-medium text-blue-900 mb-2">üìã Resumo da Configura√ß√£o</p>
                        <div class="text-xs text-blue-800 space-y-1">
                            <p><span class="font-medium">Modelo:</span> <span x-text="config_analise_lote.modelo"></span></p>
                            <p><span class="font-medium">RAG:</span> <span x-text="config_analise_lote.usar_rag ? 'Ativado' : 'Desativado'"></span></p>
                            <p><span class="font-medium">Pesquisa Web:</span> <span x-text="config_analise_lote.usar_resultados_pesquisa ? 'Ativado' : 'Desativado'"></span></p>
                            <p><span class="font-medium">Temperatura:</span> <span x-text="config_analise_lote.temperatura.toFixed(1)"></span></p>
                            <p><span class="font-medium">Max Tokens:</span> <span x-text="config_analise_lote.max_tokens"></span></p>
                        </div>
                    </div>

                    <!-- Aviso -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-sm text-yellow-800">
                            <span class="font-medium">‚ö†Ô∏è Importante:</span> Estas configura√ß√µes ser√£o aplicadas a todas as 50 falhas durante a an√°lise em lote. A an√°lise pode levar alguns minutos dependendo do modelo escolhido.
                        </p>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="flex gap-3 justify-end">
                    <button @click="fechar_config_lote()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-medium">
                        Cancelar
                    </button>
                    <button @click="salvar_config_lote()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium">
                        üíæ Salvar Configura√ß√µes
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Configura√ß√£o de Filtros - Fase I -->
        <!-- ‚ö†Ô∏è ACCESSIBILITY RULE: All text on white/light backgrounds MUST use text-gray-700 or darker for proper contrast -->
        <div id="filtros-fase1-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center" @click.self="modal_filtros_fase1_aberto = false" x-show="modal_filtros_fase1_aberto" x-cloak>
            <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto" @click.stop>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-700">‚öôÔ∏è Configurar Filtros de Fontes</h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Configure como as fontes ser√£o filtradas e priorizadas para identifica√ß√£o de boas pr√°ticas
                        </p>
                    </div>
                    <button @click="modal_filtros_fase1_aberto = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Configura√ß√µes -->
                <div class="space-y-4 mb-6">
                    <!-- Taxa de Confian√ßa -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">üìä Qualidade das Fontes</p>

                        <div>
                            <label class="text-sm font-medium text-gray-700 flex items-center justify-between">
                                Taxa de Confian√ßa M√≠nima
                                <span class="text-indigo-600 font-mono" x-text="(filtros_fase1.confianca_minima * 100).toFixed(0)"></span>
                            </label>
                            <input type="range" x-model.number="filtros_fase1.confianca_minima" @input="filtros_fase1_alterados = true" min="0" max="1" step="0.05" class="w-full">
                            <p class="text-xs text-gray-500 mt-1">Fontes com confian√ßa abaixo deste valor ser√£o filtradas</p>
                        </div>
                    </div>

                    <!-- Prioriza√ß√£o Sebrae -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 space-y-3 border border-blue-200">
                        <p class="text-sm font-medium text-blue-900 mb-2">üè¢ Prioriza√ß√£o de Fontes Sebrae</p>

                        <div>
                            <label class="text-sm font-medium text-gray-700 block mb-2">Multiplicador de Peso</label>
                            <select x-model.number="filtros_fase1.peso_sebrae" @change="filtros_fase1_alterados = true" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900">
                                <option :value="1" class="text-gray-900">1x - Peso Normal</option>
                                <option :value="2" class="text-gray-900">2x - Prioridade Moderada</option>
                                <option :value="5" class="text-gray-900">5x - Prioridade Alta</option>
                                <option :value="10" class="text-gray-900">10x - Prioridade M√°xima</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Documentos do Sebrae ter√£o seu score multiplicado por este valor</p>
                        </div>
                    </div>

                    <!-- Tipo de Fonte -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">üìö Tipo de Fonte (m√∫ltipla sele√ß√£o)</p>

                        <!-- CONTRAST FIX: Always use text-gray-700+ for text on white backgrounds -->
                        <div class="space-y-2">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="academica"
                                       :checked="filtros_fase1.tipo_fonte.includes('academica')"
                                       @change="e => { e.target.checked ? filtros_fase1.tipo_fonte.push('academica') : filtros_fase1.tipo_fonte = filtros_fase1.tipo_fonte.filter(t => t !== 'academica'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Acad√™mica (Artigos, Pesquisas)</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="governamental"
                                       :checked="filtros_fase1.tipo_fonte.includes('governamental')"
                                       @change="e => { e.target.checked ? filtros_fase1.tipo_fonte.push('governamental') : filtros_fase1.tipo_fonte = filtros_fase1.tipo_fonte.filter(t => t !== 'governamental'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Governamental (Leis, Decretos, Programas)</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="tecnico"
                                       :checked="filtros_fase1.tipo_fonte.includes('tecnico')"
                                       @change="e => { e.target.checked ? filtros_fase1.tipo_fonte.push('tecnico') : filtros_fase1.tipo_fonte = filtros_fase1.tipo_fonte.filter(t => t !== 'tecnico'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">T√©cnico (Relat√≥rios, White Papers)</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="caso_sucesso"
                                       :checked="filtros_fase1.tipo_fonte.includes('caso_sucesso')"
                                       @change="e => { e.target.checked ? filtros_fase1.tipo_fonte.push('caso_sucesso') : filtros_fase1.tipo_fonte = filtros_fase1.tipo_fonte.filter(t => t !== 'caso_sucesso'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Casos de Sucesso</span>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            <span x-show="filtros_fase1.tipo_fonte.length === 0" class="text-amber-600 font-medium">Nenhum selecionado = todos os tipos</span>
                            <span x-show="filtros_fase1.tipo_fonte.length > 0" x-text="filtros_fase1.tipo_fonte.length + ' tipo(s) selecionado(s)'"></span>
                        </p>
                    </div>

                    <!-- Per√≠odo de Publica√ß√£o -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">üìÖ Per√≠odo de Publica√ß√£o</p>

                        <div>
                            <select x-model="filtros_fase1.anos_publicacao" @change="filtros_fase1_alterados = true" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900">
                                <option value="todos" class="text-gray-900">Sem Limite de Tempo</option>
                                <option value="3" class="text-gray-900">√öltimos 3 Anos</option>
                                <option value="5" class="text-gray-900">√öltimos 5 Anos</option>
                                <option value="10" class="text-gray-900">√öltimos 10 Anos</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Considerar apenas documentos publicados recentemente</p>
                        </div>
                    </div>

                    <!-- Regi√£o Geogr√°fica -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">üåç Regi√£o Geogr√°fica (m√∫ltipla sele√ß√£o)</p>

                        <div class="space-y-3">
                            <!-- Foco Brasil -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-2">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" value="brasil"
                                           :checked="filtros_fase1.regiao.includes('brasil')"
                                           @change="e => { e.target.checked ? filtros_fase1.regiao.push('brasil') : filtros_fase1.regiao = filtros_fase1.regiao.filter(r => r !== 'brasil'); filtros_fase1_alterados = true; }"
                                           class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                    <span class="text-sm font-medium text-blue-900">üáßüá∑ Brasil</span>
                                </label>
                            </div>

                            <!-- Continentes -->
                            <div class="grid grid-cols-1 gap-2">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" value="america_sul"
                                           :checked="filtros_fase1.regiao.includes('america_sul')"
                                           @change="e => { e.target.checked ? filtros_fase1.regiao.push('america_sul') : filtros_fase1.regiao = filtros_fase1.regiao.filter(r => r !== 'america_sul'); filtros_fase1_alterados = true; }"
                                           class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                    <span class="text-sm text-gray-700">üåé Am√©rica do Sul</span>
                                </label>

                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" value="america_norte"
                                           :checked="filtros_fase1.regiao.includes('america_norte')"
                                           @change="e => { e.target.checked ? filtros_fase1.regiao.push('america_norte') : filtros_fase1.regiao = filtros_fase1.regiao.filter(r => r !== 'america_norte'); filtros_fase1_alterados = true; }"
                                           class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                    <span class="text-sm text-gray-700">üåé Am√©rica do Norte</span>
                                </label>

                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" value="america_central"
                                           :checked="filtros_fase1.regiao.includes('america_central')"
                                           @change="e => { e.target.checked ? filtros_fase1.regiao.push('america_central') : filtros_fase1.regiao = filtros_fase1.regiao.filter(r => r !== 'america_central'); filtros_fase1_alterados = true; }"
                                           class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                    <span class="text-sm text-gray-700">üåé Am√©rica Central e Caribe</span>
                                </label>

                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" value="europa"
                                           :checked="filtros_fase1.regiao.includes('europa')"
                                           @change="e => { e.target.checked ? filtros_fase1.regiao.push('europa') : filtros_fase1.regiao = filtros_fase1.regiao.filter(r => r !== 'europa'); filtros_fase1_alterados = true; }"
                                           class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                    <span class="text-sm text-gray-700">üá™üá∫ Europa</span>
                                </label>

                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" value="asia"
                                           :checked="filtros_fase1.regiao.includes('asia')"
                                           @change="e => { e.target.checked ? filtros_fase1.regiao.push('asia') : filtros_fase1.regiao = filtros_fase1.regiao.filter(r => r !== 'asia'); filtros_fase1_alterados = true; }"
                                           class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                    <span class="text-sm text-gray-700">üåè √Åsia</span>
                                </label>

                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" value="africa"
                                           :checked="filtros_fase1.regiao.includes('africa')"
                                           @change="e => { e.target.checked ? filtros_fase1.regiao.push('africa') : filtros_fase1.regiao = filtros_fase1.regiao.filter(r => r !== 'africa'); filtros_fase1_alterados = true; }"
                                           class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                    <span class="text-sm text-gray-700">üåç √Åfrica</span>
                                </label>

                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" value="oceania"
                                           :checked="filtros_fase1.regiao.includes('oceania')"
                                           @change="e => { e.target.checked ? filtros_fase1.regiao.push('oceania') : filtros_fase1.regiao = filtros_fase1.regiao.filter(r => r !== 'oceania'); filtros_fase1_alterados = true; }"
                                           class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                    <span class="text-sm text-gray-700">üåè Oceania</span>
                                </label>

                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" value="global"
                                           :checked="filtros_fase1.regiao.includes('global')"
                                           @change="e => { e.target.checked ? filtros_fase1.regiao.push('global') : filtros_fase1.regiao = filtros_fase1.regiao.filter(r => r !== 'global'); filtros_fase1_alterados = true; }"
                                           class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                    <span class="text-sm text-gray-700">üåê Global/Internacional</span>
                                </label>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            <span x-show="filtros_fase1.regiao.length === 0" class="text-amber-600 font-medium">Nenhuma selecionada = todas as regi√µes</span>
                            <span x-show="filtros_fase1.regiao.length > 0" x-text="filtros_fase1.regiao.length + ' regi√£o(√µes) selecionada(s)'"></span>
                        </p>
                    </div>

                    <!-- Idioma -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">üåê Idioma (m√∫ltipla sele√ß√£o)</p>

                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="pt"
                                       :checked="filtros_fase1.idioma.includes('pt')"
                                       @change="e => { e.target.checked ? filtros_fase1.idioma.push('pt') : filtros_fase1.idioma = filtros_fase1.idioma.filter(i => i !== 'pt'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Portugu√™s</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="es"
                                       :checked="filtros_fase1.idioma.includes('es')"
                                       @change="e => { e.target.checked ? filtros_fase1.idioma.push('es') : filtros_fase1.idioma = filtros_fase1.idioma.filter(i => i !== 'es'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Espanhol</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="en"
                                       :checked="filtros_fase1.idioma.includes('en')"
                                       @change="e => { e.target.checked ? filtros_fase1.idioma.push('en') : filtros_fase1.idioma = filtros_fase1.idioma.filter(i => i !== 'en'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Ingl√™s</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="fr"
                                       :checked="filtros_fase1.idioma.includes('fr')"
                                       @change="e => { e.target.checked ? filtros_fase1.idioma.push('fr') : filtros_fase1.idioma = filtros_fase1.idioma.filter(i => i !== 'fr'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Franc√™s</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="de"
                                       :checked="filtros_fase1.idioma.includes('de')"
                                       @change="e => { e.target.checked ? filtros_fase1.idioma.push('de') : filtros_fase1.idioma = filtros_fase1.idioma.filter(i => i !== 'de'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Alem√£o</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="it"
                                       :checked="filtros_fase1.idioma.includes('it')"
                                       @change="e => { e.target.checked ? filtros_fase1.idioma.push('it') : filtros_fase1.idioma = filtros_fase1.idioma.filter(i => i !== 'it'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Italiano</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="zh"
                                       :checked="filtros_fase1.idioma.includes('zh')"
                                       @change="e => { e.target.checked ? filtros_fase1.idioma.push('zh') : filtros_fase1.idioma = filtros_fase1.idioma.filter(i => i !== 'zh'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Chin√™s</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="ja"
                                       :checked="filtros_fase1.idioma.includes('ja')"
                                       @change="e => { e.target.checked ? filtros_fase1.idioma.push('ja') : filtros_fase1.idioma = filtros_fase1.idioma.filter(i => i !== 'ja'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Japon√™s</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="ko"
                                       :checked="filtros_fase1.idioma.includes('ko')"
                                       @change="e => { e.target.checked ? filtros_fase1.idioma.push('ko') : filtros_fase1.idioma = filtros_fase1.idioma.filter(i => i !== 'ko'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Coreano</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="ar"
                                       :checked="filtros_fase1.idioma.includes('ar')"
                                       @change="e => { e.target.checked ? filtros_fase1.idioma.push('ar') : filtros_fase1.idioma = filtros_fase1.idioma.filter(i => i !== 'ar'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">√Årabe</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="ru"
                                       :checked="filtros_fase1.idioma.includes('ru')"
                                       @change="e => { e.target.checked ? filtros_fase1.idioma.push('ru') : filtros_fase1.idioma = filtros_fase1.idioma.filter(i => i !== 'ru'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Russo</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="hi"
                                       :checked="filtros_fase1.idioma.includes('hi')"
                                       @change="e => { e.target.checked ? filtros_fase1.idioma.push('hi') : filtros_fase1.idioma = filtros_fase1.idioma.filter(i => i !== 'hi'); filtros_fase1_alterados = true; }"
                                       class="form-checkbox h-4 w-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Hindi</span>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            <span x-show="filtros_fase1.idioma.length === 0" class="text-amber-600 font-medium">Nenhum selecionado = todos os idiomas</span>
                            <span x-show="filtros_fase1.idioma.length > 0" x-text="filtros_fase1.idioma.length + ' idioma(s) selecionado(s)'"></span>
                        </p>
                    </div>

                    <!-- Filtros Avan√ßados -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">üîç Filtros Avan√ßados</p>

                        <label class="flex items-start space-x-3 cursor-pointer">
                            <input type="checkbox" x-model="filtros_fase1.apenas_com_implementacao" @change="filtros_fase1_alterados = true" class="form-checkbox h-5 w-5 text-indigo-600 mt-0.5">
                            <div>
                                <p class="text-sm font-medium text-gray-700">Apenas com Casos de Implementa√ß√£o</p>
                                <p class="text-xs text-gray-500">Priorizar fontes que descrevam implementa√ß√£o pr√°tica</p>
                            </div>
                        </label>

                        <label class="flex items-start space-x-3 cursor-pointer">
                            <input type="checkbox" x-model="filtros_fase1.apenas_com_metricas" @change="filtros_fase1_alterados = true" class="form-checkbox h-5 w-5 text-indigo-600 mt-0.5">
                            <div>
                                <p class="text-sm font-medium text-gray-700">Apenas com M√©tricas de Impacto</p>
                                <p class="text-xs text-gray-500">Priorizar fontes com dados quantific√°veis de resultados</p>
                            </div>
                        </label>

                        <label class="flex items-start space-x-3 cursor-pointer">
                            <input type="checkbox" x-model="filtros_fase1.limpar_cache" @change="filtros_fase1_alterados = true" class="form-checkbox h-5 w-5 text-indigo-600 mt-0.5">
                            <div>
                                <p class="text-sm font-medium text-gray-700">Limpar Cache</p>
                                <p class="text-xs text-gray-500">Ignorar an√°lises em cache e for√ßar novas an√°lises de todas as fontes</p>
                            </div>
                        </label>
                    </div>

                    <!-- Resumo da Configura√ß√£o -->
                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                        <p class="text-sm font-medium text-indigo-900 mb-2">üìã Resumo dos Filtros Ativos</p>
                        <div class="text-xs text-indigo-800 space-y-1">
                            <p><span class="font-medium">Confian√ßa M√≠nima:</span> <span x-text="(filtros_fase1.confianca_minima * 100).toFixed(0)"></span></p>
                            <p><span class="font-medium">Peso Sebrae:</span> <span x-text="filtros_fase1.peso_sebrae + 'x'"></span></p>
                            <p><span class="font-medium">Tipo:</span> <span x-text="filtros_fase1.tipo_fonte.length > 0 ? filtros_fase1.tipo_fonte.join(', ') : 'Todos'"></span></p>
                            <p><span class="font-medium">Per√≠odo:</span> <span x-text="filtros_fase1.anos_publicacao === 'todos' ? 'Sem limite' : '√öltimos ' + filtros_fase1.anos_publicacao + ' anos'"></span></p>
                            <p><span class="font-medium">Regi√£o:</span> <span x-text="filtros_fase1.regiao.length > 0 ? filtros_fase1.regiao.join(', ') : 'Todas'"></span></p>
                            <p><span class="font-medium">Idioma:</span> <span x-text="filtros_fase1.idioma.length > 0 ? filtros_fase1.idioma.join(', ') : 'Todos'"></span></p>
                            <p><span class="font-medium">Com Implementa√ß√£o:</span> <span x-text="filtros_fase1.apenas_com_implementacao ? 'Sim' : 'N√£o'"></span></p>
                            <p><span class="font-medium">Com M√©tricas:</span> <span x-text="filtros_fase1.apenas_com_metricas ? 'Sim' : 'N√£o'"></span></p>
                            <p><span class="font-medium">Limpar Cache:</span> <span x-text="filtros_fase1.limpar_cache ? 'Sim' : 'N√£o'"></span></p>
                        </div>
                    </div>

                    <!-- Aviso -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-sm text-yellow-800">
                            <span class="font-medium">üí° Dica:</span> Filtros mais restritivos retornar√£o menos fontes, mas com maior relev√¢ncia. Use a prioriza√ß√£o Sebrae para valorizar documentos internos da organiza√ß√£o.
                        </p>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="flex gap-3 justify-end">
                    <button @click="resetar_filtros_fase1()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-medium">
                        üîÑ Restaurar Padr√µes
                    </button>
                    <button @click="aplicar_filtros_fase1()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded font-medium">
                        ‚úì Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Estimativa de Custo - Fase I -->
        <div class="fixed inset-0 bg-black bg-opacity-50 z-[10001] flex items-center justify-center" @click.self="cancelar_atualizacao_fase1()" x-show="modal_estimativa_aberto" x-cloak>
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4" @click.stop>
                <!-- Cabe√ßalho -->
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800">üìä Estimativa de Custo e Tempo</h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Revise as informa√ß√µes antes de prosseguir com a an√°lise
                        </p>
                    </div>
                    <button @click="cancelar_atualizacao_fase1()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Conte√∫do -->
                <div x-show="estimativa_carregando" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600 mb-4"></div>
                    <p class="text-gray-600">Calculando estimativas...</p>
                </div>

                <div x-show="!estimativa_carregando && estimativa_dados" class="space-y-4">
                    <!-- Resumo Geral -->
                    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-6 border border-purple-200">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">üìã</span>
                            Resumo da Opera√ß√£o
                        </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Falhas Priorizadas</p>
                                <p class="text-2xl font-bold text-purple-600" x-text="estimativa_dados?.num_falhas || 0"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Total de Fontes</p>
                                <p class="text-2xl font-bold text-indigo-600" x-text="estimativa_dados?.total_fontes_disponiveis || 0"></p>
                            </div>
                        </div>
                    </div>

                    <!-- An√°lises Necess√°rias -->
                    <div class="bg-amber-50 rounded-lg p-6 border border-amber-200">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">ü§ñ</span>
                            An√°lises com IA
                        </h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-700">Fontes ap√≥s filtros:</span>
                                <span class="font-mono font-bold text-gray-800" x-text="estimativa_dados?.total_fontes_apos_filtros || 0"></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-700">J√° em cache:</span>
                                <span class="font-mono font-bold text-green-600" x-text="estimativa_dados?.fontes_em_cache || 0"></span>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-amber-300">
                                <span class="text-sm font-medium text-gray-800">Novas an√°lises necess√°rias:</span>
                                <span class="font-mono font-bold text-amber-700" x-text="estimativa_dados?.fontes_a_analisar || 0"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Estimativas de Tempo e Custo -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Tempo -->
                        <div class="bg-blue-50 rounded-lg p-6 border border-blue-200">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">‚è±Ô∏è</span>
                                <h4 class="font-bold text-gray-800">Tempo</h4>
                            </div>
                            <p class="text-xl font-bold text-blue-600" x-text="estimativa_dados?.tempo_estimado_formatado || '0s'"></p>
                            <p class="text-xs text-gray-500 mt-1">Tempo estimado de processamento</p>
                        </div>

                        <!-- Custo -->
                        <div class="bg-green-50 rounded-lg p-6 border border-green-200">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">üí∞</span>
                                <h4 class="font-bold text-gray-800">Custo</h4>
                            </div>
                            <p class="text-xl font-bold text-green-600" x-text="estimativa_dados?.custo_estimado_formatado || '$0.0000 USD'"></p>
                            <p class="text-xs text-gray-500 mt-1">Custo estimado (Grok 4 Fast)</p>
                        </div>
                    </div>

                    <!-- Aviso -->
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">
                                    <strong>Aten√ß√£o:</strong> As estimativas s√£o aproximadas. O tempo real e custo podem variar dependendo da carga do sistema e complexidade das an√°lises.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div x-show="!estimativa_carregando" class="flex gap-3 justify-end mt-6 pt-4 border-t">
                    <button @click="cancelar_atualizacao_fase1()" class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg font-medium transition-colors">
                        ‚úï Cancelar
                    </button>
                    <button @click="confirmar_atualizacao_fase1()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors">
                        ‚úì Confirmar e Prosseguir
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Confirma√ß√£o de Pesquisa (Fase 1 - Pesquisa) -->
        <div class="fixed inset-0 bg-black bg-opacity-50 z-[10001] flex items-center justify-center" @click.self="cancelar_pesquisa()" x-show="modal_confirmacao_pesquisa_aberto" x-cloak>
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4" @click.stop>
                <!-- Cabe√ßalho -->
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800" x-text="estimativa_pesquisa?.tipo === 'iniciar' ? 'üîç Iniciar Pesquisa de Pol√≠ticas P√∫blicas' : 'üîÑ Reiniciar Todas as Pesquisas'"></h3>
                        <p class="text-sm text-gray-600 mt-1">
                            Revise as estimativas antes de prosseguir
                        </p>
                    </div>
                    <button @click="cancelar_pesquisa()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Conte√∫do -->
                <div x-show="estimativa_pesquisa_carregando" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-green-600 mb-4"></div>
                    <p class="text-gray-600">Calculando estimativas...</p>
                </div>

                <div x-show="!estimativa_pesquisa_carregando && estimativa_pesquisa" class="space-y-4">
                    <!-- Resumo -->
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-6 border border-green-200">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">üìä</span>
                            Resumo da Opera√ß√£o
                        </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Total de Falhas</p>
                                <p class="text-2xl font-bold text-green-600" x-text="estimativa_pesquisa?.total_falhas || 0"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600" x-text="estimativa_pesquisa?.tipo === 'iniciar' ? 'Falhas Pendentes' : 'Ser√£o Reprocessadas'"></p>
                                <p class="text-2xl font-bold text-emerald-600" x-text="estimativa_pesquisa?.total_pendentes || 0"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Descri√ß√£o da Opera√ß√£o -->
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <h4 class="font-bold text-gray-800 mb-2 flex items-center">
                            <span class="mr-2">‚ÑπÔ∏è</span>
                            O que ser√° feito?
                        </h4>
                        <p class="text-sm text-gray-700" x-show="estimativa_pesquisa?.tipo === 'iniciar'">
                            O sistema ir√° buscar pol√≠ticas p√∫blicas e documentos relacionados para cada falha pendente utilizando a API Perplexity. Os resultados ser√£o armazenados e poder√£o ser utilizados nas fases seguintes de prioriza√ß√£o e mapeamento de boas pr√°ticas.
                        </p>
                        <p class="text-sm text-gray-700" x-show="estimativa_pesquisa?.tipo === 'reiniciar'">
                            <strong>Aten√ß√£o:</strong> Todas as pesquisas existentes ser√£o descartadas e o processo ser√° iniciado do zero para TODAS as falhas. Use esta op√ß√£o apenas se necess√°rio.
                        </p>
                    </div>

                    <!-- Estimativas -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Tempo -->
                        <div class="bg-blue-50 rounded-lg p-6 border border-blue-200">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">‚è±Ô∏è</span>
                                <h4 class="font-bold text-gray-800">Tempo</h4>
                            </div>
                            <p class="text-xl font-bold text-blue-600" x-text="estimativa_pesquisa?.tempo_estimado_formatado || '0s'"></p>
                            <p class="text-xs text-gray-500 mt-1">Tempo estimado total</p>
                        </div>

                        <!-- Custo -->
                        <div class="bg-green-50 rounded-lg p-6 border border-green-200">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">üí∞</span>
                                <h4 class="font-bold text-gray-800">Custo</h4>
                            </div>
                            <p class="text-xl font-bold text-green-600" x-text="estimativa_pesquisa?.custo_estimado_formatado || '$0.00 USD'"></p>
                            <p class="text-xs text-gray-500 mt-1">Custo estimado (Perplexity API)</p>
                        </div>
                    </div>

                    <!-- Aviso -->
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">
                                    <strong>Aten√ß√£o:</strong> As estimativas s√£o aproximadas e baseadas em m√©dias. O tempo e custo reais podem variar dependendo da complexidade das consultas e disponibilidade da API.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div x-show="!estimativa_pesquisa_carregando" class="flex gap-3 justify-end mt-6 pt-4 border-t">
                    <button @click="cancelar_pesquisa()" class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg font-medium transition-colors">
                        ‚úï Cancelar
                    </button>
                    <button @click="confirmar_pesquisa()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                        ‚úì Confirmar e Iniciar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Resultados da Pesquisa (Fase 1) -->
        <div class="fixed inset-0 bg-black bg-opacity-50 z-[10001] flex items-center justify-center" @click.self="fechar_modal_resultados_pesquisa()" x-show="modal_resultados_pesquisa_aberto" x-cloak>
            <div class="bg-white rounded-lg max-w-6xl w-full mx-4 max-h-[90vh] flex flex-col" @click.stop>
                <!-- Cabe√ßalho -->
                <div class="flex justify-between items-start p-6 border-b sticky top-0 bg-white rounded-t-lg z-10">
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">üìä Resultados da Pesquisa</h3>
                        <div x-show="falha_selecionada_resultados">
                            <p class="text-sm text-gray-600 mb-1">
                                <span class="font-semibold">Falha #<span x-text="falha_selecionada_resultados?.id"></span>:</span>
                                <span x-text="falha_selecionada_resultados?.titulo"></span>
                            </p>
                            <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded text-sm" x-text="falha_selecionada_resultados?.pilar"></span>
                        </div>
                    </div>
                    <button @click="fechar_modal_resultados_pesquisa()" class="text-gray-400 hover:text-gray-600 ml-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Barra de Busca e Filtros -->
                <div class="p-4 border-b bg-gray-50">
                    <div class="flex gap-3 mb-3">
                        <!-- Campo de busca -->
                        <div class="flex-1 relative">
                            <input
                                type="text"
                                x-model="busca_resultados_pesquisa"
                                @input="aplicar_filtros_resultados()"
                                placeholder="Buscar nos resultados (t√≠tulo, descri√ß√£o, tradu√ß√£o...)"
                                class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <svg class="w-5 h-5 absolute left-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <!-- Bot√£o de filtros -->
                        <button
                            @click="mostrar_filtros_resultados = !mostrar_filtros_resultados"
                            class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                            </svg>
                            Filtros
                        </button>
                    </div>

                    <!-- Painel de filtros expans√≠vel -->
                    <div x-show="mostrar_filtros_resultados" x-collapse class="grid grid-cols-4 gap-3 p-3 bg-white border border-gray-200 rounded-lg">
                        <!-- Ordenar por -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ordenar por</label>
                            <select x-model="ordenacao_resultados" @change="aplicar_filtros_resultados()" class="w-full px-3 py-1.5 text-sm text-gray-900 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="score_desc">Score (maior ‚Üí menor)</option>
                                <option value="score_asc">Score (menor ‚Üí maior)</option>
                                <option value="idioma">Idioma (A ‚Üí Z)</option>
                                <option value="pais">Pa√≠s (A ‚Üí Z)</option>
                            </select>
                        </div>
                        <!-- Filtrar por idiomas (sele√ß√£o m√∫ltipla com painel expans√≠vel) -->
                        <div x-data="{ idiomas_aberto: false, todos_idiomas: ['pt', 'en', 'es', 'fr', 'de', 'it', 'ja', 'ar', 'ko', 'he'] }">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Idiomas</label>
                            <button
                                @click="idiomas_aberto = !idiomas_aberto"
                                class="w-full px-3 py-1.5 text-sm text-gray-900 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center justify-between">
                                <span x-text="filtro_idiomas_resultados.length === 0 ? 'Todos os idiomas' : filtro_idiomas_resultados.length + ' selecionados'"></span>
                                <svg class="w-4 h-4 transition-transform" :class="idiomas_aberto ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div x-show="idiomas_aberto" x-collapse class="mt-2 p-2 border border-gray-200 rounded-lg bg-gray-50 space-y-1.5 max-h-48 overflow-y-auto">
                                <!-- Op√ß√£o "Todos" -->
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input
                                        type="checkbox"
                                        :checked="filtro_idiomas_resultados.length === 0"
                                        @change="if ($event.target.checked) { filtro_idiomas_resultados = []; aplicar_filtros_resultados(); }"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900 font-medium">Todos</span>
                                </label>
                                <hr class="border-gray-300">
                                <!-- Idiomas individuais -->
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="pt" x-model="filtro_idiomas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">üáßüá∑ Portugu√™s</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="en" x-model="filtro_idiomas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">üá∫üá∏ Ingl√™s</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="es" x-model="filtro_idiomas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">üá™üá∏ Espanhol</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="fr" x-model="filtro_idiomas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">üá´üá∑ Franc√™s</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="de" x-model="filtro_idiomas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">üá©üá™ Alem√£o</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="it" x-model="filtro_idiomas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">üáÆüáπ Italiano</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="ja" x-model="filtro_idiomas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">üáØüáµ Japon√™s</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="ar" x-model="filtro_idiomas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">üá∏üá¶ √Årabe</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="ko" x-model="filtro_idiomas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">üá∞üá∑ Coreano</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="he" x-model="filtro_idiomas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">üáÆüá± Hebraico</span>
                                </label>
                            </div>
                        </div>
                        <!-- Filtrar por ferramentas (sele√ß√£o m√∫ltipla com painel expans√≠vel) -->
                        <div x-data="{ ferramentas_aberto: false }">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ferramentas</label>
                            <button
                                @click="ferramentas_aberto = !ferramentas_aberto"
                                class="w-full px-3 py-1.5 text-sm text-gray-900 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center justify-between">
                                <span x-text="filtro_ferramentas_resultados.length === 0 ? 'Todas as ferramentas' : filtro_ferramentas_resultados.length + ' selecionadas'"></span>
                                <svg class="w-4 h-4 transition-transform" :class="ferramentas_aberto ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div x-show="ferramentas_aberto" x-collapse class="mt-2 p-2 border border-gray-200 rounded-lg bg-gray-50 space-y-1.5 max-h-48 overflow-y-auto">
                                <!-- Op√ß√£o "Todas" -->
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input
                                        type="checkbox"
                                        :checked="filtro_ferramentas_resultados.length === 0"
                                        @change="if ($event.target.checked) { filtro_ferramentas_resultados = []; aplicar_filtros_resultados(); }"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900 font-medium">Todas</span>
                                </label>
                                <hr class="border-gray-300">
                                <!-- Ferramentas individuais -->
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="perplexity" x-model="filtro_ferramentas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">üîÆ Perplexity</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="tavily" x-model="filtro_ferramentas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">üîç Tavily</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="serper" x-model="filtro_ferramentas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">üåê Serper</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-white p-1.5 rounded">
                                    <input type="checkbox" value="exa" x-model="filtro_ferramentas_resultados" @change="aplicar_filtros_resultados()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-gray-900">‚ú® Exa</span>
                                </label>
                            </div>
                        </div>
                        <!-- Filtrar por score (range slider) -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-2">
                                Range de Score
                                <span class="text-gray-900 font-semibold ml-1" x-text="`${filtro_score_min_resultados} - ${filtro_score_max_resultados}`"></span>
                            </label>
                            <div class="relative pt-6 pb-2">
                                <!-- Range visual track -->
                                <div class="absolute w-full h-2 bg-gray-200 rounded-lg top-6"></div>
                                <div class="absolute h-2 bg-blue-500 rounded-lg top-6"
                                     :style="`left: ${filtro_score_min_resultados}%; width: ${filtro_score_max_resultados - filtro_score_min_resultados}%`"></div>

                                <!-- Slider m√≠nimo (por baixo) -->
                                <input
                                    type="range"
                                    min="0"
                                    max="100"
                                    step="5"
                                    x-model.number="filtro_score_min_resultados"
                                    @input="if (filtro_score_min_resultados > filtro_score_max_resultados) filtro_score_max_resultados = filtro_score_min_resultados; aplicar_filtros_resultados();"
                                    class="absolute w-full appearance-none bg-transparent pointer-events-none top-6"
                                    style="z-index: 3; height: 0;"
                                >

                                <!-- Slider m√°ximo (por cima) -->
                                <input
                                    type="range"
                                    min="0"
                                    max="100"
                                    step="5"
                                    x-model.number="filtro_score_max_resultados"
                                    @input="if (filtro_score_max_resultados < filtro_score_min_resultados) filtro_score_min_resultados = filtro_score_max_resultados; aplicar_filtros_resultados();"
                                    class="absolute w-full appearance-none bg-transparent pointer-events-none top-6"
                                    style="z-index: 4; height: 0;"
                                >

                                <!-- Labels de valores -->
                                <div class="flex justify-between text-xs text-gray-500 mt-8">
                                    <span>0</span>
                                    <span>50</span>
                                    <span>100</span>
                                </div>
                            </div>

                            <style>
                                /* Reativar pointer events apenas nos thumbs */
                                input[type="range"]::-webkit-slider-thumb {
                                    pointer-events: auto;
                                    width: 18px;
                                    height: 18px;
                                    appearance: none;
                                    background: #2563eb;
                                    border: 2px solid white;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                }
                                input[type="range"]::-moz-range-thumb {
                                    pointer-events: auto;
                                    width: 18px;
                                    height: 18px;
                                    appearance: none;
                                    background: #2563eb;
                                    border: 2px solid white;
                                    border-radius: 50%;
                                    cursor: pointer;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                }
                            </style>
                        </div>
                    </div>
                </div>

                <!-- Conte√∫do -->
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- Loading -->
                    <div x-show="carregando_resultados_pesquisa" class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600 mb-4"></div>
                        <p class="text-gray-600">Carregando resultados...</p>
                    </div>

                    <!-- Resultados -->
                    <div x-show="!carregando_resultados_pesquisa && paginacao_resultados_pesquisa.total > 0" class="space-y-4">
                        <!-- Info do total -->
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <p class="text-sm text-blue-800">
                                <span class="font-semibold">Exibindo
                                    <span x-text="resultados_pesquisa_paginados.length"></span>
                                </span>
                                resultado(s)
                                de <span class="font-semibold" x-text="paginacao_local.total_filtrados"></span> filtrado(s):
                                <span class="font-semibold" x-text="Math.round((paginacao_local.total_filtrados / paginacao_resultados_pesquisa.total) * 100)"></span>%
                                do total de <span class="font-semibold" x-text="paginacao_resultados_pesquisa.total"></span>
                            </p>
                        </div>

                        <!-- Lista de resultados -->
                        <template x-for="resultado in resultados_pesquisa_paginados" :key="resultado.id">
                            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow relative">
                                <div class="absolute top-4 right-4 flex items-center gap-2 z-20">
                                    <span
                                        class="px-2 py-1 text-xs font-medium rounded"
                                        :class="{
                                            'bg-green-100 text-green-800': resultado.confidence_score > 0.5,
                                            'bg-yellow-100 text-yellow-800': resultado.confidence_score >= 0.25 && resultado.confidence_score <= 0.5,
                                            'bg-red-100 text-red-800': resultado.confidence_score < 0.25
                                        }"
                                        x-text="((resultado.confidence_score ?? 0) * 100).toFixed(0)"
                                    ></span>
                                    <div class="relative" x-data="{ aberto: false }">
                                        <button
                                            @click="aberto = !aberto"
                                            @click.away="aberto = false"
                                            class="px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded hover:bg-gray-200 transition-colors cursor-pointer flex items-center gap-1"
                                            :title="'Clique para corrigir o idioma'"
                                        >
                                            <span x-text="resultado.idioma?.toUpperCase()"></span>
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </button>

                                        <!-- Menu dropdown -->
                                        <div
                                            x-show="aberto"
                                            x-transition:enter="transition ease-out duration-100"
                                            x-transition:enter-start="transform opacity-0 scale-95"
                                            x-transition:enter-end="transform opacity-100 scale-100"
                                            x-transition:leave="transition ease-in duration-75"
                                            x-transition:leave-start="transform opacity-100 scale-100"
                                            x-transition:leave-end="transform opacity-0 scale-95"
                                            class="absolute right-0 mt-2 w-44 bg-white rounded-lg shadow-lg border border-gray-200 z-50 max-h-64 overflow-y-auto"
                                            @click.away="aberto = false"
                                        >
                                            <div class="py-1">
                                                <button @click="atualizar_idioma_resultado(resultado, 'pt'); aberto = false" class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 hover:text-gray-900 flex items-center gap-2">
                                                    <span>üáßüá∑</span> <span>Portugu√™s</span>
                                                </button>
                                                <button @click="atualizar_idioma_resultado(resultado, 'en'); aberto = false" class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 hover:text-gray-900 flex items-center gap-2">
                                                    <span>üá∫üá∏</span> <span>Ingl√™s</span>
                                                </button>
                                                <button @click="atualizar_idioma_resultado(resultado, 'es'); aberto = false" class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 hover:text-gray-900 flex items-center gap-2">
                                                    <span>üá™üá∏</span> <span>Espanhol</span>
                                                </button>
                                                <button @click="atualizar_idioma_resultado(resultado, 'fr'); aberto = false" class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 hover:text-gray-900 flex items-center gap-2">
                                                    <span>üá´üá∑</span> <span>Franc√™s</span>
                                                </button>
                                                <button @click="atualizar_idioma_resultado(resultado, 'de'); aberto = false" class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 hover:text-gray-900 flex items-center gap-2">
                                                    <span>üá©üá™</span> <span>Alem√£o</span>
                                                </button>
                                                <button @click="atualizar_idioma_resultado(resultado, 'it'); aberto = false" class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 hover:text-gray-900 flex items-center gap-2">
                                                    <span>üáÆüáπ</span> <span>Italiano</span>
                                                </button>
                                                <button @click="atualizar_idioma_resultado(resultado, 'ja'); aberto = false" class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 hover:text-gray-900 flex items-center gap-2">
                                                    <span>üáØüáµ</span> <span>Japon√™s</span>
                                                </button>
                                                <button @click="atualizar_idioma_resultado(resultado, 'ar'); aberto = false" class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 hover:text-gray-900 flex items-center gap-2">
                                                    <span>üá∏üá¶</span> <span>√Årabe</span>
                                                </button>
                                                <button @click="atualizar_idioma_resultado(resultado, 'ko'); aberto = false" class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 hover:text-gray-900 flex items-center gap-2">
                                                    <span>üá∞üá∑</span> <span>Coreano</span>
                                                </button>
                                                <button @click="atualizar_idioma_resultado(resultado, 'he'); aberto = false" class="w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 hover:text-gray-900 flex items-center gap-2">
                                                    <span>üáÆüá±</span> <span>Hebraico</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-start justify-between gap-4 mb-3 pr-28">
                                    <div class="flex-1">
                                        <!-- T√≠tulo (sempre exibe traduzido se dispon√≠vel) -->
                                        <div class="relative" x-data="{ menu_traducao_aberto: false, editando: false, titulo_editado: (resultado.titulo_pt && resultado.titulo_pt.trim()) ? resultado.titulo_pt.trim() : resultado.titulo }">
                                            <!-- T√≠tulo - clic√°vel se idioma != pt -->
                                            <div class="flex items-center gap-2">
                                                <div x-show="!editando" class="flex-1">
                                                    <h4
                                                        class="font-semibold text-gray-900"
                                                        :class="resultado.idioma !== 'pt' ? 'cursor-pointer hover:text-blue-600 transition-colors' : ''"
                                                        @click="if (resultado.idioma !== 'pt') menu_traducao_aberto = !menu_traducao_aberto"
                                                        x-text="obter_titulo_portugues(resultado)"
                                                    ></h4>
                                                    <!-- √çcone para indicar que √© clic√°vel -->
                                                    <span x-show="resultado.idioma !== 'pt' && resultado.titulo_pt && resultado.titulo_pt.trim()" class="text-xs text-gray-400 italic">
                                                        (clique para op√ß√µes de tradu√ß√£o)
                                                    </span>
                                                </div>

                                                    <!-- Input de edi√ß√£o -->
                                                    <div x-show="editando" class="flex-1 flex items-center gap-2">
                                                        <input
                                                            type="text"
                                                            x-model="titulo_editado"
                                                            class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                                            @keyup.enter="salvar_edicao_titulo(resultado, titulo_editado); editando = false"
                                                            @keyup.escape="editando = false; titulo_editado = (resultado.titulo_pt && resultado.titulo_pt.trim()) ? resultado.titulo_pt.trim() : resultado.titulo"
                                                        >
                                                        <button
                                                            @click="salvar_edicao_titulo(resultado, titulo_editado); editando = false"
                                                            class="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700">
                                                            Salvar
                                                        </button>
                                                        <button
                                                            @click="editando = false; titulo_editado = (resultado.titulo_pt && resultado.titulo_pt.trim()) ? resultado.titulo_pt.trim() : resultado.titulo"
                                                            class="px-2 py-1 text-xs bg-gray-400 text-white rounded hover:bg-gray-500">
                                                            Cancelar
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Menu dropdown -->
                                                <div
                                                    x-show="menu_traducao_aberto && resultado.idioma !== 'pt'"
                                                    x-transition:enter="transition ease-out duration-100"
                                                    x-transition:enter-start="transform opacity-0 scale-95"
                                                    x-transition:enter-end="transform opacity-100 scale-100"
                                                    x-transition:leave="transition ease-in duration-75"
                                                    x-transition:leave-start="transform opacity-100 scale-100"
                                                    x-transition:leave-end="transform opacity-0 scale-95"
                                                    class="absolute left-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 z-50"
                                                    @click.away="menu_traducao_aberto = false"
                                                >
                                                    <div class="py-1">
                                                        <button
                                                            @click="refazer_traducao_resultado(resultado); menu_traducao_aberto = false"
                                                            class="w-full text-left px-4 py-2 text-sm text-gray-900 hover:bg-gray-50 flex items-center gap-2"
                                                            :disabled="resultado._retraduzindo"
                                                        >
                                                            <span>ü§ñ</span>
                                                            <span x-show="!resultado._retraduzindo">Refazer tradu√ß√£o (IA)</span>
                                                            <span x-show="resultado._retraduzindo" class="text-gray-500">Retraduzindo...</span>
                                                        </button>
                                                        <button
                                                            @click="editando = true; menu_traducao_aberto = false; titulo_editado = (resultado.titulo_pt && resultado.titulo_pt.trim()) ? resultado.titulo_pt.trim() : resultado.titulo"
                                                            class="w-full text-left px-4 py-2 text-sm text-gray-900 hover:bg-gray-50 flex items-center gap-2"
                                                        >
                                                            <span>‚úèÔ∏è</span>
                                                            <span>Editar tradu√ß√£o</span>
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Avisos quando n√£o h√° tradu√ß√£o -->
                                                <div x-show="!resultado.titulo_pt || !resultado.titulo_pt.trim()">
                                                    <div class="flex items-center gap-2 mt-2">
                                                        <button
                                                            x-show="resultado.idioma !== 'pt' && !resultado._traduzindo"
                                                            @click="app.traduzir_resultado(resultado)"
                                                            class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                                            Traduzir agora
                                                        </button>
                                                        <span
                                                            x-show="resultado._traduzindo"
                                                            class="px-2 py-1 text-xs bg-gray-300 text-gray-600 rounded">
                                                            Traduzindo...
                                                        </span>
                                                    </div>
                                                    <p class="text-xs text-amber-600 italic mt-1" x-show="resultado.idioma !== 'pt' && !resultado._traduzindo">
                                                        ‚ö†Ô∏è Tradu√ß√£o do t√≠tulo em portugu√™s n√£o dispon√≠vel
                                                    </p>
                                                </div>

                                                <!-- Mostrar original em it√°lico se houver tradu√ß√£o e idioma != pt -->
                                                <p class="text-xs text-gray-500 italic mt-1"
                                                   x-show="resultado.titulo_pt && resultado.titulo_pt.trim() && resultado.idioma !== 'pt'"
                                                   x-text="`Original (${resultado.idioma?.toUpperCase()}): ${resultado.titulo}`"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 text-sm text-gray-600 leading-snug"
                                         x-text="obter_primeira_linha_pt(resultado)">
                                    </div>
                                </div>

                                <!-- Descri√ß√£o (sempre exibe traduzida se dispon√≠vel) -->
                                <p class="text-sm text-gray-600 mb-2" x-text="(resultado.descricao_pt && resultado.descricao_pt.trim()) ? resultado.descricao_pt : resultado.descricao"></p>

                                <!-- Aviso quando n√£o h√° tradu√ß√£o da descri√ß√£o -->
                                <p class="text-xs text-amber-600 italic mb-2" x-show="resultado.idioma !== 'pt' && (!resultado.descricao_pt || !resultado.descricao_pt.trim())">
                                    ‚ö†Ô∏è Tradu√ß√£o da descri√ß√£o em portugu√™s n√£o dispon√≠vel
                                </p>

                                <!-- Informa√ß√µes de Ferramenta e Termo de Busca -->
                                <div class="flex items-start gap-3 mb-3 p-2 bg-gray-50 rounded border border-gray-200">
                                    <!-- Ferramenta de Pesquisa -->
                                    <div x-show="resultado.ferramenta_origem" class="flex items-center gap-1.5">
                                        <span class="font-medium text-gray-700 text-xs">üîç Ferramenta:</span>
                                        <span class="text-xs text-gray-900 font-medium capitalize" x-text="resultado.ferramenta_origem"></span>
                                    </div>

                                    <!-- Termo de Busca -->
                                    <div x-show="resultado.query" class="flex items-start gap-1.5 flex-1" x-data="{ expandido: false }">
                                        <span class="font-medium text-gray-700 text-xs whitespace-nowrap">üè∑Ô∏è Busca:</span>
                                        <div class="flex-1">
                                            <span
                                                x-show="!expandido && resultado.query && resultado.query.length > 80"
                                                @click="expandido = true"
                                                class="text-xs text-gray-900 cursor-pointer hover:text-blue-600 transition-colors"
                                                x-text="resultado.query.substring(0, 80) + '...'">
                                            </span>
                                            <span
                                                x-show="expandido || !resultado.query || resultado.query.length <= 80"
                                                @click="if (resultado.query && resultado.query.length > 80) expandido = false"
                                                :class="resultado.query && resultado.query.length > 80 ? 'text-xs text-gray-900 cursor-pointer hover:text-blue-600 transition-colors' : 'text-xs text-gray-900'"
                                                x-text="resultado.query">
                                            </span>
                                            <span x-show="resultado.query && resultado.query.length > 80" class="text-xs text-gray-400 ml-1">
                                                (clique para <span x-text="expandido ? 'recolher' : 'expandir'"></span>)
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <div class="flex items-center gap-3 flex-1">
                                        <span x-show="resultado.pais_origem">
                                            üåç <span x-text="resultado.pais_origem"></span>
                                        </span>
                                        <span x-show="resultado.fonte_tipo">
                                            üìë <span x-text="resultado.fonte_tipo"></span>
                                        </span>
                                    </div>
                                    <a :href="resultado.fonte_url" target="_blank" rel="noopener noreferrer"
                                       class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1 flex-shrink-0 ml-2">
                                        Ver fonte
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                        </svg>
                                    </a>
                                    <!-- √çcone de link externo -->
                                    <a
                                        :href="resultado.url"
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="p-1.5 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded transition-colors flex-shrink-0"
                                        title="Abrir link original em nova janela"
                                    >
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Mensagem quando n√£o h√° resultados -->
                    <div x-show="!carregando_resultados_pesquisa && paginacao_local.total_filtrados === 0 && paginacao_resultados_pesquisa.total > 0" class="text-center py-12">
                        <div class="text-6xl mb-4">üîç</div>
                        <p class="text-gray-500 text-lg">Nenhum resultado encontrado com os filtros aplicados</p>
                        <button @click="limpar_filtros_resultados()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Limpar filtros
                        </button>
                    </div>

                    <div x-show="!carregando_resultados_pesquisa && paginacao_resultados_pesquisa.total === 0" class="text-center py-12">
                        <div class="text-6xl mb-4">üîç</div>
                        <p class="text-gray-500 text-lg">Nenhum resultado encontrado para esta falha</p>
                    </div>
                </div>

                <!-- Pagina√ß√£o -->
                <div x-show="!carregando_resultados_pesquisa && paginacao_local.total_pages > 1" class="p-6 border-t bg-gray-50 rounded-b-lg">
                    <div class="flex items-center justify-between">
                        <button @click="mudar_pagina_local(paginacao_local.page - 1)"
                                :disabled="!paginacao_local.has_prev"
                                :class="paginacao_local.has_prev ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
                                class="px-4 py-2 rounded-lg font-medium transition-colors">
                            ‚Üê Anterior
                        </button>

                        <span class="text-sm text-gray-600">
                            P√°gina <span class="font-semibold" x-text="paginacao_local.page"></span> de
                            <span class="font-semibold" x-text="paginacao_local.total_pages"></span>
                        </span>

                        <button @click="mudar_pagina_local(paginacao_local.page + 1)"
                                :disabled="!paginacao_local.has_next"
                                :class="paginacao_local.has_next ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'"
                                class="px-4 py-2 rounded-lg font-medium transition-colors">
                            Pr√≥xima ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header Principal -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 pt-6 pb-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center mb-8">
                    <div class="flex items-center gap-6">
                        <img src="/static/img/sebrae-logo.png" alt="Sebrae Nacional" style="height: 48px; width: auto;">
                        <div class="border-l border-gray-300 pl-6">
                            <p class="text-sm font-bold" style="color: #374151; max-width: 450px;">Levantamento, proposta e plano de dissemina√ß√£o de pol√≠ticas p√∫blicas de inova√ß√£o que impactem positivamente desenvolvimento dos pequenos neg√≥cios no Brasil.</p>
                        </div>
                        <div class="border-l border-gray-300 pl-6">
                            <p class="text-xs text-gray-500 mb-2">Realiza√ß√£o:</p>
                            <div class="flex items-center gap-4">
                                <img src="/static/img/abgi logo.png" alt="ABGI" class="h-8" style="height: 32px; width: auto;">
                                <img src="/static/img/10k digital-logo.png" alt="10K Digital" class="h-8" style="height: 32px; width: auto;">
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <!-- Bot√£o de Biblioteca de Relat√≥rios -->
                        <button @click="mudar_fase(7)"
                                :class="fase_atual === 7 ? 'bg-amber-700 text-white' : 'bg-amber-100 text-amber-800 hover:bg-amber-200'"
                                class="px-3 py-2 rounded-lg text-sm font-medium transition-colors border-2 whitespace-nowrap"
                                :class="fase_atual === 7 ? 'border-amber-800' : 'border-amber-300'">
                            üìö Biblioteca de Relat√≥rios
                        </button>
                    </div>
                </div>

                <!-- Navega√ß√£o de Fases -->
                <div class="bg-gray-50 -mx-4 px-4 py-3 rounded-lg sm:-mx-6 sm:px-6 lg:-mx-8 lg:px-8 flex gap-2 flex-wrap">
                    <template x-for="(fase, idx) in fases.slice(0, 7)" :key="idx">
                        <button @click="mudar_fase(idx)"
                                :class="idx === fase_atual ? 'phase-nav-active' : 'phase-nav-inactive'"
                                class="phase-badge-nav text-sm">
                            <span x-text="idx === 0 ? fase.nome : `${idx}. ${fase.nome}`"></span>
                            <template x-if="idx < fase_atual">
                                <span class="ml-2">‚úì</span>
                            </template>
                        </button>
                    </template>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
            <!-- Fase 0: Home -->
            <section x-show="fase_atual === 0" class="space-y-8">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-8 border border-blue-200">
                    <h2 class="text-3xl font-bold mb-4">Bem-vindo ao Sistema de Pesquisa</h2>
                    <p class="text-lg text-gray-700 mb-6">
                        Este sistema ajuda a identificar, pesquisar e priorizar falhas de mercado no ecossistema de inova√ß√£o brasileiro.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <template x-for="(fase, idx) in fases.slice(0, 7)" :key="idx">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <div class="text-2xl font-bold text-blue-600 mb-2" x-text="`${idx + 1}`"></div>
                                <h3 class="font-bold mb-2" x-text="fase.nome"></h3>
                                <p class="text-sm text-gray-600" x-text="fase.descricao"></p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Estat√≠sticas Gerais -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Total de Falhas</p>
                        <p class="text-3xl font-bold text-blue-700 mt-2" x-text="stats.total_falhas">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Priorizadas</p>
                        <p class="text-3xl font-bold text-green-700 mt-2" x-text="stats.total_priorizadas">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Pesquisas Realizadas</p>
                        <p class="text-3xl font-bold text-purple-700 mt-2" x-text="stats.total_resultados">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Status</p>
                        <p class="text-lg font-bold mt-2" :class="ativo ? 'text-green-700' : 'text-gray-600'" x-text="ativo ? '‚úì Ativo' : '‚óã Inativo'"></p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-8">
                    <h3 class="text-xl font-bold mb-4">Comece Agora</h3>
                    <p class="text-gray-700 mb-6">Escolha uma fase para come√ßar:</p>
                    <div class="space-y-2">
                        <button @click="mudar_fase(1)" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ‚ñ∂ Fase 1: Pesquisa de Pol√≠ticas P√∫blicas
                        </button>
                        <button @click="mudar_fase(2)" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ‚ñ∂ Fase 2: Base de Conhecimento
                        </button>
                        <button @click="mudar_fase(3)" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ‚ñ∂ Fase 3: Prioriza√ß√£o de Falhas
                        </button>
                        <button @click="mudar_fase(4)" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ‚ñ∂ Fase 4: Boas Pr√°ticas & Sugest√µes
                        </button>
                        <button @click="mudar_fase(5)" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ‚ñ∂ Fase 5: Propostas de Pol√≠ticas P√∫blicas
                        </button>
                        <button @click="mudar_fase(6)" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ‚ñ∂ Fase 6: Plano de Implanta√ß√£o
                        </button>
                        <button @click="mudar_fase(7)" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-4 rounded-lg transition border-2 border-amber-800">
                            üìö Biblioteca de Relat√≥rios
                        </button>
                    </div>
                </div>
            </section>

            <!-- Fase 1: Pesquisa -->
            <section x-show="fase_atual === 1" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">1. Pesquisa de Pol√≠ticas P√∫blicas</h2>
                        <p class="text-gray-600 mt-1">Identifique e pesquise pol√≠ticas p√∫blicas relevantes para cada falha de mercado</p>
                    </div>
                </div>

                <!-- Painel de Configura√ß√µes de Avalia√ß√£o -->
                <div class="bg-white rounded-lg shadow">
                    <button @click="config_avaliacao_profunda_aberta = !config_avaliacao_profunda_aberta"
                            class="w-full flex justify-between items-center p-4 hover:bg-gray-50 transition">
                        <div class="flex items-center space-x-3">
                            <span class="text-xl">‚öôÔ∏è</span>
                            <div class="text-left">
                                <h3 class="font-bold text-gray-900">Configura√ß√µes de An√°lise</h3>
                                <p class="text-sm text-gray-600">Ajuste crit√©rios de avalia√ß√£o e qualidade das fontes</p>
                            </div>
                        </div>
                        <span class="text-gray-400 text-xl" x-text="config_avaliacao_profunda_aberta ? '‚ñ≤' : '‚ñº'"></span>
                    </button>

                    <div x-show="config_avaliacao_profunda_aberta" x-collapse class="p-6 border-t">
                        <div class="space-y-6">
                            <!-- Modo de Avalia√ß√£o Profunda -->
                            <div>
                                <div class="flex items-center justify-between mb-3">
                                    <label class="font-semibold text-gray-900">Avalia√ß√£o Profunda com LLM</label>
                                    <button @click="avaliacao_profunda_ativa = !avaliacao_profunda_ativa; criterios_mudaram = true"
                                            class="relative inline-flex items-center h-6 rounded-full w-11 transition"
                                            :class="avaliacao_profunda_ativa ? 'bg-blue-600' : 'bg-gray-300'">
                                        <span class="inline-block w-4 h-4 transform bg-white rounded-full transition"
                                              :class="avaliacao_profunda_ativa ? 'translate-x-6' : 'translate-x-1'"></span>
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 mb-4">Usa modelos de IA avan√ßados para an√°lise mais precisa das fontes</p>

                                <div x-show="avaliacao_profunda_ativa" class="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Modo de Avalia√ß√£o:</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center p-3 bg-white border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition"
                                               :class="modo_avaliacao_profunda === 'gratuito' ? 'border-blue-500' : 'border-gray-200'">
                                            <input type="radio" name="modo_avaliacao" value="gratuito"
                                                   x-model="modo_avaliacao_profunda" @change="criterios_mudaram = true"
                                                   class="h-4 w-4 text-blue-600">
                                            <div class="ml-3 flex-1">
                                                <span class="font-medium text-gray-900">Gratuito</span>
                                                <p class="text-sm text-gray-600">Modelos gratuitos de alta qualidade (Mixtral, Gemma, Llama 3.1, Qwen)</p>
                                                <p class="text-xs text-green-600 font-medium">Custo: R$ 0,00</p>
                                            </div>
                                        </label>

                                        <label class="flex items-center p-3 bg-white border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition"
                                               :class="modo_avaliacao_profunda === 'balanceado' ? 'border-blue-500' : 'border-gray-200'">
                                            <input type="radio" name="modo_avaliacao" value="balanceado"
                                                   x-model="modo_avaliacao_profunda" @change="criterios_mudaram = true"
                                                   class="h-4 w-4 text-blue-600">
                                            <div class="ml-3 flex-1">
                                                <span class="font-medium text-gray-900">Balanceado</span>
                                                <p class="text-sm text-gray-600">Modelos de boa qualidade com custo-benef√≠cio (Grok 4 Fast, Claude 3 Sonnet)</p>
                                                <p class="text-xs text-yellow-600 font-medium">Custo: ~R$ 0,01 - R$ 0,05 por fonte</p>
                                            </div>
                                        </label>

                                        <label class="flex items-center p-3 bg-white border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition"
                                               :class="modo_avaliacao_profunda === 'premium' ? 'border-blue-500' : 'border-gray-200'">
                                            <input type="radio" name="modo_avaliacao" value="premium"
                                                   x-model="modo_avaliacao_profunda" @change="criterios_mudaram = true"
                                                   class="h-4 w-4 text-blue-600">
                                            <div class="ml-3 flex-1">
                                                <span class="font-medium text-gray-900">Premium</span>
                                                <p class="text-sm text-gray-600">Modelos de alt√≠ssima qualidade (Grok 4, GPT-4)</p>
                                                <p class="text-xs text-red-600 font-medium">Custo: ~R$ 0,10 - R$ 0,30 por fonte</p>
                                            </div>
                                        </label>
                                    </div>

                                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                        <p class="text-sm text-yellow-800">
                                            <strong>‚ÑπÔ∏è Nota:</strong> A avalia√ß√£o profunda √© aplicada apenas a <strong>novas an√°lises</strong>.
                                            Use o bot√£o "Reanalisar Resultados" para reavaliar fontes existentes com os novos crit√©rios.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Modelo de Tradu√ß√£o -->
                            <div class="border-t pt-6">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="font-semibold text-gray-900">Modelo de Tradu√ß√£o</label>
                                </div>
                                <p class="text-sm text-gray-600 mb-4">Selecione o modelo usado para traduzir resultados internacionais</p>

                                <div class="space-y-2">
                                    <label class="flex items-center p-3 bg-white border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition"
                                           :class="modo_traducao === 'gratuito' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'">
                                        <input type="radio" name="modo_traducao" value="gratuito"
                                               x-model="modo_traducao"
                                               class="h-4 w-4 text-purple-600">
                                        <div class="ml-3 flex-1">
                                            <span class="font-medium text-gray-900">Gratuito (Recomendado)</span>
                                            <p class="text-sm text-gray-600">Rotaciona entre modelos gratuitos: Llama 3.1 70B, Gemma 2 27B, Mixtral 8x7B, Qwen 2 72B</p>
                                            <p class="text-xs text-green-600 font-medium">Custo: R$ 0,00 | Velocidade: ~3-5s por tradu√ß√£o</p>
                                        </div>
                                    </label>

                                    <label class="flex items-center p-3 bg-white border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition"
                                           :class="modo_traducao === 'economico' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'">
                                        <input type="radio" name="modo_traducao" value="economico"
                                               x-model="modo_traducao"
                                               class="h-4 w-4 text-purple-600">
                                        <div class="ml-3 flex-1">
                                            <span class="font-medium text-gray-900">Econ√¥mico</span>
                                            <p class="text-sm text-gray-600">Modelos baratos e r√°pidos: Google Gemini Flash, Claude Haiku</p>
                                            <p class="text-xs text-blue-600 font-medium">Custo: ~R$ 0,002 por tradu√ß√£o | Velocidade: ~1-2s</p>
                                        </div>
                                    </label>

                                    <label class="flex items-center p-3 bg-white border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition"
                                           :class="modo_traducao === 'qualidade' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'">
                                        <input type="radio" name="modo_traducao" value="qualidade"
                                               x-model="modo_traducao"
                                               class="h-4 w-4 text-purple-600">
                                        <div class="ml-3 flex-1">
                                            <span class="font-medium text-gray-900">Alta Qualidade</span>
                                            <p class="text-sm text-gray-600">Modelos de melhor qualidade: GPT-4o Mini, Claude Sonnet</p>
                                            <p class="text-xs text-yellow-600 font-medium">Custo: ~R$ 0,01 por tradu√ß√£o | Velocidade: ~2-4s</p>
                                        </div>
                                    </label>
                                </div>

                                <div class="mt-4 p-3 bg-purple-50 border border-purple-200 rounded-lg">
                                    <p class="text-sm text-purple-800">
                                        <strong>‚ÑπÔ∏è Nota:</strong> A configura√ß√£o √© aplicada ao usar "Completar Tradu√ß√µes" ou "Refazer Todas as Tradu√ß√µes".
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status de Pesquisa -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Status de Processamento</h3>
                        <span class="text-sm font-medium" :class="ativo ? 'text-green-700' : 'text-red-700'" x-text="ativo ? '‚óè Ativo' : '‚óã Parado'"></span>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-sm font-medium">Progresso Geral</span>
                                <span class="text-sm font-medium" x-text="`${percentual_processamento.toFixed(1)}%`"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-blue-600 h-3 rounded-full transition-all" :style="`width: ${percentual_processamento}%`"></div>
                            </div>
                        </div>
                        <!-- Estat√≠sticas de Buscas -->
                        <div class="grid grid-cols-4 gap-4 mb-4">
                            <div>
                                <p class="text-xs text-gray-600">Pendentes</p>
                                <p class="text-2xl font-bold text-yellow-700" x-text="stats.total_pendentes">0</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Processando</p>
                                <p class="text-2xl font-bold text-blue-700" x-text="stats.total_processando">0</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Conclu√≠das</p>
                                <p class="text-2xl font-bold text-green-700" x-text="stats.total_concluidas">0</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Total</p>
                                <p class="text-2xl font-bold text-purple-700" x-text="stats.total_resultados">0</p>
                            </div>
                        </div>

                        <!-- Estat√≠sticas de Tradu√ß√µes -->
                        <div class="border-t pt-4">
                            <p class="text-sm font-medium text-gray-700 mb-3">üìù Tradu√ß√µes</p>
                            <div class="flex items-start justify-between gap-4">
                                <!-- Totais -->
                                <div class="grid grid-cols-3 gap-3 flex-1">
                                    <div>
                                        <p class="text-xs text-gray-600">Resultados em Portugu√™s</p>
                                        <p class="text-2xl font-bold text-green-700" x-text="stats.resultados_pt || 0">0</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600">Resultados Internacionais</p>
                                        <p class="text-2xl font-bold text-blue-700">
                                            <span x-text="stats.resultados_internacionais || 0">0</span>
                                            <span class="text-sm" :class="(stats.percentual_traduzidos || 0) < 100 ? 'text-orange-600' : 'text-green-600'" x-text="`(${(stats.percentual_traduzidos || 0).toFixed(1)}% traduzidos)`"></span>
                                        </p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600">Total Geral</p>
                                        <p class="text-2xl font-bold text-purple-700" x-text="stats.total_resultados || 0">0</p>
                                    </div>
                                </div>
                                <!-- Bot√£o Refazer Tradu√ß√µes -->
                                <div x-show="(stats.resultados_internacionais || 0) > 0" class="flex-shrink-0">
                                    <button @click="solicitar_refazer_traducoes()" :disabled="refazendo_traducoes"
                                            class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-3 py-2 rounded-lg text-sm font-medium disabled:opacity-50 transition-all whitespace-nowrap">
                                        <span x-show="!refazendo_traducoes">üîÑ Refazer Tradu√ß√µes</span>
                                        <span x-show="refazendo_traducoes">‚ü≥ Refazendo...</span>
                                    </button>
                                    <p class="text-xs text-gray-500 mt-1 text-center max-w-[180px]">
                                        Refaz tradu√ß√µes e corrige idiomas
                                    </p>
                                </div>
                            </div>
                            <!-- Bot√µes de Tradu√ß√£o -->
                            <div x-show="(stats.resultados_internacionais || 0) > 0" class="mt-3 space-y-2">
                                <!-- Bot√£o Completar Tradu√ß√µes (apenas se < 100%) -->
                                <div x-show="(stats.percentual_traduzidos || 0) < 100">
                                    <button @click="completar_traducoes()" :disabled="completando_traducoes"
                                            class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50 transition-all">
                                        <span x-show="!completando_traducoes">üåê Completar Tradu√ß√µes</span>
                                        <span x-show="completando_traducoes">‚ü≥ Traduzindo...</span>
                                    </button>
                                </div>

                                <!-- Progresso (compartilhado entre os dois bot√µes) -->
                                <p x-show="completando_traducoes || refazendo_traducoes" class="text-xs text-blue-600 mt-2 text-center">
                                    <span x-text="refazendo_traducoes ? 'Refazendo' : 'Traduzindo'"></span>
                                    <span x-text="progresso_traducao.processados || 0">0</span>/<span x-text="progresso_traducao.total || 0">0</span> resultados...
                                    <span x-show="refazendo_traducoes && (progresso_traducao.idiomas_corrigidos || 0) > 0" class="text-purple-600">
                                        (<span x-text="progresso_traducao.idiomas_corrigidos || 0">0</span> idiomas corrigidos)
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controles -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex gap-3 flex-wrap">
                        <button @click="solicitar_inicio_pesquisa()" :disabled="pesquisa_iniciando" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50">
                            <span x-show="!pesquisa_iniciando">‚ñ∂ Iniciar Pesquisa</span>
                            <span x-show="pesquisa_iniciando">‚ü≥ Iniciando...</span>
                        </button>
                        <button @click="pausar_pesquisas()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium">
                            ‚è∏ Pausar
                        </button>
                        <button @click="solicitar_reinicio_pesquisa()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium">
                            ‚ü≤ Reiniciar Tudo
                        </button>
                        <button @click="abrir_modal_reanalisar()"
                                :disabled="reanalisando || !stats.total_resultados"
                                class="px-4 py-2 rounded-lg font-medium transition relative"
                                :class="criterios_mudaram && stats.total_resultados ? 'bg-blue-600 hover:bg-blue-700 text-white animate-pulse' : 'bg-gray-300 hover:bg-gray-400 text-gray-700 disabled:opacity-50'">
                            <span x-show="!reanalisando">üîÑ Reanalisar Resultados</span>
                            <span x-show="reanalisando">‚ü≥ Reanalisando...</span>
                            <span x-show="criterios_mudaram && stats.total_resultados && !reanalisando"
                                  class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-2 h-2"></span>
                        </button>
                    </div>
                    <p x-show="criterios_mudaram && stats.total_resultados" class="text-sm text-blue-600 mt-3">
                        ‚ÑπÔ∏è Os crit√©rios de avalia√ß√£o foram alterados. Clique em "Reanalisar Resultados" para aplicar as novas configura√ß√µes √†s fontes existentes.
                    </p>

                    <!-- Indicador de Progresso da Rean√°lise -->
                    <div x-show="reanalisando" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
                        <div class="flex items-center gap-3 mb-3">
                            <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-blue-800" x-text="progresso_reanalisar.mensagem || 'Iniciando rean√°lise...'"></p>
                                <p class="text-xs text-blue-600 mt-1">
                                    <span x-show="progresso_reanalisar.total > 0">
                                        Progresso: <strong x-text="progresso_reanalisar.processados"></strong>/<strong x-text="progresso_reanalisar.total"></strong> resultados
                                        ¬∑ <span x-text="progresso_reanalisar.scores_atualizados"></span> atualizados
                                        <span x-show="progresso_reanalisar.erros > 0" class="text-red-600">
                                            ¬∑ <span x-text="progresso_reanalisar.erros"></span> erros
                                        </span>
                                    </span>
                                </p>
                            </div>
                            <span class="text-lg font-bold text-blue-600" x-text="`${progresso_reanalisar.progresso || 0}%`"></span>
                        </div>
                        <!-- Barra de progresso -->
                        <div class="w-full bg-blue-100 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" :style="`width: ${progresso_reanalisar.progresso || 0}%`"></div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Falhas -->
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-medium">ID</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Falha</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Pilar</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Progresso</th>
                                <th class="px-6 py-3 text-right text-sm font-medium">
                                    <div class="flex items-center gap-2 justify-end">
                                        <span>Resultados</span>
                                        <span class="cursor-help" title="Score de confian√ßa (mediana)&#10;üü¢ Verde: >50 (alta)&#10;üü° Amarelo: 25-50 (m√©dia)&#10;üî¥ Vermelho: <25 (baixa)">‚ìò</span>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tabela-falhas">
                            <tr class="border-b hover:bg-gray-50">
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">Carregando falhas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Fase 2: Base de Conhecimento -->
            <section x-show="fase_atual === 2" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">2. Base de Conhecimento</h2>
                        <p class="text-gray-600 mt-1">Fa√ßa upload de documentos (DOCX, PDF) para criar uma base de conhecimento vetorial</p>
                    </div>
                </div>

                <!-- Upload Area -->
                <div class="bg-white rounded-lg shadow p-8">
                    <div class="border-2 border-dashed border-blue-300 rounded-lg p-8 text-center transition"
                         @dragover.prevent="dragover_kb = true"
                         @dragenter.prevent="dragover_kb = true"
                         @dragleave="dragover_kb = false"
                         @drop.prevent="handleFileDrops($event); dragover_kb = false"
                         :class="dragover_kb ? 'border-blue-600 bg-blue-50' : 'hover:border-blue-500'">
                        <div class="text-4xl mb-2">üìÅ</div>
                        <h3 class="text-lg font-bold mb-2">Arraste arquivos ou clique para selecionar</h3>
                        <p class="text-gray-600 mb-4">Suporta DOCX, PDF, CSV e Markdown (m√°ximo 25MB por arquivo)</p>
                        <input type="file" multiple accept=".docx,.pdf,.csv,.md" @change="handleFileUpload" class="hidden" x-ref="fileInput">
                        <button @click.stop="$refs.fileInput.click()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            Selecionar Arquivos
                        </button>
                    </div>
                </div>

                <!-- Upload Status - Melhorado com detalhes por arquivo -->
                <template x-if="uploading">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <div class="animate-spin mr-3 text-xl">‚ü≥</div>
                                    <div>
                                        <p class="font-bold text-blue-900" x-text="upload_status || 'Fazendo upload...'"></p>
                                        <p class="text-sm text-blue-700">Progresso geral: <span x-text="`${upload_progress}%`"></span></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Barra de progresso geral -->
                            <div class="w-full bg-blue-200 rounded-full h-2.5 overflow-hidden">
                                <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" :style="`width: ${upload_progress}%`"></div>
                            </div>
                        </div>

                        <!-- Lista de arquivos com status individual -->
                        <template x-if="upload_files_status.length > 0">
                            <div class="space-y-2 mt-4">
                                <p class="text-sm font-semibold text-blue-900 mb-2">Arquivos:</p>
                                <template x-for="file in upload_files_status" :key="file.name">
                                    <div class="flex items-center justify-between bg-white rounded px-3 py-2 text-sm">
                                        <div class="flex items-center space-x-2 flex-1 min-w-0">
                                            <span x-text="file.status === 'success' ? '‚úì' : file.status === 'error' || file.status === 'invalid' ? '‚úó' : file.status === 'uploading' || file.status === 'processing' ? '‚ü≥' : '‚è≥'"
                                                  :class="file.status === 'success' ? 'text-green-600' : file.status === 'error' || file.status === 'invalid' ? 'text-red-600' : file.status === 'uploading' || file.status === 'processing' ? 'text-blue-600 animate-spin' : 'text-gray-400'"></span>
                                            <span class="font-medium truncate" x-text="file.name"></span>
                                        </div>
                                        <span class="text-xs ml-2 whitespace-nowrap"
                                              :class="file.status === 'success' ? 'text-green-600' : file.status === 'error' || file.status === 'invalid' ? 'text-red-600' : 'text-blue-600'"
                                              x-text="file.message"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- Documents List -->
                <div class="bg-white rounded-lg shadow">
                    <!-- Search Bar -->
                    <div class="p-4 border-b">
                        <input type="text"
                               x-model="busca_documentos"
                               @input="filtrar_documentos()"
                               placeholder="üîç Buscar documentos por nome, tipo ou status..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Bulk actions bar -->
                    <div x-show="documentos_selecionados.length > 0" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">
                            <span x-text="documentos_selecionados.length"></span> documento(s) selecionado(s)
                        </span>
                        <div class="space-x-2">
                            <button @click="remover_selecionados()" class="px-4 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                                üóëÔ∏è Remover Selecionados
                            </button>
                            <button @click="documentos_selecionados = []" class="px-4 py-2 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400">
                                Cancelar
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100 border-b">
                                <tr>
                                    <th class="px-3 py-3 text-center text-sm font-medium">
                                        <input type="checkbox"
                                               @change="alternar_todos_documentos($event.target.checked)"
                                               :checked="documentos_filtrados.length > 0 && documentos_selecionados.length === documentos_filtrados.length"
                                               class="w-4 h-4 cursor-pointer">
                                    </th>
                                    <th @click="ordenar_documentos('nome')" class="px-6 py-3 text-left text-sm font-medium cursor-pointer hover:bg-gray-200 select-none">
                                        Nome <span x-show="ordem_campo === 'nome'" x-text="ordem_direcao === 'asc' ? '‚Üë' : '‚Üì'"></span>
                                    </th>
                                    <th @click="ordenar_documentos('tamanho')" class="px-6 py-3 text-left text-sm font-medium cursor-pointer hover:bg-gray-200 select-none">
                                        Tamanho <span x-show="ordem_campo === 'tamanho'" x-text="ordem_direcao === 'asc' ? '‚Üë' : '‚Üì'"></span>
                                    </th>
                                    <th @click="ordenar_documentos('tipo')" class="px-6 py-3 text-left text-sm font-medium cursor-pointer hover:bg-gray-200 select-none">
                                        Tipo <span x-show="ordem_campo === 'tipo'" x-text="ordem_direcao === 'asc' ? '‚Üë' : '‚Üì'"></span>
                                    </th>
                                    <th @click="ordenar_documentos('status')" class="px-6 py-3 text-left text-sm font-medium cursor-pointer hover:bg-gray-200 select-none">
                                        Status <span x-show="ordem_campo === 'status'" x-text="ordem_direcao === 'asc' ? '‚Üë' : '‚Üì'"></span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-sm font-medium">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-documentos">
                                <tr class="border-b hover:bg-gray-50">
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">Carregando documentos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Chat RAG Panel -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-purple-50">
                        <h3 class="text-lg font-bold text-gray-800">üí¨ Converse com a Base de Conhecimento</h3>
                        <p class="text-sm text-gray-600 mt-1">Fa√ßa perguntas sobre os documentos indexados</p>
                    </div>

                    <!-- Chat Messages -->
                    <div class="p-4 h-96 overflow-y-auto bg-gray-50" id="chat-kb-container">
                        <template x-if="chat_kb_mensagens.length === 0">
                            <div class="text-center text-gray-400 py-16">
                                <p class="text-lg">üëã Ol√°! Pergunte algo sobre os documentos da base</p>
                                <p class="text-sm mt-2">Exemplo: "Quais s√£o os principais desafios mencionados nos documentos?"</p>
                            </div>
                        </template>

                        <div class="space-y-4">
                            <template x-for="(msg, idx) in chat_kb_mensagens" :key="idx">
                                <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                                    <div :class="msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-white text-gray-900 border border-gray-200'"
                                         class="max-w-3xl rounded-lg p-4 shadow-sm">
                                        <div class="flex items-start space-x-2">
                                            <span x-text="msg.role === 'user' ? 'üë§' : 'ü§ñ'" class="text-lg"></span>
                                            <div class="flex-1">
                                                <div class="text-sm" x-html="markdown_to_html(msg.content)"></div>
                                                <template x-if="msg.fontes && msg.fontes.length > 0">
                                                    <div class="mt-3 pt-3 border-t" :class="msg.role === 'user' ? 'border-blue-400' : 'border-gray-200'">
                                                        <p class="text-xs font-semibold mb-2" :class="msg.role === 'user' ? 'text-blue-100' : 'text-gray-600'">üìö Fontes:</p>
                                                        <div class="space-y-1">
                                                            <template x-for="fonte in msg.fontes" :key="fonte">
                                                                <p class="text-xs" :class="msg.role === 'user' ? 'text-blue-100' : 'text-gray-600'">
                                                                    ‚Ä¢ <span x-text="fonte"></span>
                                                                </p>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </template>
                                                <!-- Debug Info (only for assistant messages) -->
                                                <template x-if="msg.role === 'assistant' && msg.debug">
                                                    <div class="mt-3 pt-3 border-t border-gray-200" x-data="{ debugExpanded: false }">
                                                        <button @click="debugExpanded = !debugExpanded"
                                                                class="flex items-center space-x-2 text-xs text-gray-500 hover:text-gray-700 focus:outline-none">
                                                            <span x-text="debugExpanded ? '‚ñº' : '‚ñ∂'"></span>
                                                            <span>üîç Informa√ß√µes de Debug</span>
                                                        </button>
                                                        <div x-show="debugExpanded" class="mt-2 space-y-2 text-xs text-gray-600 bg-gray-50 p-3 rounded">
                                                            <div class="grid grid-cols-2 gap-2">
                                                                <div>
                                                                    <strong>Total no Vector Store:</strong> <span x-text="msg.debug.total_documentos_vector_store"></span>
                                                                </div>
                                                                <div>
                                                                    <strong>Documentos Encontrados:</strong> <span x-text="msg.debug.documentos_encontrados"></span>
                                                                </div>
                                                                <div>
                                                                    <strong>Modelo LLM:</strong> <span x-text="msg.debug.modelo_llm"></span>
                                                                </div>
                                                                <div>
                                                                    <strong>Temperatura:</strong> <span x-text="msg.debug.temperatura"></span>
                                                                </div>
                                                            </div>
                                                            <template x-if="msg.debug.chunks_utilizados && msg.debug.chunks_utilizados.length > 0">
                                                                <div class="mt-3">
                                                                    <strong class="block mb-2">Chunks Utilizados:</strong>
                                                                    <div class="space-y-2">
                                                                        <template x-for="chunk in msg.debug.chunks_utilizados" :key="chunk.chunk_index">
                                                                            <div class="bg-white p-2 rounded border border-gray-200">
                                                                                <div class="flex justify-between mb-1">
                                                                                    <span class="font-semibold">Chunk <span x-text="chunk.chunk_index"></span></span>
                                                                                    <span class="text-gray-500">Dist√¢ncia: <span x-text="chunk.distancia.toFixed(4)"></span></span>
                                                                                </div>
                                                                                <div class="text-gray-600 mb-1">
                                                                                    <strong>Fonte:</strong> <span x-text="chunk.fonte"></span>
                                                                                </div>
                                                                                <div class="text-gray-600 mb-1">
                                                                                    <strong>Tamanho:</strong> <span x-text="chunk.tamanho_texto"></span> caracteres
                                                                                </div>
                                                                                <div class="text-gray-500 text-xs bg-gray-100 p-1 rounded mt-1">
                                                                                    <strong>Preview:</strong> <span x-text="chunk.preview"></span>
                                                                                </div>
                                                                            </div>
                                                                        </template>
                                                                    </div>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <template x-if="chat_kb_carregando">
                                <div class="flex justify-start">
                                    <div class="bg-white text-gray-900 border border-gray-200 rounded-lg p-4 shadow-sm">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-lg">ü§ñ</span>
                                            <span class="text-sm text-gray-600">Pesquisando na base...</span>
                                            <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="p-4 border-t bg-white relative">
                        <!-- Tags de documentos mencionados -->
                        <div x-show="chat_kb_documentos_mencionados.length > 0" class="mb-2 flex flex-wrap gap-2">
                            <template x-for="(doc, idx) in chat_kb_documentos_mencionados" :key="idx">
                                <div class="inline-flex items-center bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full">
                                    <span class="mr-1">üìÑ</span>
                                    <span x-text="doc" class="font-medium"></span>
                                    <button @click="remover_documento_mencionado(idx)" class="ml-2 hover:text-blue-900 font-bold">√ó</button>
                                </div>
                            </template>
                        </div>

                        <form @submit.prevent="enviar_pergunta_kb()" class="relative">
                            <div class="flex space-x-2">
                                <div class="flex-1 relative">
                                    <textarea
                                        x-ref="chatInput"
                                        x-model="chat_kb_input"
                                        @input="handle_at_mention($event)"
                                        @keydown="handle_autocomplete_navigation($event)"
                                        @keydown.enter.prevent="$event.shiftKey ? (chat_kb_input += '\n') : enviar_pergunta_kb()"
                                        :disabled="chat_kb_carregando"
                                        placeholder="Digite sua pergunta... (use @ para mencionar documentos)"
                                        rows="2"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100 resize-none"></textarea>

                                    <!-- Autocomplete dropdown -->
                                    <div x-show="mostrar_autocomplete && documentos_autocomplete.length > 0"
                                         x-transition
                                         class="absolute bottom-full left-0 w-full mb-2 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50">
                                        <div class="p-2">
                                            <p class="text-xs text-gray-500 px-2 py-1 font-semibold">üìÑ Documentos</p>
                                            <template x-for="(doc, idx) in documentos_autocomplete" :key="idx">
                                                <div @click="selecionar_documento(doc.nome)"
                                                     :class="idx === autocomplete_index_selecionado ? 'bg-blue-100' : 'hover:bg-gray-100'"
                                                     class="px-3 py-2 cursor-pointer rounded flex items-center space-x-2">
                                                    <span class="text-lg">üìÑ</span>
                                                    <div class="flex-1 min-w-0">
                                                        <p class="text-sm font-medium text-gray-900 truncate" x-text="doc.nome"></p>
                                                        <p class="text-xs text-gray-500" x-text="'.' + doc.tipo + ' ‚Ä¢ ' + format_tamanho(doc.tamanho)"></p>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit"
                                        :disabled="chat_kb_carregando || !chat_kb_input.trim()"
                                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed self-end">
                                    <span x-show="!chat_kb_carregando">Enviar</span>
                                    <span x-show="chat_kb_carregando">‚ü≥</span>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Dica: Digite @ para mencionar documentos ‚Ä¢ Enter para enviar ‚Ä¢ Shift+Enter para nova linha</p>
                        </form>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Total de Documentos</p>
                        <p class="text-3xl font-bold text-blue-700 mt-2" x-text="stats.total_documentos || 0">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Documentos Indexados</p>
                        <p class="text-3xl font-bold text-green-700 mt-2" x-text="stats.total_indexados || 0">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Vetores no Banco</p>
                        <p class="text-3xl font-bold text-purple-700 mt-2" x-text="stats.total_vetores || 0">0</p>
                    </div>
                </div>
            </section>

            <!-- Fase 3: Prioriza√ß√£o -->
            <section x-show="fase_atual === 3" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">3. Prioriza√ß√£o de Falhas</h2>
                        <p class="text-gray-600 mt-1">Analise o impacto e esfor√ßo de implementa√ß√£o para cada falha</p>
                    </div>
                </div>

                <!-- Controles de An√°lise -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-bold mb-4">An√°lise de IA</h3>
                    <div class="flex gap-3 flex-wrap">
                        <button @click="analisar_todas_falhas()" :disabled="analisando" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50">
                            <span x-show="!analisando">ü§ñ Analisar Todas as Falhas</span>
                            <span x-show="analisando">‚ü≥ Analisando...</span>
                        </button>
                        <button @click="abrir_config_lote()" :disabled="analisando" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50">
                            ‚öôÔ∏è Configura√ß√µes
                        </button>
                        <button @click="aba_priorizacao = 'matriz'; carregar_matriz()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium">
                            üìä Ver Matriz 2x2
                        </button>
                    </div>

                    <!-- Indicador de Progresso -->
                    <div x-show="analisando" class="mt-6">
                        <div class="mb-2 flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700">
                                Analisando falha <span x-text="progresso_analise.atual"></span> de <span x-text="progresso_analise.total"></span>
                            </span>
                            <span class="text-sm font-medium text-blue-600" x-text="Math.round((progresso_analise.atual / progresso_analise.total) * 100) + '%'"></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300"
                                 :style="'width: ' + ((progresso_analise.atual / progresso_analise.total) * 100) + '%'"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2" x-show="progresso_analise.falha_atual">
                            Atual: <span x-text="progresso_analise.falha_atual"></span>
                        </p>
                    </div>
                </div>

                <!-- Abas de Conte√∫do -->
                <div class="border-b border-gray-200">
                    <nav class="flex justify-between items-center">
                        <div class="flex space-x-8">
                            <button @click="aba_priorizacao = 'tabela'" :class="aba_priorizacao === 'tabela' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'" class="py-4 px-1 font-medium text-sm border-b-2 border-transparent">
                                Tabela de Prioriza√ß√£o
                            </button>
                            <button @click="aba_priorizacao = 'matriz'; carregar_matriz()" :class="aba_priorizacao === 'matriz' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'" class="py-4 px-1 font-medium text-sm border-b-2 border-transparent">
                                Matriz 2x2
                            </button>
                        </div>
                        <div class="flex items-center space-x-2 px-4 py-2 bg-amber-50 border border-amber-200 rounded-lg">
                            <span class="text-amber-600 font-bold text-lg">‚≠ê</span>
                            <span class="text-sm font-medium text-gray-700">Priorizadas:</span>
                            <span class="text-lg font-bold text-amber-600" x-text="contar_priorizadas()"></span>
                        </div>
                    </nav>
                </div>

                <!-- Aba: Tabela -->
                <div x-show="aba_priorizacao === 'tabela'" class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-medium cursor-pointer hover:bg-gray-200" @click="ordenar_priorizacoes('id')">
                                    ID <span x-show="ordem_campo === 'id'" x-text="ordem_direcao === 'asc' ? '‚ñ≤' : '‚ñº'"></span>
                                </th>
                                <th class="px-6 py-3 text-left text-sm font-medium cursor-pointer hover:bg-gray-200" @click="ordenar_priorizacoes('score')">
                                    Score <span x-show="ordem_campo === 'score'" x-text="ordem_direcao === 'asc' ? '‚ñ≤' : '‚ñº'"></span>
                                </th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Falha</th>
                                <th class="px-6 py-3 text-left text-sm font-medium cursor-pointer hover:bg-gray-200" @click="ordenar_priorizacoes('impacto')">
                                    Impacto <span x-show="ordem_campo === 'impacto'" x-text="ordem_direcao === 'asc' ? '‚ñ≤' : '‚ñº'"></span>
                                </th>
                                <th class="px-6 py-3 text-left text-sm font-medium cursor-pointer hover:bg-gray-200" @click="ordenar_priorizacoes('esforco')">
                                    Esfor√ßo <span x-show="ordem_campo === 'esforco'" x-text="ordem_direcao === 'asc' ? '‚ñ≤' : '‚ñº'"></span>
                                </th>
                                <th class="px-6 py-3 text-left text-sm font-medium cursor-pointer hover:bg-gray-200" @click="ordenar_priorizacoes('quadrante')">
                                    Quadrante <span x-show="ordem_campo === 'quadrante'" x-text="ordem_direcao === 'asc' ? '‚ñ≤' : '‚ñº'"></span>
                                </th>
                                <th class="px-6 py-3 text-sm font-medium cursor-pointer hover:bg-gray-200" @click="ordenar_priorizacoes('destacada')">
                                    Priorizar <span x-show="ordem_campo === 'destacada'" x-text="ordem_direcao === 'asc' ? '‚ñ≤' : '‚ñº'"></span>
                                </th>
                                <th class="px-6 py-3 text-sm font-medium">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-priorizacao">
                            <tr class="border-b hover:bg-gray-50">
                                <td colspan="8" class="px-6 py-4 text-center text-gray-500">Carregando prioriza√ß√µes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Aba: Matriz -->
                <div x-show="aba_priorizacao === 'matriz'" class="space-y-6">
                    <!-- Gr√°fico da Matriz + Legenda de Quadrantes -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex gap-6">
                            <!-- Matriz -->
                            <div class="flex-1" style="height: 800px;">
                                <canvas id="canvas-matriz"></canvas>
                            </div>

                            <!-- Legenda de Quadrantes -->
                            <div class="w-72 flex flex-col justify-center space-y-4">
                                <h3 class="font-bold text-gray-800 text-lg mb-2">Quadrantes de Prioriza√ß√£o</h3>

                                <!-- Ganhos R√°pidos -->
                                <div class="border-2 border-green-200 rounded-lg p-4" style="background-color: rgba(16, 185, 129, 0.08);">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-4 h-4 rounded" style="background-color: rgba(16, 185, 129, 0.3);"></div>
                                        <h4 class="font-bold text-green-700">Ganhos R√°pidos</h4>
                                    </div>
                                    <p class="text-sm text-gray-600">Alto impacto com baixo esfor√ßo. Prioridade m√°xima para implementa√ß√£o imediata.</p>
                                </div>

                                <!-- Investir com Cautela -->
                                <div class="border-2 border-yellow-200 rounded-lg p-4" style="background-color: rgba(245, 158, 11, 0.08);">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-4 h-4 rounded" style="background-color: rgba(245, 158, 11, 0.3);"></div>
                                        <h4 class="font-bold text-yellow-700">Investir com Cautela</h4>
                                    </div>
                                    <p class="text-sm text-gray-600">Alto impacto mas alto esfor√ßo. Projetos estruturantes que exigem planejamento cuidadoso.</p>
                                </div>

                                <!-- Considerar -->
                                <div class="border-2 border-gray-200 rounded-lg p-4" style="background-color: rgba(156, 163, 175, 0.08);">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-4 h-4 rounded" style="background-color: rgba(156, 163, 175, 0.3);"></div>
                                        <h4 class="font-bold text-gray-700">Considerar</h4>
                                    </div>
                                    <p class="text-sm text-gray-600">Baixo impacto e baixo esfor√ßo. Implementar se houver recursos dispon√≠veis.</p>
                                </div>

                                <!-- Baixa Prioridade -->
                                <div class="border-2 border-red-200 rounded-lg p-4" style="background-color: rgba(239, 68, 68, 0.08);">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-4 h-4 rounded" style="background-color: rgba(239, 68, 68, 0.3);"></div>
                                        <h4 class="font-bold text-red-700">Baixa Prioridade</h4>
                                    </div>
                                    <p class="text-sm text-gray-600">Baixo impacto com alto esfor√ßo. Adiar ou reavaliar viabilidade.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Legenda dos Pilares -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Legenda - Pilares do Ecossistema</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div class="flex items-center gap-2">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400" style="background-color: #EF4444;"></div>
                                <span class="text-sm font-medium text-gray-800">1. Talento</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400" style="background-color: #F59E0B;"></div>
                                <span class="text-sm font-medium text-gray-800">2. Densidade</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400" style="background-color: #10B981;"></div>
                                <span class="text-sm font-medium text-gray-800">3. Impacto/Diversidade</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400" style="background-color: #3B82F6;"></div>
                                <span class="text-sm font-medium text-gray-800">4. Acesso a Mercado</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400" style="background-color: #8B5CF6;"></div>
                                <span class="text-sm font-medium text-gray-800">5. Cultura</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400" style="background-color: #EC4899;"></div>
                                <span class="text-sm font-medium text-gray-800">6. Regula√ß√£o</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-5 h-5 rounded-full border-2 border-gray-400" style="background-color: #06B6D4;"></div>
                                <span class="text-sm font-medium text-gray-800">7. Capital</span>
                            </div>
                        </div>
                    </div>

                    <!-- Legenda de Prioriza√ß√£o -->
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
                        <p class="text-sm text-amber-800">
                            <span class="font-bold">*</span> Falhas priorizadas aparecem em <span class="font-bold">negrito</span> nas listas abaixo
                        </p>
                    </div>

                    <!-- Quadrantes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Quick Wins -->
                        <div class="matrix-cell quick-wins">
                            <h3 class="text-lg font-bold mb-2">üéØ Quick Wins</h3>
                            <p class="text-sm mb-4">Alto impacto, Baixo esfor√ßo</p>
                            <ul class="space-y-2" id="quadrante-quick-wins">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>

                        <!-- Strategic -->
                        <div class="matrix-cell strategic">
                            <h3 class="text-lg font-bold mb-2">‚≠ê Strategic</h3>
                            <p class="text-sm mb-4">Alto impacto, Alto esfor√ßo</p>
                            <ul class="space-y-2" id="quadrante-strategic">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>

                        <!-- Fill-in -->
                        <div class="matrix-cell fill-in">
                            <h3 class="text-lg font-bold mb-2">‚úì Fill-in</h3>
                            <p class="text-sm mb-4">Baixo impacto, Baixo esfor√ßo</p>
                            <ul class="space-y-2" id="quadrante-fill-in">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>

                        <!-- Low Priority -->
                        <div class="matrix-cell low-priority">
                            <h3 class="text-lg font-bold mb-2">‚è± Low Priority</h3>
                            <p class="text-sm mb-4">Baixo impacto, Alto esfor√ßo</p>
                            <ul class="space-y-2" id="quadrante-low-priority">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Fase 4: Boas Pr√°ticas -->
            <section x-show="fase_atual === 4" class="space-y-6">
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-8 border border-purple-200">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="text-4xl">üí°</div>
                        <div>
                            <h2 class="text-3xl font-bold">4. Mapeamento de Boas Pr√°ticas & Sugest√µes</h2>
                            <p class="text-gray-600 mt-2">Identifica√ß√£o de solu√ß√µes e casos de sucesso</p>
                        </div>
                    </div>
                </div>

                <!-- Sub-navega√ß√£o de Fases -->
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex gap-2 flex-wrap">
                        <button @click="boas_praticas_subfase = 1"
                                :class="boas_praticas_subfase === 1 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="px-4 py-2 rounded-lg font-medium transition-colors">
                            Fase I - Filtro de Fontes
                        </button>
                        <button @click="boas_praticas_subfase = 2"
                                :class="boas_praticas_subfase === 2 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="px-4 py-2 rounded-lg font-medium transition-colors">
                            Fase II - Detec√ß√£o de Boas Pr√°ticas
                        </button>
                        <button @click="boas_praticas_subfase = 3"
                                :class="boas_praticas_subfase === 3 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="px-4 py-2 rounded-lg font-medium transition-colors">
                            Fase III - Sugest√£o de Boas Pr√°ticas
                        </button>
                        <button @click="boas_praticas_subfase = 4"
                                :class="boas_praticas_subfase === 4 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                class="px-4 py-2 rounded-lg font-medium transition-colors">
                            Fase IV - Consolida√ß√£o de Boas Pr√°ticas
                        </button>
                    </div>
                </div>

                <!-- Fase I: Listagem de Falhas Priorizadas -->
                <div x-show="boas_praticas_subfase === 1" class="space-y-4" x-init="carregar_falhas_fase1()">
                    <!-- Controles -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-xl font-bold">Fase I - Filtro de Fontes</h3>
                                <p class="text-sm text-gray-600 mt-1">Visualize as fontes encontradas para cada falha priorizada. A detec√ß√£o de boas pr√°ticas ser√° executada na Fase II.</p>
                            </div>
                            <div class="flex gap-3">
                                <button @click="modal_filtros_fase1_aberto = true"
                                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2">
                                    ‚öôÔ∏è Configurar Filtros
                                </button>
                                <button @click="solicitar_atualizacao_fase1()"
                                        :disabled="carregando_fase1"
                                        :class="filtros_fase1_alterados
                                            ? 'bg-amber-600 hover:bg-amber-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-medium transition-colors animate-pulse'
                                            : 'bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-lg font-medium transition-colors'">
                                    <span x-show="!carregando_fase1 && !filtros_fase1_alterados">üîÑ Atualizar Lista</span>
                                    <span x-show="!carregando_fase1 && filtros_fase1_alterados">‚ö†Ô∏è Atualizar com Novos Filtros</span>
                                    <span x-show="carregando_fase1">‚è≥ Carregando...</span>
                                </button>
                            </div>
                        </div>

                        <!-- Status -->
                        <div x-show="fase1_status" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-sm text-blue-800" x-text="fase1_status"></p>
                        </div>

                        <!-- Indicador de Progresso em Lote -->
                        <div x-show="progresso_lote_fase1.ativo" class="mt-4 p-6 bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-300 rounded-lg">
                            <div class="space-y-4">
                                <!-- T√≠tulo -->
                                <div class="flex items-center justify-between">
                                    <h4 class="font-bold text-gray-800 flex items-center">
                                        <span class="mr-2">‚ö°</span>
                                        Processando Fontes com An√°lise de IA
                                    </h4>
                                    <span class="text-sm font-mono font-bold text-purple-600" x-text="`${progresso_lote_fase1.processadas}/${progresso_lote_fase1.total}`"></span>
                                </div>

                                <!-- Falha Atual -->
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Falha Atual:</p>
                                    <p class="text-sm font-medium text-gray-800" x-text="progresso_lote_fase1.falha_atual"></p>
                                </div>

                                <!-- Etapa Atual -->
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Etapa:</p>
                                    <p class="text-sm font-medium text-indigo-600" x-text="progresso_lote_fase1.etapa_atual"></p>
                                </div>

                                <!-- Barra de Progresso -->
                                <div class="relative pt-1">
                                    <div class="flex mb-2 items-center justify-between">
                                        <div>
                                            <span class="text-xs font-semibold inline-block text-purple-600">
                                                Progresso Geral
                                            </span>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-xs font-semibold inline-block text-purple-600" x-text="`${progresso_lote_fase1.percentual}%`"></span>
                                        </div>
                                    </div>
                                    <div class="overflow-hidden h-4 text-xs flex rounded-full bg-purple-200">
                                        <div :style="`width: ${progresso_lote_fase1.percentual}%`"
                                             class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-purple-500 to-indigo-500 transition-all duration-500"></div>
                                    </div>
                                </div>

                                <!-- Dica -->
                                <div class="flex items-start gap-2 text-xs text-gray-600 bg-white bg-opacity-50 rounded p-3">
                                    <svg class="w-4 h-4 text-purple-500 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>Este processo pode demorar alguns minutos dependendo do n√∫mero de fontes e an√°lises necess√°rias. Por favor, aguarde.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela de Falhas -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <!-- Contador no Topo -->
                        <div x-show="falhas_fase1.length > 0" class="bg-gradient-to-r from-purple-50 to-indigo-50 px-6 py-4 border-b border-purple-200">
                            <div class="flex items-center gap-2 text-sm">
                                <span class="font-semibold text-purple-900">üìã Total de Falhas Priorizadas:</span>
                                <span class="bg-purple-600 text-white px-3 py-1 rounded-full font-bold" x-text="falhas_fase1.length"></span>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-purple-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Falha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Descri√ß√£o</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider text-center">Fontes</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="tabela-fase1">
                                    <!-- Preenchido por JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Fase II: An√°lise com IA -->
                <div x-show="boas_praticas_subfase === 2" class="space-y-4" x-init="carregar_falhas_fase2()">
                    <!-- Controles -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div>
                            <h3 class="text-xl font-bold mb-2">Fase II - Detec√ß√£o de Boas Pr√°ticas</h3>
                            <p class="text-sm text-gray-600">Clique em "Analisar" para executar a detec√ß√£o de boas pr√°ticas com IA para cada falha. O sistema buscar√° conte√∫do completo das URLs e analisar√° documentos.</p>
                        </div>

                        <!-- Status -->
                        <div x-show="fase2_status" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-sm text-blue-800" x-text="fase2_status"></p>
                        </div>
                    </div>

                    <!-- Tabela de An√°lises -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <!-- Contadores no Topo -->
                        <div x-show="falhas_fase2.length > 0" class="bg-gradient-to-r from-purple-50 to-pink-50 px-6 py-4 border-b border-purple-200">
                            <div class="flex gap-6 text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-purple-900">üìã Total de Falhas:</span>
                                    <span class="bg-purple-600 text-white px-3 py-1 rounded-full font-bold" x-text="falhas_fase2.length"></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-purple-900">‚ú® Total de Boas Pr√°ticas:</span>
                                    <span class="bg-pink-600 text-white px-3 py-1 rounded-full font-bold" x-text="calcular_total_praticas_fase2()"></span>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-purple-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Falha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Boas Pr√°ticas Identificadas</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="tabela-fase2">
                                    <!-- Preenchido por JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Fase III: Sugest√£o de Boas Pr√°ticas -->
                <div x-show="boas_praticas_subfase === 3" class="space-y-4">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">üí°</div>
                            <h3 class="text-xl font-bold mb-2">Fase III - Sugest√£o de Boas Pr√°ticas</h3>
                            <p class="text-gray-600">Esta fase ser√° implementada em breve.</p>
                        </div>
                    </div>
                </div>

                <!-- Fase IV: Consolida√ß√£o de Boas Pr√°ticas -->
                <div x-show="boas_praticas_subfase === 4" class="space-y-4">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">üìä</div>
                            <h3 class="text-xl font-bold mb-2">Fase IV - Consolida√ß√£o de Boas Pr√°ticas</h3>
                            <p class="text-gray-600">Esta fase ser√° implementada em breve.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Fase 5: Propostas -->
            <section x-show="fase_atual === 5" class="space-y-6">
                <div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-lg p-8 border border-green-200">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="text-4xl">üìù</div>
                        <div>
                            <h2 class="text-3xl font-bold">5. Formula√ß√£o de Propostas de Pol√≠ticas P√∫blicas</h2>
                            <p class="text-gray-600 mt-2">Desenvolvimento de propostas estruturadas</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-8">
                    <p class="text-gray-600 text-center">
                        Em desenvolvimento...
                    </p>
                </div>
            </section>

            <!-- Fase 6: Plano de Implanta√ß√£o -->
            <section x-show="fase_atual === 6" class="space-y-6">
                <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-lg p-8 border border-orange-200">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="text-4xl">üöÄ</div>
                        <div>
                            <h2 class="text-3xl font-bold">6. Plano de Implanta√ß√£o</h2>
                            <p class="text-gray-600 mt-2">Estrat√©gia e roadmap de implementa√ß√£o</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-8">
                    <p class="text-gray-600 text-center">
                        Em desenvolvimento...
                    </p>
                </div>
            </section>

            <!-- Biblioteca de Relat√≥rios -->
            <section x-show="fase_atual === 7" class="space-y-6">
                <div class="bg-gradient-to-r from-amber-50 to-yellow-50 rounded-lg p-8 border border-amber-300">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="text-4xl">üìö</div>
                        <div>
                            <h2 class="text-3xl font-bold">Biblioteca de Relat√≥rios</h2>
                            <p class="text-gray-600 mt-2">Documentos, an√°lises e relat√≥rios gerados</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-8">
                    <p class="text-gray-600 text-center">
                        Em desenvolvimento...
                    </p>
                </div>
            </section>
        </main>

        <!-- Modal de Detalhes da Prioriza√ß√£o -->
        <div id="modal-detalhes" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" x-show="modal_aberto" @click.self="fechar_modal()" x-cloak>
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto" @click.stop>
                <!-- Header do Modal -->
                <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 border-b flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold" x-text="detalhes_modal?.titulo || ''"></h2>
                        <p class="text-sm mt-1 opacity-90" x-text="`Falha ID: ${detalhes_modal?.falha_id || ''}`"></p>
                    </div>
                    <button @click="fechar_modal()" class="text-white hover:bg-blue-700 p-2 rounded-full">
                        <span class="text-2xl">‚úï</span>
                    </button>
                </div>

                <!-- Conte√∫do do Modal -->
                <div class="p-6 space-y-6">
                    <!-- Scores de Impacto e Esfor√ßo -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <p class="text-sm font-medium text-gray-600">Impacto</p>
                            <p class="text-3xl font-bold text-green-600 mt-2" x-text="`${detalhes_modal?.impacto || 0}/10`"></p>
                            <p class="text-xs text-gray-600 mt-2 italic" x-text="obter_descricao_impacto(detalhes_modal?.impacto || 0)"></p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <p class="text-sm font-medium text-gray-600">Esfor√ßo</p>
                            <p class="text-3xl font-bold text-orange-600 mt-2" x-text="`${detalhes_modal?.esforco || 0}/10`"></p>
                            <p class="text-xs text-gray-600 mt-2 italic" x-text="obter_descricao_esforco(detalhes_modal?.esforco || 0)"></p>
                        </div>
                    </div>

                    <!-- Se√ß√£o de Prioriza√ß√£o -->
                    <div class="bg-amber-50 p-4 rounded-lg border border-amber-200">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-bold text-gray-800 flex items-center">
                                <span class="mr-2">‚≠ê</span>
                                Prioriza√ß√£o
                            </h3>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox"
                                       x-model="destacada_temp"
                                       @click="toggle_destaque_modal()"
                                       class="sr-only peer">
                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                                <span class="ms-2 text-sm font-medium text-gray-700">Destacar</span>
                            </label>
                        </div>

                        <div class="mt-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Justificativa (opcional)
                            </label>
                            <textarea
                                x-model="justificativa_temp"
                                @input.debounce.1000ms="salvar_justificativa()"
                                @blur="salvar_justificativa()"
                                rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 text-sm"
                                placeholder="Adicione uma justificativa para priorizar esta falha..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">A justificativa ser√° salva automaticamente enquanto voc√™ digita</p>
                        </div>
                    </div>

                    <!-- An√°lise da IA -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="text-sm font-bold text-gray-800 mb-3">An√°lise da IA</h3>
                        <div class="text-sm text-gray-700" x-html="renderizar_analise_ia(detalhes_modal?.analise_ia)"></div>
                    </div>

                    <!-- Fontes Utilizadas -->
                    <div class="border-t pt-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">üìö</span>
                            Fontes Utilizadas
                        </h3>

                        <template x-if="detalhes_modal?.fontes && detalhes_modal.fontes.length > 0">
                            <div class="space-y-3">
                                <template x-for="(fonte, idx) in detalhes_modal.fontes" :key="idx">
                                    <div :id="`fonte-${idx + 1}`" class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow scroll-mt-4">
                                        <!-- Cabe√ßalho da Fonte -->
                                        <div class="flex items-start justify-between mb-3">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <span class="text-xs font-mono text-gray-500 mr-1" x-text="`[${idx + 1}]`"></span>
                                                    <span class="text-lg" x-text="obter_icone_fonte(fonte.fonte_tipo)"></span>
                                                    <span class="font-bold text-gray-800 text-sm" x-text="obter_titulo_fonte(fonte)"></span>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <span :class="`${obter_cor_tipo(fonte.fonte_tipo)} px-2 py-1 rounded text-xs font-medium`"
                                                          x-text="obter_label_tipo(fonte.fonte_tipo)"></span>
                                                    <!-- Badge de Idioma -->
                                                    <template x-if="fonte.idioma && fonte.idioma.toLowerCase() !== 'pt' && fonte.idioma.toLowerCase() !== 'portugu√™s'">
                                                        <span class="bg-amber-100 text-amber-800 px-2 py-1 rounded text-xs font-medium flex items-center gap-1">
                                                            üåê <span x-text="obter_nome_idioma(fonte.idioma)"></span>
                                                        </span>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Trecho da Fonte (sempre mostrar se dispon√≠vel) -->
                                        <template x-if="fonte.fonte_conteudo || fonte.fonte_descricao">
                                            <div class="text-sm text-gray-700 mb-3 italic border-l-2 border-gray-300 pl-3">
                                                <p x-text="obter_trecho_fonte(fonte)"></p>
                                            </div>
                                        </template>

                                        <!-- Tradu√ß√£o (integrada com banco de dados) -->
                                        <template x-if="fonte.idioma && fonte.idioma.toLowerCase() !== 'pt' && fonte.idioma.toLowerCase() !== 'portugu√™s' && (fonte.fonte_conteudo || fonte.fonte_descricao || fonte.titulo_pt || fonte.descricao_pt)">
                                            <div class="mb-3">
                                                <div x-data="{
                                                    mostrar_traducao: false,
                                                    traducao_titulo: fonte.titulo_pt || '',
                                                    traducao_descricao: fonte.descricao_pt || '',
                                                    traduzindo: false,
                                                    get tem_traducao_db() {
                                                        return !!(fonte.titulo_pt || fonte.descricao_pt);
                                                    }
                                                }">
                                                    <button @click="
                                                        if (tem_traducao_db) {
                                                            mostrar_traducao = !mostrar_traducao;
                                                        } else if (!traducao_descricao) {
                                                            traduzindo = true;
                                                            traduzir_texto(obter_trecho_fonte(fonte), fonte.idioma).then(t => {
                                                                traducao_descricao = t;
                                                                traduzindo = false;
                                                                mostrar_traducao = true;
                                                            });
                                                        } else {
                                                            mostrar_traducao = !mostrar_traducao;
                                                        }
                                                    "
                                                            class="text-xs font-medium text-blue-600 hover:text-blue-800 flex items-center gap-1 mb-2">
                                                        <span x-show="!traduzindo">üáßüá∑</span>
                                                        <span x-show="traduzindo">‚è≥</span>
                                                        <span x-show="!traduzindo && !mostrar_traducao">
                                                            <span x-text="tem_traducao_db ? 'Ver tradu√ß√£o (banco de dados)' : 'Traduzir para portugu√™s'"></span>
                                                        </span>
                                                        <span x-show="!traduzindo && mostrar_traducao">Ocultar tradu√ß√£o</span>
                                                        <span x-show="traduzindo">Traduzindo...</span>
                                                    </button>
                                                    <div x-show="mostrar_traducao && (traducao_titulo || traducao_descricao)" class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-gray-700">
                                                        <div class="flex items-start gap-2 mb-2">
                                                            <span class="text-blue-600 text-xs font-semibold">üáßüá∑ TRADU√á√ÉO:</span>
                                                            <span x-show="tem_traducao_db" class="text-xs text-green-600 font-medium">(‚úì do banco)</span>
                                                        </div>
                                                        <div class="space-y-2">
                                                            <p x-show="traducao_titulo" class="font-medium text-gray-800" x-text="traducao_titulo"></p>
                                                            <p x-show="traducao_descricao" class="italic text-gray-700" x-text="traducao_descricao"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>

                                        <!-- Conte√∫do Completo (se dispon√≠vel) -->
                                        <template x-if="fonte.fonte_conteudo && fonte.fonte_conteudo.length > 200">
                                            <details class="text-xs">
                                                <summary class="cursor-pointer text-blue-600 hover:underline font-medium">Ver mais detalhes</summary>
                                                <div class="mt-2 p-3 bg-white rounded border border-gray-300 max-h-40 overflow-y-auto">
                                                    <p class="text-gray-700 whitespace-pre-wrap mb-3" x-text="fonte.fonte_conteudo"></p>
                                                    <!-- Link para fonte original dentro do "Ver mais detalhes" -->
                                                    <template x-if="fonte.fonte_url">
                                                        <a :href="fonte.fonte_url" target="_blank" rel="noopener noreferrer"
                                                           class="text-blue-600 hover:underline text-xs font-medium flex items-center gap-1 mt-2">
                                                            <span>üîó</span> Acessar fonte original
                                                        </a>
                                                    </template>
                                                </div>
                                            </details>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <template x-if="!detalhes_modal?.fontes || detalhes_modal.fontes.length === 0">
                            <div class="text-center py-8 text-gray-500">
                                <p class="text-sm">Nenhuma fonte registrada para esta prioriza√ß√£o</p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Footer do Modal -->
                <div class="sticky bottom-0 bg-gray-100 p-4 border-t flex justify-end gap-3">
                    <button @click="fechar_modal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-medium text-sm">
                        Fechar
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white mt-12 py-8 border-t border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center space-y-3">
                    <p class="text-sm text-gray-100">
                        Desenvolvido com ‚ù§Ô∏è e <strong>IA</strong> pela <a href='http://aistudio.10k.digital' target='_blank' class="text-blue-300 hover:text-blue-200 underline">10K AI Studio</a>
                    </p>
                    <p class="text-xs text-gray-300">
                        Copyright 2025. Todos os Direitos Reservados.
                    </p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        function app() {
            return {
                fase_atual: 0,
                fases: [
                    { nome: 'Home', descricao: 'Vis√£o geral do projeto' },
                    { nome: 'Pesquisa', descricao: 'Busca por pol√≠ticas p√∫blicas' },
                    { nome: 'Base de Conhecimento', descricao: 'Gerenciamento de documentos e RAG' },
                    { nome: 'Prioriza√ß√£o', descricao: 'An√°lise de impacto e esfor√ßo' },
                    { nome: 'Boas Pr√°ticas', descricao: 'Mapeamento de boas pr√°ticas e sugest√µes' },
                    { nome: 'Propostas', descricao: 'Formula√ß√£o de propostas de pol√≠ticas p√∫blicas' },
                    { nome: 'Plano de Implanta√ß√£o', descricao: 'Estrat√©gia de implementa√ß√£o' },
                    { nome: 'Biblioteca', descricao: 'Documentos e relat√≥rios' }
                ],
                stats: { total_falhas: 0, total_priorizadas: 0, total_resultados: 0, total_pendentes: 0, total_processando: 0, total_concluidas: 0, total_documentos: 0, total_indexados: 0, total_vetores: 0, resultados_pt: 0, resultados_internacionais: 0, resultados_traduzidos: 0, percentual_traduzidos: 0 },
                ativo: false,
                pesquisa_iniciando: false,
                analisando: false,
                uploading: false,
                upload_progress: 0,
                upload_status: '',
                upload_files_status: [],
                dragover_kb: false,
                duplicados_modal_aberto: false,
                arquivos_duplicados: [],
                arquivos_pendentes: null,
                opcao_duplicados: 'ask',
                documentos: [],
                documentos_filtrados: [],
                documentos_selecionados: [],
                busca_documentos: '',
                ordem_campo: 'nome',
                ordem_direcao: 'asc',
                priorizacoes_dados: [],
                chat_kb_mensagens: [],
                chat_kb_input: '',
                chat_kb_carregando: false,
                chat_kb_documentos_mencionados: [],  // Documentos @ mencionados
                mostrar_autocomplete: false,
                documentos_autocomplete: [],
                autocomplete_index_selecionado: 0,
                autocomplete_query_inicio: 0,  // Posi√ß√£o do @ no texto
                chat_pesquisa_mensagens: [],
                chat_pesquisa_input: '',
                chat_pesquisa_carregando: false,
                percentual_processamento: 0,
                aba_priorizacao: 'tabela',
                chartMatriz: null,
                modal_aberto: false,
                detalhes_modal: null,
                destacada_temp: false,
                justificativa_temp: '',
                confirmacao_aberta: false,
                modal_analise_aberto: false,
                falha_analise: null,
                config_analise: {
                    usar_rag: true,
                    usar_resultados_pesquisa: true,
                    temperatura: 0.3,
                    modelo: 'google/gemini-2.5-pro',
                    max_tokens: 4000
                },
                analisando_individual: false,
                boas_praticas_subfase: 1,
                buscando_boas_praticas: false,
                boas_praticas_status: '',
                boas_praticas_dados: [],
                // Fase I - Listagem
                carregando_fase1: false,
                fase1_status: '',
                falhas_fase1: [],
                linhas_expandidas_fase1: {},  // { falha_id: true/false }
                fontes_falha_fase1: {},  // { falha_id: [fontes] }
                carregando_fontes_fase1: {},  // { falha_id: true/false }
                paginacao_fontes_fase1: {},  // { falha_id: { page, total_pages, has_next, has_prev } }
                progresso_falhas_fase1: {},  // { falha_id: { ativo: bool, percentual: 0-100, etapa: string } }
                contagem_fontes_fase1: {},  // { falha_id: numero_fontes_apos_filtros }
                // Modal e configura√ß√µes de filtros
                modal_filtros_fase1_aberto: false,
                filtros_fase1: {
                    confianca_minima: 0.5,
                    peso_sebrae: 1,  // 1 = normal, 2 = 2X, 5 = 5X, 10 = 10X
                    tipo_fonte: [],  // Array: academica, governamental, tecnico, caso_sucesso
                    anos_publicacao: 'todos',  // todos, 3, 5, 10
                    regiao: [],  // Array: brasil, latam, global
                    idioma: [],  // Array: pt, es, en
                    apenas_com_implementacao: false,
                    apenas_com_metricas: false,
                    limpar_cache: false  // Se true, ignora cache e for√ßa nova an√°lise
                },
                filtros_fase1_alterados: false,  // Indica se os filtros foram modificados desde a √∫ltima aplica√ß√£o
                // Configura√ß√µes de Avalia√ß√£o Profunda
                config_avaliacao_profunda_aberta: false,  // Painel de configura√ß√µes aberto/fechado
                avaliacao_profunda_ativa: false,  // Se avalia√ß√£o profunda est√° ativada
                modo_avaliacao_profunda: 'gratuito',  // premium, balanceado, gratuito
                modo_traducao: 'gratuito',  // gratuito, economico, qualidade - modo de tradu√ß√£o
                criterios_mudaram: false,  // Se crit√©rios mudaram desde √∫ltima an√°lise
                modal_reanalisar_aberto: false,  // Modal de confirma√ß√£o de rean√°lise
                estimativa_reanalisar: null,  // { custo, tempo, modelo, num_fontes }
                reanalisando: false,  // Se est√° executando rean√°lise
                progresso_reanalisar: {  // Progresso da rean√°lise em background
                    job_id: null,
                    status: '',
                    progresso: 0,
                    total: 0,
                    processados: 0,
                    scores_atualizados: 0,
                    erros: 0,
                    mensagem: ''
                },
                intervalo_polling_reanalisar: null,  // Refer√™ncia ao setInterval
                // Tradu√ß√µes
                completando_traducoes: false,  // Se est√° traduzindo resultados
                refazendo_traducoes: false,  // Se est√° refazendo TODAS as tradu√ß√µes
                job_id_traducao: null,  // ID do job de tradu√ß√£o em lote
                intervalo_polling_traducao: null,  // Refer√™ncia ao setInterval para polling
                progresso_traducao: {  // Progresso da tradu√ß√£o
                    total: 0,
                    processados: 0,
                    traduzidas: 0,
                    erros: 0,
                    idiomas_corrigidos: 0  // Contador de idiomas corrigidos
                },
                modal_confirmar_traducao_aberto: false,  // Modal de confirma√ß√£o de tradu√ß√£o
                estimativa_traducao: null,  // { custo, tempo, modo, total }
                estimativa_traducao_carregando: false,  // Se est√° carregando estimativa
                // Fase II - An√°lise com IA
                fase2_status: '',
                falhas_fase2: [],
                analisando_falha: {},  // { falha_id: true/false }
                progresso_analise: {
                    etapa: '',
                    progresso: 0,
                    mensagem: ''
                },
                modal_config_lote_aberto: false,
                config_analise_lote: {
                    usar_rag: true,
                    usar_resultados_pesquisa: true,
                    temperatura: 0.3,
                    modelo: 'google/gemini-2.5-pro',
                    max_tokens: 4000
                },
                confirmacao_titulo: '',
                confirmacao_mensagem: '',
                confirmacao_callback: null,
                // Modal de estimativa de custo
                modal_estimativa_aberto: false,
                estimativa_dados: null,
                estimativa_carregando: false,
                falha_estimativa_id: null,
                // Progresso de carregamento em lote
                progresso_lote_fase1: {
                    ativo: false,
                    total: 0,
                    processadas: 0,
                    falha_atual: '',
                    etapa_atual: '',
                    percentual: 0
                },
                // Modal de confirma√ß√£o para pesquisa
                modal_confirmacao_pesquisa_aberto: false,
                estimativa_pesquisa: null,
                estimativa_pesquisa_carregando: false,
                // Modal de resultados da pesquisa
                modal_resultados_pesquisa_aberto: false,
                falha_selecionada_resultados: null,
                resultados_pesquisa: [],
                resultados_pesquisa_filtrados: [],
                resultados_pesquisa_paginados: [],
                carregando_resultados_pesquisa: false,
                paginacao_resultados_pesquisa: {
                    page: 1,
                    total_pages: 1,
                    total: 0,
                    has_next: false,
                    has_prev: false
                },
                paginacao_local: {
                    page: 1,
                    page_size: 20,
                    total_filtrados: 0,
                    total_pages: 1,
                    has_next: false,
                    has_prev: false
                },
                // Filtros e busca
                busca_resultados_pesquisa: '',
                mostrar_filtros_resultados: true,
                ordenacao_resultados: 'score_desc',
                filtro_idiomas_resultados: [],
                filtro_score_min_resultados: 0,
                filtro_score_max_resultados: 100,
                filtro_ferramentas_resultados: [],

                obter_titulo_portugues(resultado) {
                    if (!resultado) return '';
                    const tituloPt = (resultado.titulo_pt || '').trim();
                    if (tituloPt) {
                        return tituloPt;
                    }

                    if ((resultado.idioma || '').toLowerCase() !== 'pt') {
                        const descricaoTraduzida = (resultado.descricao_pt || '').trim();
                        const linhaDescricao = this.extrair_primeira_linha(descricaoTraduzida);
                        if (linhaDescricao) {
                            return linhaDescricao;
                        }
                    }

                    const tituloOriginal = (resultado.titulo || '').trim();
                    return tituloOriginal || 'T√≠tulo n√£o dispon√≠vel';
                },

                obter_primeira_linha_pt(resultado) {
                    if (!resultado) return '';

                    const descricaoTraduzida = (resultado.descricao_pt || '').trim();
                    if (descricaoTraduzida) {
                        const linha = this.extrair_primeira_linha(descricaoTraduzida);
                        if (linha) {
                            return linha;
                        }
                    }

                    if ((resultado.idioma || '').toLowerCase() === 'pt') {
                        const descricaoOriginal = (resultado.descricao || '').trim();
                        const linhaPt = this.extrair_primeira_linha(descricaoOriginal);
                        if (linhaPt) {
                            return linhaPt;
                        }
                    }

                    return (resultado.idioma && resultado.idioma.toLowerCase() !== 'pt')
                        ? 'Tradu√ß√£o da descri√ß√£o indispon√≠vel.'
                        : 'Descri√ß√£o n√£o dispon√≠vel.';
                },

                extrair_primeira_linha(texto) {
                    if (!texto) return '';
                    const linhas = texto
                        .split(/\r?\n/)
                        .map(linha => linha.trim())
                        .filter(Boolean);

                    if (!linhas.length) return '';
                    const primeira = linhas[0];
                    return primeira.length > 180 ? `${primeira.slice(0, 177)}...` : primeira;
                },

                mudar_fase(idx) {
                    this.fase_atual = idx;
                    window.location.hash = this.get_hash_from_fase(idx);
                    if (idx === 1) this.carregar_dados_pesquisa();
                    if (idx === 2) this.carregar_documentos();
                    if (idx === 3) this.carregar_dados_priorizacao();
                    if (idx === 4) this.carregar_falhas_priorizadas_inicial();
                },

                get_hash_from_fase(idx) {
                    const hashes = ['home', 'pesquisa', 'conhecimento', 'priorizacao', 'boas-praticas', 'propostas', 'plano-implantacao', 'biblioteca'];
                    return `#${hashes[idx] || 'home'}`;
                },

                get_fase_from_hash() {
                    const hash = window.location.hash.slice(1) || 'home';
                    const hashes = {
                        'home': 0,
                        'pesquisa': 1,
                        'conhecimento': 2,
                        'priorizacao': 3,
                        'boas-praticas': 4,
                        'propostas': 5,
                        'plano-implantacao': 6,
                        'biblioteca': 7
                    };
                    return hashes[hash] || 0;
                },

                // Converter markdown para HTML
                markdown_to_html(text) {
                    if (!text) return '';

                    let html = text;

                    // Headers (### Header -> <h3>Header</h3>)
                    html = html.replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold mt-4 mb-2">$1</h3>');
                    html = html.replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-4 mb-2">$1</h2>');
                    html = html.replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mt-4 mb-2">$1</h1>');

                    // Bold (**texto** -> <b>texto</b>)
                    html = html.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>');

                    // Italic (*texto* -> <i>texto</i>)
                    html = html.replace(/\*([^*]+)\*/g, '<i>$1</i>');

                    // Lists - Unordered (- item ou * item)
                    html = html.replace(/^\s*[-*]\s+(.*)$/gim, '<li class="ml-4">‚Ä¢ $1</li>');

                    // Lists - Ordered (1. item)
                    html = html.replace(/^\s*\d+\.\s+(.*)$/gim, '<li class="ml-4 list-decimal">$1</li>');

                    // Wrap consecutive <li> tags in <ul>
                    html = html.replace(/(<li[^>]*>.*<\/li>\n?)+/gs, '<ul class="my-2">$&</ul>');

                    // Code blocks (```code```)
                    html = html.replace(/```([^`]+)```/g, '<pre class="bg-gray-100 p-2 rounded my-2 overflow-x-auto"><code>$1</code></pre>');

                    // Inline code (`code`)
                    html = html.replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-1 rounded">$1</code>');

                    // Line breaks (dois espa√ßos + newline ou \n\n)
                    html = html.replace(/\n\n/g, '<br><br>');
                    html = html.replace(/  \n/g, '<br>');

                    // Links [text](url)
                    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-blue-600 underline" target="_blank">$1</a>');

                    return html;
                },

                mostrar_notificacao(mensagem, tipo = 'info') {
                    const container = document.getElementById('notificacoes-container');
                    const cores = {
                        'sucesso': 'bg-green-100 border-green-400 text-green-800',
                        'erro': 'bg-red-100 border-red-400 text-red-800',
                        'info': 'bg-blue-100 border-blue-400 text-blue-800',
                        'aviso': 'bg-yellow-100 border-yellow-400 text-yellow-800'
                    };
                    const div = document.createElement('div');
                    div.className = `border rounded px-4 py-3 ${cores[tipo] || cores['info']} animate-pulse`;
                    div.textContent = mensagem;
                    container.appendChild(div);

                    setTimeout(() => {
                        div.style.opacity = '0';
                        div.style.transition = 'opacity 0.3s';
                        setTimeout(() => div.remove(), 300);
                    }, 4000);
                },

                mostrar_confirmacao(titulo, mensagem, callback) {
                    this.confirmacao_titulo = titulo;
                    this.confirmacao_mensagem = mensagem;
                    this.confirmacao_callback = callback;
                    this.confirmacao_aberta = true;
                },

                fechar_confirmacao() {
                    this.confirmacao_aberta = false;
                    this.confirmacao_callback = null;
                },

                executar_confirmacao() {
                    if (this.confirmacao_callback) {
                        this.confirmacao_callback();
                    }
                    this.fechar_confirmacao();
                },

                async inicializar() {
                    try {
                        // Expor app globalmente para onclick handlers
                        window.app = this;

                        // Carregar configura√ß√µes de an√°lise em lote do localStorage
                        const configSalva = localStorage.getItem('config_analise_lote');
                        if (configSalva) {
                            try {
                                this.config_analise_lote = JSON.parse(configSalva);
                            } catch (e) {
                                console.warn('Erro ao carregar configura√ß√µes salvas:', e);
                            }
                        }

                        // Carregar filtros salvos do localStorage
                        const filtrosSalvos = localStorage.getItem('filtros_fase1');
                        if (filtrosSalvos) {
                            try {
                                this.filtros_fase1 = JSON.parse(filtrosSalvos);
                            } catch (e) {
                                console.warn('Erro ao carregar filtros salvos:', e);
                            }
                        }

                        // Carregar p√°gina baseada na URL
                        this.fase_atual = this.get_fase_from_hash();

                        // Listener para mudan√ßa de URL
                        window.addEventListener('hashchange', () => {
                            this.fase_atual = this.get_fase_from_hash();
                        });

                        await this.carregar_stats();
                        if (this.fase_atual === 0) this.carregar_dados_pesquisa();
                        if (this.fase_atual === 1) this.carregar_dados_pesquisa();
                        if (this.fase_atual === 2) this.carregar_documentos();
                        if (this.fase_atual === 3) this.carregar_dados_priorizacao();
                        if (this.fase_atual === 4) this.carregar_falhas_priorizadas_inicial();

                        setInterval(() => this.carregar_stats(), 5000);
                    } catch (e) {
                        console.error('Erro ao inicializar aplica√ß√£o:', e);
                        // Mesmo com erro, manter a app vis√≠vel
                        this.stats.total_falhas = 50; // Valores padr√£o
                        this.stats.total_priorizadas = 50;
                    }
                },

                async carregar_stats() {
                    try {
                        // Carregar todas as estat√≠sticas de uma √∫nica vez
                        const res = await fetch('/api/stats');
                        if (res.ok) {
                            const response = await res.json();
                            if (response.sucesso && response.dados) {
                                const dados = response.dados;
                                this.stats.total_falhas = dados.total_falhas || 0;
                                this.stats.total_resultados = dados.total_resultados || 0;
                                this.stats.total_priorizadas = dados.pesquisas_concluidas || 0;
                                this.stats.total_pendentes = dados.total_pendentes || 0;
                                this.stats.total_processando = dados.total_processando || 0;
                                this.stats.total_concluidas = dados.total_concluidas || 0;

                                // Estat√≠sticas de tradu√ß√£o
                                this.stats.resultados_pt = dados.resultados_pt || 0;
                                this.stats.resultados_internacionais = dados.resultados_internacionais || 0;
                                this.stats.resultados_traduzidos = dados.resultados_traduzidos || 0;
                                this.stats.percentual_traduzidos = dados.percentual_traduzidos || 0;

                                // Calcular percentual de processamento baseado em falhas com resultados
                                if (this.stats.total_falhas > 0) {
                                    this.percentual_processamento = (dados.pesquisas_concluidas / this.stats.total_falhas) * 100;
                                } else {
                                    this.percentual_processamento = 0;
                                }

                                console.log('‚úì Stats carregadas:', this.stats);
                            }
                        } else {
                            console.warn('Resposta n√£o ok ao carregar stats:', res.status);
                            this.stats.total_falhas = 0;
                            this.stats.total_resultados = 0;
                            this.stats.total_priorizadas = 0;
                            this.stats.total_pendentes = 0;
                            this.stats.total_processando = 0;
                            this.stats.total_concluidas = 0;
                            this.percentual_processamento = 0;
                        }
                    } catch (e) {
                        console.error('Erro ao carregar stats:', e);
                        this.stats.total_falhas = 0;
                        this.stats.total_resultados = 0;
                        this.stats.total_priorizadas = 0;
                        this.stats.total_pendentes = 0;
                        this.stats.total_processando = 0;
                        this.stats.total_concluidas = 0;
                        this.percentual_processamento = 0;
                    }
                },

                async carregar_dados_pesquisa() {
                    try {
                        const res = await fetch('/api/falhas');
                        const data = await res.json();
                        const tbody = document.getElementById('tabela-falhas');
                        if (data.dados && Array.isArray(data.dados)) {
                            tbody.innerHTML = data.dados.map(falha => {
                                // Determinar cor do score tipo sem√°foro (traffic light)
                                // Verde > 50, Amarelo 25-50, Vermelho < 25
                                const score = falha.confidence_medio || 0;
                                let scoreColor, scoreBg, scoreText;

                                if (score === 0) {
                                    scoreColor = 'text-gray-500';
                                    scoreBg = 'bg-gray-100';
                                    scoreText = 'N/A';
                                } else if (score > 0.5) {
                                    scoreColor = 'text-green-700';
                                    scoreBg = 'bg-green-100';
                                    scoreText = (score * 100).toFixed(0);
                                } else if (score >= 0.25) {
                                    scoreColor = 'text-yellow-700';
                                    scoreBg = 'bg-yellow-100';
                                    scoreText = (score * 100).toFixed(0);
                                } else {
                                    scoreColor = 'text-red-700';
                                    scoreBg = 'bg-red-100';
                                    scoreText = (score * 100).toFixed(0);
                                }

                                // Calcular percentual de progresso real das pesquisas
                                const totalEsperado = Math.max(falha.total_buscas_enfileiradas || 0, falha.max_searches || 0);
                                const percentualProgresso = totalEsperado > 0
                                    ? Math.min(((falha.searches_completed || 0) / totalEsperado) * 100, 100)
                                    : 0;

                                return `
                                <tr class="border-b hover:bg-blue-50 cursor-pointer" onclick="window.app.abrir_modal_resultados_pesquisa(${falha.id}, '${falha.titulo.replace(/'/g, "\\'")}', '${falha.pilar}')">
                                    <td class="px-6 py-4 text-sm">${falha.id}</td>
                                    <td class="px-6 py-4 text-sm font-medium">${falha.titulo}</td>
                                    <td class="px-6 py-4 text-sm"><span class="bg-blue-100 text-blue-800 px-3 py-1 rounded">${falha.pilar}</span></td>
                                    <td class="px-6 py-4 text-sm">
                                        <div class="w-full bg-gray-200 rounded h-2">
                                            <div class="bg-blue-600 h-2 rounded" style="width: ${percentualProgresso}%"></div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-sm">
                                        <div class="flex items-center gap-2 justify-end">
                                            <span class="font-medium whitespace-nowrap text-blue-600">${falha.total_resultados || 0}</span>
                                            <span class="font-bold ${scoreColor} ${scoreBg} px-3 py-1 rounded-full text-xs whitespace-nowrap min-w-[50px] text-center">${scoreText}</span>
                                        </div>
                                    </td>
                                </tr>
                            `;
                            }).join('');
                        }
                    } catch (e) {
                        console.error('Erro ao carregar falhas', e);
                    }
                },

                async abrir_modal_resultados_pesquisa(falha_id, titulo, pilar) {
                    this.falha_selecionada_resultados = {
                        id: falha_id,
                        titulo: titulo,
                        pilar: pilar
                    };
                    this.modal_resultados_pesquisa_aberto = true;
                    await this.carregar_resultados_pesquisa(falha_id, 1);
                },

                async carregar_resultados_pesquisa(falha_id, page = 1) {
                    this.carregando_resultados_pesquisa = true;
                    try {
                        // Carregar TODOS os resultados de uma vez (page_size=10000)
                        const res = await fetch(`/api/falhas/${falha_id}/resultados?page=1&page_size=10000`);
                        if (!res.ok) {
                            throw new Error(`Erro ${res.status}: ${await res.text()}`);
                        }
                        const data = await res.json();
                        this.resultados_pesquisa = data.resultados || [];
                        this.paginacao_resultados_pesquisa = {
                            page: 1,
                            total_pages: 1,
                            total: data.total,
                            has_next: false,
                            has_prev: false
                        };
                        // Aplicar filtros iniciais
                        this.aplicar_filtros_resultados();
                    } catch (e) {
                        console.error('Erro ao carregar resultados:', e);
                        this.mostrar_notificacao('Erro ao carregar resultados: ' + e.message, 'erro');
                        this.resultados_pesquisa = [];
                        this.resultados_pesquisa_filtrados = [];
                    } finally {
                        this.carregando_resultados_pesquisa = false;
                    }
                },

                aplicar_filtros_resultados() {
                    let resultados = [...this.resultados_pesquisa];

                    // 1. Filtro de busca (busca em t√≠tulo, descri√ß√£o e tradu√ß√µes)
                    if (this.busca_resultados_pesquisa.trim()) {
                        const busca = this.busca_resultados_pesquisa.toLowerCase();
                        resultados = resultados.filter(r => {
                            return (r.titulo && r.titulo.toLowerCase().includes(busca)) ||
                                   (r.descricao && r.descricao.toLowerCase().includes(busca)) ||
                                   (r.titulo_pt && r.titulo_pt.toLowerCase().includes(busca)) ||
                                   (r.descricao_pt && r.descricao_pt.toLowerCase().includes(busca)) ||
                                   (r.titulo_en && r.titulo_en.toLowerCase().includes(busca)) ||
                                   (r.descricao_en && r.descricao_en.toLowerCase().includes(busca));
                        });
                    }

                    // 2. Filtro de idiomas (m√∫ltiplos)
                    if (this.filtro_idiomas_resultados.length > 0) {
                        resultados = resultados.filter(r =>
                            r.idioma && this.filtro_idiomas_resultados.includes(r.idioma.toLowerCase())
                        );
                    }

                    // 3. Filtro de ferramentas (m√∫ltiplos)
                    if (this.filtro_ferramentas_resultados.length > 0) {
                        resultados = resultados.filter(r =>
                            r.ferramenta_origem && this.filtro_ferramentas_resultados.includes(r.ferramenta_origem.toLowerCase())
                        );
                    }

                    // 4. Filtro de score (range)
                    const score_min = this.filtro_score_min_resultados / 100;
                    const score_max = this.filtro_score_max_resultados / 100;
                    resultados = resultados.filter(r =>
                        r.confidence_score >= score_min && r.confidence_score <= score_max
                    );

                    // 5. Ordena√ß√£o
                    switch (this.ordenacao_resultados) {
                        case 'score_desc':
                            resultados.sort((a, b) => (b.confidence_score || 0) - (a.confidence_score || 0));
                            break;
                        case 'score_asc':
                            resultados.sort((a, b) => (a.confidence_score || 0) - (b.confidence_score || 0));
                            break;
                        case 'idioma':
                            resultados.sort((a, b) => (a.idioma || '').localeCompare(b.idioma || ''));
                            break;
                        case 'pais':
                            resultados.sort((a, b) => (a.pais_origem || '').localeCompare(b.pais_origem || ''));
                            break;
                    }

                    this.resultados_pesquisa_filtrados = resultados;

                    // Calcular pagina√ß√£o local
                    this.paginacao_local.total_filtrados = resultados.length;
                    this.paginacao_local.total_pages = Math.ceil(resultados.length / this.paginacao_local.page_size);

                    // Ajustar p√°gina atual se necess√°rio
                    if (this.paginacao_local.page > this.paginacao_local.total_pages && this.paginacao_local.total_pages > 0) {
                        this.paginacao_local.page = this.paginacao_local.total_pages;
                    }
                    if (this.paginacao_local.page < 1) {
                        this.paginacao_local.page = 1;
                    }

                    // Calcular has_next e has_prev
                    this.paginacao_local.has_next = this.paginacao_local.page < this.paginacao_local.total_pages;
                    this.paginacao_local.has_prev = this.paginacao_local.page > 1;

                    // Paginar resultados
                    const inicio = (this.paginacao_local.page - 1) * this.paginacao_local.page_size;
                    const fim = inicio + this.paginacao_local.page_size;
                    this.resultados_pesquisa_paginados = resultados.slice(inicio, fim);
                },

                limpar_filtros_resultados() {
                    this.busca_resultados_pesquisa = '';
                    this.filtro_idiomas_resultados = [];
                    this.filtro_ferramentas_resultados = [];
                    this.filtro_score_min_resultados = 0;
                    this.filtro_score_max_resultados = 100;
                    this.ordenacao_resultados = 'score_desc';
                    this.paginacao_local.page = 1;
                    this.aplicar_filtros_resultados();
                },

                mudar_pagina_local(nova_pagina) {
                    if (nova_pagina >= 1 && nova_pagina <= this.paginacao_local.total_pages) {
                        this.paginacao_local.page = nova_pagina;
                        this.aplicar_filtros_resultados();
                    }
                },

                async mudar_pagina_resultados_pesquisa(nova_pagina) {
                    if (this.falha_selecionada_resultados) {
                        await this.carregar_resultados_pesquisa(this.falha_selecionada_resultados.id, nova_pagina);
                    }
                },

                fechar_modal_resultados_pesquisa() {
                    this.modal_resultados_pesquisa_aberto = false;
                    this.falha_selecionada_resultados = null;
                    this.resultados_pesquisa = [];
                    this.resultados_pesquisa_filtrados = [];
                    this.resultados_pesquisa_paginados = [];
                    this.paginacao_resultados_pesquisa = {
                        page: 1,
                        total_pages: 1,
                        total: 0,
                        has_next: false,
                        has_prev: false
                    };
                    this.paginacao_local = {
                        page: 1,
                        page_size: 20,
                        total_filtrados: 0,
                        total_pages: 1,
                        has_next: false,
                        has_prev: false
                    };
                    // Limpar filtros
                    this.busca_resultados_pesquisa = '';
                    this.filtro_idiomas_resultados = [];
                    this.filtro_ferramentas_resultados = [];
                    this.filtro_score_min_resultados = 0;
                    this.filtro_score_max_resultados = 100;
                    this.ordenacao_resultados = 'score_desc';
                    this.mostrar_filtros_resultados = false;
                },

                async traduzir_resultado(resultado) {
                    try {
                        // Marcar como traduzindo
                        resultado._traduzindo = true;

                        // Chamar endpoint de tradu√ß√£o
                        const response = await fetch(`/api/resultados/${resultado.id}/traduzir`, {
                            method: 'POST'
                        });

                        if (!response.ok) {
                            throw new Error('Erro ao traduzir resultado');
                        }

                        const data = await response.json();

                        // Atualizar resultado com tradu√ß√µes
                        resultado.titulo_pt = data.titulo_pt;
                        resultado.descricao_pt = data.descricao_pt;
                        resultado._traduzindo = false;

                        // Reaplica filtros para atualizar a exibi√ß√£o
                        this.aplicar_filtros_resultados();

                    } catch (erro) {
                        console.error('Erro ao traduzir resultado:', erro);
                        alert('Erro ao traduzir resultado. Tente novamente.');
                        resultado._traduzindo = false;
                    }
                },

                async atualizar_idioma_resultado(resultado, novo_idioma) {
                    try {
                        // Se j√° √© o mesmo idioma, n√£o faz nada
                        if (resultado.idioma === novo_idioma) {
                            return;
                        }

                        // Chamar endpoint para atualizar idioma
                        const response = await fetch(`/resultados/${resultado.id}/idioma?idioma=${novo_idioma}`, {
                            method: 'PATCH'
                        });

                        if (!response.ok) {
                            throw new Error('Erro ao atualizar idioma');
                        }

                        const data = await response.json();

                        // Atualizar resultado localmente
                        resultado.idioma = data.idioma;

                        // Reaplica filtros para atualizar a exibi√ß√£o
                        this.aplicar_filtros_resultados();

                        // Mostrar mensagem de sucesso
                        console.log(`Idioma atualizado para ${novo_idioma.toUpperCase()}`);

                    } catch (erro) {
                        console.error('Erro ao atualizar idioma:', erro);
                        alert('Erro ao atualizar idioma. Tente novamente.');
                    }
                },

                async refazer_traducao_resultado(resultado) {
                    try {
                        // Marcar como retraduzindo
                        resultado._retraduzindo = true;

                        // Limpar tradu√ß√µes anteriores localmente
                        resultado.titulo_pt = null;
                        resultado.descricao_pt = null;

                        // Limpar tradu√ß√µes no banco para for√ßar nova tradu√ß√£o
                        const clearResponse = await fetch(`/api/resultados/${resultado.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                titulo_pt: '',
                                descricao_pt: ''
                            })
                        });

                        if (!clearResponse.ok) {
                            throw new Error('Erro ao limpar tradu√ß√µes anteriores');
                        }

                        // Aguardar um momento para garantir que o banco foi atualizado
                        await new Promise(resolve => setTimeout(resolve, 200));

                        // Chamar endpoint de tradu√ß√£o novamente
                        const response = await fetch(`/api/resultados/${resultado.id}/traduzir`, {
                            method: 'POST'
                        });

                        if (!response.ok) {
                            throw new Error('Erro ao refazer tradu√ß√£o');
                        }

                        const data = await response.json();

                        // Atualizar resultado com novas tradu√ß√µes
                        resultado.titulo_pt = data.titulo_pt;
                        resultado.descricao_pt = data.descricao_pt;
                        resultado._retraduzindo = false;

                        // Reaplica filtros para atualizar a exibi√ß√£o
                        this.aplicar_filtros_resultados();

                        console.log('Tradu√ß√£o refeita com sucesso');

                    } catch (erro) {
                        console.error('Erro ao refazer tradu√ß√£o:', erro);
                        alert('Erro ao refazer tradu√ß√£o. Tente novamente.');
                        resultado._retraduzindo = false;
                    }
                },

                async salvar_edicao_titulo(resultado, titulo_editado) {
                    try {
                        if (!titulo_editado || titulo_editado.trim() === '') {
                            alert('O t√≠tulo n√£o pode estar vazio');
                            return;
                        }

                        // Atualizar no backend
                        const response = await fetch(`/resultados/${resultado.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                titulo_pt: titulo_editado.trim()
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Erro ao salvar edi√ß√£o');
                        }

                        // Atualizar localmente
                        resultado.titulo_pt = titulo_editado.trim();

                        // Reaplica filtros
                        this.aplicar_filtros_resultados();

                        console.log('Edi√ß√£o salva com sucesso');

                    } catch (erro) {
                        console.error('Erro ao salvar edi√ß√£o:', erro);
                        alert('Erro ao salvar edi√ß√£o. Tente novamente.');
                    }
                },

                async carregar_dados_priorizacao() {
                    await this.carregar_priorizacoes();
                    await this.carregar_matriz();
                },

                async carregar_priorizacoes() {
                    try {
                        console.log('[DEBUG] Carregando prioriza√ß√µes...');
                        const res = await fetch('/api/priorizacoes/');
                        if (!res.ok) {
                            console.log('[DEBUG] Erro ao carregar prioriza√ß√µes:', res.status);
                            return;
                        }
                        const data = await res.json();
                        console.log('[DEBUG] Prioriza√ß√µes carregadas:', data.dados?.length || 0);
                        const tbody = document.getElementById('tabela-priorizacao');
                        if (data.dados && Array.isArray(data.dados)) {
                            // Ordenar por falha_id (mesma ordem da aba Pesquisa)
                            const priorizacoesOrdenadas = data.dados.sort((a, b) => a.falha_id - b.falha_id);

                            // Armazenar dados para ordena√ß√£o
                            this.priorizacoes_dados = priorizacoesOrdenadas;

                            // Renderizar tabela
                            this.renderizar_tabela_priorizacao();
                        } else {
                            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Nenhuma prioriza√ß√£o encontrada</td></tr>';
                        }
                    } catch (e) {
                        console.error('[DEBUG] Erro ao carregar prioriza√ß√µes', e);
                    }
                },

                renderizar_tabela_priorizacao() {
                    const tbody = document.getElementById('tabela-priorizacao');
                    if (!this.priorizacoes_dados || !Array.isArray(this.priorizacoes_dados)) return;

                    tbody.innerHTML = this.priorizacoes_dados.map(p => {
                        const quadrante = this.obter_quadrante(p.impacto, p.esforco);
                        const destacada = p.destacada === 1 || p.destacada === true;
                        const rowClass = destacada ? 'border-b hover:bg-amber-50 bg-amber-50' : 'border-b hover:bg-blue-50';
                        const titleClass = destacada ? 'font-bold text-gray-900' : 'font-medium';
                        return `
                            <tr class="${rowClass}">
                                <td class="px-6 py-4 text-sm">${p.falha_id}</td>
                                <td class="px-6 py-4 text-sm"><span class="bg-blue-100 text-blue-800 px-3 py-1 rounded font-bold">${p.score || 0}</span></td>
                                <td class="px-6 py-4 text-sm ${titleClass}">${p.titulo}</td>
                                <td class="px-6 py-4 text-sm"><span class="bg-green-100 text-green-800 px-3 py-1 rounded font-bold">${p.impacto}/10</span></td>
                                <td class="px-6 py-4 text-sm"><span class="bg-orange-100 text-orange-800 px-3 py-1 rounded font-bold">${p.esforco}/10</span></td>
                                <td class="px-6 py-4 text-sm"><span class="bg-purple-100 text-purple-800 px-3 py-1 rounded text-xs">${quadrante}</span></td>
                                <td class="px-6 py-4 text-sm">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" data-action="toggle-destaque" data-falha-id="${p.falha_id}" ${destacada ? 'checked' : ''} class="sr-only peer">
                                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                                        <span class="ms-2 text-xs font-medium text-gray-700">Priorizar</span>
                                    </label>
                                </td>
                                <td class="px-6 py-4 text-sm space-x-2">
                                    <button data-action="analisar" data-falha-id="${p.falha_id}" data-titulo="${p.titulo.replace(/"/g, '&quot;')}" class="text-green-600 hover:underline font-medium">üîç Analisar</button>
                                    <button data-action="detalhes" data-falha-id="${p.falha_id}" class="text-blue-600 hover:underline font-medium">Ver Detalhes</button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    // Adicionar event listeners aos bot√µes
                    tbody.querySelectorAll('button[data-action="analisar"]').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const falhaId = parseInt(btn.getAttribute('data-falha-id'));
                            const titulo = btn.getAttribute('data-titulo');
                            this.abrir_modal_analise(falhaId, titulo);
                        });
                    });

                    tbody.querySelectorAll('button[data-action="detalhes"]').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const falhaId = parseInt(btn.getAttribute('data-falha-id'));
                            this.abrir_detalhes_priorizacao(falhaId);
                        });
                    });

                    // Event listeners para o toggle de destaque
                    tbody.querySelectorAll('input[data-action="toggle-destaque"]').forEach(checkbox => {
                        checkbox.addEventListener('change', async (e) => {
                            const falhaId = parseInt(checkbox.getAttribute('data-falha-id'));
                            const destacada = checkbox.checked;
                            await this.toggle_destaque(falhaId, destacada);
                        });
                    });

                    console.log('[DEBUG] Event listeners adicionados aos bot√µes');
                },

                ordenar_priorizacoes(campo) {
                    // Toggle dire√ß√£o se clicar no mesmo campo
                    if (this.ordem_campo === campo) {
                        this.ordem_direcao = this.ordem_direcao === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.ordem_campo = campo;
                        // Score e destacada padr√£o DESC (mostrar maiores/priorizadas primeiro)
                        this.ordem_direcao = (campo === 'score' || campo === 'destacada') ? 'desc' : 'asc';
                    }

                    // Ordenar dados
                    this.priorizacoes_dados.sort((a, b) => {
                        let valA, valB;

                        // Tratamento especial para quadrante (calculado dinamicamente)
                        if (campo === 'quadrante') {
                            valA = this.obter_quadrante(a.impacto, a.esforco);
                            valB = this.obter_quadrante(b.impacto, b.esforco);
                        }
                        // Tratamento especial para destacada (booleano)
                        else if (campo === 'destacada') {
                            valA = (a.destacada === 1 || a.destacada === true) ? 1 : 0;
                            valB = (b.destacada === 1 || b.destacada === true) ? 1 : 0;
                        }
                        // Valores num√©ricos
                        else if (campo === 'id' || campo === 'falha_id' || campo === 'impacto' || campo === 'esforco' || campo === 'score') {
                            valA = parseFloat(a[campo]) || 0;
                            valB = parseFloat(b[campo]) || 0;
                        }
                        // Valores de texto
                        else {
                            valA = a[campo];
                            valB = b[campo];
                        }

                        // Comparar
                        if (valA < valB) return this.ordem_direcao === 'asc' ? -1 : 1;
                        if (valA > valB) return this.ordem_direcao === 'asc' ? 1 : -1;
                        return 0;
                    });

                    // Re-renderizar tabela
                    this.renderizar_tabela_priorizacao();
                },

                async toggle_destaque(falhaId, destacada) {
                    try {
                        const res = await fetch(`/api/priorizacoes/${falhaId}/destaque`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ destacada })
                        });

                        if (!res.ok) {
                            throw new Error('Erro ao atualizar destaque');
                        }

                        // Atualizar dados locais
                        const priorizacao = this.priorizacoes_dados.find(p => p.falha_id === falhaId);
                        if (priorizacao) {
                            priorizacao.destacada = destacada ? 1 : 0;
                        }

                        // Re-renderizar tabela e matriz
                        this.renderizar_tabela_priorizacao();
                        await this.carregar_matriz();

                        console.log(`[DEBUG] Destaque ${destacada ? 'ativado' : 'desativado'} para falha ${falhaId}`);
                    } catch (error) {
                        console.error('[ERROR] Erro ao alternar destaque:', error);
                        alert('Erro ao atualizar prioriza√ß√£o');
                        // Reverter o checkbox em caso de erro
                        const checkbox = document.querySelector(`input[data-falha-id="${falhaId}"][data-action="toggle-destaque"]`);
                        if (checkbox) checkbox.checked = !destacada;
                    }
                },

                contar_priorizadas() {
                    if (!this.priorizacoes_dados || !Array.isArray(this.priorizacoes_dados)) {
                        return 0;
                    }
                    return this.priorizacoes_dados.filter(p => p.destacada === 1 || p.destacada === true).length;
                },

            async carregar_matriz() {
                    console.log('[MATRIZ] Iniciando carregamento da matriz...');
                    try {
                        const res = await fetch('/api/priorizacoes/matriz/quadrantes');
                        if (!res.ok) {
                            console.error('[MATRIZ] Erro ao buscar quadrantes:', res.status);
                            return;
                        }
                        const data = await res.json();
                        console.log('[MATRIZ] Quadrantes recebidos:', data);

                        // Renderizar quadrantes
                        this.renderizar_quadrante('quick_wins', data.quick_wins.dados);
                        this.renderizar_quadrante('strategic', data.strategic.dados);
                        this.renderizar_quadrante('fill_in', data.fill_in.dados);
                        this.renderizar_quadrante('low_priority', data.low_priority.dados);

                        // Renderizar gr√°fico
                        this.renderizar_grafico(data);
                    } catch (e) {
                        console.error('[MATRIZ] Erro ao carregar matriz:', e);
                    }
                },

                renderizar_quadrante(quadrante, falhas) {
                    // Converter underscore para h√≠fen (quick_wins -> quick-wins)
                    const quadranteId = quadrante.replace(/_/g, '-');
                    const el = document.getElementById(`quadrante-${quadranteId}`);
                    if (!el) {
                        console.error(`[QUADRANTE] Elemento n√£o encontrado: quadrante-${quadranteId}`);
                        return;
                    }
                    if (!falhas || falhas.length === 0) {
                        el.innerHTML = '<li class="text-sm text-gray-600">Nenhuma falha neste quadrante</li>';
                    } else {
                        // Ordenar por score (maior primeiro)
                        const falhasOrdenadas = [...falhas].sort((a, b) => (b.score || 0) - (a.score || 0));
                        el.innerHTML = falhasOrdenadas.map(f => {
                            const destacada = f.destacada === 1 || f.destacada === true;
                            const fontWeight = destacada ? 'font-bold' : '';
                            return `<li class="text-sm ${fontWeight} cursor-pointer hover:text-blue-600" onclick="window.app.abrir_detalhes_priorizacao(${f.falha_id})">‚Ä¢ #${f.falha_id} (${f.score || 0}) ${f.titulo}</li>`;
                        }).join('');
                    }
                },

                async renderizar_grafico(data, tentativa = 0) {
                    const canvas = document.getElementById('canvas-matriz');
                    if (!canvas) {
                        console.error('[MATRIZ] Canvas n√£o encontrado');
                        return;
                    }

                    // Verificar se canvas est√° vis√≠vel (com limite de tentativas)
                    if (canvas.offsetParent === null) {
                        if (tentativa < 20) {
                            console.warn(`[MATRIZ] Canvas est√° oculto, aguardando... (tentativa ${tentativa + 1}/20)`);
                            setTimeout(() => this.renderizar_grafico(data, tentativa + 1), 100);
                            return;
                        } else {
                            console.error('[MATRIZ] Canvas permanece oculto ap√≥s 20 tentativas');
                            return;
                        }
                    }

                    // For√ßar dimens√µes do canvas para compatibilidade com navegadores
                    const container = canvas.parentElement;
                    if (container) {
                        const containerWidth = container.offsetWidth;
                        const containerHeight = container.offsetHeight;
                        canvas.width = containerWidth;
                        canvas.height = containerHeight;
                        console.log(`[MATRIZ] Canvas dimens√µes: ${containerWidth}x${containerHeight}`);
                    }

                    const ctx = canvas.getContext('2d');
                    if (!ctx) {
                        console.error('[MATRIZ] N√£o foi poss√≠vel obter contexto 2D do canvas');
                        return;
                    }
                    console.log('[MATRIZ] Iniciando renderiza√ß√£o do gr√°fico...');

                    try {
                        const res = await fetch('/api/priorizacoes/matriz/dados');
                        if (!res.ok) {
                            console.error('[MATRIZ] Erro ao buscar dados:', res.status);
                            return;
                        }
                        const matrizData = await res.json();
                        console.log('[MATRIZ] Dados recebidos:', matrizData.total, 'falhas');

                        // Mapa de cores por pilar
                        const coresPilares = {
                            '1. Talento': '#EF4444',              // Vermelho
                            '2. Densidade': '#F59E0B',            // Laranja
                            '3. Impacto e Diversidade': '#10B981', // Verde
                            '4. Acesso a Mercado': '#3B82F6',     // Azul
                            '5. Cultura': '#8B5CF6',              // Roxo
                            '6. Regula√ß√£o': '#EC4899',            // Rosa
                            '7. Capital': '#06B6D4'               // Ciano
                        };

                        // Detectar overlaps e aplicar jitter
                        const posicaoMap = {}; // Mapeia "x,y" -> array de falhas
                        matrizData.dados.forEach(falha => {
                            const chave = `${falha.esforco},${falha.impacto}`;
                            if (!posicaoMap[chave]) {
                                posicaoMap[chave] = [];
                            }
                            posicaoMap[chave].push(falha);
                        });

                        console.log('[MATRIZ] Detectados', Object.keys(posicaoMap).length, 'posi√ß√µes √∫nicas');

                        // Aplicar jitter e agrupar por pilar
                        const datasetsPorPilar = {};
                        matrizData.dados.forEach(falha => {
                            const chave = `${falha.esforco},${falha.impacto}`;
                            const falhasNaPosicao = posicaoMap[chave];

                            // Aplicar jitter se houver m√∫ltiplas falhas na mesma posi√ß√£o
                            let x = falha.esforco;
                            let y = falha.impacto;

                            if (falhasNaPosicao.length > 1) {
                                const indice = falhasNaPosicao.indexOf(falha);
                                const jitterAmount = 0.12;

                                // Distribuir em c√≠rculo ao redor da posi√ß√£o original
                                const angulo = (indice / falhasNaPosicao.length) * 2 * Math.PI;
                                x += Math.cos(angulo) * jitterAmount;
                                y += Math.sin(angulo) * jitterAmount;
                            }

                            const pilar = falha.pilar;
                            const destacada = falha.destacada === 1 || falha.destacada === true;

                            if (!datasetsPorPilar[pilar]) {
                                datasetsPorPilar[pilar] = {
                                    label: pilar,
                                    data: [],
                                    backgroundColor: coresPilares[pilar] || '#6B7280',
                                    borderColor: [], // Array para permitir cores diferentes por ponto
                                    borderWidth: [], // Array para permitir larguras diferentes por ponto
                                    pointRadius: 8,
                                    pointHoverRadius: 12,
                                    falhasData: [], // Guardar dados completos das falhas
                                    posicaoOriginal: [] // Guardar posi√ß√£o original sem jitter
                                };
                            }

                            datasetsPorPilar[pilar].data.push({ x, y });
                            datasetsPorPilar[pilar].falhasData.push(falha);
                            datasetsPorPilar[pilar].posicaoOriginal.push({
                                x: falha.esforco,
                                y: falha.impacto
                            });
                            // Adicionar borda destacada para falhas priorizadas (PRETA para destacadas)
                            datasetsPorPilar[pilar].borderColor.push(destacada ? '#000000' : (coresPilares[pilar] || '#6B7280'));
                            datasetsPorPilar[pilar].borderWidth.push(destacada ? 4 : 2);
                        });

                        // Armazenar mapa de posi√ß√µes para uso no tooltip
                        this.posicaoMapMatriz = posicaoMap;

                        const datasets = Object.values(datasetsPorPilar);
                        console.log('[MATRIZ] Datasets criados:', datasets.length, 'pilares');

                        if (this.chartMatriz) {
                            console.log('[MATRIZ] Destruindo gr√°fico anterior');
                            this.chartMatriz.destroy();
                        }

                        // Registrar plugin customizado para quadrantes
                        const quadrantPlugin = {
                            id: 'backgroundQuadrants',
                            beforeDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                const chartArea = chart.chartArea;
                                const xScale = chart.scales.x;
                                const yScale = chart.scales.y;

                                if (!chartArea) return;

                                // Salvar estado do contexto
                                ctx.save();

                                // Definir ponto de divis√£o (meio da matriz)
                                const xMid = xScale.getPixelForValue(5);
                                const yMid = yScale.getPixelForValue(5);

                                // Q1: GANHOS R√ÅPIDOS (Alto Impacto, Baixo Esfor√ßo) - Verde claro
                                ctx.fillStyle = 'rgba(16, 185, 129, 0.08)'; // Verde
                                ctx.fillRect(
                                    chartArea.left,
                                    chartArea.top,
                                    xMid - chartArea.left,
                                    yMid - chartArea.top
                                );

                                // Q2: INVESTIR COM CAUTELA (Alto Impacto, Alto Esfor√ßo) - Amarelo claro
                                ctx.fillStyle = 'rgba(245, 158, 11, 0.08)'; // Amarelo
                                ctx.fillRect(
                                    xMid,
                                    chartArea.top,
                                    chartArea.right - xMid,
                                    yMid - chartArea.top
                                );

                                // Q3: BAIXA PRIORIDADE (Baixo Impacto, Baixo Esfor√ßo) - Cinza claro
                                ctx.fillStyle = 'rgba(156, 163, 175, 0.08)'; // Cinza
                                ctx.fillRect(
                                    chartArea.left,
                                    yMid,
                                    xMid - chartArea.left,
                                    chartArea.bottom - yMid
                                );

                                // Q4: CONSIDERAR (Baixo Impacto, Alto Esfor√ßo) - Vermelho claro
                                ctx.fillStyle = 'rgba(239, 68, 68, 0.08)'; // Vermelho
                                ctx.fillRect(
                                    xMid,
                                    yMid,
                                    chartArea.right - xMid,
                                    chartArea.bottom - yMid
                                );

                                // Restaurar estado do contexto
                                ctx.restore();
                            }
                        };

                        console.log('[MATRIZ] Criando novo gr√°fico Chart.js...');
                        this.chartMatriz = new Chart(ctx, {
                            type: 'scatter',
                            data: { datasets },
                            plugins: [quadrantPlugin],
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                aspectRatio: 1, // For√ßar aspecto quadrado
                                // Configura√ß√µes adicionais para compatibilidade com navegadores
                                devicePixelRatio: window.devicePixelRatio || 1,
                                animation: {
                                    duration: 0 // Desabilitar anima√ß√£o inicial para renderiza√ß√£o mais r√°pida
                                },
                                layout: {
                                    padding: {
                                        top: 20,
                                        right: 20,
                                        bottom: 20,
                                        left: 20
                                    }
                                },
                                // Permitir que pontos vazem para fora do gr√°fico
                                clip: false,
                                onClick: (event, elements) => {
                                    if (elements.length > 0) {
                                        const element = elements[0];
                                        const datasetIndex = element.datasetIndex;
                                        const dataIndex = element.index;
                                        const dataset = this.chartMatriz.data.datasets[datasetIndex];
                                        const falha = dataset.falhasData[dataIndex];
                                        const posicaoOriginal = dataset.posicaoOriginal[dataIndex];
                                        const chave = `${posicaoOriginal.x},${posicaoOriginal.y}`;
                                        const falhasNaPosicao = this.posicaoMapMatriz[chave] || [falha];

                                        // Se houver m√∫ltiplas falhas, mostrar a primeira
                                        // (usu√°rio pode ver todas no tooltip ao passar o mouse)
                                        const falhaParaAbrir = falhasNaPosicao[0];
                                        this.abrir_detalhes_priorizacao(falhaParaAbrir.falha_id);
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'bottom',
                                        labels: {
                                            usePointStyle: true,
                                            pointStyle: 'circle',
                                            padding: 15,
                                            font: { size: 11 }
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Matriz de Prioriza√ß√£o (Impacto vs Esfor√ßo)',
                                        font: { size: 16, weight: 'bold' },
                                        padding: { top: 10, bottom: 20 }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            title: (context) => {
                                                const datasetIndex = context[0].datasetIndex;
                                                const dataIndex = context[0].dataIndex;
                                                const dataset = context[0].chart.data.datasets[datasetIndex];
                                                const pilarAtual = dataset.label; // Nome do pilar do dataset
                                                const posicaoOriginal = dataset.posicaoOriginal[dataIndex];
                                                const chave = `${posicaoOriginal.x},${posicaoOriginal.y}`;
                                                const todasFalhasNaPosicao = this.posicaoMapMatriz[chave] || [];

                                                // Filtrar apenas as falhas do pilar atual e remover duplicatas por ID
                                                const falhasDoPilar = todasFalhasNaPosicao
                                                    .filter(f => f.pilar === pilarAtual)
                                                    .filter((falha, index, self) =>
                                                        index === self.findIndex(f => f.falha_id === falha.falha_id)
                                                    );

                                                if (falhasDoPilar.length > 1) {
                                                    return `${falhasDoPilar.length} falhas de ${pilarAtual} (Impacto: ${posicaoOriginal.y}, Esfor√ßo: ${posicaoOriginal.x})`;
                                                } else {
                                                    const falha = dataset.falhasData[dataIndex];
                                                    return falha.titulo;
                                                }
                                            },
                                            label: (context) => {
                                                const datasetIndex = context.datasetIndex;
                                                const dataIndex = context.dataIndex;
                                                const dataset = context.chart.data.datasets[datasetIndex];
                                                const pilarAtual = dataset.label; // Nome do pilar do dataset
                                                const posicaoOriginal = dataset.posicaoOriginal[dataIndex];
                                                const chave = `${posicaoOriginal.x},${posicaoOriginal.y}`;
                                                const todasFalhasNaPosicao = this.posicaoMapMatriz[chave] || [];

                                                // Filtrar apenas as falhas do pilar atual e remover duplicatas por ID
                                                const falhasDoPilar = todasFalhasNaPosicao
                                                    .filter(f => f.pilar === pilarAtual)
                                                    .filter((falha, index, self) =>
                                                        index === self.findIndex(f => f.falha_id === falha.falha_id)
                                                    );

                                                if (falhasDoPilar.length > 1) {
                                                    // Mostrar apenas as falhas do pilar atual (sem duplicatas)
                                                    const labels = [];
                                                    falhasDoPilar.forEach((f, idx) => {
                                                        labels.push(''); // Linha em branco para separa√ß√£o
                                                        labels.push(`${idx + 1}. ${f.titulo}`);
                                                        labels.push(`   ID: ${f.falha_id}`);
                                                    });
                                                    return labels;
                                                } else {
                                                    const falha = dataset.falhasData[dataIndex];
                                                    return [
                                                        `ID: ${falha.falha_id}`,
                                                        `Score: ${falha.score || 0}`,
                                                        `Impacto: ${falha.impacto}/10`,
                                                        `Esfor√ßo: ${falha.esforco}/10`,
                                                        `Pilar: ${falha.pilar}`
                                                    ];
                                                }
                                            }
                                        },
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        titleFont: { size: 13, weight: 'bold' },
                                        bodyFont: { size: 11 },
                                        padding: 12,
                                        displayColors: false,
                                        maxWidth: 400
                                    }
                                },
                                scales: {
                                    x: {
                                        title: { display: true, text: 'Esfor√ßo (0-10)', font: { size: 14, weight: 'bold' } },
                                        min: 0,
                                        max: 10,
                                        ticks: { stepSize: 1 },
                                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                                    },
                                    y: {
                                        title: { display: true, text: 'Impacto (0-10)', font: { size: 14, weight: 'bold' } },
                                        min: 0,
                                        max: 10,
                                        ticks: { stepSize: 1 },
                                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                                    }
                                }
                            }
                        });
                        console.log('[MATRIZ] ‚úì Gr√°fico criado com sucesso!');

                        // For√ßar renderiza√ß√£o imediata para compatibilidade com navegadores
                        // (especialmente Atlas browser)
                        if (this.chartMatriz) {
                            try {
                                this.chartMatriz.update('none'); // Update sem anima√ß√£o
                                this.chartMatriz.resize(); // For√ßa recalculo de dimens√µes
                                console.log('[MATRIZ] ‚úì Renderiza√ß√£o for√ßada completada');
                            } catch (e) {
                                console.error('[MATRIZ] Erro ao for√ßar renderiza√ß√£o:', e);
                            }
                        }
                    } catch (e) {
                        console.error('[MATRIZ] ‚úó Erro ao renderizar gr√°fico:', e);
                    }
                },

                obter_quadrante(impacto, esforco) {
                    // Usar limiar de 5.0 (ponto m√©dio) para consist√™ncia com a matriz visual
                    if (impacto > 5 && esforco <= 5) return 'üéØ Quick Wins';
                    if (impacto > 5 && esforco > 5) return '‚≠ê Strategic';
                    if (impacto <= 5 && esforco <= 5) return '‚úì Fill-in';
                    return '‚è± Low Priority';
                },

                async solicitar_inicio_pesquisa() {
                    // Mostrar modal de confirma√ß√£o
                    this.modal_confirmacao_pesquisa_aberto = true;
                    this.estimativa_pesquisa_carregando = true;

                    try {
                        // Obter estat√≠sticas atuais
                        const res = await fetch('/api/pesquisas/stats');
                        if (!res.ok) throw new Error('Erro ao obter estat√≠sticas');

                        const stats = await res.json();
                        const total_falhas = stats.total_falhas || 0;
                        const total_pendentes = stats.total_pendentes || 0;

                        // Estimativas baseadas em dados emp√≠ricos
                        const tempo_por_falha = 30; // ~30 segundos por falha
                        const custo_por_falha = 0.01; // ~$0.01 USD por falha (Perplexity API)

                        const tempo_total_segundos = total_pendentes * tempo_por_falha;
                        const custo_total = total_pendentes * custo_por_falha;

                        // Formatar tempo
                        let tempo_formatado;
                        if (tempo_total_segundos < 60) {
                            tempo_formatado = `~${tempo_total_segundos} segundos`;
                        } else if (tempo_total_segundos < 3600) {
                            const minutos = Math.ceil(tempo_total_segundos / 60);
                            tempo_formatado = `~${minutos} minutos`;
                        } else {
                            const horas = Math.floor(tempo_total_segundos / 3600);
                            const minutos = Math.ceil((tempo_total_segundos % 3600) / 60);
                            tempo_formatado = `~${horas}h ${minutos}min`;
                        }

                        this.estimativa_pesquisa = {
                            total_falhas,
                            total_pendentes,
                            tempo_estimado_segundos: tempo_total_segundos,
                            tempo_estimado_formatado: tempo_formatado,
                            custo_estimado_usd: custo_total,
                            custo_estimado_formatado: `$${custo_total.toFixed(2)} USD`,
                            tipo: 'iniciar'
                        };

                    } catch (e) {
                        console.error('Erro ao calcular estimativa:', e);
                        this.modal_confirmacao_pesquisa_aberto = false;
                        this.mostrar_notificacao('Erro ao calcular estimativa: ' + e.message, 'erro');
                    } finally {
                        this.estimativa_pesquisa_carregando = false;
                    }
                },

                async solicitar_reinicio_pesquisa() {
                    // Mostrar modal de confirma√ß√£o
                    this.modal_confirmacao_pesquisa_aberto = true;
                    this.estimativa_pesquisa_carregando = true;

                    try {
                        // Obter estat√≠sticas atuais
                        const res = await fetch('/api/pesquisas/stats');
                        if (!res.ok) throw new Error('Erro ao obter estat√≠sticas');

                        const stats = await res.json();
                        const total_falhas = stats.total_falhas || 0;

                        // Estimativas (reiniciar ir√° pesquisar TODAS as falhas novamente)
                        const tempo_por_falha = 30;
                        const custo_por_falha = 0.01;

                        const tempo_total_segundos = total_falhas * tempo_por_falha;
                        const custo_total = total_falhas * custo_por_falha;

                        let tempo_formatado;
                        if (tempo_total_segundos < 60) {
                            tempo_formatado = `~${tempo_total_segundos} segundos`;
                        } else if (tempo_total_segundos < 3600) {
                            const minutos = Math.ceil(tempo_total_segundos / 60);
                            tempo_formatado = `~${minutos} minutos`;
                        } else {
                            const horas = Math.floor(tempo_total_segundos / 3600);
                            const minutos = Math.ceil((tempo_total_segundos % 3600) / 60);
                            tempo_formatado = `~${horas}h ${minutos}min`;
                        }

                        this.estimativa_pesquisa = {
                            total_falhas,
                            total_pendentes: total_falhas, // Reiniciar = todas
                            tempo_estimado_segundos: tempo_total_segundos,
                            tempo_estimado_formatado: tempo_formatado,
                            custo_estimado_usd: custo_total,
                            custo_estimado_formatado: `$${custo_total.toFixed(2)} USD`,
                            tipo: 'reiniciar'
                        };

                    } catch (e) {
                        console.error('Erro ao calcular estimativa:', e);
                        this.modal_confirmacao_pesquisa_aberto = false;
                        this.mostrar_notificacao('Erro ao calcular estimativa: ' + e.message, 'erro');
                    } finally {
                        this.estimativa_pesquisa_carregando = false;
                    }
                },

                async confirmar_pesquisa() {
                    this.modal_confirmacao_pesquisa_aberto = false;

                    if (this.estimativa_pesquisa?.tipo === 'iniciar') {
                        await this.iniciar_pesquisas();
                    } else if (this.estimativa_pesquisa?.tipo === 'reiniciar') {
                        await this.reiniciar_pesquisas_executar();
                    }
                },

                cancelar_pesquisa() {
                    this.modal_confirmacao_pesquisa_aberto = false;
                    this.estimativa_pesquisa = null;
                },

                async iniciar_pesquisas() {
                    this.pesquisa_iniciando = true;
                    try {
                        const res = await fetch('/api/pesquisas/iniciar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ falhas_ids: 'all' })
                        });
                        if (res.ok) {
                            this.ativo = true;
                            this.mostrar_notificacao('‚úì Pesquisas iniciadas com sucesso!', 'sucesso');
                            setTimeout(() => this.carregar_stats(), 1000);
                        }
                    } catch (e) {
                        this.mostrar_notificacao('‚úó Erro ao iniciar pesquisas: ' + e.message, 'erro');
                    } finally {
                        this.pesquisa_iniciando = false;
                    }
                },

                async pausar_pesquisas() {
                    try {
                        await fetch('/api/pesquisas/pausar', { method: 'POST' });
                        this.ativo = false;
                        this.mostrar_notificacao('‚úì Pesquisa pausada', 'sucesso');
                    } catch (e) {
                        this.mostrar_notificacao('‚úó Erro: ' + e.message, 'erro');
                    }
                },

                async completar_traducoes() {
                    try {
                        // Iniciar tradu√ß√£o em lote via background job
                        const response = await fetch('/api/traducao/lote/iniciar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                max_concurrent: 10  // 10 tradu√ß√µes simult√¢neas
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Erro ao iniciar tradu√ß√£o em lote');
                        }

                        const data = await response.json();
                        this.job_id_traducao = data.job_id;
                        this.completando_traducoes = true;
                        this.progresso_traducao = { total: 0, processados: 0, traduzidas: 0, erros: 0, idiomas_corrigidos: 0 };

                        this.mostrar_notificacao('üåê Tradu√ß√£o em lote iniciada! Acompanhe o progresso...', 'sucesso');

                        // Iniciar polling do progresso
                        this.iniciar_polling_traducao();

                    } catch (e) {
                        this.mostrar_notificacao('‚úó Erro ao completar tradu√ß√µes: ' + e.message, 'erro');
                        this.completando_traducoes = false;
                    }
                },

                async solicitar_refazer_traducoes() {
                    try {
                        this.estimativa_traducao_carregando = true;
                        this.modal_confirmar_traducao_aberto = true;

                        // Solicitar estimativa do backend
                        const response = await fetch('/api/traducao/lote/estimar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                modo: this.modo_traducao,
                                refazer_todas: true
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Erro ao obter estimativa');
                        }

                        const estimativa = await response.json();
                        this.estimativa_traducao = estimativa;

                    } catch (e) {
                        this.mostrar_notificacao('‚úó Erro ao calcular estimativa: ' + e.message, 'erro');
                        this.modal_confirmar_traducao_aberto = false;
                    } finally {
                        this.estimativa_traducao_carregando = false;
                    }
                },

                fechar_modal_traducao() {
                    this.modal_confirmar_traducao_aberto = false;
                    this.estimativa_traducao = null;
                },

                async refazer_todas_traducoes() {
                    try {
                        // Fechar modal
                        this.fechar_modal_traducao();

                        // Iniciar refazimento via background job
                        const response = await fetch('/api/traducao/lote/refazer_todas', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                modo: this.modo_traducao
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Erro ao iniciar refazimento de tradu√ß√µes');
                        }

                        const data = await response.json();
                        this.job_id_traducao = data.job_id;
                        this.refazendo_traducoes = true;
                        this.progresso_traducao = { total: 0, processados: 0, traduzidas: 0, erros: 0, idiomas_corrigidos: 0 };

                        this.mostrar_notificacao('üîÑ Refazendo todas as tradu√ß√µes! Acompanhe o progresso...', 'sucesso');

                        // Iniciar polling do progresso
                        this.iniciar_polling_traducao();

                    } catch (e) {
                        this.mostrar_notificacao('‚úó Erro ao refazer tradu√ß√µes: ' + e.message, 'erro');
                        this.refazendo_traducoes = false;
                    }
                },

                iniciar_polling_traducao() {
                    // Limpar intervalo anterior se existir
                    if (this.intervalo_polling_traducao) {
                        clearInterval(this.intervalo_polling_traducao);
                    }

                    // Polling a cada 1 segundo
                    this.intervalo_polling_traducao = setInterval(async () => {
                        try {
                            const response = await fetch(`/api/traducao/lote/status/${this.job_id_traducao}`);

                            if (!response.ok) {
                                throw new Error('Erro ao obter status da tradu√ß√£o');
                            }

                            const status = await response.json();

                            // Atualizar progresso
                            this.progresso_traducao = {
                                total: status.total || 0,
                                processados: status.processados || 0,
                                traduzidas: status.traduzidas || 0,
                                erros: status.erros || 0,
                                idiomas_corrigidos: status.idiomas_corrigidos || 0
                            };

                            // Verificar se terminou
                            if (status.status === 'concluido') {
                                clearInterval(this.intervalo_polling_traducao);
                                this.intervalo_polling_traducao = null;

                                const era_refazimento = this.refazendo_traducoes;
                                this.completando_traducoes = false;
                                this.refazendo_traducoes = false;

                                // Atualizar stats
                                await this.carregar_stats();

                                // Mensagem customizada para refazimento ou tradu√ß√£o normal
                                let mensagem = `‚úì ${status.total_traduzidas || 0} resultados traduzidos!`;

                                if (era_refazimento && status.total_idiomas_corrigidos > 0) {
                                    mensagem += ` ${status.total_idiomas_corrigidos} idiomas corrigidos!`;
                                }

                                if (status.total_erros > 0) {
                                    mensagem += ` (${status.total_erros} erros)`;
                                }

                                this.mostrar_notificacao(mensagem, 'sucesso');
                            } else if (status.status === 'erro') {
                                clearInterval(this.intervalo_polling_traducao);
                                this.intervalo_polling_traducao = null;
                                this.completando_traducoes = false;
                                this.refazendo_traducoes = false;

                                this.mostrar_notificacao(
                                    '‚úó Erro na tradu√ß√£o: ' + (status.erro || 'Erro desconhecido'),
                                    'erro'
                                );
                            }

                        } catch (e) {
                            console.error('Erro no polling de tradu√ß√£o:', e);
                            clearInterval(this.intervalo_polling_traducao);
                            this.intervalo_polling_traducao = null;
                            this.completando_traducoes = false;
                            this.mostrar_notificacao('‚úó Erro ao acompanhar progresso da tradu√ß√£o', 'erro');
                        }
                    }, 1000); // Poll a cada 1 segundo
                },

                async abrir_modal_reanalisar() {
                    try {
                        // Buscar estimativa de custo e tempo
                        const modo = this.avaliacao_profunda_ativa ? this.modo_avaliacao_profunda : 'gratuito';
                        const num_fontes = this.stats.total_resultados;

                        const response = await fetch(`/api/analise/estimar?num_fontes=${num_fontes}&modo=${modo}`);
                        if (!response.ok) throw new Error('Erro ao obter estimativa');

                        this.estimativa_reanalisar = await response.json();
                        this.modal_reanalisar_aberto = true;
                    } catch (e) {
                        this.mostrar_notificacao('‚úó Erro ao calcular estimativa: ' + e.message, 'erro');
                    }
                },

                async executar_reanalisar() {
                    this.modal_reanalisar_aberto = false;
                    this.reanalisando = true;

                    try {
                        // Iniciar rean√°lise em background
                        const response = await fetch('/api/analise/reanalisar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                avaliar_profundamente: this.avaliacao_profunda_ativa,
                                modo_avaliacao: this.modo_avaliacao_profunda
                            })
                        });

                        if (!response.ok) throw new Error('Erro ao iniciar rean√°lise');

                        const resultado = await response.json();
                        this.progresso_reanalisar.job_id = resultado.job_id;
                        this.progresso_reanalisar.status = 'iniciado';
                        this.progresso_reanalisar.mensagem = 'Iniciando rean√°lise...';

                        // Iniciar polling do progresso
                        this.iniciar_polling_reanalisar();

                    } catch (e) {
                        this.mostrar_notificacao('‚úó Erro ao iniciar rean√°lise: ' + e.message, 'erro');
                        this.reanalisando = false;
                    }
                },

                async iniciar_polling_reanalisar() {
                    // Limpar intervalo anterior se existir
                    if (this.intervalo_polling_reanalisar) {
                        clearInterval(this.intervalo_polling_reanalisar);
                    }

                    // Fazer polling a cada 1 segundo
                    this.intervalo_polling_reanalisar = setInterval(async () => {
                        try {
                            const response = await fetch(`/api/analise/reanalisar/status/${this.progresso_reanalisar.job_id}`);

                            if (!response.ok) {
                                throw new Error('Erro ao obter status da rean√°lise');
                            }

                            const status = await response.json();

                            // Atualizar progresso
                            this.progresso_reanalisar.status = status.status;
                            this.progresso_reanalisar.progresso = status.progresso || 0;
                            this.progresso_reanalisar.total = status.total || 0;
                            this.progresso_reanalisar.processados = status.processados || 0;
                            this.progresso_reanalisar.scores_atualizados = status.scores_atualizados || 0;
                            this.progresso_reanalisar.erros = status.erros || 0;

                            // Atualizar mensagem
                            if (status.status === 'processando') {
                                this.progresso_reanalisar.mensagem = `Processando... ${status.processados}/${status.total} resultados`;
                            } else if (status.status === 'concluido') {
                                this.progresso_reanalisar.mensagem = status.mensagem || 'Rean√°lise conclu√≠da!';
                            } else if (status.status === 'erro') {
                                this.progresso_reanalisar.mensagem = 'Erro na rean√°lise: ' + (status.erro || 'Erro desconhecido');
                            }

                            // Se conclu√≠do ou erro, parar polling
                            if (status.status === 'concluido' || status.status === 'erro') {
                                clearInterval(this.intervalo_polling_reanalisar);
                                this.intervalo_polling_reanalisar = null;
                                this.reanalisando = false;

                                if (status.status === 'concluido') {
                                    this.mostrar_notificacao(
                                        `‚úì Rean√°lise conclu√≠da! ${status.scores_atualizados} scores atualizados, ${status.erros} erros.`,
                                        'sucesso'
                                    );

                                    // Resetar flag de crit√©rios mudados
                                    this.criterios_mudaram = false;

                                    // Recarregar stats ap√≥s 2 segundos
                                    setTimeout(() => {
                                        this.carregar_stats();
                                    }, 2000);
                                } else {
                                    this.mostrar_notificacao(
                                        '‚úó Erro na rean√°lise: ' + (status.erro || 'Erro desconhecido'),
                                        'erro'
                                    );
                                }
                            }

                        } catch (e) {
                            console.error('Erro no polling de rean√°lise:', e);
                            clearInterval(this.intervalo_polling_reanalisar);
                            this.intervalo_polling_reanalisar = null;
                            this.reanalisando = false;
                            this.mostrar_notificacao('‚úó Erro ao acompanhar progresso da rean√°lise', 'erro');
                        }
                    }, 1000); // Poll a cada 1 segundo
                },

                async reiniciar_pesquisas_executar() {
                    try {
                        await fetch('/api/pesquisas/reiniciar', { method: 'POST' });
                        this.mostrar_notificacao('‚úì Pesquisas reiniciadas com sucesso!', 'sucesso');
                        this.carregar_stats();
                    } catch (e) {
                        this.mostrar_notificacao('‚úó Erro: ' + e.message, 'erro');
                    }
                },

                async analisar_todas_falhas() {
                    this.analisando = true;

                    // Inicializar progresso
                    this.progresso_analise = {
                        atual: 0,
                        total: 0,
                        falha_atual: ''
                    };

                    try {
                        // Construir URL com par√¢metros do corpo como query string (EventSource n√£o suporta POST)
                        const params = new URLSearchParams({
                            usar_rag: this.config_analise_lote.usar_rag,
                            usar_resultados_pesquisa: this.config_analise_lote.usar_resultados_pesquisa,
                            temperatura: this.config_analise_lote.temperatura,
                            max_tokens: this.config_analise_lote.max_tokens,
                            modelo: this.config_analise_lote.modelo
                        });

                        // Usar fetch com streaming para receber eventos SSE
                        const response = await fetch('/api/priorizacoes/analisar-todas-stream', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                usar_rag: this.config_analise_lote.usar_rag,
                                usar_resultados_pesquisa: this.config_analise_lote.usar_resultados_pesquisa,
                                temperatura: this.config_analise_lote.temperatura,
                                max_tokens: this.config_analise_lote.max_tokens,
                                modelo: this.config_analise_lote.modelo
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        // Ler stream de eventos
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();

                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n\n');
                            buffer = lines.pop(); // Manter √∫ltima linha incompleta no buffer

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const eventData = JSON.parse(line.substring(6));

                                    if (eventData.tipo === 'inicio') {
                                        this.progresso_analise.total = eventData.total;
                                        console.log(`[SSE] Iniciando an√°lise de ${eventData.total} falhas`);
                                    }
                                    else if (eventData.tipo === 'progresso') {
                                        this.progresso_analise.atual = eventData.atual;
                                        this.progresso_analise.falha_atual = eventData.falha_atual;
                                        console.log(`[SSE] Progresso: ${eventData.atual}/${this.progresso_analise.total}`);
                                    }
                                    else if (eventData.tipo === 'completo') {
                                        console.log('[SSE] An√°lise conclu√≠da');
                                        this.mostrar_notificacao(
                                            `‚úì An√°lise conclu√≠da! ${eventData.analisadas} analisadas, ${eventData.falhadas} falhadas`,
                                            eventData.falhadas > 0 ? 'aviso' : 'sucesso'
                                        );
                                        await this.carregar_priorizacoes();
                                    }
                                    else if (eventData.tipo === 'erro') {
                                        console.error('[SSE] Erro:', eventData.mensagem);
                                        this.mostrar_notificacao(`‚úó Erro: ${eventData.mensagem}`, 'erro');
                                    }
                                }
                            }
                        }

                    } catch (e) {
                        console.error('[ERRO] An√°lise em lote:', e);
                        this.mostrar_notificacao('‚úó Erro: ' + e.message, 'erro');
                    } finally {
                        this.analisando = false;
                        // Resetar progresso ap√≥s 2 segundos
                        setTimeout(() => {
                            this.progresso_analise = { atual: 0, total: 0, falha_atual: '' };
                        }, 2000);
                    }
                },

                abrir_modal_analise(falha_id, titulo) {
                    console.log('[DEBUG] abrir_modal_analise chamado', { falha_id, titulo });
                    this.falha_analise = { id: falha_id, titulo: titulo };
                    this.modal_analise_aberto = true;
                    console.log('[DEBUG] modal_analise_aberto definido como', this.modal_analise_aberto);
                    // Resetar configura√ß√µes para padr√£o
                    this.config_analise = {
                        usar_rag: true,
                        usar_resultados_pesquisa: true,
                        temperatura: 0.3,
                        max_tokens: 4000,
                        modelo: 'google/gemini-2.5-pro'
                    };
                },

                fechar_modal_analise() {
                    this.modal_analise_aberto = false;
                    this.falha_analise = null;
                },

                abrir_config_lote() {
                    this.modal_config_lote_aberto = true;
                },

                fechar_config_lote() {
                    this.modal_config_lote_aberto = false;
                },

                salvar_config_lote() {
                    // Salvar no localStorage para persistir entre sess√µes
                    localStorage.setItem('config_analise_lote', JSON.stringify(this.config_analise_lote));
                    this.mostrar_notificacao('‚úì Configura√ß√µes salvas com sucesso!', 'sucesso');
                    this.fechar_config_lote();
                },

                resetar_filtros_fase1() {
                    // Restaurar valores padr√£o
                    this.filtros_fase1 = {
                        confianca_minima: 0.5,
                        peso_sebrae: 1,
                        tipo_fonte: [],
                        anos_publicacao: 'todos',
                        regiao: [],
                        idioma: [],
                        apenas_com_implementacao: false,
                        apenas_com_metricas: false,
                        limpar_cache: false
                    };
                    this.filtros_fase1_alterados = true;
                    this.mostrar_notificacao('‚úì Filtros restaurados para os valores padr√£o', 'sucesso');
                },

                aplicar_filtros_fase1() {
                    // Salvar filtros no localStorage
                    localStorage.setItem('filtros_fase1', JSON.stringify(this.filtros_fase1));
                    // NOTA: Mantemos filtros_fase1_alterados = true para que o bot√£o "Atualizar Lista" continue destacado
                    // A flag s√≥ ser√° resetada quando a lista for efetivamente atualizada
                    this.mostrar_notificacao('‚úì Filtros salvos! Clique em "Atualizar Lista" para aplic√°-los.', 'sucesso');
                    this.modal_filtros_fase1_aberto = false;

                    // Recarregar fontes de todas as falhas expandidas
                    Object.keys(this.linhas_expandidas_fase1).forEach(falha_id => {
                        if (this.linhas_expandidas_fase1[falha_id]) {
                            this.carregar_fontes_fase1(parseInt(falha_id), 1);
                        }
                    });
                },

                async executar_analise_individual() {
                    console.log('[DEBUG] executar_analise_individual chamado');
                    if (!this.falha_analise) {
                        console.log('[DEBUG] Nenhuma falha selecionada');
                        return;
                    }

                    console.log('[DEBUG] Iniciando an√°lise para falha', this.falha_analise.id);
                    this.analisando_individual = true;

                    try {
                        // Etapa 1: Preparando an√°lise
                        this.progresso_analise = {
                            etapa: 'Preparando',
                            progresso: 10,
                            mensagem: 'Preparando contexto da an√°lise...'
                        };

                        const payload = {
                            falha_id: this.falha_analise.id,
                            usar_rag: this.config_analise.usar_rag,
                            usar_resultados_pesquisa: this.config_analise.usar_resultados_pesquisa,
                            temperatura: this.config_analise.temperatura,
                            max_tokens: this.config_analise.max_tokens,
                            modelo: this.config_analise.modelo
                        };
                        console.log('[DEBUG] Payload:', payload);

                        // Etapa 2: Coletando dados
                        this.progresso_analise = {
                            etapa: 'Coletando',
                            progresso: 30,
                            mensagem: this.config_analise.usar_rag ? 'Buscando na base de conhecimento...' : 'Preparando dados...'
                        };

                        // Etapa 3: Analisando
                        const nomeModelo = this.config_analise.modelo
                            ? this.config_analise.modelo.split('/').pop().replace(':free', '').replace('-', ' ')
                            : 'Gemini 2.5 Pro';
                        this.progresso_analise = {
                            etapa: 'Analisando',
                            progresso: 50,
                            mensagem: `Enviando para an√°lise da IA (${nomeModelo})...`
                        };

                        const res = await fetch('/api/priorizacoes/analisar-individual', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        console.log('[DEBUG] Resposta HTTP:', res.status);

                        // Etapa 4: Processando resposta
                        this.progresso_analise = {
                            etapa: 'Processando',
                            progresso: 75,
                            mensagem: 'Processando resultado da an√°lise...'
                        };

                        if (res.ok) {
                            const data = await res.json();
                            console.log('[DEBUG] Resposta da API:', data);

                            // Etapa 5: Salvando
                            this.progresso_analise = {
                                etapa: 'Salvando',
                                progresso: 90,
                                mensagem: 'Salvando resultado...'
                            };

                            // Pequeno delay para mostrar o progresso
                            await new Promise(resolve => setTimeout(resolve, 500));

                            // Etapa 6: Conclu√≠do
                            this.progresso_analise = {
                                etapa: 'Conclu√≠do',
                                progresso: 100,
                                mensagem: `An√°lise conclu√≠da! Impacto: ${data.impacto}/10, Esfor√ßo: ${data.esforco}/10`
                            };

                            // Aguardar um pouco antes de fechar
                            await new Promise(resolve => setTimeout(resolve, 1000));

                            this.mostrar_notificacao(`‚úì An√°lise da falha #${this.falha_analise.id} conclu√≠da! Impacto: ${data.impacto}/10, Esfor√ßo: ${data.esforco}/10`, 'sucesso');
                            this.fechar_modal_analise();
                            await this.carregar_priorizacoes();
                        } else {
                            let errorMessage = 'Erro desconhecido';
                            try {
                                const error = await res.json();
                                console.log('[DEBUG] Erro da API:', error);
                                errorMessage = error.detail || errorMessage;

                                // Melhorar mensagens de erro espec√≠ficas
                                if (res.status === 429) {
                                    errorMessage = 'Rate limit atingido. O modelo Gemini 2.0 Flash (gratuito) tem limite de requisi√ß√µes. Por favor, aguarde alguns segundos e tente novamente.';
                                } else if (res.status === 500) {
                                    errorMessage = 'Erro no servidor. Verifique os logs para mais detalhes.';
                                } else if (res.status === 422) {
                                    errorMessage = 'Dados inv√°lidos na requisi√ß√£o. Verifique as configura√ß√µes.';
                                }
                            } catch (e) {
                                console.error('[DEBUG] Erro ao parsear resposta de erro:', e);
                            }

                            this.progresso_analise = {
                                etapa: 'Erro',
                                progresso: 0,
                                mensagem: errorMessage
                            };
                            this.mostrar_notificacao('‚úó ' + errorMessage, 'erro');
                        }
                    } catch (e) {
                        console.error('[DEBUG] Exception:', e);
                        this.progresso_analise = {
                            etapa: 'Erro',
                            progresso: 0,
                            mensagem: 'Erro: ' + e.message
                        };
                        this.mostrar_notificacao('‚úó Erro: ' + e.message, 'erro');
                    } finally {
                        this.analisando_individual = false;
                        // Resetar progresso ap√≥s 2 segundos
                        setTimeout(() => {
                            this.progresso_analise = {
                                etapa: '',
                                progresso: 0,
                                mensagem: ''
                            };
                        }, 2000);
                    }
                },

                fechar_duplicados_modal() {
                    this.duplicados_modal_aberto = false;
                    this.arquivos_duplicados = [];
                    this.arquivos_pendentes = null;
                    this.opcao_duplicados = 'ask';
                },

                async proceder_com_upload() {
                    // Fechar modal
                    this.duplicados_modal_aberto = false;

                    // Prosseguir com upload usando a op√ß√£o selecionada
                    if (this.arquivos_pendentes) {
                        await this.executar_upload(this.arquivos_pendentes, this.opcao_duplicados);
                    }

                    // Limpar estado
                    this.arquivos_pendentes = null;
                    this.arquivos_duplicados = [];
                    this.opcao_duplicados = 'ask';
                },

                handleFileDrops(event) {
                    const files = event.dataTransfer.files;
                    if (!files || files.length === 0) return;

                    // Criar um evento sint√©tico compat√≠vel com handleFileUpload
                    const syntheticEvent = {
                        target: { files: files }
                    };

                    this.handleFileUpload(syntheticEvent);
                },

                async handleFileUpload(event) {
                    const files = event.target.files;
                    if (!files || files.length === 0) return;

                    // Primeiro, verificar se h√° duplicados
                    try {
                        const checkFormData = new FormData();
                        for (let file of files) {
                            checkFormData.append('files', file);
                        }

                        const checkRes = await fetch('/api/knowledge-base/check-duplicates', {
                            method: 'POST',
                            body: checkFormData
                        });

                        if (checkRes.ok) {
                            const checkData = await checkRes.json();

                            if (checkData.has_duplicates) {
                                // Mostrar modal de duplicados
                                this.arquivos_duplicados = checkData.duplicates;
                                this.arquivos_pendentes = files;
                                this.duplicados_modal_aberto = true;
                                return;
                            }
                        }
                    } catch (e) {
                        console.error('Erro ao verificar duplicados:', e);
                        // Continuar com upload mesmo em caso de erro na verifica√ß√£o
                    }

                    // Se n√£o h√° duplicados, prosseguir com upload
                    await this.executar_upload(files, 'overwrite');
                },

                async executar_upload(files, overwriteOption) {
                    this.uploading = true;
                    this.upload_progress = 0;
                    this.upload_status = 'Preparando upload...';
                    this.upload_files_status = [];
                    const formData = new FormData();
                    let validFileCount = 0;

                    for (let file of files) {
                        // Validate file type by extension (more reliable)
                        const validExtensions = ['.docx', '.pdf', '.csv', '.md', '.txt'];
                        const hasValidExtension = validExtensions.some(ext => file.name.toLowerCase().endswith(ext));

                        if (!hasValidExtension) {
                            this.mostrar_notificacao(`Arquivo inv√°lido: ${file.name}. Suportados: DOCX, PDF, CSV, Markdown.`, 'erro');
                            this.upload_files_status.push({ name: file.name, status: 'invalid', message: 'Tipo inv√°lido' });
                            continue;
                        }

                        // Validate file size (25MB max)
                        if (file.size > 25 * 1024 * 1024) {
                            this.mostrar_notificacao(`Arquivo muito grande: ${file.name}. M√°ximo 25MB.`, 'erro');
                            this.upload_files_status.push({ name: file.name, status: 'invalid', message: 'Muito grande (>25MB)' });
                            continue;
                        }

                        formData.append('files', file);
                        this.upload_files_status.push({ name: file.name, status: 'pending', message: 'Aguardando...', progress: 0 });
                        validFileCount++;
                    }

                    this.upload_status = `${validFileCount} arquivo(s) v√°lido(s) encontrado(s)`;

                    if (validFileCount === 0) {
                        this.mostrar_notificacao('‚úó Nenhum arquivo v√°lido selecionado', 'erro');
                        this.uploading = false;
                        return;
                    }

                    try {
                        // Usar SSE para progresso em tempo real
                        const xhr = new XMLHttpRequest();
                        let uploadCompleted = false;
                        let processingStarted = false;

                        // Timeout de 5 minutos
                        const uploadTimeout = setTimeout(() => {
                            if (!uploadCompleted) {
                                console.error('Upload timeout after 5 minutes');
                                xhr.abort();
                                this.mostrar_notificacao('‚úó Upload expirou (timeout)', 'erro');
                                this.uploading = false;
                                this.upload_files_status = [];
                                this.upload_status = '';
                            }
                        }, 300000);

                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                const progress = Math.round((e.loaded / e.total) * 100);
                                this.upload_progress = progress;

                                if (progress < 100) {
                                    this.upload_status = `Enviando arquivos... ${progress}%`;
                                    // Atualizar status dos arquivos pendentes para "uploading"
                                    this.upload_files_status = this.upload_files_status.map(f =>
                                        f.status === 'pending' ? { ...f, status: 'uploading', message: 'Enviando...' } : f
                                    );
                                } else {
                                    // Upload completo (100%), aguardando resposta do servidor
                                    this.upload_status = 'Upload conclu√≠do, processando e indexando arquivos...';
                                    this.upload_files_status = this.upload_files_status.map(f =>
                                        (f.status === 'uploading' || f.status === 'pending')
                                            ? { ...f, status: 'processing', message: 'Processando...' }
                                            : f
                                    );
                                }
                            }
                        });

                        xhr.addEventListener('load', () => {
                            clearTimeout(uploadTimeout);
                            uploadCompleted = true;
                            console.log('XHR load event triggered, status:', xhr.status);
                            console.log('Response:', xhr.responseText);

                            if (xhr.status === 200) {
                                try {
                                    const response = JSON.parse(xhr.responseText);
                                    const count = response.total || 0;

                                    // Atualizar status dos arquivos para processando/sucesso
                                    if (response.dados && Array.isArray(response.dados)) {
                                        const uploadedNames = response.dados.map(d => d.nome);
                                        const skippedNames = response.ignorados || [];

                                        this.upload_files_status = this.upload_files_status.map(f => {
                                            if (uploadedNames.includes(f.name)) {
                                                return { ...f, status: 'success', message: 'Indexado com sucesso!' };
                                            } else if (skippedNames.includes(f.name)) {
                                                return { ...f, status: 'error', message: 'Ignorado (duplicado)' };
                                            } else if (f.status === 'uploading' || f.status === 'pending' || f.status === 'processing') {
                                                return { ...f, status: 'error', message: 'N√£o processado pelo servidor' };
                                            }
                                            return f;
                                        });
                                    } else {
                                        // Se n√£o houver detalhes, marcar todos como sucesso
                                        this.upload_files_status = this.upload_files_status.map(f =>
                                            (f.status === 'uploading' || f.status === 'pending' || f.status === 'processing')
                                                ? { ...f, status: 'success', message: 'Indexado!' }
                                                : f
                                        );
                                    }

                                    const skippedCount = response.ignorados ? response.ignorados.length : 0;
                                    let statusMsg = `‚úì ${count} arquivo(s) indexado(s) com sucesso!`;
                                    if (skippedCount > 0) {
                                        statusMsg += ` (${skippedCount} ignorado(s))`;
                                    }
                                    this.upload_status = statusMsg;
                                    this.mostrar_notificacao(statusMsg, 'sucesso');

                                    // Limpar status ap√≥s 3 segundos
                                    setTimeout(() => {
                                        this.upload_files_status = [];
                                        this.upload_status = '';
                                    }, 3000);
                                } catch (e) {
                                    console.error('Failed to parse success response:', e);
                                    this.upload_status = '‚úì Arquivos enviados com sucesso!';
                                    this.mostrar_notificacao('‚úì Arquivos enviados com sucesso!', 'sucesso');
                                    setTimeout(() => {
                                        this.upload_files_status = [];
                                        this.upload_status = '';
                                    }, 3000);
                                }
                                this.carregar_documentos();
                            } else {
                                let errorMsg = xhr.statusText;
                                try {
                                    const response = JSON.parse(xhr.responseText);
                                    if (response.detail) {
                                        errorMsg = response.detail;
                                    } else if (response.mensagem) {
                                        errorMsg = response.mensagem;
                                    }
                                } catch (e) {
                                    console.error('Failed to parse error response:', e);
                                }
                                console.error('Upload failed with status:', xhr.status, 'Error:', errorMsg);
                                this.mostrar_notificacao('‚úó Erro ao enviar arquivos: ' + errorMsg, 'erro');
                            }
                            this.uploading = false;
                            this.upload_progress = 0;
                        });

                        xhr.addEventListener('error', (e) => {
                            clearTimeout(uploadTimeout);
                            uploadCompleted = true;
                            console.error('XHR error event triggered', e);
                            console.error('XHR status:', xhr.status, 'readyState:', xhr.readyState);
                            this.mostrar_notificacao('‚úó Erro de conex√£o ao enviar arquivos', 'erro');
                            this.uploading = false;
                            this.upload_files_status = [];
                            this.upload_status = '';
                        });

                        xhr.addEventListener('abort', () => {
                            clearTimeout(uploadTimeout);
                            if (!uploadCompleted) {
                                console.log('XHR abort event triggered');
                                this.mostrar_notificacao('‚úó Upload cancelado', 'aviso');
                                this.uploading = false;
                                this.upload_files_status = [];
                                this.upload_status = '';
                            }
                        });

                        // Debug: log number of files in FormData
                        const fileCount = Array.from(formData.entries()).filter(([key]) => key === 'files').length;
                        console.log(`Starting upload with ${fileCount} files in FormData, overwrite option: ${overwriteOption}`);
                        console.log('FormData entries:', Array.from(formData.entries()).map(([k, v]) => ({ key: k, fileName: v.name, size: v.size })));

                        // Usar endpoint com streaming de progresso
                        xhr.open('POST', `/api/knowledge-base/upload-stream?overwrite=${overwriteOption}`);
                        xhr.setRequestHeader('Accept', 'text/event-stream');

                        // Processar eventos SSE na medida em que chegam
                        let responseBuffer = '';
                        xhr.addEventListener('readystatechange', () => {
                            if (xhr.readyState === 3) {  // LOADING - dados parciais dispon√≠veis
                                processingStarted = true;
                                const newData = xhr.responseText.substring(responseBuffer.length);
                                responseBuffer = xhr.responseText;

                                // Processar eventos SSE
                                const events = newData.split('\n\n').filter(e => e.trim());
                                events.forEach(eventText => {
                                    if (!eventText.startsWith('data: ')) return;

                                    try {
                                        const jsonData = eventText.substring(6);  // Remove "data: "
                                        const event = JSON.parse(jsonData);

                                        if (event.type === 'start') {
                                            this.upload_status = `Iniciando processamento de ${event.total} arquivo(s)...`;
                                        } else if (event.type === 'progress') {
                                            // Atualizar progresso do arquivo espec√≠fico
                                            const fileIndex = event.file_index;
                                            const phase = event.phase;
                                            const progress = event.progress || 0;
                                            const detail = event.detail || '';

                                            let message = 'Processando...';
                                            if (phase === 'reading') message = 'Lendo arquivo...';
                                            else if (phase === 'extracting') message = 'Extraindo texto...';
                                            else if (phase === 'indexing') {
                                                // Mostrar detalhe do chunk se dispon√≠vel
                                                message = detail || 'Indexando...';
                                            }
                                            else if (phase === 'saving') message = 'Salvando...';
                                            else if (phase === 'complete') message = 'Conclu√≠do!';

                                            if (this.upload_files_status[fileIndex]) {
                                                this.upload_files_status[fileIndex] = {
                                                    ...this.upload_files_status[fileIndex],
                                                    status: phase === 'complete' ? 'success' : 'processing',
                                                    message: `${message} ${progress}%`,
                                                    progress: progress
                                                };
                                            }
                                        } else if (event.type === 'file_complete') {
                                            const result = event.result;
                                            const fileIndex = event.file_index;

                                            if (this.upload_files_status[fileIndex]) {
                                                if (result.status === 'success') {
                                                    this.upload_files_status[fileIndex] = {
                                                        ...this.upload_files_status[fileIndex],
                                                        status: 'success',
                                                        message: 'Indexado com sucesso!',
                                                        progress: 100
                                                    };
                                                } else if (result.status === 'error') {
                                                    this.upload_files_status[fileIndex] = {
                                                        ...this.upload_files_status[fileIndex],
                                                        status: 'error',
                                                        message: result.error || 'Erro',
                                                        progress: 0
                                                    };
                                                } else if (result.status === 'skipped') {
                                                    this.upload_files_status[fileIndex] = {
                                                        ...this.upload_files_status[fileIndex],
                                                        status: 'error',
                                                        message: 'Ignorado (duplicado)',
                                                        progress: 0
                                                    };
                                                }
                                            }
                                        } else if (event.type === 'complete') {
                                            // Processamento completo
                                            const count = event.total || 0;
                                            const skippedCount = event.ignorados ? event.ignorados.length : 0;
                                            let statusMsg = `‚úì ${count} arquivo(s) indexado(s) com sucesso!`;
                                            if (skippedCount > 0) {
                                                statusMsg += ` (${skippedCount} ignorado(s))`;
                                            }
                                            this.upload_status = statusMsg;

                                            // Finalizar upload
                                            this.uploading = false;
                                            this.upload_progress = 0;

                                            // Mostrar notifica√ß√£o apropriada
                                            if (count > 0) {
                                                this.mostrar_notificacao(statusMsg, 'sucesso');
                                            } else if (skippedCount > 0) {
                                                this.mostrar_notificacao(`Todos os ${skippedCount} arquivo(s) foram ignorados (duplicados)`, 'aviso');
                                            }

                                            // Recarregar documentos
                                            this.carregar_documentos();

                                            // Limpar status ap√≥s 3 segundos
                                            setTimeout(() => {
                                                this.upload_files_status = [];
                                                this.upload_status = '';
                                            }, 3000);
                                        }
                                    } catch (e) {
                                        console.error('Erro ao processar evento SSE:', e, eventText);
                                    }
                                });
                            }
                        });

                        xhr.send(formData);
                    } catch (e) {
                        console.error('Upload error:', e);
                        this.mostrar_notificacao('‚úó Erro ao processar upload: ' + e.message, 'erro');
                        this.uploading = false;
                    }
                },

                async carregar_documentos() {
                    try {
                        const res = await fetch('/api/knowledge-base/documentos');
                        if (!res.ok) return;
                        const data = await res.json();

                        if (data.dados && Array.isArray(data.dados)) {
                            this.documentos = data.dados;
                            this.documentos_filtrados = [...this.documentos];
                            this.aplicar_ordenacao();
                            this.renderizar_documentos();
                        } else {
                            this.documentos = [];
                            this.documentos_filtrados = [];
                            this.renderizar_documentos();
                        }
                    } catch (e) {
                        console.error('Erro ao carregar documentos:', e);
                    }
                },

                renderizar_documentos() {
                    const tbody = document.getElementById('tabela-documentos');

                    if (this.documentos_filtrados.length === 0) {
                        const mensagem = this.busca_documentos ? 'Nenhum documento encontrado com essa busca' : 'Nenhum documento enviado';
                        tbody.innerHTML = `<tr class="border-b"><td colspan="6" class="px-6 py-4 text-center text-gray-500">${mensagem}</td></tr>`;
                        return;
                    }

                    tbody.innerHTML = this.documentos_filtrados.map(doc => {
                        const isChecked = this.documentos_selecionados.includes(doc.nome);
                        return `
                        <tr class="border-b hover:bg-blue-50">
                            <td class="px-3 py-4 text-center">
                                <input type="checkbox"
                                       class="checkbox-doc w-4 h-4 cursor-pointer"
                                       data-filename="${doc.nome}"
                                       ${isChecked ? 'checked' : ''}>
                            </td>
                            <td class="px-6 py-4 text-sm font-medium">${doc.nome}</td>
                            <td class="px-6 py-4 text-sm">${(doc.tamanho / 1024).toFixed(2)} KB</td>
                            <td class="px-6 py-4 text-sm"><span class="bg-gray-100 px-2 py-1 rounded text-xs">${doc.tipo}</span></td>
                            <td class="px-6 py-4 text-sm">
                                <span class="${doc.status === 'indexado' ? 'text-green-600 font-bold' : 'text-yellow-600'}">${doc.status}</span>
                            </td>
                            <td class="px-6 py-4 text-sm">
                                <button class="btn-remover text-red-600 hover:underline text-xs" data-filename="${doc.nome}">Remover</button>
                            </td>
                        </tr>
                    `;
                    }).join('');

                    // Add event delegation for checkboxes
                    tbody.querySelectorAll('.checkbox-doc').forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            e.stopPropagation();
                            const filename = checkbox.getAttribute('data-filename');
                            this.alternar_selecao_documento(filename);
                        });
                    });

                    // Add event delegation for delete buttons
                    tbody.querySelectorAll('.btn-remover').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const filename = btn.getAttribute('data-filename');
                            this.remover_documento(filename);
                        });
                    });
                },

                ordenar_documentos(campo) {
                    // Se clicar no mesmo campo, inverte a dire√ß√£o
                    if (this.ordem_campo === campo) {
                        this.ordem_direcao = this.ordem_direcao === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.ordem_campo = campo;
                        this.ordem_direcao = 'asc';
                    }
                    this.aplicar_ordenacao();
                    this.renderizar_documentos();
                },

                aplicar_ordenacao() {
                    this.documentos_filtrados.sort((a, b) => {
                        let valA, valB;

                        switch(this.ordem_campo) {
                            case 'nome':
                                valA = a.nome.toLowerCase();
                                valB = b.nome.toLowerCase();
                                break;
                            case 'tamanho':
                                valA = a.tamanho;
                                valB = b.tamanho;
                                break;
                            case 'tipo':
                                valA = a.tipo.toLowerCase();
                                valB = b.tipo.toLowerCase();
                                break;
                            case 'status':
                                valA = a.status.toLowerCase();
                                valB = b.status.toLowerCase();
                                break;
                            default:
                                valA = a.nome.toLowerCase();
                                valB = b.nome.toLowerCase();
                        }

                        if (valA < valB) return this.ordem_direcao === 'asc' ? -1 : 1;
                        if (valA > valB) return this.ordem_direcao === 'asc' ? 1 : -1;
                        return 0;
                    });
                },

                filtrar_documentos() {
                    const busca = this.busca_documentos.toLowerCase().trim();

                    if (!busca) {
                        this.documentos_filtrados = [...this.documentos];
                    } else {
                        this.documentos_filtrados = this.documentos.filter(doc =>
                            doc.nome.toLowerCase().includes(busca) ||
                            doc.tipo.toLowerCase().includes(busca) ||
                            doc.status.toLowerCase().includes(busca)
                        );
                    }

                    this.aplicar_ordenacao();
                    this.renderizar_documentos();
                },

                // ========== FUN√á√ïES DE @ MEN√á√ÉO ==========

                async handle_at_mention(event) {
                    const textarea = event.target;
                    const cursorPos = textarea.selectionStart;
                    const textoBefore = this.chat_kb_input.substring(0, cursorPos);

                    // Procurar √∫ltimo @ antes do cursor
                    const lastAtPos = textoBefore.lastIndexOf('@');

                    if (lastAtPos !== -1) {
                        // H√° um @ antes do cursor
                        const queryAfterAt = textoBefore.substring(lastAtPos + 1);

                        // Verificar se h√° espa√ßo ap√≥s o @ (se sim, fechar autocomplete)
                        if (queryAfterAt.includes(' ') || queryAfterAt.includes('\n')) {
                            this.mostrar_autocomplete = false;
                            return;
                        }

                        // Buscar documentos
                        this.autocomplete_query_inicio = lastAtPos;
                        await this.buscar_documentos_autocomplete(queryAfterAt);
                    } else {
                        // N√£o h√° @ antes do cursor
                        this.mostrar_autocomplete = false;
                    }
                },

                async buscar_documentos_autocomplete(query) {
                    try {
                        const res = await fetch(`/api/knowledge-base/documentos/buscar?query=${encodeURIComponent(query)}`);
                        if (!res.ok) return;

                        const data = await res.json();
                        this.documentos_autocomplete = data.dados || [];
                        this.mostrar_autocomplete = this.documentos_autocomplete.length > 0;
                        this.autocomplete_index_selecionado = 0;
                    } catch (error) {
                        console.error('Erro ao buscar documentos:', error);
                        this.mostrar_autocomplete = false;
                    }
                },

                selecionar_documento(nomeDocumento) {
                    // Adicionar √† lista de mencionados
                    if (!this.chat_kb_documentos_mencionados.includes(nomeDocumento)) {
                        this.chat_kb_documentos_mencionados.push(nomeDocumento);
                    }

                    // Remover @ e query do texto
                    const beforeAt = this.chat_kb_input.substring(0, this.autocomplete_query_inicio);
                    const afterQuery = this.chat_kb_input.substring(this.$refs.chatInput.selectionStart);
                    this.chat_kb_input = beforeAt + afterQuery;

                    // Fechar autocomplete
                    this.mostrar_autocomplete = false;
                    this.documentos_autocomplete = [];

                    // Focar de volta no textarea
                    this.$refs.chatInput.focus();
                },

                remover_documento_mencionado(index) {
                    this.chat_kb_documentos_mencionados.splice(index, 1);
                },

                handle_autocomplete_navigation(event) {
                    if (!this.mostrar_autocomplete) return;

                    if (event.key === 'ArrowDown') {
                        event.preventDefault();
                        this.autocomplete_index_selecionado = Math.min(
                            this.autocomplete_index_selecionado + 1,
                            this.documentos_autocomplete.length - 1
                        );
                    } else if (event.key === 'ArrowUp') {
                        event.preventDefault();
                        this.autocomplete_index_selecionado = Math.max(
                            this.autocomplete_index_selecionado - 1,
                            0
                        );
                    } else if (event.key === 'Tab' || (event.key === 'Enter' && this.mostrar_autocomplete)) {
                        event.preventDefault();
                        const docSelecionado = this.documentos_autocomplete[this.autocomplete_index_selecionado];
                        if (docSelecionado) {
                            this.selecionar_documento(docSelecionado.nome);
                        }
                    } else if (event.key === 'Escape') {
                        this.mostrar_autocomplete = false;
                    }
                },

                format_tamanho(bytes) {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                },

                // ========== FIM FUN√á√ïES DE @ MEN√á√ÉO ==========

                async enviar_pergunta_kb() {
                    if (!this.chat_kb_input.trim() || this.chat_kb_carregando) return;

                    const pergunta = this.chat_kb_input.trim();
                    const documentos_mencionados = [...this.chat_kb_documentos_mencionados];  // Copiar array

                    this.chat_kb_input = '';
                    this.chat_kb_documentos_mencionados = [];  // Limpar men√ß√µes
                    this.chat_kb_carregando = true;
                    this.mostrar_autocomplete = false;  // Fechar autocomplete

                    // Adicionar mensagem do usu√°rio (com tags de documentos se houver)
                    let conteudoMensagem = pergunta;
                    if (documentos_mencionados.length > 0) {
                        const tags = documentos_mencionados.map(doc => `üìÑ \`${doc}\``).join(' ');
                        conteudoMensagem = `${tags}\n\n${pergunta}`;
                    }

                    this.chat_kb_mensagens.push({
                        role: 'user',
                        content: conteudoMensagem
                    });

                    // Scroll para o fim
                    setTimeout(() => {
                        const container = document.getElementById('chat-kb-container');
                        if (container) container.scrollTop = container.scrollHeight;
                    }, 100);

                    try {
                        const res = await fetch('/api/knowledge-base/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                pergunta,
                                documentos_mencionados  // Enviar documentos mencionados
                            })
                        });

                        if (!res.ok) {
                            throw new Error('Erro ao processar pergunta');
                        }

                        const data = await res.json();

                        // Adicionar resposta do assistente
                        this.chat_kb_mensagens.push({
                            role: 'assistant',
                            content: data.resposta || 'N√£o consegui encontrar uma resposta.',
                            fontes: data.fontes || [],
                            debug: data.debug || null
                        });

                        // Scroll para o fim
                        setTimeout(() => {
                            const container = document.getElementById('chat-kb-container');
                            if (container) container.scrollTop = container.scrollHeight;
                        }, 100);
                    } catch (e) {
                        console.error('Erro no chat:', e);
                        this.mostrar_notificacao('‚úó Erro ao processar pergunta', 'erro');
                        this.chat_kb_mensagens.push({
                            role: 'assistant',
                            content: 'Desculpe, ocorreu um erro ao processar sua pergunta. Tente novamente.'
                        });
                    } finally {
                        this.chat_kb_carregando = false;
                    }
                },

                async abrir_detalhes_priorizacao(falha_id) {
                    console.log('[DEBUG] abrir_detalhes_priorizacao chamado para falha', falha_id);
                    try {
                        const res = await fetch(`/api/priorizacoes/${falha_id}?incluir_fontes=true`);
                        console.log('[DEBUG] Resposta HTTP:', res.status);
                        if (!res.ok) {
                            this.mostrar_notificacao('‚úó Erro ao carregar detalhes da prioriza√ß√£o', 'erro');
                            return;
                        }
                        const data = await res.json();
                        console.log('[DEBUG] Dados recebidos:', data);
                        this.detalhes_modal = data.dados;

                        // Inicializar estados tempor√°rios do modal
                        this.destacada_temp = this.detalhes_modal.destacada === 1 || this.detalhes_modal.destacada === true;
                        this.justificativa_temp = this.detalhes_modal.justificativa_destaque || '';

                        console.log('[DEBUG] detalhes_modal definido como:', this.detalhes_modal);
                        console.log('[DEBUG] destacada_temp:', this.destacada_temp);
                        this.modal_aberto = true;
                        console.log('[DEBUG] modal_aberto definido como true');
                    } catch (e) {
                        console.error('[DEBUG] Erro ao abrir detalhes:', e);
                        this.mostrar_notificacao('‚úó Erro ao carregar detalhes da prioriza√ß√£o', 'erro');
                    }
                },

                async fechar_modal() {
                    // Salvar justificativa antes de fechar (se houver mudan√ßas)
                    if (this.detalhes_modal && this.justificativa_temp !== (this.detalhes_modal.justificativa_destaque || '')) {
                        await this.salvar_justificativa();
                    }

                    this.modal_aberto = false;
                    this.detalhes_modal = null;
                    this.destacada_temp = false;
                    this.justificativa_temp = '';
                },

                async toggle_destaque_modal() {
                    // Este m√©todo √© chamado apenas quando o usu√°rio clica no toggle
                    // O valor j√° foi invertido pelo x-model, ent√£o usamos destacada_temp diretamente
                    await this.atualizar_destaque_modal(this.destacada_temp);
                },

                async atualizar_destaque_modal(destacada) {
                    if (!this.detalhes_modal) return;

                    const falhaId = this.detalhes_modal.falha_id;
                    const justificativa = this.justificativa_temp || this.detalhes_modal.justificativa_destaque || '';

                    try {
                        const res = await fetch(`/api/priorizacoes/${falhaId}/destaque`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ destacada, justificativa })
                        });

                        if (!res.ok) throw new Error('Erro ao atualizar destaque');

                        // Atualizar dados locais
                        this.detalhes_modal.destacada = destacada ? 1 : 0;
                        this.detalhes_modal.justificativa_destaque = justificativa;

                        // Atualizar tamb√©m nos dados da tabela
                        const priorizacao = this.priorizacoes_dados.find(p => p.falha_id === falhaId);
                        if (priorizacao) {
                            priorizacao.destacada = destacada ? 1 : 0;
                            priorizacao.justificativa_destaque = justificativa;
                        }

                        // Re-renderizar tabela e matriz
                        this.renderizar_tabela_priorizacao();
                        await this.carregar_matriz();

                        console.log(`[DEBUG] Destaque ${destacada ? 'ativado' : 'desativado'} via modal para falha ${falhaId}`);
                    } catch (error) {
                        console.error('[ERROR] Erro ao atualizar destaque via modal:', error);
                        alert('Erro ao atualizar prioriza√ß√£o');
                    }
                },

                async salvar_justificativa() {
                    if (!this.detalhes_modal) return;

                    const falhaId = this.detalhes_modal.falha_id;
                    // Preservar o estado atual de destacada ao salvar apenas a justificativa
                    const destacada = this.detalhes_modal.destacada === 1 || this.detalhes_modal.destacada === true;
                    const justificativa = this.justificativa_temp;

                    // N√£o fazer requisi√ß√£o se n√£o houver mudan√ßas na justificativa
                    if (justificativa === (this.detalhes_modal.justificativa_destaque || '')) {
                        return;
                    }

                    try {
                        const res = await fetch(`/api/priorizacoes/${falhaId}/destaque`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ destacada, justificativa })
                        });

                        if (!res.ok) throw new Error('Erro ao salvar justificativa');

                        // Atualizar dados do modal
                        this.detalhes_modal.justificativa_destaque = justificativa;

                        // Atualizar tamb√©m nos dados da tabela
                        const priorizacao = this.priorizacoes_dados.find(p => p.falha_id === falhaId);
                        if (priorizacao) {
                            priorizacao.justificativa_destaque = justificativa;
                        }

                        console.log(`[DEBUG] Justificativa salva para falha ${falhaId}`);
                    } catch (error) {
                        console.error('[ERROR] Erro ao salvar justificativa:', error);
                        this.mostrar_notificacao('‚úó Erro ao salvar justificativa', 'erro');
                    }
                },

                renderizar_analise_ia(analise_json) {
                    if (!analise_json) {
                        return '<p class="text-gray-500 italic">Sem an√°lise dispon√≠vel</p>';
                    }

                    try {
                        // Tentar parsear como JSON
                        let analise;
                        if (typeof analise_json === 'string') {
                            analise = JSON.parse(analise_json);
                        } else {
                            analise = analise_json;
                        }

                        console.log('[DEBUG] An√°lise parseada:', analise);
                        console.log('[DEBUG] Tipo de justificativa:', typeof analise.justificativa, analise.justificativa);

                        let html = '';

                        // Fun√ß√£o auxiliar para descri√ß√£o de impacto
                        const getDescricaoImpacto = (nota) => {
                            const descricoes = {
                                0: 'Impacto nulo - Sem relev√¢ncia pr√°tica',
                                1: 'Impacto m√≠nimo - Afeta nicho muito espec√≠fico',
                                2: 'Impacto muito baixo - Benef√≠cio marginal',
                                3: 'Impacto baixo - Relev√¢ncia limitada',
                                4: 'Impacto moderado-baixo - Efeito localizado',
                                5: 'Impacto moderado - Relev√¢ncia m√©dia',
                                6: 'Impacto moderado-alto - Benef√≠cio significativo',
                                7: 'Impacto alto - Grande potencial de transforma√ß√£o',
                                8: 'Impacto muito alto - Efeito sist√™mico importante',
                                9: 'Impacto cr√≠tico - Potencial transformador massivo',
                                10: 'Impacto m√°ximo - Mudan√ßa estrutural fundamental'
                            };
                            return descricoes[nota] || 'Impacto n√£o avaliado';
                        };

                        // Renderizar Impacto
                        if (analise.impacto) {
                            html += '<div class="mb-4">';
                            html += '<h4 class="font-bold text-gray-800 mb-2">üìä Impacto</h4>';

                            if (typeof analise.impacto === 'object') {
                                html += '<ul class="list-disc list-inside space-y-1 ml-2">';
                                if (analise.impacto.abrangencia !== undefined) {
                                    html += `<li><strong>Abrang√™ncia:</strong> ${analise.impacto.abrangencia}/3</li>`;
                                }
                                if (analise.impacto.magnitude !== undefined) {
                                    html += `<li><strong>Magnitude:</strong> ${analise.impacto.magnitude}/3</li>`;
                                }
                                if (analise.impacto.maturidade !== undefined) {
                                    html += `<li><strong>Maturidade:</strong> ${analise.impacto.maturidade}/2</li>`;
                                }
                                if (analise.impacto.multiplicador !== undefined) {
                                    html += `<li><strong>Multiplicador:</strong> ${analise.impacto.multiplicador}/2</li>`;
                                }
                                if (analise.impacto.total !== undefined) {
                                    html += `<li class="font-bold text-green-700"><strong>Total:</strong> ${analise.impacto.total}/10</li>`;
                                }
                                html += '</ul>';
                                // Adicionar descri√ß√£o do score total
                                if (analise.impacto.total !== undefined) {
                                    html += `<p class="ml-2 mt-2 text-sm italic text-gray-600">${getDescricaoImpacto(analise.impacto.total)}</p>`;
                                }
                            } else {
                                const impactoScore = parseInt(analise.impacto);
                                html += `<p class="ml-2"><strong>Score:</strong> ${impactoScore}/10</p>`;
                                html += `<p class="ml-2 mt-1 text-sm italic text-gray-600">${getDescricaoImpacto(impactoScore)}</p>`;
                            }
                            html += '</div>';
                        }

                        // Fun√ß√£o auxiliar para descri√ß√£o de esfor√ßo
                        const getDescricaoEsforco = (nota) => {
                            const descricoes = {
                                0: 'Esfor√ßo nulo - Implementa√ß√£o trivial',
                                1: 'Esfor√ßo m√≠nimo - Ajustes simples necess√°rios',
                                2: 'Esfor√ßo muito baixo - Poucos recursos necess√°rios',
                                3: 'Esfor√ßo baixo - Implementa√ß√£o direta',
                                4: 'Esfor√ßo moderado-baixo - Coordena√ß√£o b√°sica',
                                5: 'Esfor√ßo moderado - Mobiliza√ß√£o m√©dia de recursos',
                                6: 'Esfor√ßo moderado-alto - Coordena√ß√£o complexa',
                                7: 'Esfor√ßo alto - Mudan√ßas estruturais significativas',
                                8: 'Esfor√ßo muito alto - Reforma profunda necess√°ria',
                                9: 'Esfor√ßo cr√≠tico - Transforma√ß√£o sist√™mica ampla',
                                10: 'Esfor√ßo m√°ximo - Mudan√ßa constitucional/estrutural'
                            };
                            return descricoes[nota] || 'Esfor√ßo n√£o avaliado';
                        };

                        // Renderizar Esfor√ßo
                        const esforco = analise.esforco || analise.esfor√ßo;
                        if (esforco) {
                            html += '<div class="mb-4">';
                            html += '<h4 class="font-bold text-gray-800 mb-2">‚ö° Esfor√ßo</h4>';

                            if (typeof esforco === 'object') {
                                html += '<ul class="list-disc list-inside space-y-1 ml-2">';
                                if (esforco.stakeholders !== undefined) {
                                    html += `<li><strong>Stakeholders:</strong> ${esforco.stakeholders}/3</li>`;
                                }
                                if (esforco.investimento !== undefined) {
                                    html += `<li><strong>Investimento:</strong> ${esforco.investimento}/2</li>`;
                                }
                                if (esforco.tempo !== undefined) {
                                    html += `<li><strong>Tempo:</strong> ${esforco.tempo}/2</li>`;
                                }
                                if (esforco.estrutural !== undefined) {
                                    html += `<li><strong>Mudan√ßas Estruturais:</strong> ${esforco.estrutural}/3</li>`;
                                }
                                if (esforco.total !== undefined) {
                                    html += `<li class="font-bold text-orange-700"><strong>Total:</strong> ${esforco.total}/10</li>`;
                                }
                                html += '</ul>';
                                // Adicionar descri√ß√£o do score total
                                if (esforco.total !== undefined) {
                                    html += `<p class="ml-2 mt-2 text-sm italic text-gray-600">${getDescricaoEsforco(esforco.total)}</p>`;
                                }
                            } else {
                                const esforcoScore = parseInt(esforco);
                                html += `<p class="ml-2"><strong>Score:</strong> ${esforcoScore}/10</p>`;
                                html += `<p class="ml-2 mt-1 text-sm italic text-gray-600">${getDescricaoEsforco(esforcoScore)}</p>`;
                            }
                            html += '</div>';
                        }

                        // Renderizar Justificativa
                        if (analise.justificativa) {
                            html += '<div class="mb-4">';
                            html += '<h4 class="font-bold text-gray-800 mb-2">üí° Justificativa</h4>';
                            // Converter cita√ß√µes [FONTE-X] em links
                            // Garantir que justificativa √© string antes de chamar replace()
                            let justificativa = '';

                            // Se for objeto ou array, tentar extrair conte√∫do
                            if (typeof analise.justificativa === 'object' && analise.justificativa !== null) {
                                if (Array.isArray(analise.justificativa)) {
                                    // Se for array, juntar elementos
                                    justificativa = analise.justificativa.join(' ');
                                } else {
                                    // Se for objeto, tentar pegar propriedades comuns
                                    justificativa = analise.justificativa.texto ||
                                                   analise.justificativa.descricao ||
                                                   analise.justificativa.content ||
                                                   analise.justificativa.message ||
                                                   '';

                                    // Se ainda estiver vazio, tentar extrair de outras formas
                                    if (!justificativa) {
                                        console.warn('[WARN] Justificativa √© objeto mas n√£o tem propriedades conhecidas');
                                        console.warn('[WARN] Propriedades do objeto:', Object.keys(analise.justificativa));
                                        console.warn('[WARN] Conte√∫do completo:', analise.justificativa);

                                        // Tentar pegar a primeira propriedade do objeto
                                        const keys = Object.keys(analise.justificativa);
                                        if (keys.length > 0) {
                                            justificativa = analise.justificativa[keys[0]];
                                            console.log('[INFO] Usando propriedade:', keys[0], '=', justificativa);
                                        } else {
                                            justificativa = '';
                                        }
                                    }
                                }
                            } else {
                                justificativa = String(analise.justificativa || '');
                            }

                            if (justificativa && justificativa !== 'undefined' && justificativa !== 'null' && justificativa !== '[object Object]' && !justificativa.startsWith('{')) {
                                // Processar markdown e formatar
                                justificativa = this.processar_justificativa_markdown(justificativa);
                                html += `<div class="ml-2 leading-relaxed prose prose-sm max-w-none">${justificativa}</div>`;
                            } else if (justificativa.startsWith('{')) {
                                // Se come√ßar com {, √© JSON - n√£o mostrar
                                console.warn('[WARN] Justificativa parece ser JSON, n√£o exibindo');
                                html += `<p class="ml-2 text-gray-500 italic">Justificativa n√£o dispon√≠vel em formato leg√≠vel</p>`;
                            }
                            html += '</div>';
                        }

                        // Renderizar Quadrante
                        if (analise.quadrante) {
                            const cores = {
                                'GANHOS R√ÅPIDOS': 'bg-green-100 text-green-800 border-green-300',
                                'INVESTIR COM CAUTELA': 'bg-blue-100 text-blue-800 border-blue-300',
                                'CONSIDERAR': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                                'BAIXA PRIORIDADE': 'bg-gray-100 text-gray-800 border-gray-300'
                            };
                            const cor = cores[analise.quadrante] || 'bg-gray-100 text-gray-800 border-gray-300';
                            html += `<div class="mt-4 p-3 rounded-lg border ${cor}">`;
                            html += `<strong>Quadrante:</strong> ${analise.quadrante}`;
                            html += '</div>';
                        }

                        return html;

                    } catch (e) {
                        console.warn('Erro ao parsear an√°lise JSON:', e);
                        // Fallback: mostrar como texto simples com cita√ß√µes transformadas em links
                        let texto = String(analise_json);
                        texto = texto.replace(/\[FONTE-(\d+)\]/g, '<a href="#fonte-$1" class="text-blue-600 hover:underline font-medium">[FONTE-$1]</a>');
                        return `<div class="whitespace-pre-wrap">${texto}</div>`;
                    }
                },

                obter_icone_fonte(tipo) {
                    return tipo === 'pesquisa' ? 'üìÑ' : 'üìã';
                },

                obter_label_tipo(tipo) {
                    return tipo === 'pesquisa' ? 'Resultado de Pesquisa' : 'Documento';
                },

                obter_cor_tipo(tipo) {
                    return tipo === 'pesquisa'
                        ? 'bg-blue-100 text-blue-800'
                        : 'bg-purple-100 text-purple-800';
                },

                processar_justificativa_markdown(texto) {
                    if (!texto) return '';

                    // Escapar HTML para seguran√ßa
                    texto = texto.replace(/</g, '&lt;').replace(/>/g, '&gt;');

                    // Processar quebras de linha duplas como par√°grafos
                    let paragrafos = texto.split('\n\n').filter(p => p.trim());

                    // Processar cada par√°grafo
                    paragrafos = paragrafos.map(p => {
                        // Negrito **texto**
                        p = p.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

                        // It√°lico *texto*
                        p = p.replace(/\*(.+?)\*/g, '<em>$1</em>');

                        // Processar cita√ß√µes aninhadas primeiro (ex: [PISA23 em 6])
                        p = p.replace(/\[([A-Z0-9]+)\s+em\s+(\d+)\]/gi, '<span class="text-gray-600 italic">[$1 em <a href="#fonte-$2" class="text-blue-600 hover:underline font-medium">$2</a>]</span>');

                        // Processar cita√ß√µes simples [FONTE-X] ou [X]
                        p = p.replace(/\[FONTE[- ]?(\d+)\]/gi, '<a href="#fonte-$1" class="text-blue-600 hover:underline font-medium">[$1]</a>');
                        p = p.replace(/\[(\d+)\]/g, '<a href="#fonte-$1" class="text-blue-600 hover:underline font-medium">[$1]</a>');

                        // Processar listas (come√ßam com - ou *)
                        if (p.trim().match(/^[-*]\s/)) {
                            const items = p.split('\n').map(line => {
                                if (line.trim().match(/^[-*]\s/)) {
                                    return '<li>' + line.replace(/^[-*]\s/, '') + '</li>';
                                }
                                return line;
                            }).join('');
                            return '<ul class="list-disc list-inside ml-4 space-y-1">' + items + '</ul>';
                        }

                        // Processar quebras de linha simples dentro do par√°grafo
                        p = p.replace(/\n/g, '<br>');

                        return '<p class="mb-3">' + p + '</p>';
                    });

                    return paragrafos.join('');
                },

                obter_descricao_impacto(nota) {
                    const descricoes = {
                        0: 'Impacto nulo - Sem relev√¢ncia pr√°tica',
                        1: 'Impacto m√≠nimo - Afeta nicho muito espec√≠fico',
                        2: 'Impacto muito baixo - Benef√≠cio marginal',
                        3: 'Impacto baixo - Relev√¢ncia limitada',
                        4: 'Impacto moderado-baixo - Efeito localizado',
                        5: 'Impacto moderado - Relev√¢ncia m√©dia',
                        6: 'Impacto moderado-alto - Benef√≠cio significativo',
                        7: 'Impacto alto - Grande potencial de transforma√ß√£o',
                        8: 'Impacto muito alto - Efeito sist√™mico importante',
                        9: 'Impacto cr√≠tico - Potencial transformador massivo',
                        10: 'Impacto m√°ximo - Mudan√ßa estrutural fundamental'
                    };
                    return descricoes[nota] || 'Impacto n√£o avaliado';
                },

                obter_descricao_esforco(nota) {
                    const descricoes = {
                        0: 'Esfor√ßo nulo - Implementa√ß√£o trivial',
                        1: 'Esfor√ßo m√≠nimo - Ajustes simples necess√°rios',
                        2: 'Esfor√ßo muito baixo - Poucos recursos necess√°rios',
                        3: 'Esfor√ßo baixo - Implementa√ß√£o direta',
                        4: 'Esfor√ßo moderado-baixo - Coordena√ß√£o b√°sica',
                        5: 'Esfor√ßo moderado - Mobiliza√ß√£o m√©dia de recursos',
                        6: 'Esfor√ßo moderado-alto - Coordena√ß√£o complexa',
                        7: 'Esfor√ßo alto - Mudan√ßas estruturais significativas',
                        8: 'Esfor√ßo muito alto - Reforma profunda necess√°ria',
                        9: 'Esfor√ßo cr√≠tico - Transforma√ß√£o sist√™mica ampla',
                        10: 'Esfor√ßo m√°ximo - Mudan√ßa constitucional/estrutural'
                    };
                    return descricoes[nota] || 'Esfor√ßo n√£o avaliado';
                },

                obter_titulo_fonte(fonte) {
                    // Para documentos (RAG), usar o nome do arquivo
                    if (fonte.fonte_tipo === 'documento') {
                        // Tentar extrair nome do arquivo da descri√ß√£o ou t√≠tulo
                        const descricao = fonte.fonte_descricao || '';
                        const titulo = fonte.fonte_titulo || '';

                        // Se a descri√ß√£o parece ser um caminho de arquivo, extrair apenas o nome
                        if (descricao.includes('/') || descricao.includes('\\')) {
                            const partes = descricao.split(/[/\\]/);
                            return partes[partes.length - 1];
                        }

                        // Se o t√≠tulo j√° √© um nome de arquivo, usar ele
                        if (titulo.match(/\.(pdf|txt|md|docx|html)$/i)) {
                            return titulo;
                        }

                        // Sen√£o, usar o que estiver dispon√≠vel
                        return titulo || descricao || 'Documento da Base de Conhecimento';
                    }

                    // Para resultados de pesquisa, usar o t√≠tulo normal
                    return fonte.fonte_titulo || 'Fonte sem t√≠tulo';
                },

                obter_trecho_fonte(fonte) {
                    // Priorizar conte√∫do sobre descri√ß√£o
                    const texto = fonte.fonte_conteudo || fonte.fonte_descricao || '';

                    // Limitar a 300 caracteres para o trecho
                    if (texto.length > 300) {
                        return texto.substring(0, 300) + '...';
                    }

                    return texto || 'Sem trecho dispon√≠vel';
                },

                obter_nome_idioma(codigo) {
                    const idiomas = {
                        'en': 'Ingl√™s',
                        'es': 'Espanhol',
                        'fr': 'Franc√™s',
                        'de': 'Alem√£o',
                        'it': 'Italiano',
                        'zh': 'Chin√™s',
                        'ja': 'Japon√™s',
                        'ko': 'Coreano',
                        'ar': '√Årabe',
                        'ru': 'Russo',
                        'hi': 'Hindi',
                        'pt': 'Portugu√™s'
                    };
                    return idiomas[codigo.toLowerCase()] || codigo.toUpperCase();
                },

                async traduzir_texto(texto, idioma_origem) {
                    try {
                        // Usar a API Perplexity para traduzir o texto
                        const response = await fetch('/api/traduzir', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                texto: texto,
                                idioma_origem: idioma_origem,
                                idioma_destino: 'pt'
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Erro ao traduzir texto');
                        }

                        const dados = await response.json();
                        return dados.traducao || 'Tradu√ß√£o n√£o dispon√≠vel';
                    } catch (error) {
                        console.error('Erro na tradu√ß√£o:', error);
                        return 'Erro ao traduzir. Por favor, tente novamente.';
                    }
                },

                remover_documento(filename) {
                    console.log('remover_documento chamado para:', filename);
                    this.mostrar_confirmacao(`Remover "${filename}"?`, `Esta a√ß√£o n√£o pode ser desfeita.`, () => {
                        console.log('Confirma√ß√£o aceita, removendo:', filename);
                        fetch(`/api/knowledge-base/documentos/${encodeURIComponent(filename)}`, {
                            method: 'DELETE'
                        })
                        .then(res => {
                            console.log('Resposta da API DELETE:', res.status, res.statusText);
                            if (res.ok) {
                                this.mostrar_notificacao(`‚úì Documento "${filename}" removido com sucesso!`, 'sucesso');
                                this.carregar_documentos();
                            } else {
                                return res.json().then(data => {
                                    const errorMsg = data.detail || res.statusText;
                                    this.mostrar_notificacao(`‚úó Erro ao remover documento: ${errorMsg}`, 'erro');
                                }).catch(() => {
                                    this.mostrar_notificacao(`‚úó Erro ao remover documento: ${res.statusText}`, 'erro');
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao remover documento:', error);
                            this.mostrar_notificacao(`‚úó Erro ao remover documento: ${error.message}`, 'erro');
                        });
                    });
                },

                alternar_selecao_documento(filename) {
                    const index = this.documentos_selecionados.indexOf(filename);
                    if (index > -1) {
                        this.documentos_selecionados.splice(index, 1);
                    } else {
                        this.documentos_selecionados.push(filename);
                    }
                },

                alternar_todos_documentos(checked) {
                    if (checked) {
                        this.documentos_selecionados = this.documentos_filtrados.map(doc => doc.nome);
                    } else {
                        this.documentos_selecionados = [];
                    }
                    this.renderizar_documentos();
                },

                async remover_selecionados() {
                    if (this.documentos_selecionados.length === 0) return;

                    const count = this.documentos_selecionados.length;
                    const message = count === 1
                        ? `Remover 1 documento selecionado?`
                        : `Remover ${count} documentos selecionados?`;

                    this.mostrar_confirmacao(message, `Esta a√ß√£o n√£o pode ser desfeita.`, async () => {
                        let sucesso = 0;
                        let falhas = 0;

                        for (const filename of this.documentos_selecionados) {
                            try {
                                const res = await fetch(`/api/knowledge-base/documentos/${encodeURIComponent(filename)}`, {
                                    method: 'DELETE'
                                });
                                if (res.ok) {
                                    sucesso++;
                                } else {
                                    falhas++;
                                    console.error(`Falha ao remover ${filename}`);
                                }
                            } catch (error) {
                                falhas++;
                                console.error(`Erro ao remover ${filename}:`, error);
                            }
                        }

                        this.documentos_selecionados = [];

                        if (falhas === 0) {
                            this.mostrar_notificacao(`‚úì ${sucesso} documento(s) removido(s) com sucesso!`, 'sucesso');
                        } else {
                            this.mostrar_notificacao(`‚ö† ${sucesso} removido(s), ${falhas} falhou(aram)`, 'aviso');
                        }

                        await this.carregar_documentos();
                    });
                },

                // ===== BOAS PR√ÅTICAS - FASE I =====

                async solicitar_atualizacao_fase1() {
                    // Se n√£o houver filtros avan√ßados ativos, carregar diretamente
                    const filtros_avancados_ativos =
                        this.filtros_fase1.tipo_fonte.length > 0 ||
                        this.filtros_fase1.apenas_com_implementacao ||
                        this.filtros_fase1.apenas_com_metricas;

                    if (!filtros_avancados_ativos) {
                        // Sem filtros avan√ßados, n√£o h√° an√°lise LLM necess√°ria
                        await this.carregar_falhas_fase1();
                        return;
                    }

                    // Com filtros avan√ßados, mostrar estimativa
                    this.modal_estimativa_aberto = true;
                    this.estimativa_carregando = true;
                    this.estimativa_dados = null;

                    try {
                        // Primeiro, buscar lista de falhas priorizadas
                        const resFalhas = await fetch('/api/boas-praticas/fase1/listar');
                        if (!resFalhas.ok) throw new Error('Erro ao buscar falhas');

                        const dadosFalhas = await resFalhas.json();
                        const falhas = dadosFalhas.falhas || [];

                        if (falhas.length === 0) {
                            this.modal_estimativa_aberto = false;
                            this.mostrar_notificacao('Nenhuma falha priorizada encontrada', 'aviso');
                            return;
                        }

                        // Estimar custo para cada falha e agregar
                        let total_fontes = 0;
                        let total_fontes_apos_filtros = 0;
                        let total_em_cache = 0;
                        let total_a_analisar = 0;
                        let tempo_total = 0;
                        let custo_total = 0;

                        const params = new URLSearchParams({
                            confianca_minima: this.filtros_fase1.confianca_minima,
                            peso_sebrae: this.filtros_fase1.peso_sebrae,
                            tipo_fonte: this.filtros_fase1.tipo_fonte.join(','),
                            anos_publicacao: this.filtros_fase1.anos_publicacao,
                            regiao: this.filtros_fase1.regiao.join(','),
                            idioma: this.filtros_fase1.idioma.join(','),
                            apenas_com_implementacao: this.filtros_fase1.apenas_com_implementacao,
                            apenas_com_metricas: this.filtros_fase1.apenas_com_metricas,
                            limpar_cache: this.filtros_fase1.limpar_cache
                        });

                        // Buscar estimativa para cada falha em paralelo
                        const estimativas = await Promise.all(
                            falhas.map(async (falha) => {
                                try {
                                    const resEst = await fetch(`/api/boas-praticas/fase1/estimar-custo/${falha.falha_id}?${params.toString()}`);
                                    if (!resEst.ok) return null;
                                    return await resEst.json();
                                } catch (e) {
                                    console.error(`Erro ao estimar falha ${falha.falha_id}:`, e);
                                    return null;
                                }
                            })
                        );

                        // Agregar resultados
                        estimativas.forEach(est => {
                            if (!est) return;
                            total_fontes += est.total_fontes_disponiveis || 0;
                            total_fontes_apos_filtros += est.total_fontes_apos_filtros || 0;
                            total_em_cache += est.fontes_em_cache || 0;
                            total_a_analisar += est.fontes_a_analisar || 0;
                            tempo_total += est.tempo_estimado_segundos || 0;
                            custo_total += est.custo_estimado_usd || 0;
                        });

                        // Formatar tempo
                        let tempo_formatado;
                        if (tempo_total < 60) {
                            tempo_formatado = `~${Math.ceil(tempo_total)} segundos`;
                        } else {
                            const minutos = Math.floor(tempo_total / 60);
                            const segundos = Math.ceil(tempo_total % 60);
                            tempo_formatado = `~${minutos}min ${segundos}s`;
                        }

                        this.estimativa_dados = {
                            num_falhas: falhas.length,
                            total_fontes_disponiveis: total_fontes,
                            total_fontes_apos_filtros: total_fontes_apos_filtros,
                            fontes_em_cache: total_em_cache,
                            fontes_a_analisar: total_a_analisar,
                            tempo_estimado_segundos: tempo_total,
                            tempo_estimado_formatado: tempo_formatado,
                            custo_estimado_usd: custo_total,
                            custo_estimado_formatado: `$${custo_total.toFixed(4)} USD`
                        };

                    } catch (e) {
                        console.error('Erro ao estimar:', e);
                        this.modal_estimativa_aberto = false;
                        this.mostrar_notificacao('Erro ao calcular estimativa: ' + e.message, 'erro');
                    } finally {
                        this.estimativa_carregando = false;
                    }
                },

                async confirmar_atualizacao_fase1() {
                    this.modal_estimativa_aberto = false;

                    // Verificar se h√° filtros avan√ßados ativos
                    const filtros_avancados_ativos =
                        this.filtros_fase1.tipo_fonte.length > 0 ||
                        this.filtros_fase1.apenas_com_implementacao ||
                        this.filtros_fase1.apenas_com_metricas;

                    // Se n√£o h√° filtros avan√ßados, apenas carregar a lista
                    if (!filtros_avancados_ativos) {
                        await this.carregar_falhas_fase1();
                        return;
                    }

                    // Com filtros avan√ßados, pr√©-carregar todas as fontes com progresso
                    await this.carregar_falhas_fase1();

                    if (this.falhas_fase1.length === 0) {
                        return;
                    }

                    // Iniciar progresso geral
                    this.progresso_lote_fase1 = {
                        ativo: true,
                        total: this.falhas_fase1.length,
                        processadas: 0,
                        falha_atual: '',
                        etapa_atual: 'Iniciando...',
                        percentual: 0
                    };

                    try {
                        // Processar cada falha sequencialmente
                        for (let i = 0; i < this.falhas_fase1.length; i++) {
                            const falha = this.falhas_fase1[i];

                            // Atualizar progresso geral
                            this.progresso_lote_fase1.falha_atual = `${falha.titulo} (${i + 1}/${this.falhas_fase1.length})`;
                            this.progresso_lote_fase1.etapa_atual = 'Carregando fontes...';
                            this.progresso_lote_fase1.percentual = Math.floor((i / this.falhas_fase1.length) * 100);

                            // Marcar progresso individual para esta falha
                            this.progresso_falhas_fase1[falha.falha_id] = {
                                ativo: true,
                                percentual: 0,
                                etapa: 'Carregando fontes...'
                            };
                            this.renderizar_tabela_fase1();

                            // Carregar fontes (SEM expandir a linha)
                            await this.carregar_fontes_fase1(falha.falha_id);

                            // Atualizar contagem de fontes ap√≥s carregar
                            const paginacao = this.paginacao_fontes_fase1[falha.falha_id];
                            if (paginacao) {
                                this.contagem_fontes_fase1[falha.falha_id] = paginacao.total || 0;
                            }

                            // Marcar como conclu√≠da
                            this.progresso_falhas_fase1[falha.falha_id] = {
                                ativo: true,
                                percentual: 100,
                                etapa: '‚úì Conclu√≠do'
                            };

                            this.progresso_lote_fase1.processadas = i + 1;
                            this.progresso_lote_fase1.percentual = Math.floor(((i + 1) / this.falhas_fase1.length) * 100);
                            this.renderizar_tabela_fase1();

                            // Aguardar 500ms antes de processar pr√≥xima (para UX)
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }

                        this.progresso_lote_fase1.etapa_atual = 'Conclu√≠do!';
                        this.progresso_lote_fase1.percentual = 100;
                        this.mostrar_notificacao('‚úì Todas as fontes foram carregadas e analisadas!', 'sucesso');

                        // Renderizar tabela final
                        this.renderizar_tabela_fase1();

                    } catch (e) {
                        console.error('Erro ao processar falhas:', e);
                        this.mostrar_notificacao('Erro ao processar algumas falhas: ' + e.message, 'erro');
                    } finally {
                        // Aguardar 2 segundos antes de ocultar progresso individual
                        setTimeout(() => {
                            this.progresso_lote_fase1.ativo = false;
                            // Limpar progressos individuais
                            this.progresso_falhas_fase1 = {};
                            this.renderizar_tabela_fase1();
                        }, 2000);
                    }
                },

                cancelar_atualizacao_fase1() {
                    this.modal_estimativa_aberto = false;
                    this.estimativa_dados = null;
                },

                async carregar_falhas_fase1() {
                    this.carregando_fase1 = true;
                    this.filtros_fase1_alterados = false;  // Resetar flag ao atualizar
                    this.fase1_status = 'Carregando falhas priorizadas...';

                    try {
                        // Construir URL com par√¢metros de filtro
                        // Converter arrays em strings separadas por v√≠rgula
                        const params = new URLSearchParams({
                            confianca_minima: this.filtros_fase1.confianca_minima,
                            peso_sebrae: this.filtros_fase1.peso_sebrae,
                            tipo_fonte: this.filtros_fase1.tipo_fonte.join(','),
                            anos_publicacao: this.filtros_fase1.anos_publicacao,
                            regiao: this.filtros_fase1.regiao.join(','),
                            idioma: this.filtros_fase1.idioma.join(','),
                            apenas_com_implementacao: this.filtros_fase1.apenas_com_implementacao,
                            apenas_com_metricas: this.filtros_fase1.apenas_com_metricas,
                            limpar_cache: this.filtros_fase1.limpar_cache
                        });

                        const res = await fetch(`/api/boas-praticas/fase1/listar?${params.toString()}`);

                        if (!res.ok) {
                            throw new Error(`Erro ${res.status}: ${await res.text()}`);
                        }

                        const dados = await res.json();
                        this.falhas_fase1 = dados.falhas || [];

                        // Atualizar contagem filtrada para cada falha
                        this.falhas_fase1.forEach(falha => {
                            if (falha.num_fontes_filtradas !== null && falha.num_fontes_filtradas !== undefined) {
                                this.contagem_fontes_fase1[falha.falha_id] = falha.num_fontes_filtradas;
                            }
                        });

                        if (this.falhas_fase1.length === 0) {
                            this.fase1_status = 'Nenhuma falha priorizada encontrada. Complete a Fase 3 primeiro e marque falhas como destacadas.';
                        } else {
                            this.fase1_status = `‚úì ${this.falhas_fase1.length} falha(s) priorizada(s) carregada(s)`;
                        }

                        this.renderizar_tabela_fase1();
                    } catch (e) {
                        this.fase1_status = '‚úó Erro ao carregar falhas priorizadas';
                        this.mostrar_notificacao('‚úó Erro: ' + e.message, 'erro');
                        console.error('Erro:', e);
                    } finally {
                        this.carregando_fase1 = false;
                    }
                },

                async alternar_expansao_fase1(falha_id) {
                    // Se j√° est√° expandida, apenas colapsa
                    if (this.linhas_expandidas_fase1[falha_id]) {
                        this.linhas_expandidas_fase1[falha_id] = false;
                        this.renderizar_tabela_fase1();
                        return;
                    }

                    // Se n√£o est√° expandida, expande e carrega fontes se necess√°rio
                    this.linhas_expandidas_fase1[falha_id] = true;

                    // Se as fontes ainda n√£o foram carregadas, busca
                    if (!this.fontes_falha_fase1[falha_id]) {
                        await this.carregar_fontes_fase1(falha_id);
                    }

                    this.renderizar_tabela_fase1();
                },

                async carregar_fontes_fase1(falha_id, page = 1) {
                    this.carregando_fontes_fase1[falha_id] = true;
                    this.renderizar_tabela_fase1();

                    try {
                        // Construir URL com par√¢metros de filtro
                        const params = new URLSearchParams({
                            page: page,
                            page_size: 20,
                            confianca_minima: this.filtros_fase1.confianca_minima,
                            peso_sebrae: this.filtros_fase1.peso_sebrae,
                            tipo_fonte: this.filtros_fase1.tipo_fonte,
                            anos_publicacao: this.filtros_fase1.anos_publicacao,
                            regiao: this.filtros_fase1.regiao,
                            idioma: this.filtros_fase1.idioma,
                            apenas_com_implementacao: this.filtros_fase1.apenas_com_implementacao,
                            apenas_com_metricas: this.filtros_fase1.apenas_com_metricas
                        });

                        const res = await fetch(`/api/boas-praticas/fase1/fontes/${falha_id}?${params.toString()}`);

                        if (!res.ok) {
                            throw new Error(`Erro ${res.status}: ${await res.text()}`);
                        }

                        const dados = await res.json();
                        this.fontes_falha_fase1[falha_id] = dados.fontes || [];
                        this.paginacao_fontes_fase1[falha_id] = {
                            page: dados.page,
                            total_pages: dados.total_pages,
                            has_next: dados.has_next,
                            has_prev: dados.has_prev,
                            total: dados.total
                        };

                        // Atualizar contagem de fontes filtradas para exibi√ß√£o "X de Y"
                        this.contagem_fontes_fase1[falha_id] = dados.total || 0;
                    } catch (e) {
                        this.mostrar_notificacao('‚úó Erro ao carregar fontes: ' + e.message, 'erro');
                        console.error('Erro:', e);
                        this.fontes_falha_fase1[falha_id] = [];
                        this.paginacao_fontes_fase1[falha_id] = null;
                    } finally {
                        this.carregando_fontes_fase1[falha_id] = false;
                        this.renderizar_tabela_fase1();
                    }
                },

                async mudar_pagina_fontes_fase1(falha_id, nova_pagina) {
                    await this.carregar_fontes_fase1(falha_id, nova_pagina);
                },

                renderizar_tabela_fase1() {
                    const tbody = document.getElementById('tabela-fase1');
                    if (!tbody) return;

                    if (this.falhas_fase1.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                                    Nenhuma falha priorizada encontrada
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    let html = '';
                    this.falhas_fase1.forEach(falha => {
                        const isExpanded = this.linhas_expandidas_fase1[falha.falha_id];
                        const isLoading = this.carregando_fontes_fase1[falha.falha_id];
                        const fontes = this.fontes_falha_fase1[falha.falha_id] || [];
                        const progresso = this.progresso_falhas_fase1[falha.falha_id];

                        // Contagem original (antes dos filtros)
                        const numFontesOriginal = falha.num_fontes;

                        // Contagem filtrada (se dispon√≠vel)
                        const numFontesFiltradas = this.contagem_fontes_fase1[falha.falha_id];

                        // Determinar texto a exibir
                        let textoFontes;
                        if (numFontesFiltradas !== undefined) {
                            // Mostrar "X de Y" se temos a contagem filtrada
                            textoFontes = `${numFontesFiltradas} de ${numFontesOriginal}`;
                        } else {
                            // Mostrar apenas o total original
                            textoFontes = `${numFontesOriginal} fonte${numFontesOriginal !== 1 ? 's' : ''}`;
                        }

                        // Linha principal
                        html += `
                            <tr class="hover:bg-gray-50 cursor-pointer" onclick="window.app.alternar_expansao_fase1(${falha.falha_id})">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    <div class="flex items-center gap-2">
                                        <span class="text-gray-400 transition-transform ${isExpanded ? 'rotate-90' : ''}">
                                            ‚ñ∂
                                        </span>
                                        ${falha.falha_id}
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-900">
                                    <div class="font-medium">${falha.titulo}</div>
                                    <div class="text-xs text-gray-500 mt-1">${falha.pilar}</div>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600">
                                    ${falha.descricao ? falha.descricao.substring(0, 150) + '...' : 'Sem descri√ß√£o'}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                        ${textoFontes}
                                    </span>
                                </td>
                            </tr>
                        `;

                        // Linha de progresso individual (se ativo)
                        if (progresso && progresso.ativo) {
                            const progressoColor = progresso.percentual === 100 ? 'from-green-500 to-emerald-500' : 'from-purple-500 to-indigo-500';
                            html += `
                                <tr class="bg-gradient-to-r from-purple-50 to-indigo-50">
                                    <td colspan="4" class="px-6 py-3">
                                        <div class="space-y-2">
                                            <div class="flex items-center justify-between text-xs">
                                                <span class="font-medium text-gray-700">${progresso.etapa}</span>
                                                <span class="font-semibold text-purple-600">${progresso.percentual}%</span>
                                            </div>
                                            <div class="overflow-hidden h-2 text-xs flex rounded-full bg-purple-200">
                                                <div style="width: ${progresso.percentual}%"
                                                     class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r ${progressoColor} transition-all duration-500"></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }

                        // Linha expandida com fontes
                        if (isExpanded) {
                            html += `
                                <tr class="bg-purple-50">
                                    <td colspan="4" class="px-6 py-4">
                                        <div class="bg-white rounded-lg p-4 shadow-sm">
                                            <h4 class="text-sm font-semibold text-gray-900 mb-3">üìö Fontes Encontradas</h4>
                            `;

                            if (isLoading) {
                                html += `
                                    <div class="flex items-center justify-center py-8">
                                        <div class="text-sm text-gray-500">‚è≥ Carregando fontes...</div>
                                    </div>
                                `;
                            } else if (fontes.length === 0) {
                                html += `
                                    <div class="text-sm text-gray-500 text-center py-4">
                                        Nenhuma fonte dispon√≠vel
                                    </div>
                                `;
                            } else {
                                const paginacao = this.paginacao_fontes_fase1[falha.falha_id];

                                html += `<div class="space-y-3">`;
                                fontes.forEach((fonte, idx) => {
                                    const tipoIcon = fonte.tipo === 'resultado_pesquisa' ? 'üîç' : 'üìÑ';
                                    const tipoLabel = fonte.tipo === 'resultado_pesquisa' ? 'Resultado de Pesquisa' : 'Documento';

                                    // Score de confian√ßa formatado
                                    const score = fonte.confidence_score || 0.5;
                                    const scorePercent = Math.round(score * 100);
                                    const scoreColor = score > 0.5 ? 'text-green-700 bg-green-100' :
                                                      score >= 0.25 ? 'text-yellow-700 bg-yellow-100' :
                                                      'text-red-700 bg-red-100';

                                    // Flags e nomes de idiomas
                                    const idiomaInfo = {
                                        'pt': { flag: 'üáßüá∑', nome: 'Portugu√™s' },
                                        'en': { flag: 'üá∫üá∏', nome: 'Ingl√™s' },
                                        'es': { flag: 'üá™üá∏', nome: 'Espanhol' },
                                        'fr': { flag: 'üá´üá∑', nome: 'Franc√™s' },
                                        'de': { flag: 'üá©üá™', nome: 'Alem√£o' }
                                    };

                                    const idioma = fonte.idioma && idiomaInfo[fonte.idioma]
                                        ? `${idiomaInfo[fonte.idioma].flag} ${idiomaInfo[fonte.idioma].nome}`
                                        : null;

                                    html += `
                                        <div class="border border-gray-200 rounded-lg p-3 hover:border-purple-300 transition-colors">
                                            <div class="flex items-start gap-3">
                                                <div class="text-xl flex-shrink-0">${tipoIcon}</div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                                                        <span class="text-xs font-medium text-gray-500">${tipoLabel}</span>
                                                        <span class="text-xs ${scoreColor} px-2 py-0.5 rounded font-semibold" title="Score de Confian√ßa">
                                                            ‚≠ê ${scorePercent}
                                                        </span>
                                                        ${idioma ? `
                                                            <span class="text-xs text-gray-400">‚Ä¢</span>
                                                            <span class="text-xs text-gray-600">${idioma}</span>
                                                        ` : ''}
                                                        ${fonte.pais_origem && fonte.pais_origem !== 'BR' ? `
                                                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">${fonte.pais_origem}</span>
                                                        ` : ''}
                                                    </div>
                                                    <h5 class="text-sm font-medium text-gray-900 mb-1 line-clamp-2">
                                                        ${fonte.titulo || 'Sem t√≠tulo'}
                                                    </h5>
                                                    ${fonte.descricao ? `
                                                        <p class="text-xs text-gray-600 line-clamp-2 mb-2 break-all">
                                                            ${fonte.descricao}
                                                        </p>
                                                    ` : ''}
                                                    ${fonte.url ? `
                                                        <div style="max-width: 100%; overflow: hidden;">
                                                            <a href="${fonte.url}" target="_blank"
                                                               class="text-xs text-purple-600 hover:text-purple-800 hover:underline"
                                                               style="display: block; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                                               title="${fonte.url}"
                                                               onclick="event.stopPropagation()">
                                                                ${fonte.url.length > 80 ? fonte.url.substring(0, 77) + '...' : fonte.url}
                                                            </a>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                });
                                html += `</div>`;

                                // Adicionar controles de pagina√ß√£o
                                if (paginacao && paginacao.total_pages > 1) {
                                    html += `
                                        <div class="mt-4 pt-4 border-t border-gray-200">
                                            <div class="flex items-center justify-between">
                                                <div class="text-xs text-gray-500">
                                                    P√°gina ${paginacao.page} de ${paginacao.total_pages} (${paginacao.total} fontes no total)
                                                </div>
                                                <div class="flex gap-2">
                                                    <button
                                                        onclick="window.app.mudar_pagina_fontes_fase1(${falha.falha_id}, ${paginacao.page - 1})"
                                                        ${!paginacao.has_prev ? 'disabled' : ''}
                                                        class="px-3 py-1 text-xs font-medium text-purple-600 hover:text-purple-800 hover:bg-purple-50 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                                        ‚Üê Anterior
                                                    </button>
                                                    <button
                                                        onclick="window.app.mudar_pagina_fontes_fase1(${falha.falha_id}, ${paginacao.page + 1})"
                                                        ${!paginacao.has_next ? 'disabled' : ''}
                                                        class="px-3 py-1 text-xs font-medium text-purple-600 hover:text-purple-800 hover:bg-purple-50 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                                        Pr√≥xima ‚Üí
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }
                            }

                            html += `
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }
                    });

                    tbody.innerHTML = html;
                },

                // ===== BOAS PR√ÅTICAS - FASE II =====
                async carregar_falhas_fase2() {
                    this.fase2_status = 'Carregando falhas priorizadas...';

                    try {
                        const res = await fetch('/api/boas-praticas/fase1/listar');

                        if (!res.ok) {
                            throw new Error(`Erro ${res.status}: ${await res.text()}`);
                        }

                        const dados = await res.json();
                        this.falhas_fase2 = dados.falhas.map(f => ({
                            ...f,
                            praticas: null,  // null = n√£o analisado ainda
                            analisando: false
                        })) || [];

                        if (this.falhas_fase2.length === 0) {
                            this.fase2_status = 'Nenhuma falha priorizada encontrada.';
                        } else {
                            this.fase2_status = `‚úì ${this.falhas_fase2.length} falha(s) carregada(s). Clique em "Analisar" para executar a an√°lise com IA.`;
                        }

                        this.renderizar_tabela_fase2();
                    } catch (e) {
                        this.fase2_status = '‚úó Erro ao carregar falhas';
                        this.mostrar_notificacao('‚úó Erro: ' + e.message, 'erro');
                        console.error('Erro:', e);
                    }
                },

                calcular_total_praticas_fase2() {
                    return this.falhas_fase2.reduce((total, falha) => {
                        const praticas = falha.praticas || [];
                        return total + praticas.length;
                    }, 0);
                },

                async analisar_falha_fase2(falha_id, reprocessar = false) {
                    const falhaIdx = this.falhas_fase2.findIndex(f => f.falha_id === falha_id);
                    if (falhaIdx === -1) return;

                    this.falhas_fase2[falhaIdx].analisando = true;
                    this.fase2_status = `Analisando falha ${falha_id}... (Buscando URLs via Jina.ai e analisando documentos)`;
                    this.renderizar_tabela_fase2();

                    try {
                        const res = await fetch(`/api/boas-praticas/fase2/analisar/${falha_id}?reprocessar=${reprocessar}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (!res.ok) {
                            throw new Error(`Erro ${res.status}: ${await res.text()}`);
                        }

                        const dados = await res.json();
                        this.falhas_fase2[falhaIdx].praticas = dados.praticas || [];
                        this.falhas_fase2[falhaIdx].analisando = false;

                        this.fase2_status = `‚úì An√°lise conclu√≠da para falha ${falha_id}: ${dados.total_praticas} pr√°tica(s) identificada(s)`;
                        this.renderizar_tabela_fase2();

                        if (dados.total_praticas > 0) {
                            this.mostrar_notificacao(`‚úì ${dados.total_praticas} boa(s) pr√°tica(s) identificada(s) para falha ${falha_id}`, 'sucesso');
                        } else {
                            this.mostrar_notificacao(`‚Ñπ Nenhuma pr√°tica identificada para falha ${falha_id}`, 'aviso');
                        }
                    } catch (e) {
                        this.falhas_fase2[falhaIdx].analisando = false;
                        this.fase2_status = `‚úó Erro ao analisar falha ${falha_id}`;
                        this.mostrar_notificacao('‚úó Erro: ' + e.message, 'erro');
                        this.renderizar_tabela_fase2();
                        console.error('Erro:', e);
                    }
                },

                renderizar_tabela_fase2() {
                    const tbody = document.getElementById('tabela-fase2');
                    if (!tbody) return;

                    if (this.falhas_fase2.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                                    Nenhuma falha priorizada encontrada
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    tbody.innerHTML = this.falhas_fase2.map(falha => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ${falha.falha_id}
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-900">
                                <div class="font-medium">${falha.titulo}</div>
                                <div class="text-xs text-gray-500 mt-1">${falha.pilar}</div>
                                <div class="text-xs text-gray-400 mt-1">${falha.num_fontes} fonte${falha.num_fontes !== 1 ? 's' : ''} dispon√≠vel${falha.num_fontes !== 1 ? 'is' : ''}</div>
                            </td>
                            <td class="px-6 py-4 text-sm">
                                ${this.renderizar_praticas_fase2(falha)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                ${falha.analisando ? `
                                    <span class="text-purple-600 italic">‚è≥ Analisando...</span>
                                ` : falha.praticas === null ? `
                                    <button onclick="window.app.analisar_falha_fase2(${falha.falha_id})"
                                            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-medium">
                                        üîç Analisar
                                    </button>
                                ` : `
                                    <button onclick="window.app.analisar_falha_fase2(${falha.falha_id}, true)"
                                            class="text-purple-600 hover:text-purple-900 font-medium">
                                        üîÑ Reprocessar
                                    </button>
                                `}
                            </td>
                        </tr>
                    `).join('');
                },

                renderizar_praticas_fase2(falha) {
                    if (falha.analisando) {
                        return '<span class="text-purple-600 italic">‚è≥ Analisando com IA...</span>';
                    }

                    if (falha.praticas === null) {
                        return '<span class="text-amber-600 italic">‚è≥ Aguardando an√°lise...</span>';
                    }

                    if (falha.praticas.length === 0) {
                        return '<span class="text-gray-400 italic">Nenhuma pr√°tica identificada</span>';
                    }

                    return `
                        <div class="space-y-2">
                            ${falha.praticas.map((pratica, idx) => `
                                <div class="border-l-2 border-purple-300 pl-3 py-1">
                                    <div class="flex items-start gap-2">
                                        <span class="text-xs text-gray-500 font-mono">${idx + 1}.</span>
                                        <div class="flex-1">
                                            <div class="text-sm font-medium text-gray-800">${pratica.titulo}</div>
                                            ${pratica.descricao ? `<div class="text-xs text-gray-600 mt-1">${pratica.descricao}</div>` : ''}
                                            ${pratica.is_sebrae ? '<span class="inline-block mt-1 px-2 py-0.5 bg-blue-100 text-blue-800 text-xs font-semibold rounded">üìò Sebrae</span>' : ''}
                                            ${pratica.fonte ? `<div class="text-xs text-gray-400 mt-1">Fonte: ${pratica.fonte}</div>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            };
        }
    </script>
</body>
</html>
