<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Sebrae Nacional - Pesquisa de Pol√≠ticas P√∫blicas</title>
    <!-- Force body display IMMEDIATELY before any CSS loads -->
    <script>
        // This runs BEFORE any stylesheets load
        // Set a style rule that forces body to display
        const style = document.createElement('style');
        style.innerHTML = 'body { display: block !important; visibility: visible !important; opacity: 1 !important; }';
        document.head.appendChild(style);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script defer src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        body { display: block !important; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        [x-cloak] { display: none !important; }
        .phase-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
        .phase-active { background-color: #dbeafe; color: #1e40af; }
        .phase-inactive { background-color: #f3f4f6; color: #4b5563; }
        .phase-badge-nav { display: inline-flex; align-items: center; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: all 0.3s; }
        .phase-nav-active { background-color: #2563eb; color: white; }
        .phase-nav-inactive { background-color: #e5e7eb; color: #374151; }
        .phase-nav-inactive:hover { background-color: #d1d5db; }
        .matrix-cell { padding: 1rem; border-radius: 0.5rem; border: 2px solid; transition: all 0.3s; }
        .quick-wins { border-color: #22c55e; background-color: #f0fdf4; }
        .strategic { border-color: #f97316; background-color: #fff7ed; }
        .fill-in { border-color: #3b82f6; background-color: #eff6ff; }
        .low-priority { border-color: #ef4444; background-color: #fef2f2; }
        .container { max-width: 80rem; margin: 0 auto; padding: 0 1rem; }
        header { background-color: white; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        main { margin: 2rem auto; }
    </style>
    <script>
        // Fallback: Remove x-cloak after 5 seconds if Alpine.js hasn't loaded
        setTimeout(() => {
            const app = document.getElementById('app');
            if (app && app.hasAttribute('x-cloak')) {
                app.removeAttribute('x-cloak');
                console.warn('Alpine.js loading fallback applied');
            }
        }, 5000);
    </script>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="app" class="min-h-screen" x-data="app()" x-init="inicializar()" style="display: block;">
        <!-- Container de Notifica√ß√µes -->
        <div id="notificacoes-container" class="fixed top-4 right-4 z-[9999] space-y-2" style="max-width: 400px;"></div>

        <!-- Container de Confirma√ß√£o Modal -->
        <div id="confirmacao-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center" @click.self="fechar_confirmacao()" x-show="confirmacao_aberta" x-cloak>
            <div class="bg-white rounded-lg p-6 max-w-sm" @click.stop>
                <h3 class="text-lg font-bold mb-2" x-text="confirmacao_titulo"></h3>
                <p class="text-gray-600 mb-6" x-text="confirmacao_mensagem"></p>
                <div class="flex gap-3 justify-end">
                    <button @click="fechar_confirmacao()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-medium">
                        Cancelar
                    </button>
                    <button @click="executar_confirmacao()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-medium">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Arquivos Duplicados -->
        <div id="duplicados-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center" @click.self="fechar_duplicados_modal()" x-show="duplicados_modal_aberto" x-cloak>
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4" @click.stop>
                <h3 class="text-xl font-bold mb-3 text-orange-600">‚ö†Ô∏è Arquivos Duplicados Detectados</h3>
                <p class="text-gray-600 mb-4">Os seguintes arquivos j√° existem na base de conhecimento. Como deseja proceder?</p>

                <!-- Lista de arquivos duplicados -->
                <div class="bg-gray-50 rounded p-4 mb-4 max-h-60 overflow-y-auto">
                    <template x-for="dup in arquivos_duplicados" :key="dup.nome">
                        <div class="flex items-center justify-between py-2 px-3 bg-white rounded mb-2">
                            <div class="flex items-center space-x-3 flex-1 min-w-0">
                                <span class="text-orange-500 text-xl">üìÑ</span>
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-sm truncate" x-text="dup.nome"></p>
                                    <p class="text-xs text-gray-500">
                                        Existente: <span x-text="(dup.tamanho_existente / 1024).toFixed(2)"></span> KB
                                        / Novo: <span x-text="(dup.tamanho_novo / 1024).toFixed(2)"></span> KB
                                    </p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Op√ß√µes de a√ß√£o -->
                <div class="mb-6">
                    <p class="text-sm font-semibold mb-3 text-gray-700">Escolha uma a√ß√£o:</p>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 border-2 rounded cursor-pointer hover:bg-blue-50" :class="opcao_duplicados === 'overwrite' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'">
                            <input type="radio" name="duplicate-action" value="overwrite" x-model="opcao_duplicados" class="mr-3">
                            <div>
                                <p class="font-medium text-sm">Sobrescrever arquivos existentes</p>
                                <p class="text-xs text-gray-500">Substitui os arquivos antigos pelos novos</p>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border-2 rounded cursor-pointer hover:bg-green-50" :class="opcao_duplicados === 'copy' ? 'border-green-500 bg-green-50' : 'border-gray-200'">
                            <input type="radio" name="duplicate-action" value="copy" x-model="opcao_duplicados" class="mr-3">
                            <div>
                                <p class="font-medium text-sm">Criar uma c√≥pia</p>
                                <p class="text-xs text-gray-500">Mant√©m o arquivo antigo e cria "arquivo (1).pdf"</p>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border-2 rounded cursor-pointer hover:bg-gray-50" :class="opcao_duplicados === 'skip' ? 'border-gray-500 bg-gray-50' : 'border-gray-200'">
                            <input type="radio" name="duplicate-action" value="skip" x-model="opcao_duplicados" class="mr-3">
                            <div>
                                <p class="font-medium text-sm">Ignorar duplicados</p>
                                <p class="text-xs text-gray-500">Mant√©m os arquivos existentes e n√£o envia os duplicados</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Bot√µes de a√ß√£o -->
                <div class="flex gap-3 justify-end">
                    <button @click="fechar_duplicados_modal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-medium">
                        Cancelar Upload
                    </button>
                    <button @click="proceder_com_upload()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium">
                        Continuar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de An√°lise Individual -->
        <div id="analise-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center" @click.self="fechar_modal_analise()" x-show="modal_analise_aberto" x-cloak>
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" @click.stop>
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-blue-600">üîç Analisar Falha</h3>
                        <p class="text-sm text-gray-600 mt-1" x-show="falha_analise">
                            <span class="font-medium">Falha #<span x-text="falha_analise?.id"></span>:</span>
                            <span x-text="falha_analise?.titulo"></span>
                        </p>
                    </div>
                    <button @click="fechar_modal_analise()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Configura√ß√µes Avan√ßadas -->
                <div class="space-y-4 mb-6">
                    <p class="text-sm text-gray-700 font-medium mb-3">‚öôÔ∏è Configura√ß√µes de An√°lise</p>

                    <!-- Fontes de Dados -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">üìö Fontes de Dados</p>

                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" x-model="config_analise.usar_rag" class="form-checkbox h-5 w-5 text-blue-600">
                            <div>
                                <p class="text-sm font-medium">Base de Conhecimento (RAG)</p>
                                <p class="text-xs text-gray-500">Usa documentos indexados para contexto adicional</p>
                            </div>
                        </label>

                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" x-model="config_analise.usar_resultados_pesquisa" class="form-checkbox h-5 w-5 text-blue-600">
                            <div>
                                <p class="text-sm font-medium">Resultados de Pesquisa</p>
                                <p class="text-xs text-gray-500">Usa resultados de pesquisa web relacionados √† falha</p>
                            </div>
                        </label>
                    </div>

                    <!-- Par√¢metros do Modelo -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">ü§ñ Par√¢metros do Modelo</p>

                        <!-- Seletor de Modelo -->
                        <div>
                            <label class="text-sm font-medium text-gray-700 block mb-2">Modelo de IA</label>
                            <select x-model="config_analise.modelo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="google/gemini-2.5-pro">Gemini 2.5 Pro (Recomendado)</option>
                                <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash Experimental (Gratuito)</option>
                                <option value="xai/grok-4-fast">Grok 4 Fast (R√°pido)</option>
                                <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Escolha o modelo de IA para an√°lise. Gemini 2.5 Pro oferece melhor qualidade.</p>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-gray-700 flex items-center justify-between">
                                Temperatura
                                <span class="text-blue-600 font-mono" x-text="config_analise.temperatura.toFixed(1)"></span>
                            </label>
                            <input type="range" x-model.number="config_analise.temperatura" min="0" max="1" step="0.1" class="w-full">
                            <p class="text-xs text-gray-500 mt-1">Controla a criatividade da resposta (0.0 = determin√≠stico, 1.0 = criativo)</p>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-gray-700 flex items-center justify-between">
                                Tokens M√°ximos
                                <span class="text-blue-600 font-mono" x-text="config_analise.max_tokens"></span>
                            </label>
                            <input type="range" x-model.number="config_analise.max_tokens" min="1000" max="8000" step="500" class="w-full">
                            <p class="text-xs text-gray-500 mt-1">Tamanho m√°ximo da resposta (1000-8000 tokens)</p>
                        </div>
                    </div>

                    <!-- Informa√ß√µes da An√°lise -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p class="text-sm text-blue-800">
                            <span class="font-medium">Sistema:</span> An√°lise com IA + RAG<br>
                            <span class="font-medium">Contexto:</span> Base de conhecimento + Resultados de pesquisa<br>
                            <span class="font-medium">Crit√©rios:</span> Sistema de calibragem objetivo (8 dimens√µes)
                        </p>
                    </div>
                </div>

                <!-- Indicador de Progresso -->
                <div x-show="analisando_individual" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center gap-3 mb-2">
                        <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-blue-800" x-text="progresso_analise.mensagem || 'Processando...'"></p>
                            <p class="text-xs text-blue-600 mt-1" x-text="`Etapa: ${progresso_analise.etapa || 'Iniciando'}`"></p>
                        </div>
                        <span class="text-lg font-bold text-blue-600" x-text="`${progresso_analise.progresso || 0}%`"></span>
                    </div>
                    <!-- Barra de progresso -->
                    <div class="w-full bg-blue-100 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" :style="`width: ${progresso_analise.progresso || 0}%`"></div>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="flex gap-3 justify-end">
                    <button @click="fechar_modal_analise()" :disabled="analisando_individual" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                        Cancelar
                    </button>
                    <button @click="executar_analise_individual()" :disabled="analisando_individual" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                        <span x-show="!analisando_individual">üöÄ Iniciar An√°lise</span>
                        <span x-show="analisando_individual">‚ü≥ Analisando...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Header Principal -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h1 class="text-3xl font-bold" style="color: #1e3a8a;">Sebrae Nacional</h1>
                        <p class="text-sm mt-1" style="color: #374151;">Pesquisa de Pol√≠ticas P√∫blicas para Inova√ß√£o</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium" style="color: #374151;">Fase Atual</p>
                        <p class="text-lg font-bold text-blue-700" x-text="fases[fase_atual].nome"></p>
                    </div>
                </div>

                <!-- Navega√ß√£o de Fases -->
                <div class="flex gap-2">
                    <template x-for="(fase, idx) in fases" :key="idx">
                        <button @click="mudar_fase(idx)"
                                :class="idx === fase_atual ? 'phase-nav-active' : 'phase-nav-inactive'"
                                class="phase-badge-nav text-sm">
                            <span x-text="idx === 0 ? fase.nome : `${idx}. ${fase.nome}`"></span>
                            <template x-if="idx < fase_atual">
                                <span class="ml-2">‚úì</span>
                            </template>
                        </button>
                    </template>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
            <!-- Fase 0: Home -->
            <section x-show="fase_atual === 0" class="space-y-8">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-8 border border-blue-200">
                    <h2 class="text-3xl font-bold mb-4">Bem-vindo ao Sistema de Pesquisa</h2>
                    <p class="text-lg text-gray-700 mb-6">
                        Este sistema ajuda a identificar, pesquisar e priorizar falhas de mercado no ecossistema de inova√ß√£o brasileiro.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <template x-for="(fase, idx) in fases" :key="idx">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <div class="text-2xl font-bold text-blue-600 mb-2" x-text="`${idx + 1}`"></div>
                                <h3 class="font-bold mb-2" x-text="fase.nome"></h3>
                                <p class="text-sm text-gray-600" x-text="fase.descricao"></p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Estat√≠sticas Gerais -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Total de Falhas</p>
                        <p class="text-3xl font-bold text-blue-700 mt-2" x-text="stats.total_falhas">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Priorizadas</p>
                        <p class="text-3xl font-bold text-green-700 mt-2" x-text="stats.total_priorizadas">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Pesquisas Realizadas</p>
                        <p class="text-3xl font-bold text-purple-700 mt-2" x-text="stats.total_resultados">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Status</p>
                        <p class="text-lg font-bold mt-2" :class="ativo ? 'text-green-700' : 'text-gray-600'" x-text="ativo ? '‚úì Ativo' : '‚óã Inativo'"></p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-8">
                    <h3 class="text-xl font-bold mb-4">Comece Agora</h3>
                    <p class="text-gray-700 mb-6">Escolha uma fase para come√ßar:</p>
                    <div class="space-y-2">
                        <button @click="mudar_fase(1)" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ‚ñ∂ Fase 1: Pesquisa de Pol√≠ticas P√∫blicas
                        </button>
                        <button @click="mudar_fase(2)" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ‚ñ∂ Fase 2: Base de Conhecimento
                        </button>
                        <button @click="mudar_fase(3)" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ‚ñ∂ Fase 3: Prioriza√ß√£o de Falhas
                        </button>
                    </div>
                </div>
            </section>

            <!-- Fase 1: Pesquisa -->
            <section x-show="fase_atual === 1" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">1. Pesquisa de Pol√≠ticas P√∫blicas</h2>
                        <p class="text-gray-600 mt-1">Identifique e pesquise pol√≠ticas p√∫blicas relevantes para cada falha de mercado</p>
                    </div>
                </div>

                <!-- Status de Pesquisa -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Status de Processamento</h3>
                        <span class="text-sm font-medium" :class="ativo ? 'text-green-700' : 'text-red-700'" x-text="ativo ? '‚óè Ativo' : '‚óã Parado'"></span>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-sm font-medium">Progresso Geral</span>
                                <span class="text-sm font-medium" x-text="`${percentual_processamento.toFixed(1)}%`"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-blue-600 h-3 rounded-full transition-all" :style="`width: ${percentual_processamento}%`"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-4">
                            <div>
                                <p class="text-xs text-gray-600">Pendentes</p>
                                <p class="text-2xl font-bold text-yellow-700" x-text="stats.total_pendentes">0</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Processando</p>
                                <p class="text-2xl font-bold text-blue-700" x-text="stats.total_processando">0</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Conclu√≠das</p>
                                <p class="text-2xl font-bold text-green-700" x-text="stats.total_concluidas">0</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Resultados</p>
                                <p class="text-2xl font-bold text-purple-700" x-text="stats.total_resultados">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controles -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex gap-3 flex-wrap">
                        <button @click="iniciar_pesquisas()" :disabled="pesquisa_iniciando" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50">
                            <span x-show="!pesquisa_iniciando">‚ñ∂ Iniciar Pesquisa</span>
                            <span x-show="pesquisa_iniciando">‚ü≥ Iniciando...</span>
                        </button>
                        <button @click="pausar_pesquisas()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium">
                            ‚è∏ Pausar
                        </button>
                        <button @click="reiniciar_pesquisas()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium">
                            ‚ü≤ Reiniciar Tudo
                        </button>
                    </div>
                </div>

                <!-- Tabela de Falhas -->
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-medium">ID</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Falha</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Pilar</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Progresso</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Resultados</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-falhas">
                            <tr class="border-b hover:bg-gray-50">
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">Carregando falhas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Fase 2: Base de Conhecimento -->
            <section x-show="fase_atual === 2" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">2. Base de Conhecimento</h2>
                        <p class="text-gray-600 mt-1">Fa√ßa upload de documentos (DOCX, PDF) para criar uma base de conhecimento vetorial</p>
                    </div>
                </div>

                <!-- Upload Area -->
                <div class="bg-white rounded-lg shadow p-8">
                    <div class="border-2 border-dashed border-blue-300 rounded-lg p-8 text-center transition"
                         @dragover.prevent="dragover_kb = true"
                         @dragenter.prevent="dragover_kb = true"
                         @dragleave="dragover_kb = false"
                         @drop.prevent="handleFileDrops($event); dragover_kb = false"
                         :class="dragover_kb ? 'border-blue-600 bg-blue-50' : 'hover:border-blue-500'">
                        <div class="text-4xl mb-2">üìÅ</div>
                        <h3 class="text-lg font-bold mb-2">Arraste arquivos ou clique para selecionar</h3>
                        <p class="text-gray-600 mb-4">Suporta DOCX, PDF, CSV e Markdown (m√°ximo 25MB por arquivo)</p>
                        <input type="file" multiple accept=".docx,.pdf,.csv,.md" @change="handleFileUpload" class="hidden" x-ref="fileInput">
                        <button @click.stop="$refs.fileInput.click()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            Selecionar Arquivos
                        </button>
                    </div>
                </div>

                <!-- Upload Status - Melhorado com detalhes por arquivo -->
                <template x-if="uploading">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <div class="animate-spin mr-3 text-xl">‚ü≥</div>
                                    <div>
                                        <p class="font-bold text-blue-900" x-text="upload_status || 'Fazendo upload...'"></p>
                                        <p class="text-sm text-blue-700">Progresso geral: <span x-text="`${upload_progress}%`"></span></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Barra de progresso geral -->
                            <div class="w-full bg-blue-200 rounded-full h-2.5 overflow-hidden">
                                <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" :style="`width: ${upload_progress}%`"></div>
                            </div>
                        </div>

                        <!-- Lista de arquivos com status individual -->
                        <template x-if="upload_files_status.length > 0">
                            <div class="space-y-2 mt-4">
                                <p class="text-sm font-semibold text-blue-900 mb-2">Arquivos:</p>
                                <template x-for="file in upload_files_status" :key="file.name">
                                    <div class="flex items-center justify-between bg-white rounded px-3 py-2 text-sm">
                                        <div class="flex items-center space-x-2 flex-1 min-w-0">
                                            <span x-text="file.status === 'success' ? '‚úì' : file.status === 'error' || file.status === 'invalid' ? '‚úó' : file.status === 'uploading' || file.status === 'processing' ? '‚ü≥' : '‚è≥'"
                                                  :class="file.status === 'success' ? 'text-green-600' : file.status === 'error' || file.status === 'invalid' ? 'text-red-600' : file.status === 'uploading' || file.status === 'processing' ? 'text-blue-600 animate-spin' : 'text-gray-400'"></span>
                                            <span class="font-medium truncate" x-text="file.name"></span>
                                        </div>
                                        <span class="text-xs ml-2 whitespace-nowrap"
                                              :class="file.status === 'success' ? 'text-green-600' : file.status === 'error' || file.status === 'invalid' ? 'text-red-600' : 'text-blue-600'"
                                              x-text="file.message"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- Documents List -->
                <div class="bg-white rounded-lg shadow">
                    <!-- Search Bar -->
                    <div class="p-4 border-b">
                        <input type="text"
                               x-model="busca_documentos"
                               @input="filtrar_documentos()"
                               placeholder="üîç Buscar documentos por nome, tipo ou status..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Bulk actions bar -->
                    <div x-show="documentos_selecionados.length > 0" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">
                            <span x-text="documentos_selecionados.length"></span> documento(s) selecionado(s)
                        </span>
                        <div class="space-x-2">
                            <button @click="remover_selecionados()" class="px-4 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                                üóëÔ∏è Remover Selecionados
                            </button>
                            <button @click="documentos_selecionados = []" class="px-4 py-2 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400">
                                Cancelar
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100 border-b">
                                <tr>
                                    <th class="px-3 py-3 text-center text-sm font-medium">
                                        <input type="checkbox"
                                               @change="alternar_todos_documentos($event.target.checked)"
                                               :checked="documentos_filtrados.length > 0 && documentos_selecionados.length === documentos_filtrados.length"
                                               class="w-4 h-4 cursor-pointer">
                                    </th>
                                    <th @click="ordenar_documentos('nome')" class="px-6 py-3 text-left text-sm font-medium cursor-pointer hover:bg-gray-200 select-none">
                                        Nome <span x-show="ordem_campo === 'nome'" x-text="ordem_direcao === 'asc' ? '‚Üë' : '‚Üì'"></span>
                                    </th>
                                    <th @click="ordenar_documentos('tamanho')" class="px-6 py-3 text-left text-sm font-medium cursor-pointer hover:bg-gray-200 select-none">
                                        Tamanho <span x-show="ordem_campo === 'tamanho'" x-text="ordem_direcao === 'asc' ? '‚Üë' : '‚Üì'"></span>
                                    </th>
                                    <th @click="ordenar_documentos('tipo')" class="px-6 py-3 text-left text-sm font-medium cursor-pointer hover:bg-gray-200 select-none">
                                        Tipo <span x-show="ordem_campo === 'tipo'" x-text="ordem_direcao === 'asc' ? '‚Üë' : '‚Üì'"></span>
                                    </th>
                                    <th @click="ordenar_documentos('status')" class="px-6 py-3 text-left text-sm font-medium cursor-pointer hover:bg-gray-200 select-none">
                                        Status <span x-show="ordem_campo === 'status'" x-text="ordem_direcao === 'asc' ? '‚Üë' : '‚Üì'"></span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-sm font-medium">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-documentos">
                                <tr class="border-b hover:bg-gray-50">
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">Carregando documentos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Chat RAG Panel -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-purple-50">
                        <h3 class="text-lg font-bold text-gray-800">üí¨ Converse com a Base de Conhecimento</h3>
                        <p class="text-sm text-gray-600 mt-1">Fa√ßa perguntas sobre os documentos indexados</p>
                    </div>

                    <!-- Chat Messages -->
                    <div class="p-4 h-96 overflow-y-auto bg-gray-50" id="chat-kb-container">
                        <template x-if="chat_kb_mensagens.length === 0">
                            <div class="text-center text-gray-400 py-16">
                                <p class="text-lg">üëã Ol√°! Pergunte algo sobre os documentos da base</p>
                                <p class="text-sm mt-2">Exemplo: "Quais s√£o os principais desafios mencionados nos documentos?"</p>
                            </div>
                        </template>

                        <div class="space-y-4">
                            <template x-for="(msg, idx) in chat_kb_mensagens" :key="idx">
                                <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                                    <div :class="msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-white text-gray-900 border border-gray-200'"
                                         class="max-w-3xl rounded-lg p-4 shadow-sm">
                                        <div class="flex items-start space-x-2">
                                            <span x-text="msg.role === 'user' ? 'üë§' : 'ü§ñ'" class="text-lg"></span>
                                            <div class="flex-1">
                                                <div class="text-sm" x-html="markdown_to_html(msg.content)"></div>
                                                <template x-if="msg.fontes && msg.fontes.length > 0">
                                                    <div class="mt-3 pt-3 border-t" :class="msg.role === 'user' ? 'border-blue-400' : 'border-gray-200'">
                                                        <p class="text-xs font-semibold mb-2" :class="msg.role === 'user' ? 'text-blue-100' : 'text-gray-600'">üìö Fontes:</p>
                                                        <div class="space-y-1">
                                                            <template x-for="fonte in msg.fontes" :key="fonte">
                                                                <p class="text-xs" :class="msg.role === 'user' ? 'text-blue-100' : 'text-gray-600'">
                                                                    ‚Ä¢ <span x-text="fonte"></span>
                                                                </p>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </template>
                                                <!-- Debug Info (only for assistant messages) -->
                                                <template x-if="msg.role === 'assistant' && msg.debug">
                                                    <div class="mt-3 pt-3 border-t border-gray-200" x-data="{ debugExpanded: false }">
                                                        <button @click="debugExpanded = !debugExpanded"
                                                                class="flex items-center space-x-2 text-xs text-gray-500 hover:text-gray-700 focus:outline-none">
                                                            <span x-text="debugExpanded ? '‚ñº' : '‚ñ∂'"></span>
                                                            <span>üîç Informa√ß√µes de Debug</span>
                                                        </button>
                                                        <div x-show="debugExpanded" class="mt-2 space-y-2 text-xs text-gray-600 bg-gray-50 p-3 rounded">
                                                            <div class="grid grid-cols-2 gap-2">
                                                                <div>
                                                                    <strong>Total no Vector Store:</strong> <span x-text="msg.debug.total_documentos_vector_store"></span>
                                                                </div>
                                                                <div>
                                                                    <strong>Documentos Encontrados:</strong> <span x-text="msg.debug.documentos_encontrados"></span>
                                                                </div>
                                                                <div>
                                                                    <strong>Modelo LLM:</strong> <span x-text="msg.debug.modelo_llm"></span>
                                                                </div>
                                                                <div>
                                                                    <strong>Temperatura:</strong> <span x-text="msg.debug.temperatura"></span>
                                                                </div>
                                                            </div>
                                                            <template x-if="msg.debug.chunks_utilizados && msg.debug.chunks_utilizados.length > 0">
                                                                <div class="mt-3">
                                                                    <strong class="block mb-2">Chunks Utilizados:</strong>
                                                                    <div class="space-y-2">
                                                                        <template x-for="chunk in msg.debug.chunks_utilizados" :key="chunk.chunk_index">
                                                                            <div class="bg-white p-2 rounded border border-gray-200">
                                                                                <div class="flex justify-between mb-1">
                                                                                    <span class="font-semibold">Chunk <span x-text="chunk.chunk_index"></span></span>
                                                                                    <span class="text-gray-500">Dist√¢ncia: <span x-text="chunk.distancia.toFixed(4)"></span></span>
                                                                                </div>
                                                                                <div class="text-gray-600 mb-1">
                                                                                    <strong>Fonte:</strong> <span x-text="chunk.fonte"></span>
                                                                                </div>
                                                                                <div class="text-gray-600 mb-1">
                                                                                    <strong>Tamanho:</strong> <span x-text="chunk.tamanho_texto"></span> caracteres
                                                                                </div>
                                                                                <div class="text-gray-500 text-xs bg-gray-100 p-1 rounded mt-1">
                                                                                    <strong>Preview:</strong> <span x-text="chunk.preview"></span>
                                                                                </div>
                                                                            </div>
                                                                        </template>
                                                                    </div>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <template x-if="chat_kb_carregando">
                                <div class="flex justify-start">
                                    <div class="bg-white text-gray-900 border border-gray-200 rounded-lg p-4 shadow-sm">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-lg">ü§ñ</span>
                                            <span class="text-sm text-gray-600">Pesquisando na base...</span>
                                            <span class="animate-pulse">‚ü≥</span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="p-4 border-t bg-white">
                        <form @submit.prevent="enviar_pergunta_kb()" class="flex space-x-2">
                            <input type="text"
                                   x-model="chat_kb_input"
                                   :disabled="chat_kb_carregando"
                                   placeholder="Digite sua pergunta..."
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100">
                            <button type="submit"
                                    :disabled="chat_kb_carregando || !chat_kb_input.trim()"
                                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                <span x-show="!chat_kb_carregando">Enviar</span>
                                <span x-show="chat_kb_carregando">‚ü≥</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Total de Documentos</p>
                        <p class="text-3xl font-bold text-blue-700 mt-2" x-text="stats.total_documentos || 0">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Documentos Indexados</p>
                        <p class="text-3xl font-bold text-green-700 mt-2" x-text="stats.total_indexados || 0">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Vetores no Banco</p>
                        <p class="text-3xl font-bold text-purple-700 mt-2" x-text="stats.total_vetores || 0">0</p>
                    </div>
                </div>
            </section>

            <!-- Fase 3: Prioriza√ß√£o -->
            <section x-show="fase_atual === 3" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">3. Prioriza√ß√£o de Falhas</h2>
                        <p class="text-gray-600 mt-1">Analise o impacto e esfor√ßo de implementa√ß√£o para cada falha</p>
                    </div>
                </div>

                <!-- Controles de An√°lise -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-bold mb-4">An√°lise de IA</h3>
                    <div class="flex gap-3 flex-wrap">
                        <button @click="analisar_todas_falhas()" :disabled="analisando" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50">
                            <span x-show="!analisando">ü§ñ Analisar Todas as Falhas</span>
                            <span x-show="analisando">‚ü≥ Analisando...</span>
                        </button>
                        <button @click="carregar_matriz()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium">
                            üìä Ver Matriz 2x2
                        </button>
                    </div>
                </div>

                <!-- Abas de Conte√∫do -->
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8">
                        <button @click="aba_priorizacao = 'tabela'" :class="aba_priorizacao === 'tabela' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'" class="py-4 px-1 font-medium text-sm border-b-2 border-transparent">
                            Tabela de Prioriza√ß√£o
                        </button>
                        <button @click="aba_priorizacao = 'matriz'" :class="aba_priorizacao === 'matriz' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'" class="py-4 px-1 font-medium text-sm border-b-2 border-transparent">
                            Matriz 2x2
                        </button>
                    </nav>
                </div>

                <!-- Aba: Tabela -->
                <div x-show="aba_priorizacao === 'tabela'" class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-medium">ID</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Falha</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Impacto</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Esfor√ßo</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Quadrante</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-priorizacao">
                            <tr class="border-b hover:bg-gray-50">
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Carregando prioriza√ß√µes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Aba: Matriz -->
                <div x-show="aba_priorizacao === 'matriz'" class="space-y-6">
                    <!-- Gr√°fico da Matriz -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <canvas id="canvas-matriz" height="80"></canvas>
                    </div>

                    <!-- Quadrantes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Quick Wins -->
                        <div class="matrix-cell quick-wins">
                            <h3 class="text-lg font-bold mb-2">üéØ Quick Wins</h3>
                            <p class="text-sm mb-4">Alto impacto, Baixo esfor√ßo</p>
                            <ul class="space-y-2" id="quadrante-quick-wins">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>

                        <!-- Strategic -->
                        <div class="matrix-cell strategic">
                            <h3 class="text-lg font-bold mb-2">‚≠ê Strategic</h3>
                            <p class="text-sm mb-4">Alto impacto, Alto esfor√ßo</p>
                            <ul class="space-y-2" id="quadrante-strategic">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>

                        <!-- Fill-in -->
                        <div class="matrix-cell fill-in">
                            <h3 class="text-lg font-bold mb-2">‚úì Fill-in</h3>
                            <p class="text-sm mb-4">Baixo impacto, Baixo esfor√ßo</p>
                            <ul class="space-y-2" id="quadrante-fill-in">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>

                        <!-- Low Priority -->
                        <div class="matrix-cell low-priority">
                            <h3 class="text-lg font-bold mb-2">‚è± Low Priority</h3>
                            <p class="text-sm mb-4">Baixo impacto, Alto esfor√ßo</p>
                            <ul class="space-y-2" id="quadrante-low-priority">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        function app() {
            return {
                fase_atual: 0,
                fases: [
                    { nome: 'Home', descricao: 'Vis√£o geral do projeto' },
                    { nome: 'Pesquisa', descricao: 'Busca por pol√≠ticas p√∫blicas' },
                    { nome: 'Base de Conhecimento', descricao: 'Gerenciamento de documentos e RAG' },
                    { nome: 'Prioriza√ß√£o', descricao: 'An√°lise de impacto e esfor√ßo' }
                ],
                stats: { total_falhas: 0, total_priorizadas: 0, total_resultados: 0, total_pendentes: 0, total_processando: 0, total_concluidas: 0, total_documentos: 0, total_indexados: 0, total_vetores: 0 },
                ativo: false,
                pesquisa_iniciando: false,
                analisando: false,
                uploading: false,
                upload_progress: 0,
                upload_status: '',
                upload_files_status: [],
                dragover_kb: false,
                duplicados_modal_aberto: false,
                arquivos_duplicados: [],
                arquivos_pendentes: null,
                opcao_duplicados: 'ask',
                documentos: [],
                documentos_filtrados: [],
                documentos_selecionados: [],
                busca_documentos: '',
                ordem_campo: 'nome',
                ordem_direcao: 'asc',
                chat_kb_mensagens: [],
                chat_kb_input: '',
                chat_kb_carregando: false,
                chat_pesquisa_mensagens: [],
                chat_pesquisa_input: '',
                chat_pesquisa_carregando: false,
                percentual_processamento: 0,
                aba_priorizacao: 'tabela',
                chartMatriz: null,
                modal_aberto: false,
                detalhes_modal: null,
                confirmacao_aberta: false,
                modal_analise_aberto: false,
                falha_analise: null,
                config_analise: {
                    usar_rag: true,
                    usar_resultados_pesquisa: true,
                    temperatura: 0.3,
                    modelo: 'google/gemini-2.5-pro',
                    max_tokens: 4000
                },
                analisando_individual: false,
                progresso_analise: {
                    etapa: '',
                    progresso: 0,
                    mensagem: ''
                },
                confirmacao_titulo: '',
                confirmacao_mensagem: '',
                confirmacao_callback: null,

                mudar_fase(idx) {
                    this.fase_atual = idx;
                    window.location.hash = this.get_hash_from_fase(idx);
                    if (idx === 1) this.carregar_dados_pesquisa();
                    if (idx === 2) this.carregar_documentos();
                    if (idx === 3) this.carregar_dados_priorizacao();
                },

                get_hash_from_fase(idx) {
                    const hashes = ['home', 'pesquisa', 'conhecimento', 'priorizacao'];
                    return `#${hashes[idx] || 'home'}`;
                },

                get_fase_from_hash() {
                    const hash = window.location.hash.slice(1) || 'home';
                    const hashes = { 'home': 0, 'pesquisa': 1, 'conhecimento': 2, 'priorizacao': 3 };
                    return hashes[hash] || 0;
                },

                // Converter markdown para HTML
                markdown_to_html(text) {
                    if (!text) return '';

                    let html = text;

                    // Headers (### Header -> <h3>Header</h3>)
                    html = html.replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold mt-4 mb-2">$1</h3>');
                    html = html.replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-4 mb-2">$1</h2>');
                    html = html.replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mt-4 mb-2">$1</h1>');

                    // Bold (**texto** -> <b>texto</b>)
                    html = html.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>');

                    // Italic (*texto* -> <i>texto</i>)
                    html = html.replace(/\*([^*]+)\*/g, '<i>$1</i>');

                    // Lists - Unordered (- item ou * item)
                    html = html.replace(/^\s*[-*]\s+(.*)$/gim, '<li class="ml-4">‚Ä¢ $1</li>');

                    // Lists - Ordered (1. item)
                    html = html.replace(/^\s*\d+\.\s+(.*)$/gim, '<li class="ml-4 list-decimal">$1</li>');

                    // Wrap consecutive <li> tags in <ul>
                    html = html.replace(/(<li[^>]*>.*<\/li>\n?)+/gs, '<ul class="my-2">$&</ul>');

                    // Code blocks (```code```)
                    html = html.replace(/```([^`]+)```/g, '<pre class="bg-gray-100 p-2 rounded my-2 overflow-x-auto"><code>$1</code></pre>');

                    // Inline code (`code`)
                    html = html.replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-1 rounded">$1</code>');

                    // Line breaks (dois espa√ßos + newline ou \n\n)
                    html = html.replace(/\n\n/g, '<br><br>');
                    html = html.replace(/  \n/g, '<br>');

                    // Links [text](url)
                    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-blue-600 underline" target="_blank">$1</a>');

                    return html;
                },

                mostrar_notificacao(mensagem, tipo = 'info') {
                    const container = document.getElementById('notificacoes-container');
                    const cores = {
                        'sucesso': 'bg-green-100 border-green-400 text-green-800',
                        'erro': 'bg-red-100 border-red-400 text-red-800',
                        'info': 'bg-blue-100 border-blue-400 text-blue-800',
                        'aviso': 'bg-yellow-100 border-yellow-400 text-yellow-800'
                    };
                    const div = document.createElement('div');
                    div.className = `border rounded px-4 py-3 ${cores[tipo] || cores['info']} animate-pulse`;
                    div.textContent = mensagem;
                    container.appendChild(div);

                    setTimeout(() => {
                        div.style.opacity = '0';
                        div.style.transition = 'opacity 0.3s';
                        setTimeout(() => div.remove(), 300);
                    }, 4000);
                },

                mostrar_confirmacao(titulo, mensagem, callback) {
                    this.confirmacao_titulo = titulo;
                    this.confirmacao_mensagem = mensagem;
                    this.confirmacao_callback = callback;
                    this.confirmacao_aberta = true;
                },

                fechar_confirmacao() {
                    this.confirmacao_aberta = false;
                    this.confirmacao_callback = null;
                },

                executar_confirmacao() {
                    if (this.confirmacao_callback) {
                        this.confirmacao_callback();
                    }
                    this.fechar_confirmacao();
                },

                async inicializar() {
                    try {
                        // Carregar p√°gina baseada na URL
                        this.fase_atual = this.get_fase_from_hash();

                        // Listener para mudan√ßa de URL
                        window.addEventListener('hashchange', () => {
                            this.fase_atual = this.get_fase_from_hash();
                        });

                        await this.carregar_stats();
                        if (this.fase_atual === 0) this.carregar_dados_pesquisa();
                        if (this.fase_atual === 1) this.carregar_dados_pesquisa();
                        if (this.fase_atual === 2) this.carregar_documentos();
                        if (this.fase_atual === 3) this.carregar_dados_priorizacao();

                        setInterval(() => this.carregar_stats(), 5000);
                    } catch (e) {
                        console.error('Erro ao inicializar aplica√ß√£o:', e);
                        // Mesmo com erro, manter a app vis√≠vel
                        this.stats.total_falhas = 50; // Valores padr√£o
                        this.stats.total_priorizadas = 50;
                    }
                },

                async carregar_stats() {
                    try {
                        // Carregar todas as estat√≠sticas de uma √∫nica vez
                        const res = await fetch('/api/stats');
                        if (res.ok) {
                            const response = await res.json();
                            if (response.sucesso && response.dados) {
                                const dados = response.dados;
                                this.stats.total_falhas = dados.total_falhas || 0;
                                this.stats.total_resultados = dados.total_resultados || 0;
                                this.stats.total_priorizadas = dados.pesquisas_concluidas || 0;
                                console.log('‚úì Stats carregadas:', this.stats);
                            }
                        } else {
                            console.warn('Resposta n√£o ok ao carregar stats:', res.status);
                            this.stats.total_falhas = 0;
                            this.stats.total_resultados = 0;
                            this.stats.total_priorizadas = 0;
                        }
                    } catch (e) {
                        console.error('Erro ao carregar stats:', e);
                        this.stats.total_falhas = 0;
                        this.stats.total_resultados = 0;
                        this.stats.total_priorizadas = 0;
                    }
                },

                async carregar_dados_pesquisa() {
                    try {
                        const res = await fetch('/api/falhas');
                        const data = await res.json();
                        const tbody = document.getElementById('tabela-falhas');
                        if (data.dados && Array.isArray(data.dados)) {
                            tbody.innerHTML = data.dados.map(falha => `
                                <tr class="border-b hover:bg-blue-50 cursor-pointer" onclick="console.log('Clicou na falha: ' + ${falha.id})">
                                    <td class="px-6 py-4 text-sm">${falha.id}</td>
                                    <td class="px-6 py-4 text-sm font-medium">${falha.titulo}</td>
                                    <td class="px-6 py-4 text-sm"><span class="bg-blue-100 text-blue-800 px-3 py-1 rounded">${falha.pilar}</span></td>
                                    <td class="px-6 py-4 text-sm flex items-center gap-3">
                                        <div class="flex-1 max-w-xs">
                                            <div class="w-16 bg-gray-200 rounded h-2"><div class="bg-blue-600 h-2 rounded" style="width: ${Math.min((falha.total_resultados || 0) * 5, 100)}%"></div></div>
                                        </div>
                                        <span class="font-medium whitespace-nowrap text-blue-600">${falha.total_resultados || 0}</span>
                                    </td>
                                </tr>
                            `).join('');
                        }
                    } catch (e) {
                        console.error('Erro ao carregar falhas', e);
                    }
                },

                async carregar_dados_priorizacao() {
                    await this.carregar_priorizacoes();
                    await this.carregar_matriz();
                },

                async carregar_priorizacoes() {
                    try {
                        console.log('[DEBUG] Carregando prioriza√ß√µes...');
                        const res = await fetch('/api/priorizacoes/');
                        if (!res.ok) {
                            console.log('[DEBUG] Erro ao carregar prioriza√ß√µes:', res.status);
                            return;
                        }
                        const data = await res.json();
                        console.log('[DEBUG] Prioriza√ß√µes carregadas:', data.dados?.length || 0);
                        const tbody = document.getElementById('tabela-priorizacao');
                        if (data.dados && Array.isArray(data.dados)) {
                            tbody.innerHTML = data.dados.map(p => {
                                const quadrante = this.obter_quadrante(p.impacto, p.esforco);
                                return `
                                    <tr class="border-b hover:bg-blue-50">
                                        <td class="px-6 py-4 text-sm">${p.falha_id}</td>
                                        <td class="px-6 py-4 text-sm font-medium">${p.titulo}</td>
                                        <td class="px-6 py-4 text-sm"><span class="bg-green-100 text-green-800 px-3 py-1 rounded font-bold">${p.impacto}/10</span></td>
                                        <td class="px-6 py-4 text-sm"><span class="bg-orange-100 text-orange-800 px-3 py-1 rounded font-bold">${p.esforco}/10</span></td>
                                        <td class="px-6 py-4 text-sm"><span class="bg-purple-100 text-purple-800 px-3 py-1 rounded text-xs">${quadrante}</span></td>
                                        <td class="px-6 py-4 text-sm space-x-2">
                                            <button data-action="analisar" data-falha-id="${p.falha_id}" data-titulo="${p.titulo.replace(/"/g, '&quot;')}" class="text-green-600 hover:underline font-medium">üîç Analisar</button>
                                            <button data-action="detalhes" data-falha-id="${p.falha_id}" class="text-blue-600 hover:underline font-medium">Ver Detalhes</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('');

                            // Adicionar event listeners aos bot√µes
                            tbody.querySelectorAll('button[data-action="analisar"]').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    const falhaId = parseInt(btn.getAttribute('data-falha-id'));
                                    const titulo = btn.getAttribute('data-titulo');
                                    this.abrir_modal_analise(falhaId, titulo);
                                });
                            });

                            tbody.querySelectorAll('button[data-action="detalhes"]').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    const falhaId = parseInt(btn.getAttribute('data-falha-id'));
                                    this.abrir_detalhes_priorizacao(falhaId);
                                });
                            });

                            console.log('[DEBUG] Event listeners adicionados aos bot√µes');
                        }
                    } catch (e) {
                        console.error('[DEBUG] Erro ao carregar prioriza√ß√µes', e);
                    }
                },

                async carregar_matriz() {
                    try {
                        const res = await fetch('/api/priorizacoes/matriz/quadrantes');
                        if (!res.ok) return;
                        const data = await res.json();

                        // Renderizar quadrantes
                        this.renderizar_quadrante('quick_wins', data.quick_wins.dados);
                        this.renderizar_quadrante('strategic', data.strategic.dados);
                        this.renderizar_quadrante('fill_in', data.fill_in.dados);
                        this.renderizar_quadrante('low_priority', data.low_priority.dados);

                        // Renderizar gr√°fico
                        this.renderizar_grafico(data);
                    } catch (e) {
                        console.error('Erro ao carregar matriz', e);
                    }
                },

                renderizar_quadrante(quadrante, falhas) {
                    const el = document.getElementById(`quadrante-${quadrante}`);
                    if (!el) return;
                    if (!falhas || falhas.length === 0) {
                        el.innerHTML = '<li class="text-sm text-gray-600">Nenhuma falha neste quadrante</li>';
                    } else {
                        el.innerHTML = falhas.map(f => `<li class="text-sm">‚Ä¢ ${f.titulo}</li>`).join('');
                    }
                },

                async renderizar_grafico(data) {
                    const canvas = document.getElementById('canvas-matriz');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');

                    try {
                        const res = await fetch('/api/priorizacoes/matriz/dados');
                        if (!res.ok) return;
                        const matrizData = await res.json();

                        const labels = matrizData.dados.map(d => d.titulo.substring(0, 10));
                        const impactos = matrizData.dados.map(d => d.impacto);
                        const esforcos = matrizData.dados.map(d => d.esforco);

                        if (this.chartMatriz) this.chartMatriz.destroy();

                        this.chartMatriz = new Chart(ctx, {
                            type: 'scatter',
                            data: {
                                datasets: [{
                                    label: 'Falhas',
                                    data: impactos.map((imp, idx) => ({ x: esforcos[idx], y: imp })),
                                    borderColor: '#3B82F6',
                                    backgroundColor: '#93C5FD',
                                    borderWidth: 2,
                                    pointRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { display: true },
                                    title: { display: true, text: 'Matriz de Prioriza√ß√£o (Impacto vs Esfor√ßo)' }
                                },
                                scales: {
                                    x: { title: { display: true, text: 'Esfor√ßo (0-10)' }, min: 0, max: 10 },
                                    y: { title: { display: true, text: 'Impacto (0-10)' }, min: 0, max: 10 }
                                }
                            }
                        });
                    } catch (e) {
                        console.error('Erro ao renderizar gr√°fico', e);
                    }
                },

                obter_quadrante(impacto, esforco) {
                    if (impacto >= 6 && esforco <= 4) return 'üéØ Quick Wins';
                    if (impacto >= 6 && esforco > 4) return '‚≠ê Strategic';
                    if (impacto < 6 && esforco <= 4) return '‚úì Fill-in';
                    return '‚è± Low Priority';
                },

                async iniciar_pesquisas() {
                    this.pesquisa_iniciando = true;
                    try {
                        const res = await fetch('/api/pesquisas/iniciar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ falhas_ids: 'all' })
                        });
                        if (res.ok) {
                            this.ativo = true;
                            setTimeout(() => this.carregar_stats(), 1000);
                        }
                    } catch (e) {
                        this.mostrar_notificacao('‚úó Erro ao iniciar pesquisas: ' + e.message, 'erro');
                    } finally {
                        this.pesquisa_iniciando = false;
                    }
                },

                async pausar_pesquisas() {
                    try {
                        await fetch('/api/pesquisas/pausar', { method: 'POST' });
                        this.ativo = false;
                        this.mostrar_notificacao('‚úì Pesquisa pausada', 'sucesso');
                    } catch (e) {
                        this.mostrar_notificacao('‚úó Erro: ' + e.message, 'erro');
                    }
                },

                async reiniciar_pesquisas() {
                    this.mostrar_confirmacao('Reiniciar pesquisas?', 'Todas as pesquisas ser√£o resetadas para o status inicial.', async () => {
                        try {
                            await fetch('/api/pesquisas/reiniciar', { method: 'POST' });
                            this.mostrar_notificacao('‚úì Pesquisas reiniciadas com sucesso', 'sucesso');
                            this.carregar_stats();
                        } catch (e) {
                            this.mostrar_notificacao('‚úó Erro: ' + e.message, 'erro');
                        }
                    });
                },

                async analisar_todas_falhas() {
                    this.analisando = true;
                    try {
                        await fetch('/api/priorizacoes/inicializar/padrao');
                        const res = await fetch('/api/priorizacoes/analisar-todas', { method: 'POST' });
                        if (res.ok) {
                            this.mostrar_notificacao('‚úì An√°lise conclu√≠da com sucesso!', 'sucesso');
                            this.carregar_priorizacoes();
                        } else {
                            this.mostrar_notificacao('‚úó Erro na an√°lise', 'erro');
                        }
                    } catch (e) {
                        this.mostrar_notificacao('‚úó Erro: ' + e.message, 'erro');
                    } finally {
                        this.analisando = false;
                    }
                },

                abrir_modal_analise(falha_id, titulo) {
                    console.log('[DEBUG] abrir_modal_analise chamado', { falha_id, titulo });
                    this.falha_analise = { id: falha_id, titulo: titulo };
                    this.modal_analise_aberto = true;
                    console.log('[DEBUG] modal_analise_aberto definido como', this.modal_analise_aberto);
                    // Resetar configura√ß√µes para padr√£o
                    this.config_analise = {
                        usar_rag: true,
                        usar_resultados_pesquisa: true,
                        temperatura: 0.3,
                        max_tokens: 4000,
                        modelo: 'google/gemini-2.5-pro'
                    };
                },

                fechar_modal_analise() {
                    this.modal_analise_aberto = false;
                    this.falha_analise = null;
                },

                async executar_analise_individual() {
                    console.log('[DEBUG] executar_analise_individual chamado');
                    if (!this.falha_analise) {
                        console.log('[DEBUG] Nenhuma falha selecionada');
                        return;
                    }

                    console.log('[DEBUG] Iniciando an√°lise para falha', this.falha_analise.id);
                    this.analisando_individual = true;

                    try {
                        // Etapa 1: Preparando an√°lise
                        this.progresso_analise = {
                            etapa: 'Preparando',
                            progresso: 10,
                            mensagem: 'Preparando contexto da an√°lise...'
                        };

                        const payload = {
                            falha_id: this.falha_analise.id,
                            usar_rag: this.config_analise.usar_rag,
                            usar_resultados_pesquisa: this.config_analise.usar_resultados_pesquisa,
                            temperatura: this.config_analise.temperatura,
                            max_tokens: this.config_analise.max_tokens,
                            modelo: this.config_analise.modelo
                        };
                        console.log('[DEBUG] Payload:', payload);

                        // Etapa 2: Coletando dados
                        this.progresso_analise = {
                            etapa: 'Coletando',
                            progresso: 30,
                            mensagem: this.config_analise.usar_rag ? 'Buscando na base de conhecimento...' : 'Preparando dados...'
                        };

                        // Etapa 3: Analisando
                        const nomeModelo = this.config_analise.modelo
                            ? this.config_analise.modelo.split('/').pop().replace(':free', '').replace('-', ' ')
                            : 'Gemini 2.5 Pro';
                        this.progresso_analise = {
                            etapa: 'Analisando',
                            progresso: 50,
                            mensagem: `Enviando para an√°lise da IA (${nomeModelo})...`
                        };

                        const res = await fetch('/api/priorizacoes/analisar-individual', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        console.log('[DEBUG] Resposta HTTP:', res.status);

                        // Etapa 4: Processando resposta
                        this.progresso_analise = {
                            etapa: 'Processando',
                            progresso: 75,
                            mensagem: 'Processando resultado da an√°lise...'
                        };

                        if (res.ok) {
                            const data = await res.json();
                            console.log('[DEBUG] Resposta da API:', data);

                            // Etapa 5: Salvando
                            this.progresso_analise = {
                                etapa: 'Salvando',
                                progresso: 90,
                                mensagem: 'Salvando resultado...'
                            };

                            // Pequeno delay para mostrar o progresso
                            await new Promise(resolve => setTimeout(resolve, 500));

                            // Etapa 6: Conclu√≠do
                            this.progresso_analise = {
                                etapa: 'Conclu√≠do',
                                progresso: 100,
                                mensagem: `An√°lise conclu√≠da! Impacto: ${data.impacto}/10, Esfor√ßo: ${data.esforco}/10`
                            };

                            // Aguardar um pouco antes de fechar
                            await new Promise(resolve => setTimeout(resolve, 1000));

                            this.mostrar_notificacao(`‚úì An√°lise da falha #${this.falha_analise.id} conclu√≠da! Impacto: ${data.impacto}/10, Esfor√ßo: ${data.esforco}/10`, 'sucesso');
                            this.fechar_modal_analise();
                            await this.carregar_priorizacoes();
                        } else {
                            let errorMessage = 'Erro desconhecido';
                            try {
                                const error = await res.json();
                                console.log('[DEBUG] Erro da API:', error);
                                errorMessage = error.detail || errorMessage;

                                // Melhorar mensagens de erro espec√≠ficas
                                if (res.status === 429) {
                                    errorMessage = 'Rate limit atingido. O modelo Gemini 2.0 Flash (gratuito) tem limite de requisi√ß√µes. Por favor, aguarde alguns segundos e tente novamente.';
                                } else if (res.status === 500) {
                                    errorMessage = 'Erro no servidor. Verifique os logs para mais detalhes.';
                                } else if (res.status === 422) {
                                    errorMessage = 'Dados inv√°lidos na requisi√ß√£o. Verifique as configura√ß√µes.';
                                }
                            } catch (e) {
                                console.error('[DEBUG] Erro ao parsear resposta de erro:', e);
                            }

                            this.progresso_analise = {
                                etapa: 'Erro',
                                progresso: 0,
                                mensagem: errorMessage
                            };
                            this.mostrar_notificacao('‚úó ' + errorMessage, 'erro');
                        }
                    } catch (e) {
                        console.error('[DEBUG] Exception:', e);
                        this.progresso_analise = {
                            etapa: 'Erro',
                            progresso: 0,
                            mensagem: 'Erro: ' + e.message
                        };
                        this.mostrar_notificacao('‚úó Erro: ' + e.message, 'erro');
                    } finally {
                        this.analisando_individual = false;
                        // Resetar progresso ap√≥s 2 segundos
                        setTimeout(() => {
                            this.progresso_analise = {
                                etapa: '',
                                progresso: 0,
                                mensagem: ''
                            };
                        }, 2000);
                    }
                },

                fechar_duplicados_modal() {
                    this.duplicados_modal_aberto = false;
                    this.arquivos_duplicados = [];
                    this.arquivos_pendentes = null;
                    this.opcao_duplicados = 'ask';
                },

                async proceder_com_upload() {
                    // Fechar modal
                    this.duplicados_modal_aberto = false;

                    // Prosseguir com upload usando a op√ß√£o selecionada
                    if (this.arquivos_pendentes) {
                        await this.executar_upload(this.arquivos_pendentes, this.opcao_duplicados);
                    }

                    // Limpar estado
                    this.arquivos_pendentes = null;
                    this.arquivos_duplicados = [];
                    this.opcao_duplicados = 'ask';
                },

                handleFileDrops(event) {
                    const files = event.dataTransfer.files;
                    if (!files || files.length === 0) return;

                    // Criar um evento sint√©tico compat√≠vel com handleFileUpload
                    const syntheticEvent = {
                        target: { files: files }
                    };

                    this.handleFileUpload(syntheticEvent);
                },

                async handleFileUpload(event) {
                    const files = event.target.files;
                    if (!files || files.length === 0) return;

                    // Primeiro, verificar se h√° duplicados
                    try {
                        const checkFormData = new FormData();
                        for (let file of files) {
                            checkFormData.append('files', file);
                        }

                        const checkRes = await fetch('/api/knowledge-base/check-duplicates', {
                            method: 'POST',
                            body: checkFormData
                        });

                        if (checkRes.ok) {
                            const checkData = await checkRes.json();

                            if (checkData.has_duplicates) {
                                // Mostrar modal de duplicados
                                this.arquivos_duplicados = checkData.duplicates;
                                this.arquivos_pendentes = files;
                                this.duplicados_modal_aberto = true;
                                return;
                            }
                        }
                    } catch (e) {
                        console.error('Erro ao verificar duplicados:', e);
                        // Continuar com upload mesmo em caso de erro na verifica√ß√£o
                    }

                    // Se n√£o h√° duplicados, prosseguir com upload
                    await this.executar_upload(files, 'overwrite');
                },

                async executar_upload(files, overwriteOption) {
                    this.uploading = true;
                    this.upload_progress = 0;
                    this.upload_status = 'Preparando upload...';
                    this.upload_files_status = [];
                    const formData = new FormData();
                    let validFileCount = 0;

                    for (let file of files) {
                        // Validate file type by extension (more reliable)
                        const validExtensions = ['.docx', '.pdf', '.csv', '.md', '.txt'];
                        const hasValidExtension = validExtensions.some(ext => file.name.toLowerCase().endswith(ext));

                        if (!hasValidExtension) {
                            this.mostrar_notificacao(`Arquivo inv√°lido: ${file.name}. Suportados: DOCX, PDF, CSV, Markdown.`, 'erro');
                            this.upload_files_status.push({ name: file.name, status: 'invalid', message: 'Tipo inv√°lido' });
                            continue;
                        }

                        // Validate file size (25MB max)
                        if (file.size > 25 * 1024 * 1024) {
                            this.mostrar_notificacao(`Arquivo muito grande: ${file.name}. M√°ximo 25MB.`, 'erro');
                            this.upload_files_status.push({ name: file.name, status: 'invalid', message: 'Muito grande (>25MB)' });
                            continue;
                        }

                        formData.append('files', file);
                        this.upload_files_status.push({ name: file.name, status: 'pending', message: 'Aguardando...', progress: 0 });
                        validFileCount++;
                    }

                    this.upload_status = `${validFileCount} arquivo(s) v√°lido(s) encontrado(s)`;

                    if (validFileCount === 0) {
                        this.mostrar_notificacao('‚úó Nenhum arquivo v√°lido selecionado', 'erro');
                        this.uploading = false;
                        return;
                    }

                    try {
                        // Usar SSE para progresso em tempo real
                        const xhr = new XMLHttpRequest();
                        let uploadCompleted = false;
                        let processingStarted = false;

                        // Timeout de 5 minutos
                        const uploadTimeout = setTimeout(() => {
                            if (!uploadCompleted) {
                                console.error('Upload timeout after 5 minutes');
                                xhr.abort();
                                this.mostrar_notificacao('‚úó Upload expirou (timeout)', 'erro');
                                this.uploading = false;
                                this.upload_files_status = [];
                                this.upload_status = '';
                            }
                        }, 300000);

                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                const progress = Math.round((e.loaded / e.total) * 100);
                                this.upload_progress = progress;

                                if (progress < 100) {
                                    this.upload_status = `Enviando arquivos... ${progress}%`;
                                    // Atualizar status dos arquivos pendentes para "uploading"
                                    this.upload_files_status = this.upload_files_status.map(f =>
                                        f.status === 'pending' ? { ...f, status: 'uploading', message: 'Enviando...' } : f
                                    );
                                } else {
                                    // Upload completo (100%), aguardando resposta do servidor
                                    this.upload_status = 'Upload conclu√≠do, processando e indexando arquivos...';
                                    this.upload_files_status = this.upload_files_status.map(f =>
                                        (f.status === 'uploading' || f.status === 'pending')
                                            ? { ...f, status: 'processing', message: 'Processando...' }
                                            : f
                                    );
                                }
                            }
                        });

                        xhr.addEventListener('load', () => {
                            clearTimeout(uploadTimeout);
                            uploadCompleted = true;
                            console.log('XHR load event triggered, status:', xhr.status);
                            console.log('Response:', xhr.responseText);

                            if (xhr.status === 200) {
                                try {
                                    const response = JSON.parse(xhr.responseText);
                                    const count = response.total || 0;

                                    // Atualizar status dos arquivos para processando/sucesso
                                    if (response.dados && Array.isArray(response.dados)) {
                                        const uploadedNames = response.dados.map(d => d.nome);
                                        const skippedNames = response.ignorados || [];

                                        this.upload_files_status = this.upload_files_status.map(f => {
                                            if (uploadedNames.includes(f.name)) {
                                                return { ...f, status: 'success', message: 'Indexado com sucesso!' };
                                            } else if (skippedNames.includes(f.name)) {
                                                return { ...f, status: 'error', message: 'Ignorado (duplicado)' };
                                            } else if (f.status === 'uploading' || f.status === 'pending' || f.status === 'processing') {
                                                return { ...f, status: 'error', message: 'N√£o processado pelo servidor' };
                                            }
                                            return f;
                                        });
                                    } else {
                                        // Se n√£o houver detalhes, marcar todos como sucesso
                                        this.upload_files_status = this.upload_files_status.map(f =>
                                            (f.status === 'uploading' || f.status === 'pending' || f.status === 'processing')
                                                ? { ...f, status: 'success', message: 'Indexado!' }
                                                : f
                                        );
                                    }

                                    const skippedCount = response.ignorados ? response.ignorados.length : 0;
                                    let statusMsg = `‚úì ${count} arquivo(s) indexado(s) com sucesso!`;
                                    if (skippedCount > 0) {
                                        statusMsg += ` (${skippedCount} ignorado(s))`;
                                    }
                                    this.upload_status = statusMsg;
                                    this.mostrar_notificacao(statusMsg, 'sucesso');

                                    // Limpar status ap√≥s 3 segundos
                                    setTimeout(() => {
                                        this.upload_files_status = [];
                                        this.upload_status = '';
                                    }, 3000);
                                } catch (e) {
                                    console.error('Failed to parse success response:', e);
                                    this.upload_status = '‚úì Arquivos enviados com sucesso!';
                                    this.mostrar_notificacao('‚úì Arquivos enviados com sucesso!', 'sucesso');
                                    setTimeout(() => {
                                        this.upload_files_status = [];
                                        this.upload_status = '';
                                    }, 3000);
                                }
                                this.carregar_documentos();
                            } else {
                                let errorMsg = xhr.statusText;
                                try {
                                    const response = JSON.parse(xhr.responseText);
                                    if (response.detail) {
                                        errorMsg = response.detail;
                                    } else if (response.mensagem) {
                                        errorMsg = response.mensagem;
                                    }
                                } catch (e) {
                                    console.error('Failed to parse error response:', e);
                                }
                                console.error('Upload failed with status:', xhr.status, 'Error:', errorMsg);
                                this.mostrar_notificacao('‚úó Erro ao enviar arquivos: ' + errorMsg, 'erro');
                            }
                            this.uploading = false;
                            this.upload_progress = 0;
                        });

                        xhr.addEventListener('error', (e) => {
                            clearTimeout(uploadTimeout);
                            uploadCompleted = true;
                            console.error('XHR error event triggered', e);
                            console.error('XHR status:', xhr.status, 'readyState:', xhr.readyState);
                            this.mostrar_notificacao('‚úó Erro de conex√£o ao enviar arquivos', 'erro');
                            this.uploading = false;
                            this.upload_files_status = [];
                            this.upload_status = '';
                        });

                        xhr.addEventListener('abort', () => {
                            clearTimeout(uploadTimeout);
                            if (!uploadCompleted) {
                                console.log('XHR abort event triggered');
                                this.mostrar_notificacao('‚úó Upload cancelado', 'aviso');
                                this.uploading = false;
                                this.upload_files_status = [];
                                this.upload_status = '';
                            }
                        });

                        // Debug: log number of files in FormData
                        const fileCount = Array.from(formData.entries()).filter(([key]) => key === 'files').length;
                        console.log(`Starting upload with ${fileCount} files in FormData, overwrite option: ${overwriteOption}`);
                        console.log('FormData entries:', Array.from(formData.entries()).map(([k, v]) => ({ key: k, fileName: v.name, size: v.size })));

                        // Usar endpoint com streaming de progresso
                        xhr.open('POST', `/api/knowledge-base/upload-stream?overwrite=${overwriteOption}`);
                        xhr.setRequestHeader('Accept', 'text/event-stream');

                        // Processar eventos SSE na medida em que chegam
                        let responseBuffer = '';
                        xhr.addEventListener('readystatechange', () => {
                            if (xhr.readyState === 3) {  // LOADING - dados parciais dispon√≠veis
                                processingStarted = true;
                                const newData = xhr.responseText.substring(responseBuffer.length);
                                responseBuffer = xhr.responseText;

                                // Processar eventos SSE
                                const events = newData.split('\n\n').filter(e => e.trim());
                                events.forEach(eventText => {
                                    if (!eventText.startsWith('data: ')) return;

                                    try {
                                        const jsonData = eventText.substring(6);  // Remove "data: "
                                        const event = JSON.parse(jsonData);

                                        if (event.type === 'start') {
                                            this.upload_status = `Iniciando processamento de ${event.total} arquivo(s)...`;
                                        } else if (event.type === 'progress') {
                                            // Atualizar progresso do arquivo espec√≠fico
                                            const fileIndex = event.file_index;
                                            const phase = event.phase;
                                            const progress = event.progress || 0;
                                            const detail = event.detail || '';

                                            let message = 'Processando...';
                                            if (phase === 'reading') message = 'Lendo arquivo...';
                                            else if (phase === 'extracting') message = 'Extraindo texto...';
                                            else if (phase === 'indexing') {
                                                // Mostrar detalhe do chunk se dispon√≠vel
                                                message = detail || 'Indexando...';
                                            }
                                            else if (phase === 'saving') message = 'Salvando...';
                                            else if (phase === 'complete') message = 'Conclu√≠do!';

                                            if (this.upload_files_status[fileIndex]) {
                                                this.upload_files_status[fileIndex] = {
                                                    ...this.upload_files_status[fileIndex],
                                                    status: phase === 'complete' ? 'success' : 'processing',
                                                    message: `${message} ${progress}%`,
                                                    progress: progress
                                                };
                                            }
                                        } else if (event.type === 'file_complete') {
                                            const result = event.result;
                                            const fileIndex = event.file_index;

                                            if (this.upload_files_status[fileIndex]) {
                                                if (result.status === 'success') {
                                                    this.upload_files_status[fileIndex] = {
                                                        ...this.upload_files_status[fileIndex],
                                                        status: 'success',
                                                        message: 'Indexado com sucesso!',
                                                        progress: 100
                                                    };
                                                } else if (result.status === 'error') {
                                                    this.upload_files_status[fileIndex] = {
                                                        ...this.upload_files_status[fileIndex],
                                                        status: 'error',
                                                        message: result.error || 'Erro',
                                                        progress: 0
                                                    };
                                                } else if (result.status === 'skipped') {
                                                    this.upload_files_status[fileIndex] = {
                                                        ...this.upload_files_status[fileIndex],
                                                        status: 'error',
                                                        message: 'Ignorado (duplicado)',
                                                        progress: 0
                                                    };
                                                }
                                            }
                                        } else if (event.type === 'complete') {
                                            // Processamento completo
                                            const count = event.total || 0;
                                            const skippedCount = event.ignorados ? event.ignorados.length : 0;
                                            let statusMsg = `‚úì ${count} arquivo(s) indexado(s) com sucesso!`;
                                            if (skippedCount > 0) {
                                                statusMsg += ` (${skippedCount} ignorado(s))`;
                                            }
                                            this.upload_status = statusMsg;

                                            // Finalizar upload
                                            this.uploading = false;
                                            this.upload_progress = 0;

                                            // Mostrar notifica√ß√£o apropriada
                                            if (count > 0) {
                                                this.mostrar_notificacao(statusMsg, 'sucesso');
                                            } else if (skippedCount > 0) {
                                                this.mostrar_notificacao(`Todos os ${skippedCount} arquivo(s) foram ignorados (duplicados)`, 'aviso');
                                            }

                                            // Recarregar documentos
                                            this.carregar_documentos();

                                            // Limpar status ap√≥s 3 segundos
                                            setTimeout(() => {
                                                this.upload_files_status = [];
                                                this.upload_status = '';
                                            }, 3000);
                                        }
                                    } catch (e) {
                                        console.error('Erro ao processar evento SSE:', e, eventText);
                                    }
                                });
                            }
                        });

                        xhr.send(formData);
                    } catch (e) {
                        console.error('Upload error:', e);
                        this.mostrar_notificacao('‚úó Erro ao processar upload: ' + e.message, 'erro');
                        this.uploading = false;
                    }
                },

                async carregar_documentos() {
                    try {
                        const res = await fetch('/api/knowledge-base/documentos');
                        if (!res.ok) return;
                        const data = await res.json();

                        if (data.dados && Array.isArray(data.dados)) {
                            this.documentos = data.dados;
                            this.documentos_filtrados = [...this.documentos];
                            this.aplicar_ordenacao();
                            this.renderizar_documentos();
                        } else {
                            this.documentos = [];
                            this.documentos_filtrados = [];
                            this.renderizar_documentos();
                        }
                    } catch (e) {
                        console.error('Erro ao carregar documentos:', e);
                    }
                },

                renderizar_documentos() {
                    const tbody = document.getElementById('tabela-documentos');

                    if (this.documentos_filtrados.length === 0) {
                        const mensagem = this.busca_documentos ? 'Nenhum documento encontrado com essa busca' : 'Nenhum documento enviado';
                        tbody.innerHTML = `<tr class="border-b"><td colspan="6" class="px-6 py-4 text-center text-gray-500">${mensagem}</td></tr>`;
                        return;
                    }

                    tbody.innerHTML = this.documentos_filtrados.map(doc => {
                        const isChecked = this.documentos_selecionados.includes(doc.nome);
                        return `
                        <tr class="border-b hover:bg-blue-50">
                            <td class="px-3 py-4 text-center">
                                <input type="checkbox"
                                       class="checkbox-doc w-4 h-4 cursor-pointer"
                                       data-filename="${doc.nome}"
                                       ${isChecked ? 'checked' : ''}>
                            </td>
                            <td class="px-6 py-4 text-sm font-medium">${doc.nome}</td>
                            <td class="px-6 py-4 text-sm">${(doc.tamanho / 1024).toFixed(2)} KB</td>
                            <td class="px-6 py-4 text-sm"><span class="bg-gray-100 px-2 py-1 rounded text-xs">${doc.tipo}</span></td>
                            <td class="px-6 py-4 text-sm">
                                <span class="${doc.status === 'indexado' ? 'text-green-600 font-bold' : 'text-yellow-600'}">${doc.status}</span>
                            </td>
                            <td class="px-6 py-4 text-sm">
                                <button class="btn-remover text-red-600 hover:underline text-xs" data-filename="${doc.nome}">Remover</button>
                            </td>
                        </tr>
                    `;
                    }).join('');

                    // Add event delegation for checkboxes
                    tbody.querySelectorAll('.checkbox-doc').forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            e.stopPropagation();
                            const filename = checkbox.getAttribute('data-filename');
                            this.alternar_selecao_documento(filename);
                        });
                    });

                    // Add event delegation for delete buttons
                    tbody.querySelectorAll('.btn-remover').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const filename = btn.getAttribute('data-filename');
                            this.remover_documento(filename);
                        });
                    });
                },

                ordenar_documentos(campo) {
                    // Se clicar no mesmo campo, inverte a dire√ß√£o
                    if (this.ordem_campo === campo) {
                        this.ordem_direcao = this.ordem_direcao === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.ordem_campo = campo;
                        this.ordem_direcao = 'asc';
                    }
                    this.aplicar_ordenacao();
                    this.renderizar_documentos();
                },

                aplicar_ordenacao() {
                    this.documentos_filtrados.sort((a, b) => {
                        let valA, valB;

                        switch(this.ordem_campo) {
                            case 'nome':
                                valA = a.nome.toLowerCase();
                                valB = b.nome.toLowerCase();
                                break;
                            case 'tamanho':
                                valA = a.tamanho;
                                valB = b.tamanho;
                                break;
                            case 'tipo':
                                valA = a.tipo.toLowerCase();
                                valB = b.tipo.toLowerCase();
                                break;
                            case 'status':
                                valA = a.status.toLowerCase();
                                valB = b.status.toLowerCase();
                                break;
                            default:
                                valA = a.nome.toLowerCase();
                                valB = b.nome.toLowerCase();
                        }

                        if (valA < valB) return this.ordem_direcao === 'asc' ? -1 : 1;
                        if (valA > valB) return this.ordem_direcao === 'asc' ? 1 : -1;
                        return 0;
                    });
                },

                filtrar_documentos() {
                    const busca = this.busca_documentos.toLowerCase().trim();

                    if (!busca) {
                        this.documentos_filtrados = [...this.documentos];
                    } else {
                        this.documentos_filtrados = this.documentos.filter(doc =>
                            doc.nome.toLowerCase().includes(busca) ||
                            doc.tipo.toLowerCase().includes(busca) ||
                            doc.status.toLowerCase().includes(busca)
                        );
                    }

                    this.aplicar_ordenacao();
                    this.renderizar_documentos();
                },

                async enviar_pergunta_kb() {
                    if (!this.chat_kb_input.trim() || this.chat_kb_carregando) return;

                    const pergunta = this.chat_kb_input.trim();
                    this.chat_kb_input = '';
                    this.chat_kb_carregando = true;

                    // Adicionar mensagem do usu√°rio
                    this.chat_kb_mensagens.push({
                        role: 'user',
                        content: pergunta
                    });

                    // Scroll para o fim
                    setTimeout(() => {
                        const container = document.getElementById('chat-kb-container');
                        if (container) container.scrollTop = container.scrollHeight;
                    }, 100);

                    try {
                        const res = await fetch('/api/knowledge-base/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ pergunta })
                        });

                        if (!res.ok) {
                            throw new Error('Erro ao processar pergunta');
                        }

                        const data = await res.json();

                        // Adicionar resposta do assistente
                        this.chat_kb_mensagens.push({
                            role: 'assistant',
                            content: data.resposta || 'N√£o consegui encontrar uma resposta.',
                            fontes: data.fontes || [],
                            debug: data.debug || null
                        });

                        // Scroll para o fim
                        setTimeout(() => {
                            const container = document.getElementById('chat-kb-container');
                            if (container) container.scrollTop = container.scrollHeight;
                        }, 100);
                    } catch (e) {
                        console.error('Erro no chat:', e);
                        this.mostrar_notificacao('‚úó Erro ao processar pergunta', 'erro');
                        this.chat_kb_mensagens.push({
                            role: 'assistant',
                            content: 'Desculpe, ocorreu um erro ao processar sua pergunta. Tente novamente.'
                        });
                    } finally {
                        this.chat_kb_carregando = false;
                    }
                },

                abrir_detalhes_priorizacao(falha_id) {
                    console.log('[DEBUG] abrir_detalhes_priorizacao chamado para falha', falha_id);
                    (async () => {
                        try {
                            const res = await fetch(`/api/priorizacoes/${falha_id}?incluir_fontes=true`);
                            console.log('[DEBUG] Resposta HTTP:', res.status);
                            if (!res.ok) {
                                this.mostrar_notificacao('‚úó Erro ao carregar detalhes da prioriza√ß√£o', 'erro');
                                return;
                            }
                            const data = await res.json();
                            console.log('[DEBUG] Dados recebidos:', data);
                            this.detalhes_modal = data.dados;
                            console.log('[DEBUG] detalhes_modal definido como:', this.detalhes_modal);
                            this.modal_aberto = true;
                            console.log('[DEBUG] modal_aberto definido como true');
                        } catch (e) {
                            console.error('[DEBUG] Erro ao abrir detalhes:', e);
                            this.mostrar_notificacao('‚úó Erro ao carregar detalhes da prioriza√ß√£o', 'erro');
                        }
                    }).call(this);
                },

                fechar_modal() {
                    this.modal_aberto = false;
                    this.detalhes_modal = null;
                },

                obter_icone_fonte(tipo) {
                    return tipo === 'pesquisa' ? 'üìÑ' : 'üìã';
                },

                obter_label_tipo(tipo) {
                    return tipo === 'pesquisa' ? 'Resultado de Pesquisa' : 'Documento';
                },

                obter_cor_tipo(tipo) {
                    return tipo === 'pesquisa'
                        ? 'bg-blue-100 text-blue-800'
                        : 'bg-purple-100 text-purple-800';
                },

                remover_documento(filename) {
                    console.log('remover_documento chamado para:', filename);
                    this.mostrar_confirmacao(`Remover "${filename}"?`, `Esta a√ß√£o n√£o pode ser desfeita.`, () => {
                        console.log('Confirma√ß√£o aceita, removendo:', filename);
                        fetch(`/api/knowledge-base/documentos/${encodeURIComponent(filename)}`, {
                            method: 'DELETE'
                        })
                        .then(res => {
                            console.log('Resposta da API DELETE:', res.status, res.statusText);
                            if (res.ok) {
                                this.mostrar_notificacao(`‚úì Documento "${filename}" removido com sucesso!`, 'sucesso');
                                this.carregar_documentos();
                            } else {
                                return res.json().then(data => {
                                    const errorMsg = data.detail || res.statusText;
                                    this.mostrar_notificacao(`‚úó Erro ao remover documento: ${errorMsg}`, 'erro');
                                }).catch(() => {
                                    this.mostrar_notificacao(`‚úó Erro ao remover documento: ${res.statusText}`, 'erro');
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao remover documento:', error);
                            this.mostrar_notificacao(`‚úó Erro ao remover documento: ${error.message}`, 'erro');
                        });
                    });
                },

                alternar_selecao_documento(filename) {
                    const index = this.documentos_selecionados.indexOf(filename);
                    if (index > -1) {
                        this.documentos_selecionados.splice(index, 1);
                    } else {
                        this.documentos_selecionados.push(filename);
                    }
                },

                alternar_todos_documentos(checked) {
                    if (checked) {
                        this.documentos_selecionados = this.documentos_filtrados.map(doc => doc.nome);
                    } else {
                        this.documentos_selecionados = [];
                    }
                    this.renderizar_documentos();
                },

                async remover_selecionados() {
                    if (this.documentos_selecionados.length === 0) return;

                    const count = this.documentos_selecionados.length;
                    const message = count === 1
                        ? `Remover 1 documento selecionado?`
                        : `Remover ${count} documentos selecionados?`;

                    this.mostrar_confirmacao(message, `Esta a√ß√£o n√£o pode ser desfeita.`, async () => {
                        let sucesso = 0;
                        let falhas = 0;

                        for (const filename of this.documentos_selecionados) {
                            try {
                                const res = await fetch(`/api/knowledge-base/documentos/${encodeURIComponent(filename)}`, {
                                    method: 'DELETE'
                                });
                                if (res.ok) {
                                    sucesso++;
                                } else {
                                    falhas++;
                                    console.error(`Falha ao remover ${filename}`);
                                }
                            } catch (error) {
                                falhas++;
                                console.error(`Erro ao remover ${filename}:`, error);
                            }
                        }

                        this.documentos_selecionados = [];

                        if (falhas === 0) {
                            this.mostrar_notificacao(`‚úì ${sucesso} documento(s) removido(s) com sucesso!`, 'sucesso');
                        } else {
                            this.mostrar_notificacao(`‚ö† ${sucesso} removido(s), ${falhas} falhou(aram)`, 'aviso');
                        }

                        await this.carregar_documentos();
                    });
                }
            };
        }
    </script>

    <!-- Modal de Detalhes da Prioriza√ß√£o -->
    <div id="modal-detalhes" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" x-show="modal_aberto" @click.self="fechar_modal()" x-cloak>
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto" @click.stop>
            <!-- Header do Modal -->
            <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 border-b flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold" x-text="detalhes_modal?.titulo || ''"></h2>
                    <p class="text-sm mt-1 opacity-90" x-text="`Falha ID: ${detalhes_modal?.falha_id || ''}`"></p>
                </div>
                <button @click="fechar_modal()" class="text-white hover:bg-blue-700 p-2 rounded-full">
                    <span class="text-2xl">‚úï</span>
                </button>
            </div>

            <!-- Conte√∫do do Modal -->
            <div class="p-6 space-y-6">
                <!-- Scores de Impacto e Esfor√ßo -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <p class="text-sm font-medium text-gray-600">Impacto</p>
                        <p class="text-3xl font-bold text-green-600 mt-2" x-text="`${detalhes_modal?.impacto || 0}/10`"></p>
                        <p class="text-xs text-gray-600 mt-2">Potencial de impacto positivo</p>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <p class="text-sm font-medium text-gray-600">Esfor√ßo</p>
                        <p class="text-3xl font-bold text-orange-600 mt-2" x-text="`${detalhes_modal?.esforco || 0}/10`"></p>
                        <p class="text-xs text-gray-600 mt-2">Dificuldade de implementa√ß√£o</p>
                    </div>
                </div>

                <!-- An√°lise da IA -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="text-sm font-bold text-gray-800 mb-3">An√°lise da IA</h3>
                    <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="detalhes_modal?.analise || 'Sem an√°lise dispon√≠vel'"></p>
                </div>

                <!-- Fontes Utilizadas -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">üìö</span>
                        Fontes Utilizadas
                    </h3>

                    <template x-if="detalhes_modal?.fontes && detalhes_modal.fontes.length > 0">
                        <div class="space-y-3">
                            <template x-for="(fonte, idx) in detalhes_modal.fontes" :key="idx">
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
                                    <!-- Cabe√ßalho da Fonte -->
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="text-lg" x-text="obter_icone_fonte(fonte.fonte_tipo)"></span>
                                                <span class="font-bold text-gray-800 text-sm" x-text="fonte.fonte_titulo"></span>
                                            </div>
                                            <span :class="`${obter_cor_tipo(fonte.fonte_tipo)} px-2 py-1 rounded text-xs font-medium`"
                                                  x-text="obter_label_tipo(fonte.fonte_tipo)"></span>
                                        </div>
                                    </div>

                                    <!-- Descri√ß√£o da Fonte -->
                                    <template x-if="fonte.fonte_descricao">
                                        <p class="text-sm text-gray-600 mb-3" x-text="fonte.fonte_descricao"></p>
                                    </template>

                                    <!-- Conte√∫do da Fonte (se dispon√≠vel) -->
                                    <template x-if="fonte.fonte_conteudo && fonte.fonte_conteudo.length > 100">
                                        <details class="text-xs">
                                            <summary class="cursor-pointer text-blue-600 hover:underline font-medium">Ver mais detalhes</summary>
                                            <div class="mt-2 p-3 bg-white rounded border border-gray-300 max-h-40 overflow-y-auto">
                                                <p class="text-gray-700 whitespace-pre-wrap" x-text="fonte.fonte_conteudo"></p>
                                            </div>
                                        </details>
                                    </template>

                                    <!-- URL da Fonte -->
                                    <template x-if="fonte.fonte_url">
                                        <div class="mt-3">
                                            <a :href="fonte.fonte_url" target="_blank" rel="noopener noreferrer"
                                               class="text-blue-600 hover:underline text-xs font-medium flex items-center gap-1">
                                                <span>üîó</span> Ver fonte original
                                            </a>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>

                    <template x-if="!detalhes_modal?.fontes || detalhes_modal.fontes.length === 0">
                        <div class="text-center py-8 text-gray-500">
                            <p class="text-sm">Nenhuma fonte registrada para esta prioriza√ß√£o</p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Footer do Modal -->
            <div class="sticky bottom-0 bg-gray-100 p-4 border-t flex justify-end gap-3">
                <button @click="fechar_modal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-medium text-sm">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</body>
</html>
