<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Sebrae Nacional - Pesquisa de Políticas Públicas</title>
    <!-- Force body display IMMEDIATELY before any CSS loads -->
    <script>
        // This runs BEFORE any stylesheets load
        // Set a style rule that forces body to display
        const style = document.createElement('style');
        style.innerHTML = 'body { display: block !important; visibility: visible !important; opacity: 1 !important; }';
        document.head.appendChild(style);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script defer src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        body { display: block !important; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        [x-cloak] { display: none !important; }
        .phase-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
        .phase-active { background-color: #dbeafe; color: #1e40af; }
        .phase-inactive { background-color: #f3f4f6; color: #4b5563; }
        .phase-badge-nav { display: inline-flex; align-items: center; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: all 0.3s; }
        .phase-nav-active { background-color: #2563eb; color: white; }
        .phase-nav-inactive { background-color: #e5e7eb; color: #374151; }
        .phase-nav-inactive:hover { background-color: #d1d5db; }
        .matrix-cell { padding: 1rem; border-radius: 0.5rem; border: 2px solid; transition: all 0.3s; }
        .quick-wins { border-color: #22c55e; background-color: #f0fdf4; }
        .strategic { border-color: #f97316; background-color: #fff7ed; }
        .fill-in { border-color: #3b82f6; background-color: #eff6ff; }
        .low-priority { border-color: #ef4444; background-color: #fef2f2; }
        .container { max-width: 80rem; margin: 0 auto; padding: 0 1rem; }
        header { background-color: white; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        main { margin: 2rem auto; }
    </style>
    <script>
        // Fallback: Remove x-cloak after 5 seconds if Alpine.js hasn't loaded
        setTimeout(() => {
            const app = document.getElementById('app');
            if (app && app.hasAttribute('x-cloak')) {
                app.removeAttribute('x-cloak');
                console.warn('Alpine.js loading fallback applied');
            }
        }, 5000);
    </script>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="app" class="min-h-screen" x-data="app()" x-init="inicializar()" style="display: block;">
        <!-- Header Principal -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h1 class="text-3xl font-bold" style="color: #1e3a8a;">Sebrae Nacional</h1>
                        <p class="text-sm mt-1" style="color: #374151;">Pesquisa de Políticas Públicas para Inovação</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium" style="color: #374151;">Fase Atual</p>
                        <p class="text-lg font-bold text-blue-700" x-text="fases[fase_atual].nome"></p>
                    </div>
                </div>

                <!-- Navegação de Fases -->
                <div class="flex gap-2">
                    <template x-for="(fase, idx) in fases" :key="idx">
                        <button @click="mudar_fase(idx)"
                                :class="idx === fase_atual ? 'phase-nav-active' : 'phase-nav-inactive'"
                                class="phase-badge-nav text-sm">
                            <span x-text="idx === 0 ? fase.nome : `${idx}. ${fase.nome}`"></span>
                            <template x-if="idx < fase_atual">
                                <span class="ml-2">✓</span>
                            </template>
                        </button>
                    </template>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
            <!-- Fase 0: Home -->
            <section x-show="fase_atual === 0" class="space-y-8">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-8 border border-blue-200">
                    <h2 class="text-3xl font-bold mb-4">Bem-vindo ao Sistema de Pesquisa</h2>
                    <p class="text-lg text-gray-700 mb-6">
                        Este sistema ajuda a identificar, pesquisar e priorizar falhas de mercado no ecossistema de inovação brasileiro.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <template x-for="(fase, idx) in fases" :key="idx">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <div class="text-2xl font-bold text-blue-600 mb-2" x-text="`${idx + 1}`"></div>
                                <h3 class="font-bold mb-2" x-text="fase.nome"></h3>
                                <p class="text-sm text-gray-600" x-text="fase.descricao"></p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Estatísticas Gerais -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Total de Falhas</p>
                        <p class="text-3xl font-bold text-blue-700 mt-2" x-text="stats.total_falhas">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Priorizadas</p>
                        <p class="text-3xl font-bold text-green-700 mt-2" x-text="stats.total_priorizadas">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Pesquisas Realizadas</p>
                        <p class="text-3xl font-bold text-purple-700 mt-2" x-text="stats.total_resultados">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Status</p>
                        <p class="text-lg font-bold mt-2" :class="ativo ? 'text-green-700' : 'text-gray-600'" x-text="ativo ? '✓ Ativo' : '○ Inativo'"></p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-8">
                    <h3 class="text-xl font-bold mb-4">Comece Agora</h3>
                    <p class="text-gray-700 mb-6">Escolha uma fase para começar:</p>
                    <div class="space-y-2">
                        <button @click="mudar_fase(1)" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ▶ Fase 1: Pesquisa de Políticas Públicas
                        </button>
                        <button @click="mudar_fase(2)" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ▶ Fase 2: Base de Conhecimento
                        </button>
                        <button @click="mudar_fase(3)" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">
                            ▶ Fase 3: Priorização de Falhas
                        </button>
                    </div>
                </div>
            </section>

            <!-- Fase 1: Pesquisa -->
            <section x-show="fase_atual === 1" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">1. Pesquisa de Políticas Públicas</h2>
                        <p class="text-gray-600 mt-1">Identifique e pesquise políticas públicas relevantes para cada falha de mercado</p>
                    </div>
                </div>

                <!-- Status de Pesquisa -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Status de Processamento</h3>
                        <span class="text-sm font-medium" :class="ativo ? 'text-green-700' : 'text-red-700'" x-text="ativo ? '● Ativo' : '○ Parado'"></span>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-sm font-medium">Progresso Geral</span>
                                <span class="text-sm font-medium" x-text="`${percentual_processamento.toFixed(1)}%`"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-blue-600 h-3 rounded-full transition-all" :style="`width: ${percentual_processamento}%`"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-4">
                            <div>
                                <p class="text-xs text-gray-600">Pendentes</p>
                                <p class="text-2xl font-bold text-yellow-700" x-text="stats.total_pendentes">0</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Processando</p>
                                <p class="text-2xl font-bold text-blue-700" x-text="stats.total_processando">0</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Concluídas</p>
                                <p class="text-2xl font-bold text-green-700" x-text="stats.total_concluidas">0</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Resultados</p>
                                <p class="text-2xl font-bold text-purple-700" x-text="stats.total_resultados">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controles -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex gap-3 flex-wrap">
                        <button @click="iniciar_pesquisas()" :disabled="pesquisa_iniciando" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50">
                            <span x-show="!pesquisa_iniciando">▶ Iniciar Pesquisa</span>
                            <span x-show="pesquisa_iniciando">⟳ Iniciando...</span>
                        </button>
                        <button @click="pausar_pesquisas()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium">
                            ⏸ Pausar
                        </button>
                        <button @click="reiniciar_pesquisas()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium">
                            ⟲ Reiniciar Tudo
                        </button>
                    </div>
                </div>

                <!-- Tabela de Falhas -->
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-medium">ID</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Falha</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Pilar</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Progresso</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Resultados</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-falhas">
                            <tr class="border-b hover:bg-gray-50">
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">Carregando falhas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Fase 2: Base de Conhecimento -->
            <section x-show="fase_atual === 2" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">2. Base de Conhecimento</h2>
                        <p class="text-gray-600 mt-1">Faça upload de documentos (DOCX, PDF) para criar uma base de conhecimento vetorial</p>
                    </div>
                </div>

                <!-- Upload Area -->
                <div class="bg-white rounded-lg shadow p-8">
                    <div class="border-2 border-dashed border-blue-300 rounded-lg p-8 text-center transition"
                         @dragover.prevent="dragover_kb = true"
                         @dragenter.prevent="dragover_kb = true"
                         @dragleave="dragover_kb = false"
                         @drop.prevent="handleFileDrops($event); dragover_kb = false"
                         :class="dragover_kb ? 'border-blue-600 bg-blue-50' : 'hover:border-blue-500'">
                        <div class="text-4xl mb-2">📁</div>
                        <h3 class="text-lg font-bold mb-2">Arraste arquivos ou clique para selecionar</h3>
                        <p class="text-gray-600 mb-4">Suporta DOCX e PDF (máximo 25MB por arquivo)</p>
                        <input type="file" multiple accept=".docx,.pdf" @change="handleFileUpload" class="hidden" x-ref="fileInput">
                        <button @click.stop="$refs.fileInput.click()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                            Selecionar Arquivos
                        </button>
                    </div>
                </div>

                <!-- Upload Status -->
                <template x-if="uploading">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <div class="flex items-center">
                            <div class="animate-spin mr-3">⟳</div>
                            <div>
                                <p class="font-bold">Fazendo upload...</p>
                                <p class="text-sm text-gray-600" x-text="`${upload_progress}%`"></p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Documents List -->
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-medium">Nome</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Tamanho</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Tipo</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Status</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-documentos">
                            <tr class="border-b hover:bg-gray-50">
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">Carregando documentos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Total de Documentos</p>
                        <p class="text-3xl font-bold text-blue-700 mt-2" x-text="stats.total_documentos || 0">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Documentos Indexados</p>
                        <p class="text-3xl font-bold text-green-700 mt-2" x-text="stats.total_indexados || 0">0</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <p class="text-sm font-medium text-gray-600">Vetores no Banco</p>
                        <p class="text-3xl font-bold text-purple-700 mt-2" x-text="stats.total_vetores || 0">0</p>
                    </div>
                </div>
            </section>

            <!-- Fase 3: Priorização -->
            <section x-show="fase_atual === 3" class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">3. Priorização de Falhas</h2>
                        <p class="text-gray-600 mt-1">Analise o impacto e esforço de implementação para cada falha</p>
                    </div>
                </div>

                <!-- Controles de Análise -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-bold mb-4">Análise de IA</h3>
                    <div class="flex gap-3 flex-wrap">
                        <button @click="analisar_todas_falhas()" :disabled="analisando" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium disabled:opacity-50">
                            <span x-show="!analisando">🤖 Analisar Todas as Falhas</span>
                            <span x-show="analisando">⟳ Analisando...</span>
                        </button>
                        <button @click="carregar_matriz()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium">
                            📊 Ver Matriz 2x2
                        </button>
                    </div>
                </div>

                <!-- Abas de Conteúdo -->
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8">
                        <button @click="aba_priorizacao = 'tabela'" :class="aba_priorizacao === 'tabela' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'" class="py-4 px-1 font-medium text-sm border-b-2 border-transparent">
                            Tabela de Priorização
                        </button>
                        <button @click="aba_priorizacao = 'matriz'" :class="aba_priorizacao === 'matriz' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'" class="py-4 px-1 font-medium text-sm border-b-2 border-transparent">
                            Matriz 2x2
                        </button>
                    </nav>
                </div>

                <!-- Aba: Tabela -->
                <div x-show="aba_priorizacao === 'tabela'" class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100 border-b">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-medium">ID</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Falha</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Impacto</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Esforço</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Quadrante</th>
                                <th class="px-6 py-3 text-left text-sm font-medium">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-priorizacao">
                            <tr class="border-b hover:bg-gray-50">
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Carregando priorizações...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Aba: Matriz -->
                <div x-show="aba_priorizacao === 'matriz'" class="space-y-6">
                    <!-- Gráfico da Matriz -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <canvas id="canvas-matriz" height="80"></canvas>
                    </div>

                    <!-- Quadrantes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Quick Wins -->
                        <div class="matrix-cell quick-wins">
                            <h3 class="text-lg font-bold mb-2">🎯 Quick Wins</h3>
                            <p class="text-sm mb-4">Alto impacto, Baixo esforço</p>
                            <ul class="space-y-2" id="quadrante-quick-wins">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>

                        <!-- Strategic -->
                        <div class="matrix-cell strategic">
                            <h3 class="text-lg font-bold mb-2">⭐ Strategic</h3>
                            <p class="text-sm mb-4">Alto impacto, Alto esforço</p>
                            <ul class="space-y-2" id="quadrante-strategic">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>

                        <!-- Fill-in -->
                        <div class="matrix-cell fill-in">
                            <h3 class="text-lg font-bold mb-2">✓ Fill-in</h3>
                            <p class="text-sm mb-4">Baixo impacto, Baixo esforço</p>
                            <ul class="space-y-2" id="quadrante-fill-in">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>

                        <!-- Low Priority -->
                        <div class="matrix-cell low-priority">
                            <h3 class="text-lg font-bold mb-2">⏱ Low Priority</h3>
                            <p class="text-sm mb-4">Baixo impacto, Alto esforço</p>
                            <ul class="space-y-2" id="quadrante-low-priority">
                                <li class="text-sm text-gray-600">Carregando...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        function app() {
            return {
                fase_atual: 0,
                fases: [
                    { nome: 'Home', descricao: 'Visão geral do projeto' },
                    { nome: 'Pesquisa', descricao: 'Busca por políticas públicas' },
                    { nome: 'Base de Conhecimento', descricao: 'Gerenciamento de documentos e RAG' },
                    { nome: 'Priorização', descricao: 'Análise de impacto e esforço' }
                ],
                stats: { total_falhas: 0, total_priorizadas: 0, total_resultados: 0, total_pendentes: 0, total_processando: 0, total_concluidas: 0, total_documentos: 0, total_indexados: 0, total_vetores: 0 },
                ativo: false,
                pesquisa_iniciando: false,
                analisando: false,
                uploading: false,
                upload_progress: 0,
                dragover_kb: false,
                percentual_processamento: 0,
                aba_priorizacao: 'tabela',
                chartMatriz: null,
                modal_aberto: false,
                detalhes_modal: null,

                mudar_fase(idx) {
                    this.fase_atual = idx;
                    if (idx === 1) this.carregar_dados_pesquisa();
                    if (idx === 2) this.carregar_documentos();
                    if (idx === 3) this.carregar_dados_priorizacao();
                },

                async inicializar() {
                    try {
                        await this.carregar_stats();
                        this.carregar_dados_pesquisa();
                        setInterval(() => this.carregar_stats(), 5000);
                    } catch (e) {
                        console.error('Erro ao inicializar aplicação:', e);
                        // Mesmo com erro, manter a app visível
                        this.stats.total_falhas = 50; // Valores padrão
                        this.stats.total_priorizadas = 50;
                    }
                },

                async carregar_stats() {
                    try {
                        // Carregar todas as estatísticas de uma única vez
                        const res = await fetch('/api/stats');
                        if (res.ok) {
                            const response = await res.json();
                            if (response.sucesso && response.dados) {
                                const dados = response.dados;
                                this.stats.total_falhas = dados.total_falhas || 0;
                                this.stats.total_resultados = dados.total_resultados || 0;
                                this.stats.total_priorizadas = dados.pesquisas_concluidas || 0;
                                console.log('✓ Stats carregadas:', this.stats);
                            }
                        } else {
                            console.warn('Resposta não ok ao carregar stats:', res.status);
                            this.stats.total_falhas = 0;
                            this.stats.total_resultados = 0;
                            this.stats.total_priorizadas = 0;
                        }
                    } catch (e) {
                        console.error('Erro ao carregar stats:', e);
                        this.stats.total_falhas = 0;
                        this.stats.total_resultados = 0;
                        this.stats.total_priorizadas = 0;
                    }
                },

                async carregar_dados_pesquisa() {
                    try {
                        const res = await fetch('/api/falhas');
                        const data = await res.json();
                        const tbody = document.getElementById('tabela-falhas');
                        if (data.dados && Array.isArray(data.dados)) {
                            tbody.innerHTML = data.dados.map(falha => `
                                <tr class="border-b hover:bg-blue-50 cursor-pointer" onclick="console.log('Clicou na falha: ' + ${falha.id})">
                                    <td class="px-6 py-4 text-sm">${falha.id}</td>
                                    <td class="px-6 py-4 text-sm font-medium">${falha.titulo}</td>
                                    <td class="px-6 py-4 text-sm"><span class="bg-blue-100 text-blue-800 px-3 py-1 rounded">${falha.pilar}</span></td>
                                    <td class="px-6 py-4 text-sm flex items-center gap-3">
                                        <div class="flex-1 max-w-xs">
                                            <div class="w-16 bg-gray-200 rounded h-2"><div class="bg-blue-600 h-2 rounded" style="width: ${Math.min((falha.total_resultados || 0) * 5, 100)}%"></div></div>
                                        </div>
                                        <span class="font-medium whitespace-nowrap text-blue-600">${falha.total_resultados || 0}</span>
                                    </td>
                                </tr>
                            `).join('');
                        }
                    } catch (e) {
                        console.error('Erro ao carregar falhas', e);
                    }
                },

                async carregar_dados_priorizacao() {
                    await this.carregar_priorizacoes();
                    await this.carregar_matriz();
                },

                async carregar_priorizacoes() {
                    try {
                        const res = await fetch('/api/priorizacoes/');
                        if (!res.ok) return;
                        const data = await res.json();
                        const tbody = document.getElementById('tabela-priorizacao');
                        if (data.dados && Array.isArray(data.dados)) {
                            tbody.innerHTML = data.dados.map(p => {
                                const quadrante = this.obter_quadrante(p.impacto, p.esforco);
                                return `
                                    <tr class="border-b hover:bg-blue-50 cursor-pointer" onclick="console.log('Clicou na falha: ' + ${falha.id})">
                                        <td class="px-6 py-4 text-sm">${p.falha_id}</td>
                                        <td class="px-6 py-4 text-sm font-medium">${p.titulo}</td>
                                        <td class="px-6 py-4 text-sm"><span class="bg-green-100 text-green-800 px-3 py-1 rounded font-bold">${p.impacto}/10</span></td>
                                        <td class="px-6 py-4 text-sm"><span class="bg-orange-100 text-orange-800 px-3 py-1 rounded font-bold">${p.esforco}/10</span></td>
                                        <td class="px-6 py-4 text-sm"><span class="bg-purple-100 text-purple-800 px-3 py-1 rounded text-xs">${quadrante}</span></td>
                                        <td class="px-6 py-4 text-sm">
                                            <button @click="abrir_detalhes_priorizacao(${p.falha_id})" class="text-blue-600 hover:underline font-medium">Ver Detalhes</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('');
                        }
                    } catch (e) {
                        console.error('Erro ao carregar priorizações', e);
                    }
                },

                async carregar_matriz() {
                    try {
                        const res = await fetch('/api/priorizacoes/matriz/quadrantes');
                        if (!res.ok) return;
                        const data = await res.json();

                        // Renderizar quadrantes
                        this.renderizar_quadrante('quick_wins', data.quick_wins.dados);
                        this.renderizar_quadrante('strategic', data.strategic.dados);
                        this.renderizar_quadrante('fill_in', data.fill_in.dados);
                        this.renderizar_quadrante('low_priority', data.low_priority.dados);

                        // Renderizar gráfico
                        this.renderizar_grafico(data);
                    } catch (e) {
                        console.error('Erro ao carregar matriz', e);
                    }
                },

                renderizar_quadrante(quadrante, falhas) {
                    const el = document.getElementById(`quadrante-${quadrante}`);
                    if (!el) return;
                    if (!falhas || falhas.length === 0) {
                        el.innerHTML = '<li class="text-sm text-gray-600">Nenhuma falha neste quadrante</li>';
                    } else {
                        el.innerHTML = falhas.map(f => `<li class="text-sm">• ${f.titulo}</li>`).join('');
                    }
                },

                async renderizar_grafico(data) {
                    const canvas = document.getElementById('canvas-matriz');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');

                    try {
                        const res = await fetch('/api/priorizacoes/matriz/dados');
                        if (!res.ok) return;
                        const matrizData = await res.json();

                        const labels = matrizData.dados.map(d => d.titulo.substring(0, 10));
                        const impactos = matrizData.dados.map(d => d.impacto);
                        const esforcos = matrizData.dados.map(d => d.esforco);

                        if (this.chartMatriz) this.chartMatriz.destroy();

                        this.chartMatriz = new Chart(ctx, {
                            type: 'scatter',
                            data: {
                                datasets: [{
                                    label: 'Falhas',
                                    data: impactos.map((imp, idx) => ({ x: esforcos[idx], y: imp })),
                                    borderColor: '#3B82F6',
                                    backgroundColor: '#93C5FD',
                                    borderWidth: 2,
                                    pointRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { display: true },
                                    title: { display: true, text: 'Matriz de Priorização (Impacto vs Esforço)' }
                                },
                                scales: {
                                    x: { title: { display: true, text: 'Esforço (0-10)' }, min: 0, max: 10 },
                                    y: { title: { display: true, text: 'Impacto (0-10)' }, min: 0, max: 10 }
                                }
                            }
                        });
                    } catch (e) {
                        console.error('Erro ao renderizar gráfico', e);
                    }
                },

                obter_quadrante(impacto, esforco) {
                    if (impacto >= 6 && esforco <= 4) return '🎯 Quick Wins';
                    if (impacto >= 6 && esforco > 4) return '⭐ Strategic';
                    if (impacto < 6 && esforco <= 4) return '✓ Fill-in';
                    return '⏱ Low Priority';
                },

                async iniciar_pesquisas() {
                    this.pesquisa_iniciando = true;
                    try {
                        const res = await fetch('/api/pesquisas/iniciar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ falhas_ids: 'all' })
                        });
                        if (res.ok) {
                            this.ativo = true;
                            setTimeout(() => this.carregar_stats(), 1000);
                        }
                    } catch (e) {
                        alert('Erro ao iniciar pesquisas: ' + e.message);
                    } finally {
                        this.pesquisa_iniciando = false;
                    }
                },

                async pausar_pesquisas() {
                    try {
                        await fetch('/api/pesquisas/pausar', { method: 'POST' });
                        this.ativo = false;
                    } catch (e) {
                        alert('Erro: ' + e.message);
                    }
                },

                async reiniciar_pesquisas() {
                    if (confirm('Tem certeza que deseja reiniciar todas as pesquisas?')) {
                        try {
                            await fetch('/api/pesquisas/reiniciar', { method: 'POST' });
                            this.carregar_stats();
                        } catch (e) {
                            alert('Erro: ' + e.message);
                        }
                    }
                },

                async analisar_todas_falhas() {
                    this.analisando = true;
                    try {
                        await fetch('/api/priorizacoes/inicializar/padrao');
                        const res = await fetch('/api/priorizacoes/analisar-todas', { method: 'POST' });
                        if (res.ok) {
                            alert('Análise concluída!');
                            this.carregar_priorizacoes();
                        }
                    } catch (e) {
                        alert('Erro: ' + e.message);
                    } finally {
                        this.analisando = false;
                    }
                },

                handleFileDrops(event) {
                    const files = event.dataTransfer.files;
                    if (!files || files.length === 0) return;

                    // Criar um evento sintético compatível com handleFileUpload
                    const syntheticEvent = {
                        target: { files: files }
                    };

                    this.handleFileUpload(syntheticEvent);
                },

                async handleFileUpload(event) {
                    const files = event.target.files;
                    if (!files || files.length === 0) return;

                    this.uploading = true;
                    this.upload_progress = 0;
                    const formData = new FormData();

                    for (let file of files) {
                        // Validate file type
                        const validTypes = ['application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/pdf'];
                        if (!validTypes.includes(file.type)) {
                            alert(`Arquivo inválido: ${file.name}. Apenas DOCX e PDF são suportados.`);
                            continue;
                        }

                        // Validate file size (10MB max)
                        if (file.size > 25 * 1024 * 1024) {
                            alert(`Arquivo muito grande: ${file.name}. Máximo 25MB.`);
                            continue;
                        }

                        formData.append('files', file);
                    }

                    try {
                        const xhr = new XMLHttpRequest();

                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                this.upload_progress = Math.round((e.loaded / e.total) * 100);
                            }
                        });

                        xhr.addEventListener('load', () => {
                            if (xhr.status === 200) {
                                alert('Arquivos enviados com sucesso!');
                                this.carregar_documentos();
                            } else {
                                alert('Erro ao enviar arquivos: ' + xhr.statusText);
                            }
                            this.uploading = false;
                            this.upload_progress = 0;
                        });

                        xhr.addEventListener('error', () => {
                            alert('Erro de conexão ao enviar arquivos');
                            this.uploading = false;
                        });

                        xhr.open('POST', '/api/knowledge-base/upload');
                        xhr.send(formData);
                    } catch (e) {
                        alert('Erro ao processar upload: ' + e.message);
                        this.uploading = false;
                    }
                },

                async carregar_documentos() {
                    try {
                        const res = await fetch('/api/knowledge-base/documentos');
                        if (!res.ok) return;
                        const data = await res.json();
                        const tbody = document.getElementById('tabela-documentos');

                        if (data.dados && Array.isArray(data.dados)) {
                            tbody.innerHTML = data.dados.map(doc => `
                                <tr class="border-b hover:bg-blue-50 cursor-pointer" onclick="console.log('Documento: ' + '${doc.nome}')">
                                    <td class="px-6 py-4 text-sm font-medium">${doc.nome}</td>
                                    <td class="px-6 py-4 text-sm">${(doc.tamanho / 1024).toFixed(2)} KB</td>
                                    <td class="px-6 py-4 text-sm"><span class="bg-gray-100 px-2 py-1 rounded text-xs">${doc.tipo}</span></td>
                                    <td class="px-6 py-4 text-sm">
                                        <span class="${doc.status === 'indexado' ? 'text-green-600 font-bold' : 'text-yellow-600'}">${doc.status}</span>
                                    </td>
                                    <td class="px-6 py-4 text-sm">
                                        <button @click="remover_documento('${doc.nome}')" class="text-red-600 hover:underline text-xs">Remover</button>
                                    </td>
                                </tr>
                            `).join('');
                        } else {
                            tbody.innerHTML = '<tr class="border-b"><td colspan="5" class="px-6 py-4 text-center text-gray-500">Nenhum documento enviado</td></tr>';
                        }
                    } catch (e) {
                        console.error('Erro ao carregar documentos:', e);
                    }
                },
                abrir_detalhes_priorizacao(falha_id) {
                    (async () => {
                        try {
                            const res = await fetch(`/api/priorizacoes/${falha_id}?incluir_fontes=true`);
                            if (!res.ok) {
                                alert('Erro ao carregar detalhes da priorização');
                                return;
                            }
                            const data = await res.json();
                            this.detalhes_modal = data.dados;
                            this.modal_aberto = true;
                        } catch (e) {
                            console.error('Erro ao abrir detalhes:', e);
                            alert('Erro ao carregar detalhes da priorização');
                        }
                    }).call(this);
                },

                fechar_modal() {
                    this.modal_aberto = false;
                    this.detalhes_modal = null;
                },

                obter_icone_fonte(tipo) {
                    return tipo === 'pesquisa' ? '📄' : '📋';
                },

                obter_label_tipo(tipo) {
                    return tipo === 'pesquisa' ? 'Resultado de Pesquisa' : 'Documento';
                },

                obter_cor_tipo(tipo) {
                    return tipo === 'pesquisa'
                        ? 'bg-blue-100 text-blue-800'
                        : 'bg-purple-100 text-purple-800';
                },

                remover_documento(filename) {
                    if (!confirm(`Tem certeza que deseja remover o documento "${filename}"? Esta ação não pode ser desfeita.`)) {
                        return;
                    }

                    fetch(`/api/knowledge-base/documentos/${encodeURIComponent(filename)}`, {
                        method: 'DELETE'
                    })
                    .then(res => {
                        if (res.ok) {
                            alert(`Documento "${filename}" removido com sucesso!`);
                            this.carregar_documentos();  // Recarregar a lista
                        } else {
                            alert(`Erro ao remover documento: ${res.statusText}`);
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao remover documento:', error);
                        alert(`Erro ao remover documento: ${error.message}`);
                    });
                }
            };
        }
    </script>

    <!-- Modal de Detalhes da Priorização -->
    <div id="modal-detalhes" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" x-show="modal_aberto" @click.self="fechar_modal()" style="display: none;">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto" @click.stop>
            <!-- Header do Modal -->
            <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 border-b flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold" x-text="detalhes_modal?.titulo || ''"></h2>
                    <p class="text-sm mt-1 opacity-90" x-text="`Falha ID: ${detalhes_modal?.falha_id || ''}`"></p>
                </div>
                <button @click="fechar_modal()" class="text-white hover:bg-blue-700 p-2 rounded-full">
                    <span class="text-2xl">✕</span>
                </button>
            </div>

            <!-- Conteúdo do Modal -->
            <div class="p-6 space-y-6">
                <!-- Scores de Impacto e Esforço -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <p class="text-sm font-medium text-gray-600">Impacto</p>
                        <p class="text-3xl font-bold text-green-600 mt-2" x-text="`${detalhes_modal?.impacto || 0}/10`"></p>
                        <p class="text-xs text-gray-600 mt-2">Potencial de impacto positivo</p>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <p class="text-sm font-medium text-gray-600">Esforço</p>
                        <p class="text-3xl font-bold text-orange-600 mt-2" x-text="`${detalhes_modal?.esforco || 0}/10`"></p>
                        <p class="text-xs text-gray-600 mt-2">Dificuldade de implementação</p>
                    </div>
                </div>

                <!-- Análise da IA -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="text-sm font-bold text-gray-800 mb-3">Análise da IA</h3>
                    <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="detalhes_modal?.analise || 'Sem análise disponível'"></p>
                </div>

                <!-- Fontes Utilizadas -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">📚</span>
                        Fontes Utilizadas
                    </h3>

                    <template x-if="detalhes_modal?.fontes && detalhes_modal.fontes.length > 0">
                        <div class="space-y-3">
                            <template x-for="(fonte, idx) in detalhes_modal.fontes" :key="idx">
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
                                    <!-- Cabeçalho da Fonte -->
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="text-lg" x-text="obter_icone_fonte(fonte.fonte_tipo)"></span>
                                                <span class="font-bold text-gray-800 text-sm" x-text="fonte.fonte_titulo"></span>
                                            </div>
                                            <span :class="`${obter_cor_tipo(fonte.fonte_tipo)} px-2 py-1 rounded text-xs font-medium`"
                                                  x-text="obter_label_tipo(fonte.fonte_tipo)"></span>
                                        </div>
                                    </div>

                                    <!-- Descrição da Fonte -->
                                    <template x-if="fonte.fonte_descricao">
                                        <p class="text-sm text-gray-600 mb-3" x-text="fonte.fonte_descricao"></p>
                                    </template>

                                    <!-- Conteúdo da Fonte (se disponível) -->
                                    <template x-if="fonte.fonte_conteudo && fonte.fonte_conteudo.length > 100">
                                        <details class="text-xs">
                                            <summary class="cursor-pointer text-blue-600 hover:underline font-medium">Ver mais detalhes</summary>
                                            <div class="mt-2 p-3 bg-white rounded border border-gray-300 max-h-40 overflow-y-auto">
                                                <p class="text-gray-700 whitespace-pre-wrap" x-text="fonte.fonte_conteudo"></p>
                                            </div>
                                        </details>
                                    </template>

                                    <!-- URL da Fonte -->
                                    <template x-if="fonte.fonte_url">
                                        <div class="mt-3">
                                            <a :href="fonte.fonte_url" target="_blank" rel="noopener noreferrer"
                                               class="text-blue-600 hover:underline text-xs font-medium flex items-center gap-1">
                                                <span>🔗</span> Ver fonte original
                                            </a>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>

                    <template x-if="!detalhes_modal?.fontes || detalhes_modal.fontes.length === 0">
                        <div class="text-center py-8 text-gray-500">
                            <p class="text-sm">Nenhuma fonte registrada para esta priorização</p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Footer do Modal -->
            <div class="sticky bottom-0 bg-gray-100 p-4 border-t flex justify-end gap-3">
                <button @click="fechar_modal()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded font-medium text-sm">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</body>
</html>
